import{playWave as _1,setWaveVolume as Ku,stopMidi as iu,setMidiVolume as Fu,playMidi as m1}from"./deps.js";class f0{key=0n;next=null;prev=null;unlink(){if(this.prev!=null){if(this.prev.next=this.next,this.next)this.next.prev=this.prev;this.next=null,this.prev=null}}}class V0 extends f0{next2=null;prev2=null;unlink2(){if(this.prev2!==null){if(this.prev2.next2=this.next2,this.next2)this.next2.prev2=this.prev2;this.next2=null,this.prev2=null}}}class $0{sentinel=new f0;cursor=null;constructor(){this.sentinel.next=this.sentinel,this.sentinel.prev=this.sentinel}push(u){if(u.prev)u.unlink();if(u.prev=this.sentinel.prev,u.next=this.sentinel,u.prev)u.prev.next=u;u.next.prev=u}addHead(u){if(u.prev)u.unlink();if(u.prev=this.sentinel,u.next=this.sentinel.next,u.prev.next=u,u.next)u.next.prev=u}pop(){let u=this.sentinel.next;if(u===this.sentinel)return null;return u?.unlink(),u}head(){let u=this.sentinel.next;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.next||null,u}tail(){let u=this.sentinel.prev;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.prev||null,u}next(){let u=this.cursor;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.next||null,u}prev(){let u=this.cursor;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.prev||null,u}clear(){while(!0){let u=this.sentinel.next;if(u===this.sentinel)return;u?.unlink()}}}var Y0=async(u)=>new Promise((_)=>setTimeout(_,u)),r0=async(u)=>new Uint8Array(await(await fetch(u)).arrayBuffer());function ku(u,_,m,R,b){while(b--)m[R++]=u[_++]}function Au(u){let _=0n;for(let m=0;m<u.length;m++)_=_<<8n|BigInt(u[m]);return _}function fu(u){let _=[];while(u>0n)_.unshift(Number(u&0xffn)),u>>=8n;if(_[0]&128)_.unshift(0);return new Uint8Array(_)}function Zu(u,_,m){let R=1n;while(_>0n){if(_%2n===1n)R=R*u%m;u=u*u%m,_>>=1n}return R}class W extends V0{static CRC32_POLYNOMIAL=3988292384;static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static cacheMin=new $0;static cacheMid=new $0;static cacheMax=new $0;static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static{for(let u=0;u<32;u++)W.bitmask[u]=(1<<u)-1;W.bitmask[32]=4294967295;for(let u=0;u<256;u++){let _=u;for(let m=0;m<8;m++)if((_&1)===1)_=_>>>1^W.CRC32_POLYNOMIAL;else _>>>=1;W.crctable[u]=_}}static getcrc(u,_,m){let R=4294967295;for(let b=_;b<m;b++)R=R>>>8^this.crctable[(R^u[b])&255];return~R}static checkcrc(u,_,m,R=0){return W.getcrc(u,_,m)==R}view;data;pos=0;bitPos=0;random=null;constructor(u){if(!u)throw Error();super();if(u instanceof Int8Array)this.data=new Uint8Array(u);else this.data=u;this.view=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}get length(){return this.view.byteLength}get available(){return this.view.byteLength-this.pos}static alloc(u){let _=null;if(u===0&&W.cacheMinCount>0)W.cacheMinCount--,_=W.cacheMin.pop();else if(u===1&&W.cacheMidCount>0)W.cacheMidCount--,_=W.cacheMid.pop();else if(u===2&&W.cacheMaxCount>0)W.cacheMaxCount--,_=W.cacheMax.pop();if(_)return _.pos=0,_;if(u===0)return new W(new Uint8Array(100));else if(u===1)return new W(new Uint8Array(5000));else return new W(new Uint8Array(30000))}release(){if(this.pos=0,this.length===100&&W.cacheMinCount<1000)W.cacheMin.push(this),W.cacheMinCount++;else if(this.length===5000&&W.cacheMidCount<250)W.cacheMid.push(this),W.cacheMidCount++;else if(this.length===30000&&W.cacheMaxCount<50)W.cacheMax.push(this),W.cacheMaxCount++}g1(){return this.view.getUint8(this.pos++)}g1b(){return this.view.getInt8(this.pos++)}g2(){let u=this.view.getUint16(this.pos);return this.pos+=2,u}g2b(){let u=this.view.getInt16(this.pos);return this.pos+=2,u}g3(){let u=this.view.getUint8(this.pos++)<<16|this.view.getUint16(this.pos);return this.pos+=2,u}g4(){let u=this.view.getInt32(this.pos);return this.pos+=4,u}g8(){let u=this.view.getBigInt64(this.pos);return this.pos+=8,u}gsmart(){return this.view.getUint8(this.pos)<128?this.g1()-64:this.g2()-49152}gsmarts(){return this.view.getUint8(this.pos)<128?this.g1():this.g2()-32768}gjstr(){let u=this.view,_=u.byteLength,m="",R;while((R=u.getUint8(this.pos++))!==10&&this.pos<_)m+=String.fromCharCode(R);return m}gdata(u,_,m){m.set(this.data.subarray(this.pos,this.pos+u),_),this.pos+=u}p1isaac(u){this.view.setUint8(this.pos++,u+(this.random?.nextInt??0)&255)}p1(u){this.view.setUint8(this.pos++,u)}p2(u){this.view.setUint16(this.pos,u),this.pos+=2}ip2(u){this.view.setUint16(this.pos,u,!0),this.pos+=2}p3(u){this.view.setUint8(this.pos++,u>>16),this.view.setUint16(this.pos,u),this.pos+=2}p4(u){this.view.setInt32(this.pos,u),this.pos+=4}ip4(u){this.view.setInt32(this.pos,u,!0),this.pos+=4}p8(u){this.view.setBigInt64(this.pos,u),this.pos+=8}pjstr(u){let _=this.view,m=u.length;for(let R=0;R<m;R++)_.setUint8(this.pos++,u.charCodeAt(R));_.setUint8(this.pos++,10)}pdata(u,_,m){this.data.set(u.subarray(m,m+_),this.pos),this.pos+=_-m}psize1(u){this.view.setUint8(this.pos-u-1,u)}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(u){let _=this.bitPos>>>3,m=8-(this.bitPos&7),R=0;this.bitPos+=u;for(;u>m;m=8)R+=(this.view.getUint8(_++)&W.bitmask[m])<<u-m,u-=m;if(u===m)R+=this.view.getUint8(_)&W.bitmask[m];else R+=this.view.getUint8(_)>>>m-u&W.bitmask[u];return R}rsaenc(u,_){let m=this.pos;this.pos=0;let R=new Uint8Array(m);this.gdata(m,0,R);let b=Au(R),E=Zu(b,_,u),O=fu(E);this.pos=0,this.p1(O.length),this.pdata(O,O.length,0)}}class E0{static enabled=!1;static outBuffer=null;static oldBuffer=null;static lastTime=0;static trackedCount=0;static lastMoveTime=0;static lastX=0;static lastY=0;static setEnabled(){this.outBuffer=W.alloc(1),this.oldBuffer=null,this.lastTime=performance.now(),this.enabled=!0}static setDisabled(){this.enabled=!1,this.outBuffer=null,this.oldBuffer=null}static flush(){let u=null;if(this.oldBuffer&&this.enabled)u=this.oldBuffer;return this.oldBuffer=null,u}static stop(){let u=null;if(this.outBuffer&&this.outBuffer.pos>0&&this.enabled)u=this.outBuffer;return this.setDisabled(),u}static ensureCapacity(u){if(!this.outBuffer)return;if(this.outBuffer.pos+u>=500){let _=this.outBuffer;this.outBuffer=W.alloc(1),this.oldBuffer=_}}static mousePressed(u,_,m,R){if(!this.outBuffer)return;if(!this.enabled&&(u>=0&&u<789&&_>=0&&_<532))return;this.trackedCount++;let b=performance.now(),E=(b-this.lastTime)/10|0;if(E>250)E=250;if(this.lastTime=b,this.ensureCapacity(5),m===2)this.outBuffer.p1(1);else this.outBuffer.p1(2);this.outBuffer.p1(E),this.outBuffer.p3(u+(_<<10))}static mouseReleased(u,_){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let m=performance.now(),R=(m-this.lastTime)/10|0;if(R>250)R=250;if(this.lastTime=m,this.ensureCapacity(2),u===2)this.outBuffer.p1(3);else this.outBuffer.p1(4);this.outBuffer.p1(R)}static mouseMoved(u,_,m){if(!this.outBuffer)return;if(!this.enabled&&(u>=0&&u<789&&_>=0&&_<532))return;let R=performance.now();if(R-this.lastMoveTime<50)return;this.lastMoveTime=R,this.trackedCount++;let b=(R-this.lastTime)/10|0;if(b>250)b=250;if(this.lastTime=R,u-this.lastX<8&&u-this.lastX>=-8&&_-this.lastY<8&&_-this.lastY>=-8)this.ensureCapacity(3),this.outBuffer.p1(5),this.outBuffer.p1(b),this.outBuffer.p1(u+(_-this.lastY+8<<4)+8-this.lastX);else if(u-this.lastX<128&&u-this.lastX>=-128&&_-this.lastY<128&&_-this.lastY>=-128)this.ensureCapacity(4),this.outBuffer.p1(6),this.outBuffer.p1(b),this.outBuffer.p1(u+128-this.lastX),this.outBuffer.p1(_+128-this.lastY);else this.ensureCapacity(5),this.outBuffer.p1(7),this.outBuffer.p1(b),this.outBuffer.p3(u+(_<<10));this.lastX=u,this.lastY=_}static keyPressed(u){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let _=performance.now(),m=(_-this.lastTime)/10|0;if(m>250)m=250;if(this.lastTime=_,u===1000)u=11;else if(u===1001)u=12;else if(u===1002)u=14;else if(u===1003)u=15;else if(u>=1008)u-=992;this.ensureCapacity(3),this.outBuffer.p1(8),this.outBuffer.p1(m),this.outBuffer.p1(u)}static keyReleased(u){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let _=performance.now(),m=(_-this.lastTime)/10|0;if(m>250)m=250;if(this.lastTime=_,u===1000)u=11;else if(u===1001)u=12;else if(u===1002)u=14;else if(u===1003)u=15;else if(u>=1008)u-=992;this.ensureCapacity(3),this.outBuffer.p1(9),this.outBuffer.p1(m),this.outBuffer.p1(u)}static focusGained(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let u=performance.now(),_=(u-this.lastTime)/10|0;if(_>250)_=250;this.lastTime=u,this.ensureCapacity(2),this.outBuffer.p1(10),this.outBuffer.p1(_)}static focusLost(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let u=performance.now(),_=(u-this.lastTime)/10|0;if(_>250)_=250;this.lastTime=u,this.ensureCapacity(2),this.outBuffer.p1(11),this.outBuffer.p1(_)}static mouseEntered(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let u=performance.now(),_=(u-this.lastTime)/10|0;if(_>250)_=250;this.lastTime=u,this.ensureCapacity(2),this.outBuffer.p1(12),this.outBuffer.p1(_)}static mouseExited(){if(!this.outBuffer)return;if(!this.enabled)return;this.trackedCount++;let u=performance.now(),_=(u-this.lastTime)/10|0;if(_>250)_=250;this.lastTime=u,this.ensureCapacity(2),this.outBuffer.p1(13),this.outBuffer.p1(_)}}var Vu=["F11","F12"],M=new Map;M.set("ArrowLeft",{code:37,ch:1});M.set("ArrowRight",{code:39,ch:2});M.set("ArrowUp",{code:38,ch:3});M.set("ArrowDown",{code:40,ch:4});M.set("Control",{code:17,ch:5});M.set("Shift",{code:16,ch:6});M.set("Alt",{code:18,ch:7});M.set("Backspace",{code:8,ch:8});M.set("Tab",{code:9,ch:9});M.set("Enter",{code:10,ch:10});M.set("Escape",{code:27,ch:27});M.set(" ",{code:32,ch:32});M.set("Delete",{code:127,ch:127});M.set("Home",{code:36,ch:1000});M.set("End",{code:35,ch:1001});M.set("PageUp",{code:33,ch:1002});M.set("PageDown",{code:34,ch:1003});M.set("F1",{code:112,ch:1008});M.set("F2",{code:113,ch:1009});M.set("F3",{code:114,ch:1010});M.set("F4",{code:115,ch:1011});M.set("F5",{code:116,ch:1012});M.set("F6",{code:117,ch:1013});M.set("F7",{code:118,ch:1014});M.set("F8",{code:119,ch:1015});M.set("F9",{code:120,ch:1016});M.set("F10",{code:121,ch:1017});M.set("F11",{code:122,ch:1018});M.set("F12",{code:123,ch:1019});M.set("CapsLock",{code:20,ch:65535});M.set("Meta",{code:524,ch:65535});M.set("Insert",{code:155,ch:65535});M.set("`",{code:192,ch:96});M.set("~",{code:192,ch:126});M.set("!",{code:49,ch:33});M.set("@",{code:50,ch:64});M.set("#",{code:51,ch:35});M.set("£",{code:51,ch:163});M.set("$",{code:52,ch:36});M.set("%",{code:53,ch:37});M.set("^",{code:54,ch:94});M.set("&",{code:55,ch:38});M.set("*",{code:56,ch:42});M.set("(",{code:57,ch:40});M.set(")",{code:48,ch:41});M.set("-",{code:45,ch:45});M.set("_",{code:45,ch:95});M.set("=",{code:61,ch:61});M.set("+",{code:61,ch:43});M.set("[",{code:91,ch:91});M.set("{",{code:91,ch:123});M.set("]",{code:93,ch:93});M.set("}",{code:93,ch:125});M.set("\\",{code:92,ch:92});M.set("|",{code:92,ch:124});M.set(";",{code:59,ch:59});M.set(":",{code:59,ch:58});M.set("'",{code:222,ch:39});M.set('"',{code:222,ch:34});M.set(",",{code:44,ch:44});M.set("<",{code:44,ch:60});M.set(".",{code:46,ch:46});M.set(">",{code:46,ch:62});M.set("/",{code:47,ch:47});M.set("?",{code:47,ch:63});M.set("0",{code:48,ch:48});M.set("1",{code:49,ch:49});M.set("2",{code:50,ch:50});M.set("3",{code:51,ch:51});M.set("4",{code:52,ch:52});M.set("5",{code:53,ch:53});M.set("6",{code:54,ch:54});M.set("7",{code:55,ch:55});M.set("8",{code:56,ch:56});M.set("9",{code:57,ch:57});M.set("a",{code:65,ch:97});M.set("b",{code:66,ch:98});M.set("c",{code:67,ch:99});M.set("d",{code:68,ch:100});M.set("e",{code:69,ch:101});M.set("f",{code:70,ch:102});M.set("g",{code:71,ch:103});M.set("h",{code:72,ch:104});M.set("i",{code:73,ch:105});M.set("j",{code:74,ch:106});M.set("k",{code:75,ch:107});M.set("l",{code:76,ch:108});M.set("m",{code:77,ch:109});M.set("n",{code:78,ch:110});M.set("o",{code:79,ch:111});M.set("p",{code:80,ch:112});M.set("q",{code:81,ch:113});M.set("r",{code:82,ch:114});M.set("s",{code:83,ch:115});M.set("t",{code:84,ch:116});M.set("u",{code:85,ch:117});M.set("v",{code:86,ch:118});M.set("w",{code:87,ch:119});M.set("x",{code:88,ch:120});M.set("y",{code:89,ch:121});M.set("z",{code:90,ch:122});M.set("A",{code:65,ch:65});M.set("B",{code:66,ch:66});M.set("C",{code:67,ch:67});M.set("D",{code:68,ch:68});M.set("E",{code:69,ch:69});M.set("F",{code:70,ch:70});M.set("G",{code:71,ch:71});M.set("H",{code:72,ch:72});M.set("I",{code:73,ch:73});M.set("J",{code:74,ch:74});M.set("K",{code:75,ch:75});M.set("L",{code:76,ch:76});M.set("M",{code:77,ch:77});M.set("N",{code:78,ch:78});M.set("O",{code:79,ch:79});M.set("P",{code:80,ch:80});M.set("Q",{code:81,ch:81});M.set("R",{code:82,ch:82});M.set("S",{code:83,ch:83});M.set("T",{code:84,ch:84});M.set("U",{code:85,ch:85});M.set("V",{code:86,ch:86});M.set("W",{code:87,ch:87});M.set("X",{code:88,ch:88});M.set("Y",{code:89,ch:89});M.set("Z",{code:90,ch:90});var d=document.getElementById("canvas"),i=d.getContext("2d",{willReadFrequently:!0}),p0=document.createElement("canvas"),z0=document.createElement("img"),uu=p0.getContext("2d",{willReadFrequently:!0});var Yu=["q","w","e","r","t","y","u","i","o","p","a","s","d","f","g","h","j","k","l","Shift","z","x","c","v","b","n","m","Del","123",","," ",".","Enter"],tu=["Q","W","E","R","T","Y","U","I","O","P","A","S","D","F","G","H","J","K","L","Shift","Z","X","C","V","B","N","M","Del","123",","," ",".","Enter"],Cu=["1","2","3","4","5","6","7","8","9","0","!",'"',"$","%","_","&","*","(",")","1/2","@","=","<",">","~",";",":","Del","abc","#"," ","?","Enter"],au=["£","^","[","]","{","}","'","-","+","/","\\","|","","","","","","","","2/2","","","","","","","","Del","abc",""," ","","Enter"],P0=[0,10,19,28],Z0=50,x0=30,yu=1000,Xu=5,su=75;function xu(){return document.fullscreenElement!==null}class Mu{canvasKeyboard;nativeKeyboard;mode;constructor(){this.canvasKeyboard=new Bu,this.nativeKeyboard=new Su;let u=localStorage.getItem("mobileKeyboardMode");if(u==="native")this.mode=1;else if(u==="canvas")this.mode=2;else this.mode=0}show(u,_,m,R){if(this.mode===0)if(xu())this.canvasKeyboard.show(u,_);else this.nativeKeyboard.show(m??u,R??_);else if(this.mode===2)this.canvasKeyboard.show(u,_);else if(this.mode===1)this.nativeKeyboard.show(m??u,R??_)}hide(){this.canvasKeyboard.hide(),this.nativeKeyboard.hide()}draw(){this.canvasKeyboard.draw()}isDisplayed(){return this.canvasKeyboard.isDisplayed()||this.nativeKeyboard.isDisplayed()}isWithinCanvasKeyboard(u,_){return this.canvasKeyboard.isDisplayed()&&this.canvasKeyboard.posWithinKeyboard(u,_)}captureMouseUp(u,_){if(this.canvasKeyboard.isDisplayed())return this.canvasKeyboard.captureMouseUp(u,_);else if(this.nativeKeyboard.isDisplayed())return this.nativeKeyboard.captureMouseUp(u,_);return!1}captureMouseDown(u,_){if(this.canvasKeyboard.isDisplayed())return this.canvasKeyboard.captureMouseDown(u,_);else if(this.nativeKeyboard.isDisplayed())return this.nativeKeyboard.captureMouseDown(u,_);return!1}notifyTouchMove(u,_){if(this.canvasKeyboard.isDisplayed())this.canvasKeyboard.notifyTouchMove(u,_);else if(this.nativeKeyboard.isDisplayed())this.nativeKeyboard.notifyTouchMove(u,_)}}class Bu{displayed=!1;height=x0*4+10;width=Z0*10+10;startX=0;startY=503-this.height;mode=0;animateBoxIndex=-1;animateBoxTimeout=0;touchStartAtX=0;touchStartAtY=0;touching=!1;touchStartTimestamp=0;getBoxColorForIndex(u){if(this.animateBoxIndex>-1){if(this.animateBoxIndex===u)return"#a6a6a6"}let _=this.getCharForIndex(u);if(_!==void 0&&_.length>1)return"#a9afba";return"#c8cdd1"}getBoxForIndex(u){let _=u<P0[1]?0:u<P0[2]?1:u<P0[3]?2:3,R={startX:(u-P0[_])*Z0+5,startY:_*x0+5,width:Z0,height:x0};if(_===1)R.startX+=Z0/2;if(u===30)R.width*=6;if(u>30)R.startX+=Z0*5;return R}getCharForIndex(u){if(this.mode===1)return tu[u];else if(this.mode===2)return Cu[u];else if(this.mode===3)return au[u];return Yu[u]}drawKeyBoxes(){for(let u=0;u<Yu.length;u++){let _=this.getBoxForIndex(u);i.fillStyle=this.getBoxColorForIndex(u),i.beginPath(),i.roundRect(this.startX+_.startX+2,this.startY+_.startY+2,_.width-2,_.height-2,5),i.fill()}}drawKeyChars(){i.fillStyle="black",i.textAlign="center",i.textBaseline="middle";for(let u=0;u<Yu.length;u++){i.font="16px Roboto, sans-serif";let _=this.getBoxForIndex(u),m=this.startX+_.startX+Z0/2,R=this.startY+_.startY+x0/2+2,b=this.getCharForIndex(u);if(b.length>1)i.font="14px Roboto, sans-serif";i.fillText(b,m,R)}}drawBackground(){i.fillStyle="#dadde2",i.beginPath(),i.roundRect(this.startX,this.startY,this.width,this.height,5),i.fill()}draw(){if(!this.isDisplayed())return;i.save(),this.drawBackground(),this.drawKeyBoxes(),this.drawKeyChars(),i.restore()}show(u,_){this.mode=0,this.displayed=!0}hide(){this.displayed=!1}isDisplayed(){return this.displayed}posWithinKeyboard(u,_){let m=u>=this.startX&&u<this.startX+this.width,R=_>=this.startY&&_<this.startY+this.height;return m&&R}getBoxIndexForClick(u,_){let m=u-this.startX,R=_-this.startY;if(m<0||R<0||m>=this.width||R>=this.height)return-1;let b=Math.floor(R/x0),E=Math.floor(m/Z0);if(b===0)return E;if(b===1){if(m<Z0/2||m>this.width-Z0/2)return-1;return P0[1]+Math.floor((m-Z0/2)/Z0)}if(b===2){if(E>=9)return-1;return P0[2]+E}return P0[3]+E}getCharForClick(u,_){let m=this.getBoxIndexForClick(u,_);if(m>-1){let R="";if(m>=30&&m<=35)R=" ";else if(m===36)R=this.getCharForIndex(31);else if(m===37)R="Enter";else R=this.getCharForIndex(m);if(R==="Del")R="Backspace";return R}return""}captureMouseDown(u,_){if(this.posWithinKeyboard(u,_))return!0;return!1}captureMouseUp(u,_){if(this.touching=!1,this.posWithinKeyboard(u,_)){let m=this.getBoxIndexForClick(u,_),R=this.getCharForClick(u,_);if(R==="Shift"){if(this.mode===0)this.mode=1;else this.mode=0;return!0}else if(R==="123"||R==="2/2")return this.mode=2,!0;else if(R==="1/2")return this.mode=3,!0;else if(R==="abc")return this.mode=0,!0;else if(R==="")return!0;let b=new KeyboardEvent("keydown",{key:R,code:R}),E=new KeyboardEvent("keyup",{key:R,code:R});if(d.dispatchEvent(b),d.dispatchEvent(E),!this.animateBoxTimeout){if(m>=30&&m<=35)this.animateBoxIndex=30;else if(m>35)this.animateBoxIndex=m-5;else this.animateBoxIndex=m;this.animateBoxTimeout=window.setTimeout(()=>{this.animateBoxIndex=-1,this.animateBoxTimeout=0},100)}return!0}return!1}notifyTouchMove(u,_){if(!this.posWithinKeyboard(u,_))return;if(this.touching&&performance.now()>this.touchStartTimestamp+yu){this.touching=!1;return}if(!this.touching){this.touching=!0,this.touchStartTimestamp=performance.now(),this.touchStartAtX=u-this.startX,this.touchStartAtY=_-this.startY;return}let m=Math.abs(Math.abs(this.touchStartAtX-u)-this.startX),R=Math.abs(Math.abs(this.touchStartAtY-_)-this.startY);if(m>su||R>su)return;if(m>Xu||R>Xu){let b=Math.max(0,Math.min(789-this.width,u-this.touchStartAtX)),E=Math.max(0,Math.min(532-this.height,_-this.touchStartAtY));this.startX=b,this.startY=E,d.dispatchEvent(new FocusEvent("focus"))}}}class Su{virtualInputElement;displayed=!1;isAndroid=!1;constructor(){if(this.isAndroid=navigator.userAgent.includes("Android"),this.virtualInputElement=document.createElement("input"),this.virtualInputElement.setAttribute("type","password"),this.virtualInputElement.setAttribute("autofocus","autofocus"),this.virtualInputElement.setAttribute("spellcheck","false"),this.virtualInputElement.setAttribute("autocomplete","off"),this.virtualInputElement.setAttribute("autocorrect","off"),this.virtualInputElement.setAttribute("autocapitalize","off"),this.virtualInputElement.setAttribute("style","position: fixed; top: 0px; left: 0px; width: 1px; height: 1px; opacity: 0;"),this.isAndroid)this.virtualInputElement.addEventListener("input",(u)=>{if(!(u instanceof InputEvent))return;let _=u.data;if(_===null)return;if(u.inputType!=="insertText")return;d.dispatchEvent(new KeyboardEvent("keydown",{key:_,code:_})),d.dispatchEvent(new KeyboardEvent("keyup",{key:_,code:_}))}),this.virtualInputElement.addEventListener("keydown",(u)=>{if(u.key==="Enter"||u.key==="Backspace")d.dispatchEvent(new KeyboardEvent("keydown",{key:u.key,code:u.key}))}),this.virtualInputElement.addEventListener("keyup",(u)=>{if(u.key==="Enter"||u.key==="Backspace")d.dispatchEvent(new KeyboardEvent("keyup",{key:u.key,code:u.key}))});else this.virtualInputElement.addEventListener("keydown",(u)=>{d.dispatchEvent(new KeyboardEvent("keydown",{key:u.key,code:u.key}))}),this.virtualInputElement.addEventListener("keyup",(u)=>{d.dispatchEvent(new KeyboardEvent("keyup",{key:u.key,code:u.key}))});document.body.appendChild(this.virtualInputElement)}draw(){}show(u,_){if(u&&_)this.virtualInputElement.style.left=`${u}px`,this.virtualInputElement.style.top=`${_}px`;d.blur(),this.virtualInputElement.focus(),this.virtualInputElement.click(),this.displayed=!0}hide(){this.virtualInputElement.blur(),d.focus(),this.displayed=!1}isDisplayed(){return this.displayed}captureMouseUp(u,_){return!1}captureMouseDown(u,_){return!1}notifyTouchMove(u,_){return}}var J0=new Mu;class K extends V0{static pixels=new Int32Array;static width2d=0;static height2d=0;static top=0;static bottom=0;static left=0;static right=0;static boundX=0;static centerX2d=0;static centerY2d=0;static bind(u,_,m){this.pixels=u,this.width2d=_,this.height2d=m,this.setBounds(0,0,_,m)}static resetBounds(){this.left=0,this.top=0,this.right=this.width2d,this.bottom=this.height2d,this.boundX=this.right-1,this.centerX2d=this.right/2|0}static setBounds(u,_,m,R){if(u<0)u=0;if(_<0)_=0;if(m>this.width2d)m=this.width2d;if(R>this.height2d)R=this.height2d;this.top=_,this.bottom=R,this.left=u,this.right=m,this.boundX=this.right-1,this.centerX2d=this.right/2|0,this.centerY2d=this.bottom/2|0}static clear(){let u=this.width2d*this.height2d;for(let _=0;_<u;_++)this.pixels[_]=0}static drawRect(u,_,m,R,b){this.drawHorizontalLine(u,_,b,m),this.drawHorizontalLine(u,_+R-1,b,m),this.drawVerticalLine(u,_,b,R),this.drawVerticalLine(u+m-1,_,b,R)}static drawRectAlpha(u,_,m,R,b,E){if(this.drawHorizontalLineAlpha(u,_,b,m,E),this.drawHorizontalLineAlpha(u,_+R-1,b,m,E),R>=3)this.drawVerticalLineAlpha(u,_,b,R,E),this.drawVerticalLineAlpha(u+m-1,_,b,R,E)}static drawHorizontalLine(u,_,m,R){if(_<this.top||_>=this.bottom)return;if(u<this.left)R-=this.left-u,u=this.left;if(u+R>this.right)R=this.right-u;let b=u+_*this.width2d;for(let E=0;E<R;E++)this.pixels[b+E]=m}static drawHorizontalLineAlpha=(u,_,m,R,b)=>{if(_<this.top||_>=this.bottom)return;if(u<this.left)R-=this.left-u,u=this.left;if(u+R>this.right)R=this.right-u;let E=256-b,O=(m>>16&255)*b,L=(m>>8&255)*b,I=(m&255)*b,N=this.width2d-R,H=u+_*this.width2d;for(let G=0;G<R;G++){let T=(this.pixels[H]>>16&255)*E,q=(this.pixels[H]>>8&255)*E,Q=(this.pixels[H]&255)*E,n=(O+T>>8<<16)+(L+q>>8<<8)+(I+Q>>8);this.pixels[H++]=n}};static drawVerticalLine(u,_,m,R){if(u<this.left||u>=this.right)return;if(_<this.top)R-=this.top-_,_=this.top;if(_+R>this.bottom)R=this.bottom-_;let b=u+_*this.width2d;for(let E=0;E<R;E++)this.pixels[b+E*this.width2d]=m}static drawVerticalLineAlpha=(u,_,m,R,b)=>{if(u<this.left||u>=this.right)return;if(_<this.top)R-=this.top-_,_=this.top;if(_+R>this.bottom)R=this.bottom-_;let E=256-b,O=(m>>16&255)*b,L=(m>>8&255)*b,I=(m&255)*b,N=u+_*this.width2d;for(let H=0;H<R;H++){let G=(this.pixels[N]>>16&255)*E,T=(this.pixels[N]>>8&255)*E,q=(this.pixels[N]&255)*E,Q=(O+G>>8<<16)+(L+T>>8<<8)+(I+q>>8);this.pixels[N]=Q,N+=this.width2d}};static drawLine(u,_,m,R,b){let E=Math.abs(m-u),O=Math.abs(R-_),L=u<m?1:-1,I=_<R?1:-1,N=E-O;while(!0){if(u>=this.left&&u<this.right&&_>=this.top&&_<this.bottom)this.pixels[u+_*this.width2d]=b;if(u===m&&_===R)break;let H=2*N;if(H>-O)N=N-O,u=u+L;if(H<E)N=N+E,_=_+I}}static fillRect2d(u,_,m,R,b){if(u<this.left)m-=this.left-u,u=this.left;if(_<this.top)R-=this.top-_,_=this.top;if(u+m>this.right)m=this.right-u;if(_+R>this.bottom)R=this.bottom-_;let E=this.width2d-m,O=u+_*this.width2d;for(let L=-R;L<0;L++){for(let I=-m;I<0;I++)this.pixels[O++]=b;O+=E}}static fillRectAlpha(u,_,m,R,b,E){if(u<this.left)m-=this.left-u,u=this.left;if(_<this.top)R-=this.top-_,_=this.top;if(u+m>this.right)m=this.right-u;if(_+R>this.bottom)R=this.bottom-_;let O=256-E,L=(b>>16&255)*E,I=(b>>8&255)*E,N=(b&255)*E,H=this.width2d-m,G=u+_*this.width2d;for(let T=0;T<R;T++){for(let q=-m;q<0;q++){let Q=(this.pixels[G]>>16&255)*O,n=(this.pixels[G]>>8&255)*O,J=(this.pixels[G]&255)*O,U=(L+Q>>8<<16)+(I+n>>8<<8)+(N+J>>8);this.pixels[G++]=U}G+=H}}static fillCircle(u,_,m,R,b){let E=256-b,O=(R>>16&255)*b,L=(R>>8&255)*b,I=(R&255)*b,N=_-m;if(N<0)N=0;let H=_+m;if(H>=this.height2d)H=this.height2d-1;for(let G=N;G<=H;G++){let T=G-_,q=Math.sqrt(m*m-T*T)|0,Q=u-q;if(Q<0)Q=0;let n=u+q;if(n>=this.width2d)n=this.width2d-1;let J=Q+G*this.width2d;for(let U=Q;U<=n;U++){let w=(this.pixels[J]>>16&255)*E,k=(this.pixels[J]>>8&255)*E,V=(this.pixels[J]&255)*E,j=(O+w>>8<<16)+(L+k>>8<<8)+(I+V>>8);this.pixels[J++]=j}}}static setPixel(u,_,m){if(u<this.left||u>=this.right||_<this.top||_>=this.bottom)return;this.pixels[u+_*this.width2d]=m}}class I0 extends V0{pixels;width2d;height2d;cropX;cropY;cropW;cropH;rgbPal;constructor(u,_,m){super();this.pixels=new Int8Array(u*_),this.width2d=this.cropW=u,this.height2d=this.cropH=_,this.cropX=this.cropY=0,this.rgbPal=m}static fromArchive(u,_,m=0){let R=new W(u.read(_+".dat")),b=new W(u.read("index.dat"));b.pos=R.g2();let E=b.g2(),O=b.g2(),L=b.g1(),I=new Int32Array(L);for(let J=1;J<L;J++)if(I[J]=b.g3(),I[J]===0)I[J]=1;for(let J=0;J<m;J++)b.pos+=2,R.pos+=b.g2()*b.g2(),b.pos+=1;if(R.pos>R.length||b.pos>b.length)throw Error();let N=b.g1(),H=b.g1(),G=b.g2(),T=b.g2(),q=new I0(G,T,I);q.cropX=N,q.cropY=H,q.cropW=E,q.cropH=O;let Q=q.pixels,n=b.g1();if(n===0){let J=q.width2d*q.height2d;for(let U=0;U<J;U++)Q[U]=R.g1b()}else if(n===1){let{width2d:J,height2d:U}=q;for(let w=0;w<J;w++)for(let k=0;k<U;k++)Q[w+k*J]=R.g1b()}return q}draw(u,_){u|=0,_|=0,u+=this.cropX,_+=this.cropY;let m=u+_*K.width2d,R=0,b=this.height2d,E=this.width2d,O=K.width2d-E,L=0;if(_<K.top){let I=K.top-_;b-=I,_=K.top,R+=I*E,m+=I*K.width2d}if(_+b>K.bottom)b-=_+b-K.bottom;if(u<K.left){let I=K.left-u;E-=I,u=K.left,R+=I,m+=I,L+=I,O+=I}if(u+E>K.right){let I=u+E-K.right;E-=I,L+=I,O+=I}if(E>0&&b>0)this.copyImage(E,b,this.pixels,R,L,K.pixels,m,O)}flipHorizontally(){let u=this.pixels,_=this.width2d,m=this.height2d;for(let R=0;R<m;R++){let b=_/2|0;for(let E=0;E<b;E++){let O=E+R*_,L=_-E-1+R*_,I=u[O];u[O]=u[L],u[L]=I}}}flipVertically(){let u=this.pixels,_=this.width2d,m=this.height2d;for(let R=0;R<(m/2|0);R++)for(let b=0;b<_;b++){let E=b+R*_,O=b+(m-R-1)*_,L=u[E];u[E]=u[O],u[O]=L}}translate2d(u,_,m){for(let R=0;R<this.rgbPal.length;R++){let b=this.rgbPal[R]>>16&255;if(b+=u,b<0)b=0;else if(b>255)b=255;let E=this.rgbPal[R]>>8&255;if(E+=_,E<0)E=0;else if(E>255)E=255;let O=this.rgbPal[R]&255;if(O+=m,O<0)O=0;else if(O>255)O=255;this.rgbPal[R]=(b<<16)+(E<<8)+O}}shrink(){this.cropW|=0,this.cropH|=0,this.cropW/=2,this.cropH/=2,this.cropW|=0,this.cropH|=0;let u=new Int8Array(this.cropW*this.cropH),_=0;for(let m=0;m<this.height2d;m++)for(let R=0;R<this.width2d;R++)u[(R+this.cropX>>1)+(m+this.cropY>>1)*this.cropW]=this.pixels[_++];this.pixels=u,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}crop(){if(this.width2d===this.cropW&&this.height2d===this.cropH)return;let u=new Int8Array(this.cropW*this.cropH),_=0;for(let m=0;m<this.height2d;m++)for(let R=0;R<this.width2d;R++)u[R+this.cropX+(m+this.cropY)*this.cropW]=this.pixels[_++];this.pixels=u,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}copyImage(u,_,m,R,b,E,O,L){let I=-(u>>2);u=-(u&3);for(let N=-_;N<0;N++){for(let H=I;H<0;H++){let G=m[R++];if(G===0)O++;else E[O++]=this.rgbPal[G&255];if(G=m[R++],G===0)O++;else E[O++]=this.rgbPal[G&255];if(G=m[R++],G===0)O++;else E[O++]=this.rgbPal[G&255];if(G=m[R++],G===0)O++;else E[O++]=this.rgbPal[G&255]}for(let H=u;H<0;H++){let G=m[R++];if(G===0)O++;else E[O++]=this.rgbPal[G&255]}O+=L,R+=b}}clip(u,_,m,R){try{let b=this.width2d,E=this.height2d,O=0,L=0,I=(b<<16)/m|0,N=(E<<16)/R|0,H=this.cropW,G=this.cropH,T=(H<<16)/m|0,q=(G<<16)/R|0;if(u=u+(this.cropX*m+H-1)/H|0,_=_+(this.cropY*R+G-1)/G|0,this.cropX*m%H!=0)O=(H-this.cropX*m%H<<16)/m|0;if(this.cropY*R%G!=0)L=(G-this.cropY*R%G<<16)/R|0;m=m*(this.width2d-(O>>16))/H|0,R=R*(this.height2d-(L>>16))/G|0;let Q=u+_*K.width2d,n=K.width2d-m,J;if(_<K.top)J=K.top-_,R-=J,_=0,Q+=J*K.width2d,L+=q*J;if(_+R>K.bottom)R-=_+R-K.bottom;if(u<K.left)J=K.left-u,m-=J,u=0,Q+=J,O+=T*J,n+=J;if(u+m>K.right)J=u+m-K.right,m-=J,n+=J;this.plot_scale(K.pixels,this.pixels,this.rgbPal,O,L,Q,n,m,R,T,q,b)}catch(b){}}plot_scale(u,_,m,R,b,E,O,L,I,N,H,G){try{let T=R;for(let q=-I;q<0;q++){let Q=(b>>16)*G;for(let n=-L;n<0;n++){let J=_[(R>>16)+Q];if(J==0)E++;else u[E++]=m[J&255];R+=N}b+=H,R=T,E+=O}}catch(T){}}}class r extends Array{constructor(u,_){super(u);for(let m=0;m<u;m++)this[m]=_}}class wu extends Array{constructor(u,_,m){super(u);for(let R=0;R<u;R++){this[R]=Array(_);for(let b=0;b<_;b++)this[R][b]=m}}}class c0 extends Array{constructor(u,_,m,R){super(u);for(let b=0;b<u;b++){this[b]=Array(_);for(let E=0;E<_;E++){this[b][E]=Array(m);for(let O=0;O<m;O++)this[b][E][O]=R}}}}class _u extends Array{constructor(u,_,m,R,b){super(u);for(let E=0;E<u;E++){this[E]=Array(_);for(let O=0;O<_;O++){this[E][O]=Array(m);for(let L=0;L<m;L++){this[E][O][L]=Array(R);for(let I=0;I<R;I++)this[E][O][L][I]=b}}}}}class B0 extends Array{constructor(u,_,m){super(u);for(let R=0;R<u;R++){this[R]=Array(_);for(let b=0;b<_;b++)this[R][b]=new Uint8Array(m)}}}class X0 extends Array{constructor(u,_){super(u);for(let m=0;m<u;m++)this[m]=new Int32Array(_)}}class g0 extends Array{constructor(u,_,m){super(u);for(let R=0;R<u;R++){this[R]=Array(_);for(let b=0;b<_;b++)this[R][b]=new Int32Array(m)}}}class h extends K{static lowMemory=!1;static divTable=new Int32Array(512);static divTable2=new Int32Array(2048);static sinTable=new Int32Array(2048);static cosTable=new Int32Array(2048);static colourTable=new Int32Array(65536);static textures=new r(50,null);static textureCount=0;static lineOffset=new Int32Array;static centerX=0;static centerY=0;static jagged=!0;static clipX=!1;static alpha=0;static texelPool=null;static activeTexels=new r(50,null);static poolSize=0;static cycle=0;static textureCycle=new Int32Array(50);static texPal=new r(50,null);static opaque=!1;static textureTranslucent=new r(50,!1);static averageTextureRgb=new Int32Array(50);static{for(let u=1;u<512;u++)this.divTable[u]=32768/u|0;for(let u=1;u<2048;u++)this.divTable2[u]=65536/u|0;for(let u=0;u<2048;u++)this.sinTable[u]=Math.sin(u*0.0030679615757712823)*65536|0,this.cosTable[u]=Math.cos(u*0.0030679615757712823)*65536|0}static init2D(){this.lineOffset=new Int32Array(K.height2d);for(let u=0;u<K.height2d;u++)this.lineOffset[u]=K.width2d*u;this.centerX=K.width2d/2|0,this.centerY=K.height2d/2|0}static init3D(u,_){this.lineOffset=new Int32Array(_);for(let m=0;m<_;m++)this.lineOffset[m]=u*m;this.centerX=u/2|0,this.centerY=_/2|0}static clearTexels(){this.texelPool=null,this.activeTexels.fill(null)}static unpackTextures(u){this.textureCount=0;for(let _=0;_<50;_++)try{if(this.textures[_]=I0.fromArchive(u,_.toString()),this.lowMemory&&this.textures[_]?.cropW===128)this.textures[_]?.shrink();else this.textures[_]?.crop();this.textureCount++}catch(m){}}static getAverageTextureRgb(u){if(this.averageTextureRgb[u]!==0)return this.averageTextureRgb[u];let _=this.texPal[u];if(!_)return 0;let m=0,R=0,b=0,E=_.length;for(let L=0;L<E;L++)m+=_[L]>>16&255,R+=_[L]>>8&255,b+=_[L]&255;let O=((m/E|0)<<16)+((R/E|0)<<8)+(b/E|0);if(O=this.gammaCorrect(O,1.4),O===0)O=1;return this.averageTextureRgb[u]=O,O}static initColourTable(u){let _=u+Math.random()*0.03-0.015,m=0;for(let R=0;R<512;R++){let b=(R/8|0)/64+0.0078125,E=(R&7)/8+0.0625;for(let O=0;O<128;O++){let L=O/128,I=L,N=L,H=L;if(E!==0){let n;if(L<0.5)n=L*(E+1);else n=L+E-L*E;let J=L*2-n,U=b+0.3333333333333333;if(U>1)U--;let w=b-0.3333333333333333;if(w<0)w++;if(U*6<1)I=J+(n-J)*6*U;else if(U*2<1)I=n;else if(U*3<2)I=J+(n-J)*(0.6666666666666666-U)*6;else I=J;if(b*6<1)N=J+(n-J)*6*b;else if(b*2<1)N=n;else if(b*3<2)N=J+(n-J)*(0.6666666666666666-b)*6;else N=J;if(w*6<1)H=J+(n-J)*6*w;else if(w*2<1)H=n;else if(w*3<2)H=J+(n-J)*(0.6666666666666666-w)*6;else H=J}let G=I*256|0,T=N*256|0,q=H*256|0,Q=(G<<16)+(T<<8)+q;this.colourTable[m++]=this.gammaCorrect(Q,_)}}for(let R=0;R<50;R++){let b=this.textures[R];if(!b)continue;let E=b.rgbPal;this.texPal[R]=new Int32Array(E.length);for(let O=0;O<E.length;O++){let L=this.texPal[R];if(!L)continue;L[O]=this.gammaCorrect(E[O],_)}}for(let R=0;R<50;R++)this.pushTexture(R)}static gammaCorrect(u,_){let m=(u>>16)/256,R=(u>>8&255)/256,b=(u&255)/256,E=Math.pow(m,_),O=Math.pow(R,_),L=Math.pow(b,_),I=E*256|0,N=O*256|0,H=L*256|0;return(I<<16)+(N<<8)+H}static initPool(u){if(this.texelPool)return;if(this.poolSize=u,this.lowMemory)this.texelPool=new X0(u,16384);else this.texelPool=new X0(u,65536);this.activeTexels.fill(null)}static pushTexture(u){if(this.activeTexels[u]&&this.texelPool)this.texelPool[this.poolSize++]=this.activeTexels[u],this.activeTexels[u]=null}static getTexels(u){if(this.textureCycle[u]=this.cycle++,this.activeTexels[u])return this.activeTexels[u];let _;if(this.poolSize>0&&this.texelPool)_=this.texelPool[--this.poolSize],this.texelPool[this.poolSize]=null;else{let b=0,E=-1;for(let O=0;O<this.textureCount;O++)if(this.activeTexels[O]&&(this.textureCycle[O]<b||E===-1))b=this.textureCycle[O],E=O;_=this.activeTexels[E],this.activeTexels[E]=null}this.activeTexels[u]=_;let m=this.textures[u],R=this.texPal[u];if(!_||!m||!R)return null;if(this.lowMemory){this.textureTranslucent[u]=!1;for(let b=0;b<4096;b++){let E=_[b]=R[m.pixels[b]]&16316671;if(E===0)this.textureTranslucent[u]=!0;_[b+4096]=E-(E>>>3)&16316671,_[b+8192]=E-(E>>>2)&16316671,_[b+12288]=E-(E>>>2)-(E>>>3)&16316671}}else{if(m.width2d===64)for(let b=0;b<128;b++)for(let E=0;E<128;E++)_[E+(b<<7|0)]=R[m.pixels[(E>>1)+(b>>1<<6|0)]];else for(let b=0;b<16384;b++)_[b]=R[m.pixels[b]];this.textureTranslucent[u]=!1;for(let b=0;b<16384;b++){_[b]&=16316671;let E=_[b];if(E===0)this.textureTranslucent[u]=!0;_[b+16384]=E-(E>>>3)&16316671,_[b+32768]=E-(E>>>2)&16316671,_[b+49152]=E-(E>>>2)-(E>>>3)&16316671}}return _}static gouraudTriangle(u,_,m,R,b,E,O,L,I){let N=0,H=0;if(b!==R)N=(_-u<<16)/(b-R)|0,H=(L-O<<15)/(b-R)|0;let G=0,T=0;if(E!==b)G=(m-_<<16)/(E-b)|0,T=(I-L<<15)/(E-b)|0;let q=0,Q=0;if(E!==R)q=(u-m<<16)/(R-E)|0,Q=(O-I<<15)/(R-E)|0;if(R<=b&&R<=E){if(R<K.bottom){if(b>K.bottom)b=K.bottom;if(E>K.bottom)E=K.bottom;if(b<E){if(m=u<<=16,I=O<<=15,R<0)m-=q*R,u-=N*R,I-=Q*R,O-=H*R,R=0;if(_<<=16,L<<=15,b<0)_-=G*b,L-=T*b,b=0;if(R!==b&&q<N||R===b&&q>G){E-=b,b-=R,R=h.lineOffset[R];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.gouraudRaster(m>>16,_>>16,I>>7,L>>7,K.pixels,R,0),m+=q,_+=G,I+=Q,L+=T,R+=K.width2d}this.gouraudRaster(m>>16,u>>16,I>>7,O>>7,K.pixels,R,0),m+=q,u+=N,I+=Q,O+=H,R+=K.width2d}}else{E-=b,b-=R,R=h.lineOffset[R];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.gouraudRaster(_>>16,m>>16,L>>7,I>>7,K.pixels,R,0),m+=q,_+=G,I+=Q,L+=T,R+=K.width2d}this.gouraudRaster(u>>16,m>>16,O>>7,I>>7,K.pixels,R,0),m+=q,u+=N,I+=Q,O+=H,R+=K.width2d}}}else{if(_=u<<=16,L=O<<=15,R<0)_-=q*R,u-=N*R,L-=Q*R,O-=H*R,R=0;if(m<<=16,I<<=15,E<0)m-=G*E,I-=T*E,E=0;if(R!==E&&q<N||R===E&&G>N){b-=E,E-=R,R=h.lineOffset[R];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.gouraudRaster(m>>16,u>>16,I>>7,O>>7,K.pixels,R,0),m+=G,u+=N,I+=T,O+=H,R+=K.width2d}this.gouraudRaster(_>>16,u>>16,L>>7,O>>7,K.pixels,R,0),_+=q,u+=N,L+=Q,O+=H,R+=K.width2d}}else{b-=E,E-=R,R=h.lineOffset[R];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.gouraudRaster(u>>16,m>>16,O>>7,I>>7,K.pixels,R,0),m+=G,u+=N,I+=T,O+=H,R+=K.width2d}this.gouraudRaster(u>>16,_>>16,O>>7,L>>7,K.pixels,R,0),_+=q,u+=N,L+=Q,O+=H,R+=K.width2d}}}}}else if(b<=E){if(b<K.bottom){if(E>K.bottom)E=K.bottom;if(R>K.bottom)R=K.bottom;if(E<R){if(u=_<<=16,O=L<<=15,b<0)u-=N*b,_-=G*b,O-=H*b,L-=T*b,b=0;if(m<<=16,I<<=15,E<0)m-=q*E,I-=Q*E,E=0;if(b!==E&&N<G||b===E&&N>q){R-=E,E-=b,b=h.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(R--,R<0)return;this.gouraudRaster(u>>16,m>>16,O>>7,I>>7,K.pixels,b,0),u+=N,m+=q,O+=H,I+=Q,b+=K.width2d}this.gouraudRaster(u>>16,_>>16,O>>7,L>>7,K.pixels,b,0),u+=N,_+=G,O+=H,L+=T,b+=K.width2d}}else{R-=E,E-=b,b=h.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(R--,R<0)return;this.gouraudRaster(m>>16,u>>16,I>>7,O>>7,K.pixels,b,0),u+=N,m+=q,O+=H,I+=Q,b+=K.width2d}this.gouraudRaster(_>>16,u>>16,L>>7,O>>7,K.pixels,b,0),u+=N,_+=G,O+=H,L+=T,b+=K.width2d}}}else{if(m=_<<=16,I=L<<=15,b<0)m-=N*b,_-=G*b,I-=H*b,L-=T*b,b=0;if(u<<=16,O<<=15,R<0)u-=q*R,O-=Q*R,R=0;if(E-=R,R-=b,b=h.lineOffset[b],N<G)while(!0){if(R--,R<0)while(!0){if(E--,E<0)return;this.gouraudRaster(u>>16,_>>16,O>>7,L>>7,K.pixels,b,0),u+=q,_+=G,O+=Q,L+=T,b+=K.width2d}this.gouraudRaster(m>>16,_>>16,I>>7,L>>7,K.pixels,b,0),m+=N,_+=G,I+=H,L+=T,b+=K.width2d}else while(!0){if(R--,R<0)while(!0){if(E--,E<0)return;this.gouraudRaster(_>>16,u>>16,L>>7,O>>7,K.pixels,b,0),u+=q,_+=G,O+=Q,L+=T,b+=K.width2d}this.gouraudRaster(_>>16,m>>16,L>>7,I>>7,K.pixels,b,0),m+=N,_+=G,I+=H,L+=T,b+=K.width2d}}}}else if(E<K.bottom){if(R>K.bottom)R=K.bottom;if(b>K.bottom)b=K.bottom;if(R<b){if(_=m<<=16,L=I<<=15,E<0)_-=G*E,m-=q*E,L-=T*E,I-=Q*E,E=0;if(u<<=16,O<<=15,R<0)u-=N*R,O-=H*R,R=0;if(b-=R,R-=E,E=h.lineOffset[E],G<q)while(!0){if(R--,R<0)while(!0){if(b--,b<0)return;this.gouraudRaster(_>>16,u>>16,L>>7,O>>7,K.pixels,E,0),_+=G,u+=N,L+=T,O+=H,E+=K.width2d}this.gouraudRaster(_>>16,m>>16,L>>7,I>>7,K.pixels,E,0),_+=G,m+=q,L+=T,I+=Q,E+=K.width2d}else while(!0){if(R--,R<0)while(!0){if(b--,b<0)return;this.gouraudRaster(u>>16,_>>16,O>>7,L>>7,K.pixels,E,0),_+=G,u+=N,L+=T,O+=H,E+=K.width2d}this.gouraudRaster(m>>16,_>>16,I>>7,L>>7,K.pixels,E,0),_+=G,m+=q,L+=T,I+=Q,E+=K.width2d}}else{if(u=m<<=16,O=I<<=15,E<0)u-=G*E,m-=q*E,O-=T*E,I-=Q*E,E=0;if(_<<=16,L<<=15,b<0)_-=N*b,L-=H*b,b=0;if(R-=b,b-=E,E=h.lineOffset[E],G<q)while(!0){if(b--,b<0)while(!0){if(R--,R<0)return;this.gouraudRaster(_>>16,m>>16,L>>7,I>>7,K.pixels,E,0),_+=N,m+=q,L+=H,I+=Q,E+=K.width2d}this.gouraudRaster(u>>16,m>>16,O>>7,I>>7,K.pixels,E,0),u+=G,m+=q,O+=T,I+=Q,E+=K.width2d}else while(!0){if(b--,b<0)while(!0){if(R--,R<0)return;this.gouraudRaster(m>>16,_>>16,I>>7,L>>7,K.pixels,E,0),_+=N,m+=q,L+=H,I+=Q,E+=K.width2d}this.gouraudRaster(m>>16,u>>16,I>>7,O>>7,K.pixels,E,0),u+=G,m+=q,O+=T,I+=Q,E+=K.width2d}}}}static gouraudRaster(u,_,m,R,b,E,O){let L;if(h.jagged){let I;if(h.clipX){if(_-u>3)I=(R-m)/(_-u)|0;else I=0;if(_>K.boundX)_=K.boundX;if(u<0)m-=u*I,u=0;if(u>=_)return;E+=u,O=_-u>>2,I<<=2}else if(u<_)if(E+=u,O=_-u>>2,O>0)I=(R-m)*h.divTable[O]>>15;else I=0;else return;if(h.alpha===0)while(!0){if(O--,O<0){if(O=_-u&3,O>0){L=h.colourTable[m>>8];do b[E++]=L,O--;while(O>0);return}break}L=h.colourTable[m>>8],m+=I,b[E++]=L,b[E++]=L,b[E++]=L,b[E++]=L}else{let N=h.alpha,H=256-h.alpha;while(!0){if(O--,O<0){if(O=_-u&3,O>0){L=h.colourTable[m>>8],L=((L&16711935)*H>>8&16711935)+((L&65280)*H>>8&65280);do b[E++]=L+((b[E]&16711935)*N>>8&16711935)+((b[E]&65280)*N>>8&65280),O--;while(O>0)}break}L=h.colourTable[m>>8],m+=I,L=((L&16711935)*H>>8&16711935)+((L&65280)*H>>8&65280),b[E++]=L+((b[E]&16711935)*N>>8&16711935)+((b[E]&65280)*N>>8&65280),b[E++]=L+((b[E]&16711935)*N>>8&16711935)+((b[E]&65280)*N>>8&65280),b[E++]=L+((b[E]&16711935)*N>>8&16711935)+((b[E]&65280)*N>>8&65280),b[E++]=L+((b[E]&16711935)*N>>8&16711935)+((b[E]&65280)*N>>8&65280)}}}else if(u<_){let I=(R-m)/(_-u)|0;if(h.clipX){if(_>K.boundX)_=K.boundX;if(u<0)m-=u*I,u=0;if(u>=_)return}if(E+=u,O=_-u,h.alpha===0)do b[E++]=h.colourTable[m>>8],m+=I,O--;while(O>0);else{let N=h.alpha,H=256-h.alpha;do L=h.colourTable[m>>8],m+=I,L=((L&16711935)*H>>8&16711935)+((L&65280)*H>>8&65280),b[E++]=L+((b[E]&16711935)*N>>8&16711935)+((b[E]&65280)*N>>8&65280),O--;while(O>0)}}}static flatTriangle(u,_,m,R,b,E,O){let L=0;if(b!==R)L=(_-u<<16)/(b-R)|0;let I=0;if(E!==b)I=(m-_<<16)/(E-b)|0;let N=0;if(E!==R)N=(u-m<<16)/(R-E)|0;if(R<=b&&R<=E){if(R<K.bottom){if(b>K.bottom)b=K.bottom;if(E>K.bottom)E=K.bottom;if(b<E){if(m=u<<=16,R<0)m-=N*R,u-=L*R,R=0;if(_<<=16,b<0)_-=I*b,b=0;if(R!==b&&N<L||R===b&&N>I){E-=b,b-=R,R=this.lineOffset[R];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.flatRaster(m>>16,_>>16,K.pixels,R,O),m+=N,_+=I,R+=K.width2d}this.flatRaster(m>>16,u>>16,K.pixels,R,O),m+=N,u+=L,R+=K.width2d}}else{E-=b,b-=R,R=this.lineOffset[R];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.flatRaster(_>>16,m>>16,K.pixels,R,O),m+=N,_+=I,R+=K.width2d}this.flatRaster(u>>16,m>>16,K.pixels,R,O),m+=N,u+=L,R+=K.width2d}}}else{if(_=u<<=16,R<0)_-=N*R,u-=L*R,R=0;if(m<<=16,E<0)m-=I*E,E=0;if(R!==E&&N<L||R===E&&I>L){b-=E,E-=R,R=this.lineOffset[R];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.flatRaster(m>>16,u>>16,K.pixels,R,O),m+=I,u+=L,R+=K.width2d}this.flatRaster(_>>16,u>>16,K.pixels,R,O),_+=N,u+=L,R+=K.width2d}}else{b-=E,E-=R,R=this.lineOffset[R];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.flatRaster(u>>16,m>>16,K.pixels,R,O),m+=I,u+=L,R+=K.width2d}this.flatRaster(u>>16,_>>16,K.pixels,R,O),_+=N,u+=L,R+=K.width2d}}}}}else if(b<=E){if(b<K.bottom){if(E>K.bottom)E=K.bottom;if(R>K.bottom)R=K.bottom;if(E<R){if(u=_<<=16,b<0)u-=L*b,_-=I*b,b=0;if(m<<=16,E<0)m-=N*E,E=0;if(b!==E&&L<I||b===E&&L>N){R-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(R--,R<0)return;this.flatRaster(u>>16,m>>16,K.pixels,b,O),u+=L,m+=N,b+=K.width2d}this.flatRaster(u>>16,_>>16,K.pixels,b,O),u+=L,_+=I,b+=K.width2d}}else{R-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(R--,R<0)return;this.flatRaster(m>>16,u>>16,K.pixels,b,O),u+=L,m+=N,b+=K.width2d}this.flatRaster(_>>16,u>>16,K.pixels,b,O),u+=L,_+=I,b+=K.width2d}}}else{if(m=_<<=16,b<0)m-=L*b,_-=I*b,b=0;if(u<<=16,R<0)u-=N*R,R=0;if(L<I){E-=R,R-=b,b=this.lineOffset[b];while(!0){if(R--,R<0)while(!0){if(E--,E<0)return;this.flatRaster(u>>16,_>>16,K.pixels,b,O),u+=N,_+=I,b+=K.width2d}this.flatRaster(m>>16,_>>16,K.pixels,b,O),m+=L,_+=I,b+=K.width2d}}else{E-=R,R-=b,b=this.lineOffset[b];while(!0){if(R--,R<0)while(!0){if(E--,E<0)return;this.flatRaster(_>>16,u>>16,K.pixels,b,O),u+=N,_+=I,b+=K.width2d}this.flatRaster(_>>16,m>>16,K.pixels,b,O),m+=L,_+=I,b+=K.width2d}}}}}else if(E<K.bottom){if(R>K.bottom)R=K.bottom;if(b>K.bottom)b=K.bottom;if(R<b){if(_=m<<=16,E<0)_-=I*E,m-=N*E,E=0;if(u<<=16,R<0)u-=L*R,R=0;if(I<N){b-=R,R-=E,E=this.lineOffset[E];while(!0){if(R--,R<0)while(!0){if(b--,b<0)return;this.flatRaster(_>>16,u>>16,K.pixels,E,O),_+=I,u+=L,E+=K.width2d}this.flatRaster(_>>16,m>>16,K.pixels,E,O),_+=I,m+=N,E+=K.width2d}}else{b-=R,R-=E,E=this.lineOffset[E];while(!0){if(R--,R<0)while(!0){if(b--,b<0)return;this.flatRaster(u>>16,_>>16,K.pixels,E,O),_+=I,u+=L,E+=K.width2d}this.flatRaster(m>>16,_>>16,K.pixels,E,O),_+=I,m+=N,E+=K.width2d}}}else{if(u=m<<=16,E<0)u-=I*E,m-=N*E,E=0;if(_<<=16,b<0)_-=L*b,b=0;if(I<N){R-=b,b-=E,E=this.lineOffset[E];while(!0){if(b--,b<0)while(!0){if(R--,R<0)return;this.flatRaster(_>>16,m>>16,K.pixels,E,O),_+=L,m+=N,E+=K.width2d}this.flatRaster(u>>16,m>>16,K.pixels,E,O),u+=I,m+=N,E+=K.width2d}}else{R-=b,b-=E,E=this.lineOffset[E];while(!0){if(b--,b<0)while(!0){if(R--,R<0)return;this.flatRaster(m>>16,_>>16,K.pixels,E,O),_+=L,m+=N,E+=K.width2d}this.flatRaster(m>>16,u>>16,K.pixels,E,O),u+=I,m+=N,E+=K.width2d}}}}}static flatRaster(u,_,m,R,b){if(this.clipX){if(_>K.boundX)_=K.boundX;if(u<0)u=0}if(u>=_)return;R+=u;let E=_-u>>2;if(this.alpha===0)while(!0){if(E--,E<0){E=_-u&3;while(!0){if(E--,E<0)return;m[R++]=b}}m[R++]=b,m[R++]=b,m[R++]=b,m[R++]=b}let O=this.alpha,L=256-this.alpha;b=((b&16711935)*L>>8&16711935)+((b&65280)*L>>8&65280);while(!0){if(E--,E<0){E=_-u&3;while(!0){if(E--,E<0)return;m[R++]=b+((m[R]&16711935)*O>>8&16711935)+((m[R]&65280)*O>>8&65280)}}m[R++]=b+((m[R]&16711935)*O>>8&16711935)+((m[R]&65280)*O>>8&65280),m[R++]=b+((m[R]&16711935)*O>>8&16711935)+((m[R]&65280)*O>>8&65280),m[R++]=b+((m[R]&16711935)*O>>8&16711935)+((m[R]&65280)*O>>8&65280),m[R++]=b+((m[R]&16711935)*O>>8&16711935)+((m[R]&65280)*O>>8&65280)}}static textureTriangle(u,_,m,R,b,E,O,L,I,N,H,G,T,q,Q,n,J,U,w){let k=this.getTexels(w);this.opaque=!this.textureTranslucent[w];let V=N-T,j=H-Q,X=G-J,A=q-N,Z=n-H,D=U-G,Y=A*H-Z*N<<14,S=Z*G-D*H<<8,s=D*N-A*G<<5,f=V*H-j*N<<14,z=j*G-X*H<<8,p=X*N-V*G<<5,B=j*A-V*Z<<14,a=X*Z-j*D<<8,y=V*D-X*A<<5,x=0,L0=0;if(b!==R)x=(_-u<<16)/(b-R)|0,L0=(L-O<<16)/(b-R)|0;let _0=0,G0=0;if(E!==b)_0=(m-_<<16)/(E-b)|0,G0=(I-L<<16)/(E-b)|0;let H0=0,Q0=0;if(E!==R)H0=(u-m<<16)/(R-E)|0,Q0=(O-I<<16)/(R-E)|0;if(R<=b&&R<=E){if(R<K.bottom){if(b>K.bottom)b=K.bottom;if(E>K.bottom)E=K.bottom;if(b<E){if(m=u<<=16,I=O<<=16,R<0)m-=H0*R,u-=x*R,I-=Q0*R,O-=L0*R,R=0;if(_<<=16,L<<=16,b<0)_-=_0*b,L-=G0*b,b=0;let q0=R-this.centerY;if(Y+=s*q0,f+=p*q0,B+=y*q0,Y|=0,f|=0,B|=0,R!==b&&H0<x||R===b&&H0>_0){E-=b,b-=R,R=this.lineOffset[R];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.textureRaster(m>>16,_>>16,K.pixels,R,k,0,0,Y,f,B,S,z,a,I>>8,L>>8),m+=H0,_+=_0,I+=Q0,L+=G0,R+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(m>>16,u>>16,K.pixels,R,k,0,0,Y,f,B,S,z,a,I>>8,O>>8),m+=H0,u+=x,I+=Q0,O+=L0,R+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}}else{E-=b,b-=R,R=this.lineOffset[R];while(!0){if(b--,b<0)while(!0){if(E--,E<0)return;this.textureRaster(_>>16,m>>16,K.pixels,R,k,0,0,Y,f,B,S,z,a,L>>8,I>>8),m+=H0,_+=_0,I+=Q0,L+=G0,R+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(u>>16,m>>16,K.pixels,R,k,0,0,Y,f,B,S,z,a,O>>8,I>>8),m+=H0,u+=x,I+=Q0,O+=L0,R+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}}}else{if(_=u<<=16,L=O<<=16,R<0)_-=H0*R,u-=x*R,L-=Q0*R,O-=L0*R,R=0;if(m<<=16,I<<=16,E<0)m-=_0*E,I-=G0*E,E=0;let q0=R-this.centerY;if(Y+=s*q0,f+=p*q0,B+=y*q0,Y|=0,f|=0,B|=0,(R===E||H0>=x)&&(R!==E||_0<=x)){b-=E,E-=R,R=this.lineOffset[R];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.textureRaster(u>>16,m>>16,K.pixels,R,k,0,0,Y,f,B,S,z,a,O>>8,I>>8),m+=_0,u+=x,I+=G0,O+=L0,R+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(u>>16,_>>16,K.pixels,R,k,0,0,Y,f,B,S,z,a,O>>8,L>>8),_+=H0,u+=x,L+=Q0,O+=L0,R+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}}else{b-=E,E-=R,R=this.lineOffset[R];while(!0){if(E--,E<0)while(!0){if(b--,b<0)return;this.textureRaster(m>>16,u>>16,K.pixels,R,k,0,0,Y,f,B,S,z,a,I>>8,O>>8),m+=_0,u+=x,I+=G0,O+=L0,R+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(_>>16,u>>16,K.pixels,R,k,0,0,Y,f,B,S,z,a,L>>8,O>>8),_+=H0,u+=x,L+=Q0,O+=L0,R+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}}}}}else if(b<=E){if(b<K.bottom){if(E>K.bottom)E=K.bottom;if(R>K.bottom)R=K.bottom;if(E<R){if(u=_<<=16,O=L<<=16,b<0)u-=x*b,_-=_0*b,O-=L0*b,L-=G0*b,b=0;if(m<<=16,I<<=16,E<0)m-=H0*E,I-=Q0*E,E=0;let q0=b-this.centerY;if(Y+=s*q0,f+=p*q0,B+=y*q0,Y|=0,f|=0,B|=0,b!==E&&x<_0||b===E&&x>H0){R-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(R--,R<0)return;this.textureRaster(u>>16,m>>16,K.pixels,b,k,0,0,Y,f,B,S,z,a,O>>8,I>>8),u+=x,m+=H0,O+=L0,I+=Q0,b+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(u>>16,_>>16,K.pixels,b,k,0,0,Y,f,B,S,z,a,O>>8,L>>8),u+=x,_+=_0,O+=L0,L+=G0,b+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}}else{R-=E,E-=b,b=this.lineOffset[b];while(!0){if(E--,E<0)while(!0){if(R--,R<0)return;this.textureRaster(m>>16,u>>16,K.pixels,b,k,0,0,Y,f,B,S,z,a,I>>8,O>>8),u+=x,m+=H0,O+=L0,I+=Q0,b+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(_>>16,u>>16,K.pixels,b,k,0,0,Y,f,B,S,z,a,L>>8,O>>8),u+=x,_+=_0,O+=L0,L+=G0,b+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}}}else{if(m=_<<=16,I=L<<=16,b<0)m-=x*b,_-=_0*b,I-=L0*b,L-=G0*b,b=0;if(u<<=16,O<<=16,R<0)u-=H0*R,O-=Q0*R,R=0;let q0=b-this.centerY;if(Y+=s*q0,f+=p*q0,B+=y*q0,Y|=0,f|=0,B|=0,E-=R,R-=b,b=this.lineOffset[b],x<_0)while(!0){if(R--,R<0)while(!0){if(E--,E<0)return;this.textureRaster(u>>16,_>>16,K.pixels,b,k,0,0,Y,f,B,S,z,a,O>>8,L>>8),u+=H0,_+=_0,O+=Q0,L+=G0,b+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(m>>16,_>>16,K.pixels,b,k,0,0,Y,f,B,S,z,a,I>>8,L>>8),m+=x,_+=_0,I+=L0,L+=G0,b+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}else while(!0){if(R--,R<0)while(!0){if(E--,E<0)return;this.textureRaster(_>>16,u>>16,K.pixels,b,k,0,0,Y,f,B,S,z,a,L>>8,O>>8),u+=H0,_+=_0,O+=Q0,L+=G0,b+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(_>>16,m>>16,K.pixels,b,k,0,0,Y,f,B,S,z,a,L>>8,I>>8),m+=x,_+=_0,I+=L0,L+=G0,b+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}}}}else if(E<K.bottom){if(R>K.bottom)R=K.bottom;if(b>K.bottom)b=K.bottom;if(R<b){if(_=m<<=16,L=I<<=16,E<0)_-=_0*E,m-=H0*E,L-=G0*E,I-=Q0*E,E=0;if(u<<=16,O<<=16,R<0)u-=x*R,O-=L0*R,R=0;let q0=E-this.centerY;if(Y+=s*q0,f+=p*q0,B+=y*q0,Y|=0,f|=0,B|=0,b-=R,R-=E,E=this.lineOffset[E],_0<H0)while(!0){if(R--,R<0)while(!0){if(b--,b<0)return;this.textureRaster(_>>16,u>>16,K.pixels,E,k,0,0,Y,f,B,S,z,a,L>>8,O>>8),_+=_0,u+=x,L+=G0,O+=L0,E+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(_>>16,m>>16,K.pixels,E,k,0,0,Y,f,B,S,z,a,L>>8,I>>8),_+=_0,m+=H0,L+=G0,I+=Q0,E+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}else while(!0){if(R--,R<0)while(!0){if(b--,b<0)return;this.textureRaster(u>>16,_>>16,K.pixels,E,k,0,0,Y,f,B,S,z,a,O>>8,L>>8),_+=_0,u+=x,L+=G0,O+=L0,E+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(m>>16,_>>16,K.pixels,E,k,0,0,Y,f,B,S,z,a,I>>8,L>>8),_+=_0,m+=H0,L+=G0,I+=Q0,E+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}}else{if(u=m<<=16,O=I<<=16,E<0)u-=_0*E,m-=H0*E,O-=G0*E,I-=Q0*E,E=0;if(_<<=16,L<<=16,b<0)_-=x*b,L-=L0*b,b=0;let q0=E-this.centerY;if(Y+=s*q0,f+=p*q0,B+=y*q0,Y|=0,f|=0,B|=0,R-=b,b-=E,E=this.lineOffset[E],_0<H0)while(!0){if(b--,b<0)while(!0){if(R--,R<0)return;this.textureRaster(_>>16,m>>16,K.pixels,E,k,0,0,Y,f,B,S,z,a,L>>8,I>>8),_+=x,m+=H0,L+=L0,I+=Q0,E+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(u>>16,m>>16,K.pixels,E,k,0,0,Y,f,B,S,z,a,O>>8,I>>8),u+=_0,m+=H0,O+=G0,I+=Q0,E+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}else while(!0){if(b--,b<0)while(!0){if(R--,R<0)return;this.textureRaster(m>>16,_>>16,K.pixels,E,k,0,0,Y,f,B,S,z,a,I>>8,L>>8),_+=x,m+=H0,L+=L0,I+=Q0,E+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}this.textureRaster(m>>16,u>>16,K.pixels,E,k,0,0,Y,f,B,S,z,a,I>>8,O>>8),u+=_0,m+=H0,O+=G0,I+=Q0,E+=K.width2d,Y+=s,f+=p,B+=y,Y|=0,f|=0,B|=0}}}}static textureRaster(u,_,m,R,b,E,O,L,I,N,H,G,T,q,Q){if(u>=_)return;let n,J;if(this.clipX){if(n=(Q-q)/(_-u)|0,_>K.boundX)_=K.boundX;if(u<0)q-=u*n,u=0;if(u>=_)return;J=_-u>>3,n<<=12}else if(_-u>7)J=_-u>>3,n=(Q-q)*this.divTable[J]>>6;else J=0,n=0;q<<=9,R+=u;let U,w,k,V,j,X,A;if(this.lowMemory&&b){if(U=0,w=0,V=u-this.centerX,L=L+(H>>3)*V,I=I+(G>>3)*V,N=N+(T>>3)*V,L|=0,I|=0,N|=0,k=N>>12,k!==0){if(E=L/k|0,O=I/k|0,E<0)E=0;else if(E>4032)E=4032}if(L=L+H,I=I+G,N=N+T,L|=0,I|=0,N|=0,k=N>>12,k!==0){if(U=L/k|0,w=I/k|0,U<7)U=7;else if(U>4032)U=4032}if(j=U-E>>3,X=w-O>>3,E+=q>>3&786432,A=q>>23,this.opaque){while(J-- >0){if(m[R++]=b[(O&4032)+(E>>6)]>>>A,E+=j,O+=X,m[R++]=b[(O&4032)+(E>>6)]>>>A,E+=j,O+=X,m[R++]=b[(O&4032)+(E>>6)]>>>A,E+=j,O+=X,m[R++]=b[(O&4032)+(E>>6)]>>>A,E+=j,O+=X,m[R++]=b[(O&4032)+(E>>6)]>>>A,E+=j,O+=X,m[R++]=b[(O&4032)+(E>>6)]>>>A,E+=j,O+=X,m[R++]=b[(O&4032)+(E>>6)]>>>A,E+=j,O+=X,m[R++]=b[(O&4032)+(E>>6)]>>>A,E=U,O=w,L+=H,I+=G,N+=T,k=N>>12,k!==0){if(U=L/k|0,w=I/k|0,U<7)U=7;else if(U>4032)U=4032}j=U-E>>3,X=w-O>>3,q+=n,E+=q>>3&786432,A=q>>23}J=_-u&7;while(J-- >0)m[R++]=b[(O&4032)+(E>>6)]>>>A,E+=j,O+=X}else{while(J-- >0){let Z;if((Z=b[(O&4032)+(E>>6)]>>>A)!==0)m[R]=Z;if(R=R+1,E+=j,O+=X,(Z=b[(O&4032)+(E>>6)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&4032)+(E>>6)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&4032)+(E>>6)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&4032)+(E>>6)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&4032)+(E>>6)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&4032)+(E>>6)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&4032)+(E>>6)]>>>A)!==0)m[R]=Z;if(R=R+1,E=U,O=w,L+=H,I+=G,N+=T,L|=0,I|=0,N|=0,k=N>>12,k!==0){if(U=L/k|0,w=I/k|0,U<7)U=7;else if(U>4032)U=4032}j=U-E>>3,X=w-O>>3,q+=n,E+=q>>3&786432,A=q>>23}J=_-u&7;while(J-- >0){let Z;if((Z=b[(O&4032)+(E>>6)]>>>A)!==0)m[R]=Z;R++,E+=j,O+=X}}return}if(U=0,w=0,V=u-this.centerX,L=L+(H>>3)*V,I=I+(G>>3)*V,N=N+(T>>3)*V,L|=0,I|=0,N|=0,k=N>>14,k!==0){if(E=L/k|0,O=I/k|0,E<0)E=0;else if(E>16256)E=16256}if(L=L+H,I=I+G,N=N+T,L|=0,I|=0,N|=0,k=N>>14,k!==0){if(U=L/k|0,w=I/k|0,U<7)U=7;else if(U>16256)U=16256}if(j=U-E>>3,X=w-O>>3,E+=q&6291456,A=q>>23,this.opaque&&b){while(J-- >0){if(m[R++]=b[(O&16256)+(E>>7)]>>>A,E+=j,O+=X,m[R++]=b[(O&16256)+(E>>7)]>>>A,E+=j,O+=X,m[R++]=b[(O&16256)+(E>>7)]>>>A,E+=j,O+=X,m[R++]=b[(O&16256)+(E>>7)]>>>A,E+=j,O+=X,m[R++]=b[(O&16256)+(E>>7)]>>>A,E+=j,O+=X,m[R++]=b[(O&16256)+(E>>7)]>>>A,E+=j,O+=X,m[R++]=b[(O&16256)+(E>>7)]>>>A,E+=j,O+=X,m[R++]=b[(O&16256)+(E>>7)]>>>A,E=U,O=w,L+=H,I+=G,N+=T,L|=0,I|=0,N|=0,k=N>>14,k!==0){if(U=L/k|0,w=I/k|0,U<7)U=7;else if(U>16256)U=16256}j=U-E>>3,X=w-O>>3,q+=n,E+=q&6291456,A=q>>23}J=_-u&7;while(J-- >0)m[R++]=b[(O&16256)+(E>>7)]>>>A,E+=j,O+=X;return}while(J-- >0&&b){let Z;if((Z=b[(O&16256)+(E>>7)]>>>A)!==0)m[R]=Z;if(R=R+1,E+=j,O+=X,(Z=b[(O&16256)+(E>>7)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&16256)+(E>>7)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&16256)+(E>>7)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&16256)+(E>>7)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&16256)+(E>>7)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&16256)+(E>>7)]>>>A)!==0)m[R]=Z;if(R++,E+=j,O+=X,(Z=b[(O&16256)+(E>>7)]>>>A)!==0)m[R]=Z;if(R++,E=U,O=w,L+=H,I+=G,N+=T,L|=0,I|=0,N|=0,k=N>>14,k!==0){if(U=L/k|0,w=I/k|0,U<7)U=7;else if(U>16256)U=16256}j=U-E>>3,X=w-O>>3,q+=n,E+=q&6291456,A=q>>23}J=_-u&7;while(J-- >0&&b){let Z;if((Z=b[(O&16256)+(E>>7)]>>>A)!==0)m[R]=Z;R++,E+=j,O+=X}}}class N0{image;width2d;height2d;ctx;paint;pixels;constructor(u,_,m=i){this.ctx=m,this.image=this.ctx.getImageData(0,0,u,_),this.paint=new Uint32Array(this.image.data.buffer),this.pixels=new Int32Array(u*_),this.width2d=u,this.height2d=_,this.bind()}clear(){this.pixels.fill(0)}bind(){K.bind(this.pixels,this.width2d,this.height2d)}draw(u,_){this.#u(),this.ctx.putImageData(this.image,u,_)}#u(){let u=this.pixels.length,_=this.pixels,m=this.paint;for(let R=0;R<u;R++){let b=_[R];m[R]=b>>16&255|(b>>8&255)<<8|(b&255)<<16|4278190080}}}class mu{state=0;deltime=20;mindel=1;otim=[,,,,,,,,,,];fps=0;debug=!1;drawArea=null;redrawScreen=!0;hasFocus=!0;idleCycles=performance.now();mouseButton=0;mouseX=-1;mouseY=-1;nextMouseClickButton=0;nextMouseClickX=-1;nextMouseClickY=-1;mouseClickButton=0;mouseClickX=-1;mouseClickY=-1;nextMouseClickTime=0;mouseClickTime=0;actionKey=[];keyQueue=[];keyQueueReadPos=0;keyQueueWritePos=0;slowestMS=0;averageMS=[];averageIndexMS=0;resizeToFit=!1;tfps=50;fpos=0;frameTime=[];ingame=!1;startedInViewport=!1;startedInTabArea=!1;startedInChatScroll=!1;ttime=-1;sx=0;sy=0;mx=0;my=0;nx=0;ny=0;dragging=!1;panning=!1;async load(){}async update(){}async draw(){}refresh(){}constructor(u=!1){if(d.tabIndex=-1,i.fillStyle="black",i.fillRect(0,0,d.width,d.height),this.resizeToFit=u,this.resizeToFit)this.resize(window.innerWidth,window.innerHeight);else this.resize(d.width,d.height)}get width(){return d.width}get height(){return d.height}resize(u,_){d.width=u,d.height=_,this.drawArea=new N0(u,_),h.init2D()}async run(){if(d.addEventListener("resize",()=>{if(this.resizeToFit)this.resize(window.innerWidth,window.innerHeight)},!1),d.onfocus=this.onfocus.bind(this),d.onblur=this.onblur.bind(this),d.onkeydown=this.onkeydown.bind(this),d.onkeyup=this.onkeyup.bind(this),d.onmousedown=this.onmousedown.bind(this),d.onpointerdown=this.onpointerdown.bind(this),d.onmouseup=this.onmouseup.bind(this),d.onpointerup=this.onpointerup.bind(this),d.onpointerenter=this.onpointerenter.bind(this),d.onpointerleave=this.onpointerleave.bind(this),d.onpointermove=this.onpointermove.bind(this),this.isTouchDevice)if(this.hasTouchEvents)d.ontouchstart=this.ontouchstart.bind(this);else d.style.touchAction="none";d.oncontextmenu=(E)=>{E.preventDefault()},window.oncontextmenu=(E)=>{E.preventDefault()},await this.drawProgress(0,"Loading..."),await this.load();let u=0,_=0,m=256,R=1,b=0;for(let E=0;E<10;E++)this.otim[E]=performance.now();while(this.state>=0){if(this.state>0){if(this.state--,this.state===0){this.shutdown();return}}let E=m,O=R;m=300,R=1,u=performance.now();let L=this.otim[_];if(L===0)m=E,R=O;else if(u>L)m=this.deltime*2560/(u-L)|0;if(m<25)m=25;else if(m>256)m=256,R=this.deltime-(u-L)/10|0;if(this.otim[_]=u,_=(_+1)%10,R>1){for(let N=0;N<10;N++)if(this.otim[N]!==0)this.otim[N]+=R}if(R<this.mindel)R=this.mindel;await Y0(R);while(b<256)this.mouseClickButton=this.nextMouseClickButton,this.mouseClickX=this.nextMouseClickX,this.mouseClickY=this.nextMouseClickY,this.mouseClickTime=this.nextMouseClickTime,this.nextMouseClickButton=0,await this.update(),b+=m;if(b&=255,this.deltime>0)this.fps=m*1000/(this.deltime*256)|0;let I=performance.now();if(await this.draw(),this.isMobile)J0.draw();if(this.frameTime[this.fpos]=(performance.now()-I)/1000,this.fpos=(this.fpos+1)%this.frameTime.length,this.tfps<50){let N=1000/this.tfps-(performance.now()-u);if(N>0)await Y0(N)}if(this.debug){for(let N=0;N<10;N++){let H=(_-N-1+20)%10}this.debug=!1}}if(this.state===-1)this.shutdown()}shutdown(){this.state=-2}setFramerate(u){this.deltime=1000/u|0}setTargetedFramerate(u){this.tfps=Math.max(Math.min(50,u|0),0)}start(){if(this.state>=0)this.state=0}stop(){if(this.state>=0)this.state=4000/this.deltime|0}async drawProgress(u,_){let m=this.width,R=this.height;if(this.redrawScreen)i.fillStyle="black",i.fillRect(0,0,m,R),this.redrawScreen=!1;let b=R/2-18;i.strokeStyle="rgb(140, 17, 17)",i.strokeRect((m/2|0)-152,b,304,34),i.fillStyle="rgb(140, 17, 17)",i.fillRect((m/2|0)-150,b+2,u*3,30),i.fillStyle="black",i.fillRect((m/2|0)-150+u*3,b+2,300-u*3,30),i.font="bold 13px helvetica, sans-serif",i.textAlign="center",i.fillStyle="white",i.fillText(_,m/2|0,b+22),await Y0(5)}get ms(){let u=this.frameTime.length,_=0;for(let R=0;R<u;R++)_+=this.frameTime[R];let m=_/u*1000;if(m>this.slowestMS)this.slowestMS=m;return this.averageMS[this.averageIndexMS]=m,this.averageIndexMS=(this.averageIndexMS+1)%250,m}get msAvg(){return this.averageMS.reduce((u,_)=>u+_,0)/250}onmousedown(u){if(u.clientX<0||u.clientY<0)return;let{x:_,y:m}=this.getMousePos(u);if(this.idleCycles=performance.now(),this.nextMouseClickX=_,this.nextMouseClickY=m,this.nextMouseClickTime=performance.now(),this.mouseX=_,this.mouseY=m,u.button===2)this.nextMouseClickButton=2,this.mouseButton=2;else this.nextMouseClickButton=1,this.mouseButton=1;if(E0.enabled)E0.mousePressed(_,m,u.button,"mouse")}onpointerdown(u){if(u.clientX<0||u.clientY<0)return;let{x:_,y:m}=this.getMousePos(u);if(J0.isWithinCanvasKeyboard(_,m)&&!this.exceedsGrabThreshold(20)){J0.captureMouseDown(_,m);return}if(u.pointerType!=="mouse")this.idleCycles=performance.now(),this.nextMouseClickX=-1,this.nextMouseClickY=-1,this.nextMouseClickButton=0,this.mouseX=_,this.mouseY=m,this.mouseButton=0,this.sx=this.nx=this.mx=u.screenX|0,this.sy=this.ny=this.my=u.screenY|0,this.ttime=u.timeStamp,this.startedInViewport=this.insideViewportArea(),this.startedInTabArea=this.insideTabArea(),this.startedInChatScroll=this.insideChatScrollArea()}onmouseup(u){let{x:_,y:m}=this.getMousePos(u);if(this.idleCycles=performance.now(),this.mouseButton=0,E0.enabled)E0.mouseReleased(u.button,"mouse");this.mouseX=_,this.mouseY=m}onpointerup(u){let{x:_,y:m}=this.getMousePos(u);if(J0.isWithinCanvasKeyboard(_,m)&&!this.exceedsGrabThreshold(20)){J0.captureMouseUp(_,m);return}if(u.pointerType!=="mouse")if(this.idleCycles=performance.now(),this.mouseX=_,this.mouseY=m,this.dragging){if(this.dragging=!1,this.nextMouseClickX=-1,this.nextMouseClickY=-1,this.nextMouseClickButton=0,this.mouseButton=0,E0.enabled)E0.mouseReleased(0,u.pointerType)}else if(this.panning){this.panning=!1,this.actionKey[1]=0,this.actionKey[2]=0,this.actionKey[3]=0,this.actionKey[4]=0;return}else{if(!J0.isDisplayed()&&this.insideMobileInputArea())J0.show(_,m,u.clientX,u.clientY);else if(J0.isDisplayed()&&!J0.isWithinCanvasKeyboard(_,m))J0.hide(),this.refresh();this.nextMouseClickX=_,this.nextMouseClickY=m,this.nextMouseClickTime=performance.now();let R=u.timeStamp>=this.ttime+500;if(R)this.nextMouseClickButton=2,this.mouseButton=2;else this.nextMouseClickButton=1,this.mouseButton=1;if(E0.enabled)E0.mousePressed(_,m,R?2:0,u.pointerType);setTimeout(()=>{if(this.mouseButton=0,E0.enabled)E0.mouseReleased(R?2:0,u.pointerType)},40)}}onpointerenter(u){if(u.clientX<0||u.clientY<0)return;let{x:_,y:m}=this.getMousePos(u);if(u.pointerType==="mouse"){if(this.mouseX=_,this.mouseY=m,E0.enabled)E0.mouseEntered()}else this.idleCycles=performance.now(),this.nextMouseClickX=-1,this.nextMouseClickY=-1,this.nextMouseClickButton=0,this.mouseX=_,this.mouseY=m,this.mouseButton=0,this.sx=this.nx=this.mx=u.screenX|0,this.sy=this.ny=this.my=u.screenY|0,this.ttime=u.timeStamp,this.startedInViewport=this.insideViewportArea(),this.startedInTabArea=this.insideTabArea()}onpointerleave(u){if(u.pointerType==="mouse"){if(this.idleCycles=performance.now(),this.mouseX=-1,this.mouseY=-1,E0.enabled)E0.mouseExited();this.nextMouseClickX=-1,this.nextMouseClickY=-1,this.nextMouseClickButton=0,this.mouseButton=0}else this.idleCycles=performance.now(),this.actionKey[1]=0,this.actionKey[2]=0,this.actionKey[3]=0,this.actionKey[4]=0}onpointermove(u){if(u.clientX<0||u.clientY<0)return;let{x:_,y:m}=this.getMousePos(u);if(u.pointerType==="mouse"){if(this.idleCycles=performance.now(),this.mouseX=_,this.mouseY=m,E0.enabled)E0.mouseMoved(_,m,u.pointerType)}else{if(this.idleCycles=performance.now(),this.mouseX=_,this.mouseY=m,this.nx=u.screenX|0,this.ny=u.screenY|0,this.dragging);else if(J0.isWithinCanvasKeyboard(_,m)&&this.exceedsGrabThreshold(20))J0.notifyTouchMove(_,m);else if(this.startedInViewport&&this.getViewportInterfaceId()===-1&&this.exceedsGrabThreshold(20)){if(this.panning=!0,this.mx-this.nx>0)this.actionKey[1]=0,this.actionKey[2]=1;else if(this.mx-this.nx<0)this.actionKey[1]=1,this.actionKey[2]=0;if(this.my-this.ny>0)this.actionKey[3]=0,this.actionKey[4]=1;else if(this.my-this.ny<0)this.actionKey[3]=1,this.actionKey[4]=0}else if(this.startedInTabArea||this.startedInChatScroll||this.getViewportInterfaceId()!==-1){if(!this.dragging&&this.exceedsGrabThreshold(5))this.dragging=!0,this.nextMouseClickX=_,this.nextMouseClickY=m,this.nextMouseClickButton=1,this.mouseButton=1}this.mx=this.nx,this.my=this.ny}}ontouchstart(u){if(u.touches.length<2||this.dragging)u.preventDefault()}onkeydown(u){this.idleCycles=performance.now();let _=M.get(u.key);if(!_||u.code.length===0&&!u.isTrusted)return;let m=_.ch;if(u.ctrlKey){if(m>=65&&m<=93||m==95)m-=64;else if(m>=97&&m<=122)m-=96}if(m>0&&m<128)this.actionKey[m]=1;if(m>4)this.keyQueue[this.keyQueueWritePos]=m,this.keyQueueWritePos=this.keyQueueWritePos+1&127;if(E0.enabled)E0.keyPressed(m);if(!Vu.includes(u.key))u.preventDefault()}onkeyup(u){if(u.isTrusted&&J0.isDisplayed())J0.hide(),this.refresh();this.idleCycles=performance.now();let _=M.get(u.key);if(!_||u.code.length===0&&!u.isTrusted)return;let m=_.ch;if(u.ctrlKey){if(m>=65&&m<=93||m==95)m-=64;else if(m>=97&&m<=122)m-=96}if(m>0&&m<128)this.actionKey[m]=0;if(E0.enabled)E0.keyReleased(m);if(!Vu.includes(u.key))u.preventDefault()}pollKey(){let u=-1;if(this.keyQueueWritePos!==this.keyQueueReadPos)u=this.keyQueue[this.keyQueueReadPos],this.keyQueueReadPos=this.keyQueueReadPos+1&127;return u}onfocus(u){if(this.hasFocus=!0,this.redrawScreen=!0,this.refresh(),E0.enabled)E0.focusGained()}onblur(u){this.hasFocus=!1;for(let _=0;_<128;_++)this.actionKey[_]=0;if(E0.enabled)E0.focusLost()}get hasTouchEvents(){return"ontouchstart"in window}get isTouchDevice(){return this.hasTouchEvents||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}get isMobile(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|Windows Phone|Mobile/i.test(navigator.userAgent))return!0;return this.isTouchDevice}insideViewportArea(){return this.ingame&&this.mouseX>=4&&this.mouseX<=516&&this.mouseY>=4&&this.mouseY<=338}insideMobileInputArea(){return this.insideChatInputArea()||this.insideChatPopupArea()||this.insideUsernameArea()||this.inPasswordArea()||this.in2FAInputArea()||this.insideReportInterfaceTextArea()}insideChatInputArea(){return this.ingame&&this.getChatInterfaceId()===-1&&!this.isChatBackInputOpen()&&!this.isShowSocialInput()&&this.mouseX>=17&&this.mouseX<=496&&this.mouseY>=434&&this.mouseY<=460}insideChatPopupArea(){return this.ingame&&(this.isChatBackInputOpen()||this.isShowSocialInput())&&this.mouseX>=17&&this.mouseX<=496&&this.mouseY>=357&&this.mouseY<=453}insideChatScrollArea(){return this.ingame&&(!this.isChatBackInputOpen()&&!this.isShowSocialInput())&&this.mouseX>=480&&this.mouseX<=496&&this.mouseY>=357&&this.mouseY<=434}insideReportInterfaceTextArea(){if(!this.ingame)return!1;let u=this.getViewportInterfaceId(),_=this.getReportAbuseInterfaceId();if(u===-1||_===-1)return!1;if(u!==_)return!1;let m=87,R=119,b=m+348,E=R+37;return this.mouseX>=m&&this.mouseX<=b&&this.mouseY>=R&&this.mouseY<=E}insideTabArea(){return this.ingame&&this.mouseX>=553&&this.mouseX<=743&&this.mouseY>=205&&this.mouseY<=466}insideUsernameArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=280&&this.mouseX<=470&&this.mouseY>=233&&this.mouseY<=264}inPasswordArea(){return!this.ingame&&this.getTitleScreenState()===2&&this.mouseX>=280&&this.mouseX<=558&&this.mouseY>=264&&this.mouseY<=284}in2FAInputArea(){return!this.ingame&&this.getTitleScreenState()===1&&this.mouseX>=280&&this.mouseX<=470&&this.mouseY>=233&&this.mouseY<=294}isFullScreen(){return document.fullscreenElement!==null}getMousePos(u){let _=this.width,m=this.height,R=d.getBoundingClientRect(),b={x:u.clientX-R.left,y:u.clientY-R.top},E=0,O=0;if(this.isFullScreen()){let L=_/m,N=window.innerWidth/window.innerHeight>=L,H=0,G=0,T=0,q=0;if(N)H=window.innerHeight*L,G=window.innerHeight,T=(window.innerWidth-H)/2;else H=window.innerWidth,G=window.innerWidth/L,q=(window.innerHeight-G)/2;let Q=_/H,n=m/G;E=(b.x-T)*Q|0,O=(b.y-q)*n|0}else{let L=d.width/R.width,I=d.height/R.height;E=b.x*L|0,O=b.y*I|0}if(E<0)E=0;if(E>_)E=_;if(O<0)O=0;if(O>m)O=m;return{x:E,y:O}}exceedsGrabThreshold(u){return Math.abs(this.sx-this.nx)>u||Math.abs(this.sy-this.ny)>u}}class K0{id;debugname=null;constructor(u){this.id=u}unpackType(u){while(!0){let _=u.g1();if(_===0)break;this.unpack(_,u)}return this}}class s0 extends K0{static count=0;static types=[];rgb=0;texture=-1;overlay=!1;occlude=!0;hue=0;saturation=0;lightness=0;luminance=0;chroma=0;hsl=0;static unpack(u){let _=new W(u.read("flo.dat"));this.count=_.g2(),this.types=Array(this.count);for(let m=0;m<this.count;m++){if(!this.types[m])this.types[m]=new s0(m);this.types[m].unpackType(_)}}unpack(u,_){if(u===1)this.rgb=_.g3(),this.setColour(this.rgb);else if(u===2)this.texture=_.g1();else if(u===3)this.overlay=!0;else if(u===5)this.occlude=!1;else if(u===6)this.debugname=_.gjstr()}setColour(u){let _=(u>>16&255)/256,m=(u>>8&255)/256,R=(u&255)/256,b=_;if(m<_)b=m;if(R<b)b=R;let E=_;if(m>_)E=m;if(R>E)E=R;let O=0,L=0,I=(b+E)/2;if(b!==E){if(I<0.5)L=(E-b)/(E+b);if(I>=0.5)L=(E-b)/(2-E-b);if(_===E)O=(m-R)/(E-b);else if(m===E)O=(R-_)/(E-b)+2;else if(R===E)O=(_-m)/(E-b)+4}if(O/=6,this.hue=O*256|0,this.saturation=L*256|0,this.lightness=I*256|0,this.saturation<0)this.saturation=0;else if(this.saturation>255)this.saturation=255;if(this.lightness<0)this.lightness=0;else if(this.lightness>255)this.lightness=255;if(I>0.5)this.luminance=(1-I)*L*512|0;else this.luminance=I*L*512|0;if(this.luminance<1)this.luminance=1;this.chroma=O*this.luminance|0;let N=this.hue+(Math.random()*16|0)-8;if(N<0)N=0;else if(N>255)N=255;let H=this.saturation+(Math.random()*48|0)-24;if(H<0)H=0;else if(H>255)H=255;let G=this.lightness+(Math.random()*48|0)-24;if(G<0)G=0;else if(G>255)G=255;this.hsl=s0.hsl24to16(N,H,G)}static hsl24to16(u,_,m){if(m>179)_=_/2|0;if(m>192)_=_/2|0;if(m>217)_=_/2|0;if(m>243)_=_/2|0;return((u/4|0)<<10)+((_/32|0)<<7)+(m/2|0)}}class Ru{length=0;types=null;labels=null;constructor(u){this.length=u.g1(),this.types=new Uint8Array(this.length),this.labels=new r(this.length,null);for(let _=0;_<this.length;_++)this.types[_]=u.g1();for(let _=0;_<this.length;_++){let m=u.g1();this.labels[_]=new Uint8Array(m);for(let R=0;R<m;R++)this.labels[_][R]=u.g1()}}}class h0{static instances=[];delay=-1;base=null;length=0;groups=null;x=null;y=null;z=null;static init(u){this.instances=Array(u+1)}static unpack(u){let _=new W(u);_.pos=u.length-8;let m=_.g2(),R=_.g2(),b=_.g2(),E=_.g2(),O=0,L=new W(u);L.pos=O,O+=m+2;let I=new W(u);I.pos=O,O+=R;let N=new W(u);N.pos=O,O+=b;let H=new W(u);H.pos=O,O+=E;let G=new W(u);G.pos=O;let T=new Ru(G),q=L.g2(),Q=new Int32Array(500),n=new Int32Array(500),J=new Int32Array(500),U=new Int32Array(500);for(let w=0;w<q;w++){let k=L.g2(),V=this.instances[k]=new h0;V.delay=H.g1(),V.base=T;let j=L.g1(),X=-1,A=0;for(let Z=0;Z<j;Z++){if(!T.types)throw Error();let D=I.g1();if(D>0){if(T.types[Z]!==0){for(let S=Z-1;S>X;S--)if(T.types[S]===0){Q[A]=S,n[A]=0,J[A]=0,U[A]=0,A++;break}}Q[A]=Z;let Y=0;if(T.types[Q[A]]===3)Y=128;if((D&1)===0)n[A]=Y;else n[A]=N.gsmart();if((D&2)===0)J[A]=Y;else J[A]=N.gsmart();if((D&4)===0)U[A]=Y;else U[A]=N.gsmart();X=Z,A++}}V.length=A,V.groups=new Int32Array(A),V.x=new Int32Array(A),V.y=new Int32Array(A),V.z=new Int32Array(A);for(let Z=0;Z<A;Z++)V.groups[Z]=Q[Z],V.x[Z]=n[Z],V.y[Z]=J[Z],V.z[Z]=U[Z]}}static get(u){return h0.instances[u]}}class o extends K0{static count=0;static types=[];frameCount=0;frames=null;iframes=null;delay=null;loops=-1;walkmerge=null;stretches=!1;priority=5;replaceheldleft=-1;replaceheldright=-1;maxloops=99;preanim_move=-1;postanim_move=-1;duplicatebehavior=-1;static unpack(u){let _=new W(u.read("seq.dat"));this.count=_.g2(),this.types=Array(this.count);for(let m=0;m<this.count;m++){if(!this.types[m])this.types[m]=new o(m);let R=this.types[m].unpackType(_);if(R.preanim_move===-1)if(R.walkmerge===null)R.preanim_move=0;else R.preanim_move=2;if(R.postanim_move===-1)if(R.walkmerge===null)R.postanim_move=0;else R.postanim_move=2;if(R.frameCount===0)R.frameCount=1,R.frames=new Int16Array(1),R.frames[0]=-1,R.iframes=new Int16Array(1),R.iframes[0]=-1,R.delay=new Int16Array(1),R.delay[0]=-1}}getFrameDuration(u){if(!this.delay||!this.frames)return 0;let _=this.delay[u];if(_===0){let m=h0.get(this.frames[u]);if(m!=null)_=this.delay[u]=m.delay}if(_===0)_=1;return _}unpack(u,_){if(u===1){this.frameCount=_.g1(),this.frames=new Int16Array(this.frameCount),this.iframes=new Int16Array(this.frameCount),this.delay=new Int16Array(this.frameCount);for(let m=0;m<this.frameCount;m++){if(this.frames[m]=_.g2(),this.iframes[m]=_.g2(),this.iframes[m]===65535)this.iframes[m]=-1;this.delay[m]=_.g2()}}else if(u===2)this.loops=_.g2();else if(u===3){let m=_.g1();this.walkmerge=new Int32Array(m+1);for(let R=0;R<m;R++)this.walkmerge[R]=_.g1();this.walkmerge[m]=9999999}else if(u===4)this.stretches=!0;else if(u===5)this.priority=_.g1();else if(u===6)this.replaceheldleft=_.g2();else if(u===7)this.replaceheldright=_.g2();else if(u===8)this.maxloops=_.g1();else if(u===9)this.preanim_move=_.g1();else if(u===10)this.postanim_move=_.g1();else if(u===11)this.duplicatebehavior=_.g1()}}class bu{bucketCount;buckets;constructor(u){this.buckets=Array(u),this.bucketCount=u;for(let _=0;_<u;_++){let m=this.buckets[_]=new f0;m.next=m,m.prev=m}}get(u){let _=this.buckets[Number(u&BigInt(this.bucketCount-1))];for(let m=_.next;m!==_;m=m.next){if(!m)continue;if(m.key===u)return m}return null}put(u,_){if(_.prev)_.unlink();let m=this.buckets[Number(u&BigInt(this.bucketCount-1))];if(_.prev=m.prev,_.next=m,_.prev)_.prev.next=_;_.next.prev=_,_.key=u}}class i0{sentinel=new V0;cursor=null;constructor(){this.sentinel.next2=this.sentinel,this.sentinel.prev2=this.sentinel}push(u){if(u.prev2)u.unlink2();if(u.prev2=this.sentinel.prev2,u.next2=this.sentinel,u.prev2)u.prev2.next2=u;u.next2.prev2=u}pop(){let u=this.sentinel.next2;if(u===this.sentinel)return null;else return u?.unlink2(),u}head(){let u=this.sentinel.next2;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.next2||null,u}next(){let u=this.cursor;if(u===this.sentinel)return this.cursor=null,null;return this.cursor=u?.next2||null,u}size(){let u=0;for(let _=this.sentinel.next2;_!==this.sentinel&&_;_=_.next2)u++;return u}}class F0{capacity;hashtable=new bu(1024);cacheHistory=new i0;cacheAvailable;constructor(u){this.capacity=u,this.cacheAvailable=u}get(u){let _=this.hashtable.get(u);if(_)this.cacheHistory.push(_);return _}put(u,_){if(this.cacheAvailable===0){let m=this.cacheHistory.pop();m?.unlink(),m?.unlink2()}else this.cacheAvailable--;this.hashtable.put(u,_),this.cacheHistory.push(_)}clear(){while(!0){let u=this.cacheHistory.pop();if(!u){this.cacheAvailable=this.capacity;return}u.unlink(),u.unlink2()}}}class P{static WALL_STRAIGHT=new P(0,0);static WALL_DIAGONAL_CORNER=new P(1,0);static WALL_L=new P(2,0);static WALL_SQUARE_CORNER=new P(3,0);static WALLDECOR_STRAIGHT_NOOFFSET=new P(4,1);static WALLDECOR_STRAIGHT_OFFSET=new P(5,1);static WALLDECOR_DIAGONAL_OFFSET=new P(6,1);static WALLDECOR_DIAGONAL_NOOFFSET=new P(7,1);static WALLDECOR_DIAGONAL_BOTH=new P(8,1);static WALL_DIAGONAL=new P(9,2);static CENTREPIECE_STRAIGHT=new P(10,2);static CENTREPIECE_DIAGONAL=new P(11,2);static ROOF_STRAIGHT=new P(12,2);static ROOF_DIAGONAL_WITH_ROOFEDGE=new P(13,2);static ROOF_DIAGONAL=new P(14,2);static ROOF_L_CONCAVE=new P(15,2);static ROOF_L_CONVEX=new P(16,2);static ROOF_FLAT=new P(17,2);static ROOFEDGE_STRAIGHT=new P(18,2);static ROOFEDGE_DIAGONAL_CORNER=new P(19,2);static ROOFEDGE_L=new P(20,2);static ROOFEDGE_SQUARE_CORNER=new P(21,2);static GROUND_DECOR=new P(22,3);static values(){return[this.WALL_STRAIGHT,this.WALL_DIAGONAL_CORNER,this.ROOF_FLAT,this.ROOF_L_CONCAVE,this.WALL_L,this.ROOF_DIAGONAL,this.WALL_DIAGONAL,this.WALL_SQUARE_CORNER,this.GROUND_DECOR,this.ROOF_STRAIGHT,this.CENTREPIECE_DIAGONAL,this.WALLDECOR_DIAGONAL_OFFSET,this.ROOFEDGE_L,this.CENTREPIECE_STRAIGHT,this.WALLDECOR_STRAIGHT_OFFSET,this.ROOF_DIAGONAL_WITH_ROOFEDGE,this.WALLDECOR_DIAGONAL_NOOFFSET,this.WALLDECOR_STRAIGHT_NOOFFSET,this.ROOF_L_CONVEX,this.WALLDECOR_DIAGONAL_BOTH,this.ROOFEDGE_DIAGONAL_CORNER,this.ROOFEDGE_SQUARE_CORNER,this.ROOFEDGE_STRAIGHT]}static of(u){let _=this.values();for(let m=0;m<_.length;m++){let R=_[m];if(R.id===u)return R}throw Error("shape not found")}id;layer;constructor(u,_){this.id=u,this.layer=_}}class w0 extends V0{vertexNormal=null;minY=1000;draw(u,_,m,R,b,E,O,L,I,N){let H=this.getModel(u);if(H)this.minY=H.minY,H.draw(0,_,m,R,b,E,O,L,I,N)}getModel(u){return null}}class t0{x=0;y=0;z=0;w=0}class ju{data=null;vertexCount=0;faceCount=0;texturedFaceCount=0;vertexFlagsOffset=-1;vertexXOffset=-1;vertexYOffset=-1;vertexZOffset=-1;vertexLabelsOffset=-1;faceVerticesOffset=-1;faceOrientationsOffset=-1;faceColoursOffset=-1;faceInfosOffset=-1;facePrioritiesOffset=0;faceAlphasOffset=-1;faceLabelsOffset=-1;faceTextureAxisOffset=-1}class $ extends w0{static loaded=0;static empty=new $;static tmpVertexX=new Int32Array(2000);static tmpVertexY=new Int32Array(2000);static tmpVertexZ=new Int32Array(2000);static tmpFaceAlpha=new Int32Array(2000);maxDepth=0;minDepth=0;objRaise=0;vertexLabel=null;faceLabel=null;labelVertices=null;labelFaces=null;picking=!1;vertexNormalOriginal=null;static meta=null;static provider;static faceClippedX=new r(4096,!1);static faceNearClipped=new r(4096,!1);static vertexScreenX=new Int32Array(4096);static vertexScreenY=new Int32Array(4096);static vertexScreenZ=new Int32Array(4096);static vertexViewSpaceX=new Int32Array(4096);static vertexViewSpaceY=new Int32Array(4096);static vertexViewSpaceZ=new Int32Array(4096);static tmpDepthFaceCount=new Int32Array(1500);static tmpDepthFaces=new X0(1500,512);static tmpPriorityFaceCount=new Int32Array(12);static tmpPriorityFaces=new X0(12,2000);static tmpPriority10FaceDepth=new Int32Array(2000);static tmpPriority11FaceDepth=new Int32Array(2000);static tmpPriorityDepthSum=new Int32Array(12);vertexCount=0;faceCount=0;texturedFaceCount=0;vertexX=null;vertexY=null;vertexZ=null;faceVertexA=null;faceVertexB=null;faceVertexC=null;texturedVertexA=null;texturedVertexB=null;texturedVertexC=null;faceInfo=null;facePriority=null;priority=0;faceAlpha=null;faceColour=null;faceColourA=null;faceColourB=null;faceColourC=null;maxY=0;radius=0;minX=0;maxX=0;minZ=0;maxZ=0;static clippedX=new Int32Array(10);static clippedY=new Int32Array(10);static clippedColour=new Int32Array(10);static pickedBitsets=new Int32Array(1000);static baseX=0;static baseY=0;static baseZ=0;static mouseX=0;static mouseY=0;static pickedCount=0;static checkHover=!1;static init(u,_){$.meta=Array(u),$.provider=_}static unpack(u,_){if(!$.meta)return;if(!_){let Q=$.meta[u]=new ju;Q.vertexCount=0,Q.faceCount=0,Q.texturedFaceCount=0;return}let m=new W(_);m.pos=_.length-18;let R=$.meta[u]=new ju;R.data=_,R.vertexCount=m.g2(),R.faceCount=m.g2(),R.texturedFaceCount=m.g1();let b=m.g1(),E=m.g1(),O=m.g1(),L=m.g1(),I=m.g1(),N=m.g2(),H=m.g2(),G=m.g2(),T=m.g2(),q=0;if(R.vertexFlagsOffset=q,q+=R.vertexCount,R.faceOrientationsOffset=q,q+=R.faceCount,R.facePrioritiesOffset=q,E==255)q+=R.faceCount;else R.facePrioritiesOffset=-E-1;if(R.faceLabelsOffset=q,L==1)q+=R.faceCount;else R.faceLabelsOffset=-1;if(R.faceInfosOffset=q,b==1)q+=R.faceCount;else R.faceInfosOffset=-1;if(R.vertexLabelsOffset=q,I==1)q+=R.vertexCount;else R.vertexLabelsOffset=-1;if(R.faceAlphasOffset=q,O==1)q+=R.faceCount;else R.faceAlphasOffset=-1;R.faceVerticesOffset=q,q+=T,R.faceColoursOffset=q,q+=R.faceCount*2,R.faceTextureAxisOffset=q,q+=R.texturedFaceCount*6,R.vertexXOffset=q,q+=N,R.vertexYOffset=q,q+=H,R.vertexZOffset=q,q+=G}static unload(u){if($.meta)$.meta[u]=null}static tryGet(u){if(!$.meta)return null;if(!$.meta[u])return $.provider.requestModel(u),null;return $.fromId(u)}static isReady(u){if(!$.meta)return!1;if(!$.meta[u])return $.provider.requestModel(u),!1;return!0}constructor(u){super();if(u)this.vertexCount=u.vertexCount,this.vertexX=u.vertexX,this.vertexY=u.vertexY,this.vertexZ=u.vertexZ,this.faceCount=u.faceCount,this.faceVertexA=u.faceVertexA,this.faceVertexB=u.faceVertexB,this.faceVertexC=u.faceVertexC,this.faceColourA=u.faceColorA,this.faceColourB=u.faceColorB,this.faceColourC=u.faceColorC,this.faceInfo=u.faceInfo,this.facePriority=u.facePriority,this.faceAlpha=u.faceAlpha,this.faceColour=u.faceColor,this.priority=u.priorityVal,this.texturedFaceCount=u.texturedFaceCount,this.texturedVertexA=u.texturedVertexA,this.texturedVertexB=u.texturedVertexB,this.texturedVertexC=u.texturedVertexC,this.minX=u.minX??0,this.maxX=u.maxX??0,this.minZ=u.minZ??0,this.maxZ=u.maxZ??0,this.radius=u.radius??0,this.maxY=u.minY??0,this.minY=u.maxY??0,this.maxDepth=u.maxDepth??0,this.minDepth=u.minDepth??0,this.vertexLabel=u.vertexLabel??null,this.faceLabel=u.faceLabel??null,this.labelVertices=u.labelVertices??null,this.labelFaces=u.labelFaces??null,this.vertexNormal=u.vertexNormal??null,this.vertexNormalOriginal=u.vertexNormalOriginal??null}static fromId(u){if(!$.meta||!$.meta[u])return new $;$.loaded++;let _=$.meta[u],m=new $;if(m.vertexCount=_.vertexCount,m.faceCount=_.faceCount,m.texturedFaceCount=_.texturedFaceCount,m.vertexX=new Int32Array(m.vertexCount),m.vertexY=new Int32Array(m.vertexCount),m.vertexZ=new Int32Array(m.vertexCount),m.faceVertexA=new Int32Array(m.faceCount),m.faceVertexB=new Int32Array(m.faceCount),m.faceVertexC=new Int32Array(m.faceCount),m.texturedVertexA=new Int32Array(m.texturedFaceCount),m.texturedVertexB=new Int32Array(m.texturedFaceCount),m.texturedVertexC=new Int32Array(m.texturedFaceCount),_.vertexLabelsOffset>=0)m.vertexLabel=new Int32Array(m.vertexCount);if(_.faceInfosOffset>=0)m.faceInfo=new Int32Array(m.faceCount);if(_.facePrioritiesOffset>=0)m.facePriority=new Int32Array(m.faceCount);else m.priority=-_.facePrioritiesOffset-1;if(_.faceAlphasOffset>=0)m.faceAlpha=new Int32Array(m.faceCount);if(_.faceLabelsOffset>=0)m.faceLabel=new Int32Array(m.faceCount);m.faceColour=new Int32Array(m.faceCount);let R=new W(_.data);R.pos=_.vertexFlagsOffset;let b=new W(_.data);b.pos=_.vertexXOffset;let E=new W(_.data);E.pos=_.vertexYOffset;let O=new W(_.data);O.pos=_.vertexZOffset;let L=new W(_.data);L.pos=_.vertexLabelsOffset;let I=0,N=0,H=0;for(let A=0;A<m.vertexCount;A++){let Z=R.g1(),D=0;if((Z&1)!=0)D=b.gsmart();let Y=0;if((Z&2)!=0)Y=E.gsmart();let S=0;if((Z&4)!=0)S=O.gsmart();if(m.vertexX[A]=I+D,m.vertexY[A]=N+Y,m.vertexZ[A]=H+S,I=m.vertexX[A],N=m.vertexY[A],H=m.vertexZ[A],m.vertexLabel!=null)m.vertexLabel[A]=L.g1()}let G=new W(_.data);G.pos=_.faceColoursOffset;let T=new W(_.data);T.pos=_.faceInfosOffset;let q=new W(_.data);q.pos=_.facePrioritiesOffset;let Q=new W(_.data);Q.pos=_.faceAlphasOffset;let n=new W(_.data);n.pos=_.faceLabelsOffset;for(let A=0;A<m.faceCount;A++){if(m.faceColour[A]=G.g2(),m.faceInfo!=null)m.faceInfo[A]=T.g1();if(m.facePriority!=null)m.facePriority[A]=q.g1();if(m.faceAlpha!=null)m.faceAlpha[A]=Q.g1();if(m.faceLabel!=null)m.faceLabel[A]=n.g1()}let J=new W(_.data);J.pos=_.faceVerticesOffset;let U=new W(_.data);U.pos=_.faceOrientationsOffset;let w=0,k=0,V=0,j=0;for(let A=0;A<m.faceCount;A++){let Z=U.g1();if(Z==1)w=J.gsmart()+j,k=J.gsmart()+w,V=J.gsmart()+k,j=V;else if(Z==2)w=w,k=V,V=J.gsmart()+j,j=V;else if(Z==3)w=V,k=k,V=J.gsmart()+j,j=V;else if(Z==4){let D=w;w=k,k=D,V=J.gsmart()+j,j=V}m.faceVertexA[A]=w,m.faceVertexB[A]=k,m.faceVertexC[A]=V}let X=new W(_.data);X.pos=_.faceTextureAxisOffset;for(let A=0;A<m.texturedFaceCount;A++)m.texturedVertexA[A]=X.g2(),m.texturedVertexB[A]=X.g2(),m.texturedVertexC[A]=X.g2();return m}static modelCopyFaces(u,_,m){let{vertexCount:R,faceCount:b,texturedFaceCount:E}=u,O;if(_){O=new Int32Array(R);for(let q=0;q<R;q++)O[q]=u.vertexY[q]}else O=u.vertexY;let L,I,N,H,G=null,T=null;if(m){L=new Int32Array(b),I=new Int32Array(b),N=new Int32Array(b);for(let q=0;q<b;q++){if(u.faceColourA)L[q]=u.faceColourA[q];if(u.faceColourB)I[q]=u.faceColourB[q];if(u.faceColourC)N[q]=u.faceColourC[q]}if(H=new Int32Array(b),!u.faceInfo)for(let q=0;q<b;q++)H[q]=0;else for(let q=0;q<b;q++)H[q]=u.faceInfo[q];G=new r(R,null);for(let q=0;q<R;q++){let Q=G[q]=new t0;if(u.vertexNormal){let n=u.vertexNormal[q];if(n)Q.x=n.x,Q.y=n.y,Q.z=n.z,Q.w=n.w}}T=u.vertexNormalOriginal}else L=u.faceColourA,I=u.faceColourB,N=u.faceColourC,H=u.faceInfo;return new $({vertexCount:R,vertexX:u.vertexX,vertexY:O,vertexZ:u.vertexZ,faceCount:b,faceVertexA:u.faceVertexA,faceVertexB:u.faceVertexB,faceVertexC:u.faceVertexC,faceColorA:L,faceColorB:I,faceColorC:N,faceInfo:H,facePriority:u.facePriority,faceAlpha:u.faceAlpha,faceColor:u.faceColour,priorityVal:u.priority,texturedFaceCount:E,texturedVertexA:u.texturedVertexA,texturedVertexB:u.texturedVertexB,texturedVertexC:u.texturedVertexC,minX:u.minX,maxX:u.maxX,minZ:u.minZ,maxZ:u.maxZ,radius:u.radius,minY:u.maxY,maxY:u.minY,maxDepth:u.maxDepth,minDepth:u.minDepth,vertexNormal:G,vertexNormalOriginal:T})}static modelShareColored(u,_,m,R){let{vertexCount:b,faceCount:E,texturedFaceCount:O}=u,L,I,N;if(R)L=u.vertexX,I=u.vertexY,N=u.vertexZ;else{L=new Int32Array(b),I=new Int32Array(b),N=new Int32Array(b);for(let T=0;T<b;T++)L[T]=u.vertexX[T],I[T]=u.vertexY[T],N[T]=u.vertexZ[T]}let H;if(_)H=u.faceColour;else{H=new Int32Array(E);for(let T=0;T<E;T++)if(u.faceColour)H[T]=u.faceColour[T]}let G;if(m)G=u.faceAlpha;else if(G=new Int32Array(E),!u.faceAlpha)for(let T=0;T<E;T++)G[T]=0;else for(let T=0;T<E;T++)G[T]=u.faceAlpha[T];return new $({vertexCount:b,vertexX:L,vertexY:I,vertexZ:N,faceCount:E,faceVertexA:u.faceVertexA,faceVertexB:u.faceVertexB,faceVertexC:u.faceVertexC,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:u.faceInfo,facePriority:u.facePriority,faceAlpha:G,faceColor:H,priorityVal:u.priority,texturedFaceCount:O,texturedVertexA:u.texturedVertexA,texturedVertexB:u.texturedVertexB,texturedVertexC:u.texturedVertexC,vertexLabel:u.vertexLabel,faceLabel:u.faceLabel})}static modelShareAlpha(u,_){let{vertexCount:m,faceCount:R,texturedFaceCount:b}=u,E=new Int32Array(m),O=new Int32Array(m),L=new Int32Array(m);for(let N=0;N<m;N++)E[N]=u.vertexX[N],O[N]=u.vertexY[N],L[N]=u.vertexZ[N];let I;if(_)I=u.faceAlpha;else if(I=new Int32Array(R),!u.faceAlpha)for(let N=0;N<R;N++)I[N]=0;else for(let N=0;N<R;N++)I[N]=u.faceAlpha[N];return new $({vertexCount:m,vertexX:E,vertexY:O,vertexZ:L,faceCount:R,faceVertexA:u.faceVertexA,faceVertexB:u.faceVertexB,faceVertexC:u.faceVertexC,faceColorA:u.faceColourA,faceColorB:u.faceColourB,faceColorC:u.faceColourC,faceInfo:u.faceInfo,facePriority:u.facePriority,faceAlpha:I,faceColor:u.faceColour,priorityVal:u.priority,texturedFaceCount:b,texturedVertexA:u.texturedVertexA,texturedVertexB:u.texturedVertexB,texturedVertexC:u.texturedVertexC,labelVertices:u.labelVertices,labelFaces:u.labelFaces})}static modelFromModelsBounds(u,_){let m=!1,R=!1,b=!1,E=!1,O=0,L=0,I=0,N=-1;for(let S=0;S<_;S++){let s=u[S];if(s){if(O+=s.vertexCount,L+=s.faceCount,I+=s.texturedFaceCount,m||=s.faceInfo!==null,!s.facePriority){if(N===-1)N=s.priority;if(N!==s.priority)R=!0}else R=!0;b||=s.faceAlpha!==null,E||=s.faceColour!==null}}let H=new Int32Array(O),G=new Int32Array(O),T=new Int32Array(O),q=new Int32Array(L),Q=new Int32Array(L),n=new Int32Array(L),J=new Int32Array(L),U=new Int32Array(L),w=new Int32Array(L),k=new Int32Array(I),V=new Int32Array(I),j=new Int32Array(I),X=null;if(m)X=new Int32Array(L);let A=null;if(R)A=new Int32Array(L);let Z=null;if(b)Z=new Int32Array(L);let D=null;if(E)D=new Int32Array(L);O=0,L=0,I=0;for(let S=0;S<_;S++){let s=u[S];if(s){let f=O;for(let z=0;z<s.vertexCount;z++)H[O]=s.vertexX[z],G[O]=s.vertexY[z],T[O]=s.vertexZ[z],O++;for(let z=0;z<s.faceCount;z++){if(q[L]=s.faceVertexA[z]+f,Q[L]=s.faceVertexB[z]+f,n[L]=s.faceVertexC[z]+f,s.faceColourA)J[L]=s.faceColourA[z];if(s.faceColourB)U[L]=s.faceColourB[z];if(s.faceColourC)w[L]=s.faceColourC[z];if(m){if(!s.faceInfo){if(X)X[L]=0}else if(X)X[L]=s.faceInfo[z]}if(R){if(!s.facePriority){if(A)A[L]=s.priority}else if(A)A[L]=s.facePriority[z]}if(b){if(!s.faceAlpha){if(Z)Z[L]=0}else if(Z)Z[L]=s.faceAlpha[z]}if(E&&s.faceColour){if(D)D[L]=s.faceColour[z]}L++}for(let z=0;z<s.texturedFaceCount;z++)k[I]=s.texturedVertexA[z]+f,V[I]=s.texturedVertexB[z]+f,j[I]=s.texturedVertexC[z]+f,I++}}let Y=new $({vertexCount:O,vertexX:H,vertexY:G,vertexZ:T,faceCount:L,faceVertexA:q,faceVertexB:Q,faceVertexC:n,faceColorA:J,faceColorB:U,faceColorC:w,faceInfo:X,facePriority:A,faceAlpha:Z,faceColor:D,priorityVal:N,texturedFaceCount:I,texturedVertexA:k,texturedVertexB:V,texturedVertexC:j});return Y.calculateBoundsCylinder(),Y}static modelFromModels(u,_){let m=!1,R=!1,b=!1,E=!1,O=0,L=0,I=0,N=-1;for(let D=0;D<_;D++){let Y=u[D];if(Y){if(O+=Y.vertexCount,L+=Y.faceCount,I+=Y.texturedFaceCount,m||=Y.faceInfo!==null,!Y.facePriority){if(N===-1)N=Y.priority;if(N!==Y.priority)R=!0}else R=!0;b||=Y.faceAlpha!==null,E||=Y.faceLabel!==null}}let H=new Int32Array(O),G=new Int32Array(O),T=new Int32Array(O),q=new Int32Array(O),Q=new Int32Array(L),n=new Int32Array(L),J=new Int32Array(L),U=new Int32Array(I),w=new Int32Array(I),k=new Int32Array(I),V=null;if(m)V=new Int32Array(L);let j=null;if(R)j=new Int32Array(L);let X=null;if(b)X=new Int32Array(L);let A=null;if(E)A=new Int32Array(L);let Z=new Int32Array(L);O=0,L=0,I=0;for(let D=0;D<_;D++){let Y=u[D];if(Y){for(let S=0;S<Y.faceCount;S++){if(m){if(!Y.faceInfo){if(V)V[L]=0}else if(V)V[L]=Y.faceInfo[S]}if(R){if(!Y.facePriority){if(j)j[L]=Y.priority}else if(j)j[L]=Y.facePriority[S]}if(b){if(!Y.faceAlpha){if(X)X[L]=0}else if(X)X[L]=Y.faceAlpha[S]}if(E&&Y.faceLabel){if(A)A[L]=Y.faceLabel[S]}if(Y.faceColour)Z[L]=Y.faceColour[S];let s=$.addVertex(Y,Y.faceVertexA[S],H,G,T,q,O);O=s.vertexCount;let f=$.addVertex(Y,Y.faceVertexB[S],H,G,T,q,O);O=f.vertexCount;let z=$.addVertex(Y,Y.faceVertexC[S],H,G,T,q,O);O=z.vertexCount,Q[L]=s.vertex,n[L]=f.vertex,J[L]=z.vertex,L++}for(let S=0;S<Y.texturedFaceCount;S++){let s=$.addVertex(Y,Y.texturedVertexA[S],H,G,T,q,O);O=s.vertexCount;let f=$.addVertex(Y,Y.texturedVertexB[S],H,G,T,q,O);O=f.vertexCount;let z=$.addVertex(Y,Y.texturedVertexC[S],H,G,T,q,O);O=z.vertexCount,U[I]=s.vertex,w[I]=f.vertex,k[I]=z.vertex,I++}}}return new $({vertexCount:O,vertexX:H,vertexY:G,vertexZ:T,faceCount:L,faceVertexA:Q,faceVertexB:n,faceVertexC:J,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:V,facePriority:j,faceAlpha:X,faceColor:Z,priorityVal:N,texturedFaceCount:I,texturedVertexA:U,texturedVertexB:w,texturedVertexC:k,vertexLabel:q,faceLabel:A})}set(u,_){if($.tmpVertexX.length<this.vertexCount)$.tmpVertexX=new Int32Array(this.vertexCount+100),$.tmpVertexY=new Int32Array(this.vertexCount+100),$.tmpVertexZ=new Int32Array(this.vertexCount+100);this.vertexX=$.tmpVertexX,this.vertexY=$.tmpVertexY,this.vertexZ=$.tmpVertexZ;for(let m=0;m<this.vertexCount;m++)this.vertexX[m]=u.vertexX[m],this.vertexY[m]=u.vertexY[m],this.vertexZ[m]=u.vertexZ[m];if(_)this.faceAlpha=u.faceAlpha;else{if($.tmpFaceAlpha.length<this.faceCount)$.tmpFaceAlpha=new Int32Array(this.faceCount+100);if(this.faceAlpha=new Int32Array(this.faceCount),!u.faceAlpha)for(let m=0;m<this.faceCount;m++)this.faceAlpha[m]=0;else for(let m=0;m<this.faceCount;m++)this.faceAlpha[m]=u.faceAlpha[m]}this.faceInfo=u.faceInfo,this.faceColour=u.faceColour,this.facePriority=u.facePriority,this.priority=u.priority,this.labelFaces=u.labelFaces,this.labelVertices=u.labelVertices,this.faceVertexA=u.faceVertexA,this.faceVertexB=u.faceVertexB,this.faceVertexC=u.faceVertexC,this.faceColourA=u.faceColourA,this.faceColourB=u.faceColourB,this.faceColourC=u.faceColourC,this.texturedVertexA=u.texturedVertexA,this.texturedVertexB=u.texturedVertexB,this.texturedVertexC=u.texturedVertexC}static addVertex=(u,_,m,R,b,E,O)=>{let L=-1;if(u.vertexX&&u.vertexY&&u.vertexZ){let I=u.vertexX[_],N=u.vertexY[_],H=u.vertexZ[_];for(let G=0;G<O;G++)if(I===m[G]&&N===R[G]&&H===b[G]){L=G;break}if(L===-1){if(m[O]=I,R[O]=N,b[O]=H,E&&u.vertexLabel)E[O]=u.vertexLabel[_];L=O++}}return{vertex:L,vertexCount:O}};calculateBoundsCylinder(){this.minY=0,this.radius=0,this.maxY=0;for(let u=0;u<this.vertexCount;u++){let _=this.vertexX[u],m=this.vertexY[u],R=this.vertexZ[u];if(-m>this.minY)this.minY=-m;if(m>this.maxY)this.maxY=m;let b=_*_+R*R;if(b>this.radius)this.radius=b}this.radius=Math.sqrt(this.radius)+0.99|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0)}calculateBoundsY(){this.minY=0,this.maxY=0;for(let u=0;u<this.vertexCount;u++){let _=this.vertexY[u];if(-_>this.minY)this.minY=-_;if(_>this.maxY)this.maxY=_}this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)+0.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+0.99|0)}calculateBoundsAABB(){this.minY=0,this.radius=0,this.maxY=0,this.minX=999999,this.maxX=-999999,this.maxZ=-99999,this.minZ=99999;for(let u=0;u<this.vertexCount;u++){let _=this.vertexX[u],m=this.vertexY[u],R=this.vertexZ[u];if(_<this.minX)this.minX=_;if(_>this.maxX)this.maxX=_;if(R<this.minZ)this.minZ=R;if(R>this.maxZ)this.maxZ=R;if(-m>this.minY)this.minY=-m;if(m>this.maxY)this.maxY=m;let b=_*_+R*R;if(b>this.radius)this.radius=b}this.radius=Math.sqrt(this.radius)|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.minY*this.minY)|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)|0)}createLabelReferences(){if(this.vertexLabel){let u=new Int32Array(256),_=0;for(let R=0;R<this.vertexCount;R++){let b=this.vertexLabel[R];if(u[b]++,b>_)_=b}this.labelVertices=new r(_+1,null);for(let R=0;R<=_;R++)this.labelVertices[R]=new Int32Array(u[R]),u[R]=0;let m=0;while(m<this.vertexCount){let R=this.vertexLabel[m],b=this.labelVertices[R];if(!b)continue;b[u[R]++]=m++}this.vertexLabel=null}if(this.faceLabel){let u=new Int32Array(256),_=0;for(let R=0;R<this.faceCount;R++){let b=this.faceLabel[R];if(u[b]++,b>_)_=b}this.labelFaces=new r(_+1,null);for(let R=0;R<=_;R++)this.labelFaces[R]=new Int32Array(u[R]),u[R]=0;let m=0;while(m<this.faceCount){let R=this.faceLabel[m],b=this.labelFaces[R];if(!b)continue;b[u[R]++]=m++}this.faceLabel=null}}applyTransform(u){if(!this.labelVertices||u===-1)return;let _=h0.instances[u];if(!_)return;let m=_.base;$.baseX=0,$.baseY=0,$.baseZ=0;for(let R=0;R<_.length;R++){if(!_.groups||!_.x||!_.y||!_.z||!m||!m.labels||!m.types)continue;let b=_.groups[R];this.applyTransform2(_.x[R],_.y[R],_.z[R],m.labels[b],m.types[b])}}applyTransforms(u,_,m){if(u===-1)return;if(!m||_===-1){this.applyTransform(u);return}let R=h0.get(u);if(!R)return;let b=h0.get(_);if(!b){this.applyTransform(u);return}let E=R.base;$.baseX=0,$.baseY=0,$.baseZ=0;let O=0,L=m[O++];for(let I=0;I<R.length;I++){if(!R.groups)continue;let N=R.groups[I];while(N>L)L=m[O++];if(E&&E.types&&R.x&&R.y&&R.z&&E.labels&&(N!==L||E.types[N]===0))this.applyTransform2(R.x[I],R.y[I],R.z[I],E.labels[N],E.types[N])}$.baseX=0,$.baseY=0,$.baseZ=0,O=0,L=m[O++];for(let I=0;I<b.length;I++){if(!b.groups)continue;let N=b.groups[I];while(N>L)L=m[O++];if(E&&E.types&&b.x&&b.y&&b.z&&E.labels&&(N===L||E.types[N]===0))this.applyTransform2(b.x[I],b.y[I],b.z[I],E.labels[N],E.types[N])}}applyTransform2(u,_,m,R,b){if(!R)return;let E=R.length;if(b===0){let O=0;$.baseX=0,$.baseY=0,$.baseZ=0;for(let L=0;L<E;L++){if(!this.labelVertices)continue;let I=R[L];if(I<this.labelVertices.length){let N=this.labelVertices[I];if(N)for(let H=0;H<N.length;H++){let G=N[H];$.baseX+=this.vertexX[G],$.baseY+=this.vertexY[G],$.baseZ+=this.vertexZ[G],O++}}}if(O>0)$.baseX=($.baseX/O|0)+u,$.baseY=($.baseY/O|0)+_,$.baseZ=($.baseZ/O|0)+m;else $.baseX=u,$.baseY=_,$.baseZ=m}else if(b===1)for(let O=0;O<E;O++){let L=R[O];if(!this.labelVertices||L>=this.labelVertices.length)continue;let I=this.labelVertices[L];if(I)for(let N=0;N<I.length;N++){let H=I[N];this.vertexX[H]+=u,this.vertexY[H]+=_,this.vertexZ[H]+=m}}else if(b===2)for(let O=0;O<E;O++){let L=R[O];if(!this.labelVertices||L>=this.labelVertices.length)continue;let I=this.labelVertices[L];if(I)for(let N=0;N<I.length;N++){let H=I[N];this.vertexX[H]-=$.baseX,this.vertexY[H]-=$.baseY,this.vertexZ[H]-=$.baseZ;let G=(u&255)*8,T=(_&255)*8,q=(m&255)*8,Q,n;if(q!==0){Q=h.sinTable[q],n=h.cosTable[q];let J=this.vertexY[H]*Q+this.vertexX[H]*n>>16;this.vertexY[H]=this.vertexY[H]*n-this.vertexX[H]*Q>>16,this.vertexX[H]=J}if(G!==0){Q=h.sinTable[G],n=h.cosTable[G];let J=this.vertexY[H]*n-this.vertexZ[H]*Q>>16;this.vertexZ[H]=this.vertexY[H]*Q+this.vertexZ[H]*n>>16,this.vertexY[H]=J}if(T!==0){Q=h.sinTable[T],n=h.cosTable[T];let J=this.vertexZ[H]*Q+this.vertexX[H]*n>>16;this.vertexZ[H]=this.vertexZ[H]*n-this.vertexX[H]*Q>>16,this.vertexX[H]=J}this.vertexX[H]+=$.baseX,this.vertexY[H]+=$.baseY,this.vertexZ[H]+=$.baseZ}}else if(b===3)for(let O=0;O<E;O++){let L=R[O];if(!this.labelVertices||L>=this.labelVertices.length)continue;let I=this.labelVertices[L];if(I)for(let N=0;N<I.length;N++){let H=I[N];this.vertexX[H]-=$.baseX,this.vertexY[H]-=$.baseY,this.vertexZ[H]-=$.baseZ,this.vertexX[H]=this.vertexX[H]*u/128|0,this.vertexY[H]=this.vertexY[H]*_/128|0,this.vertexZ[H]=this.vertexZ[H]*m/128|0,this.vertexX[H]+=$.baseX,this.vertexY[H]+=$.baseY,this.vertexZ[H]+=$.baseZ}}else if(b===5&&this.labelFaces&&this.faceAlpha)for(let O=0;O<E;O++){let L=R[O];if(L>=this.labelFaces.length)continue;let I=this.labelFaces[L];if(I)for(let N=0;N<I.length;N++){let H=I[N];if(this.faceAlpha[H]+=u*8,this.faceAlpha[H]<0)this.faceAlpha[H]=0;if(this.faceAlpha[H]>255)this.faceAlpha[H]=255}}}rotateY90(){for(let u=0;u<this.vertexCount;u++){let _=this.vertexX[u];this.vertexX[u]=this.vertexZ[u],this.vertexZ[u]=-_}}rotateX(u){let _=h.sinTable[u],m=h.cosTable[u];for(let R=0;R<this.vertexCount;R++){let b=this.vertexY[R]*m-this.vertexZ[R]*_>>16;this.vertexZ[R]=this.vertexY[R]*_+this.vertexZ[R]*m>>16,this.vertexY[R]=b}}translate(u,_,m){for(let R=0;R<this.vertexCount;R++)this.vertexX[R]+=_,this.vertexY[R]+=u,this.vertexZ[R]+=m}recolour(u,_){if(!this.faceColour)return;for(let m=0;m<this.faceCount;m++)if(this.faceColour[m]===u)this.faceColour[m]=_}rotateY180(){for(let u=0;u<this.vertexCount;u++)this.vertexZ[u]=-this.vertexZ[u];for(let u=0;u<this.faceCount;u++){let _=this.faceVertexA[u];this.faceVertexA[u]=this.faceVertexC[u],this.faceVertexC[u]=_}}scale(u,_,m){for(let R=0;R<this.vertexCount;R++)this.vertexX[R]=this.vertexX[R]*u/128|0,this.vertexY[R]=this.vertexY[R]*_/128|0,this.vertexZ[R]=this.vertexZ[R]*m/128|0}calculateNormals(u,_,m,R,b,E){let O=Math.sqrt(m*m+R*R+b*b)|0,L=_*O>>8;if(!this.faceColourA||!this.faceColourB||!this.faceColourC)this.faceColourA=new Int32Array(this.faceCount),this.faceColourB=new Int32Array(this.faceCount),this.faceColourC=new Int32Array(this.faceCount);if(!this.vertexNormal){this.vertexNormal=new r(this.vertexCount,null);for(let I=0;I<this.vertexCount;I++)this.vertexNormal[I]=new t0}for(let I=0;I<this.faceCount;I++){let N=this.faceVertexA[I],H=this.faceVertexB[I],G=this.faceVertexC[I],T=this.vertexX[H]-this.vertexX[N],q=this.vertexY[H]-this.vertexY[N],Q=this.vertexZ[H]-this.vertexZ[N],n=this.vertexX[G]-this.vertexX[N],J=this.vertexY[G]-this.vertexY[N],U=this.vertexZ[G]-this.vertexZ[N],w=q*U-J*Q,k=Q*n-U*T,V=T*J-n*q;while(w>8192||k>8192||V>8192||w<-8192||k<-8192||V<-8192)w>>=1,k>>=1,V>>=1;let j=Math.sqrt(w*w+k*k+V*V)|0;if(j<=0)j=1;if(w=w*256/j|0,k=k*256/j|0,V=V*256/j|0,!this.faceInfo||(this.faceInfo[I]&1)===0){let X=this.vertexNormal[N];if(X)X.x+=w,X.y+=k,X.z+=V,X.w++;if(X=this.vertexNormal[H],X)X.x+=w,X.y+=k,X.z+=V,X.w++;if(X=this.vertexNormal[G],X)X.x+=w,X.y+=k,X.z+=V,X.w++}else{let X=u+((m*w+R*k+b*V)/(L+(L/2|0))|0);if(this.faceColour)this.faceColourA[I]=$.mulColourLightness(this.faceColour[I],X,this.faceInfo[I])}}if(E)this.applyLighting(u,L,m,R,b);else{this.vertexNormalOriginal=new r(this.vertexCount,null);for(let I=0;I<this.vertexCount;I++){let N=this.vertexNormal[I],H=new t0;if(N)H.x=N.x,H.y=N.y,H.z=N.z,H.w=N.w;this.vertexNormalOriginal[I]=H}}if(E)this.calculateBoundsCylinder();else this.calculateBoundsAABB()}applyLighting(u,_,m,R,b){for(let E=0;E<this.faceCount;E++){let O=this.faceVertexA[E],L=this.faceVertexB[E],I=this.faceVertexC[E];if(!this.faceInfo&&this.faceColour&&this.vertexNormal&&this.faceColourA&&this.faceColourB&&this.faceColourC){let N=this.faceColour[E],H=this.vertexNormal[O];if(H)this.faceColourA[E]=$.mulColourLightness(N,u+((m*H.x+R*H.y+b*H.z)/(_*H.w)|0),0);let G=this.vertexNormal[L];if(G)this.faceColourB[E]=$.mulColourLightness(N,u+((m*G.x+R*G.y+b*G.z)/(_*G.w)|0),0);let T=this.vertexNormal[I];if(T)this.faceColourC[E]=$.mulColourLightness(N,u+((m*T.x+R*T.y+b*T.z)/(_*T.w)|0),0)}else if(this.faceInfo&&(this.faceInfo[E]&1)===0&&this.faceColour&&this.vertexNormal&&this.faceColourA&&this.faceColourB&&this.faceColourC){let N=this.faceColour[E],H=this.faceInfo[E],G=this.vertexNormal[O];if(G)this.faceColourA[E]=$.mulColourLightness(N,u+((m*G.x+R*G.y+b*G.z)/(_*G.w)|0),H);let T=this.vertexNormal[L];if(T)this.faceColourB[E]=$.mulColourLightness(N,u+((m*T.x+R*T.y+b*T.z)/(_*T.w)|0),H);let q=this.vertexNormal[I];if(q)this.faceColourC[E]=$.mulColourLightness(N,u+((m*q.x+R*q.y+b*q.z)/(_*q.w)|0),H)}}if(this.vertexNormal=null,this.vertexNormalOriginal=null,this.vertexLabel=null,this.faceLabel=null,this.faceInfo){for(let E=0;E<this.faceCount;E++)if((this.faceInfo[E]&2)===2)return}this.faceColour=null}static mulColourLightness(u,_,m){if((m&2)===2){if(_<0)_=0;else if(_>127)_=127;return 127-_}if(_=_*(u&127)>>7,_<2)_=2;else if(_>126)_=126;return(u&65408)+_}drawSimple(u,_,m,R,b,E,O){let L=h.sinTable[u],I=h.cosTable[u],N=h.sinTable[_],H=h.cosTable[_],G=h.sinTable[m],T=h.cosTable[m],q=h.sinTable[R],Q=h.cosTable[R],n=E*q+O*Q>>16;for(let J=0;J<this.vertexCount;J++){let U=this.vertexX[J],w=this.vertexY[J],k=this.vertexZ[J],V;if(m!==0)V=w*G+U*T>>16,w=w*T-U*G>>16,U=V;if(u!==0)V=w*I-k*L>>16,k=w*L+k*I>>16,w=V;if(_!==0)V=k*N+U*H>>16,k=k*H-U*N>>16,U=V;if(U+=b,w+=E,k+=O,V=w*Q-k*q>>16,k=w*q+k*Q>>16,w=V,$.vertexScreenX&&$.vertexScreenY&&$.vertexScreenZ)$.vertexScreenZ[J]=k-n,$.vertexScreenX[J]=h.centerX+((U<<9)/k|0),$.vertexScreenY[J]=h.centerY+((w<<9)/k|0);if(this.texturedFaceCount>0&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ)$.vertexViewSpaceX[J]=U,$.vertexViewSpaceY[J]=w,$.vertexViewSpaceZ[J]=k}try{this.draw2(!1,!1,0)}catch(J){}}draw(u,_,m,R,b,E,O,L,I,N){let H=I*E-O*b>>16,G=L*m+H*R>>16,T=this.radius*R>>16,q=G+T;if(q<=50||G>=3500)return;let Q=I*b+O*E>>16,n=Q-this.radius<<9;if((n/q|0)>=K.centerX2d)return;let J=Q+this.radius<<9;if((J/q|0)<=-K.centerX2d)return;let U=L*R-H*m>>16,w=this.radius*m>>16,k=U+w<<9;if((k/q|0)<=-K.centerY2d)return;let V=w+(this.minY*R>>16),j=U-V<<9;if((j/q|0)>=K.centerY2d)return;let X=T+(this.minY*m>>16),A=G-X<=50,Z=!1;if(N>0&&$.checkHover){let f=G-T;if(f<=50)f=50;if(Q>0)n=n/q|0,J=J/f|0;else J=J/q|0,n=n/f|0;if(U>0)j=j/q|0,k=k/f|0;else k=k/q|0,j=j/f|0;let z=$.mouseX-h.centerX,p=$.mouseY-h.centerY;if(z>n&&z<J&&p>j&&p<k)if(this.picking)$.pickedBitsets[$.pickedCount++]=N;else Z=!0}let D=h.centerX,Y=h.centerY,S=0,s=0;if(_!==0)S=h.sinTable[_],s=h.cosTable[_];for(let f=0;f<this.vertexCount;f++){let z=this.vertexX[f],p=this.vertexY[f],B=this.vertexZ[f],a;if(_!==0)a=B*S+z*s>>16,B=B*s-z*S>>16,z=a;if(z+=O,p+=L,B+=I,a=B*b+z*E>>16,B=B*E-z*b>>16,z=a,a=p*R-B*m>>16,B=p*m+B*R>>16,p=a,$.vertexScreenZ)$.vertexScreenZ[f]=B-G;if(B>=50&&$.vertexScreenX&&$.vertexScreenY)$.vertexScreenX[f]=D+((z<<9)/B|0),$.vertexScreenY[f]=Y+((p<<9)/B|0);else if($.vertexScreenX)$.vertexScreenX[f]=-5000,A=!0;if((A||this.texturedFaceCount>0)&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ)$.vertexViewSpaceX[f]=z,$.vertexViewSpaceY[f]=p,$.vertexViewSpaceZ[f]=B}try{this.draw2(A,Z,N)}catch(f){}}draw2(u,_,m,R=!1){for(let L=0;L<this.maxDepth;L++)if($.tmpDepthFaceCount)$.tmpDepthFaceCount[L]=0;for(let L=0;L<this.faceCount;L++){if(this.faceInfo&&this.faceInfo[L]===-1)continue;if($.vertexScreenX&&$.vertexScreenY&&$.vertexScreenZ&&$.tmpDepthFaces&&$.tmpDepthFaceCount){let I=this.faceVertexA[L],N=this.faceVertexB[L],H=this.faceVertexC[L],G=$.vertexScreenX[I],T=$.vertexScreenX[N],q=$.vertexScreenX[H],Q=$.vertexScreenY[I],n=$.vertexScreenY[N],J=$.vertexScreenY[H],U=$.vertexScreenZ[I],w=$.vertexScreenZ[N],k=$.vertexScreenZ[H];if(u&&(G===-5000||T===-5000||q===-5000)){if($.faceNearClipped)$.faceNearClipped[L]=!0;if($.tmpDepthFaces&&$.tmpDepthFaceCount){let V=((U+w+k)/3|0)+this.minDepth;$.tmpDepthFaces[V][$.tmpDepthFaceCount[V]++]=L}}else{if(_&&this.pointWithinTriangle($.mouseX,$.mouseY,Q,n,J,G,T,q))$.pickedBitsets[$.pickedCount++]=m,_=!1;let V=G-T,j=Q-n,X=q-T,A=J-n;if(V*A-j*X<=0)continue;if($.faceNearClipped)$.faceNearClipped[L]=!1;if($.faceClippedX)$.faceClippedX[L]=G<0||T<0||q<0||G>K.boundX||T>K.boundX||q>K.boundX;if($.tmpDepthFaces&&$.tmpDepthFaceCount){let Z=((U+w+k)/3|0)+this.minDepth;$.tmpDepthFaces[Z][$.tmpDepthFaceCount[Z]++]=L}}}}if(!this.facePriority&&$.tmpDepthFaceCount){for(let L=this.maxDepth-1;L>=0;L--){let I=$.tmpDepthFaceCount[L];if(I<=0)continue;if($.tmpDepthFaces){let N=$.tmpDepthFaces[L];for(let H=0;H<I;H++)try{this.drawFace(N[H],R)}catch(G){}}}return}for(let L=0;L<12;L++)if($.tmpPriorityFaceCount&&$.tmpPriorityDepthSum)$.tmpPriorityFaceCount[L]=0,$.tmpPriorityDepthSum[L]=0;if($.tmpDepthFaceCount)for(let L=this.maxDepth-1;L>=0;L--){let I=$.tmpDepthFaceCount[L];if(I>0&&$.tmpDepthFaces){let N=$.tmpDepthFaces[L];for(let H=0;H<I;H++)if(this.facePriority&&$.tmpPriorityFaceCount&&$.tmpPriorityFaces){let G=N[H],T=this.facePriority[G],q=$.tmpPriorityFaceCount[T]++;if($.tmpPriorityFaces[T][q]=G,T<10&&$.tmpPriorityDepthSum)$.tmpPriorityDepthSum[T]+=L;else if(T===10&&$.tmpPriority10FaceDepth)$.tmpPriority10FaceDepth[q]=L;else if($.tmpPriority11FaceDepth)$.tmpPriority11FaceDepth[q]=L}}}let b=0;if($.tmpPriorityFaceCount&&$.tmpPriorityDepthSum&&($.tmpPriorityFaceCount[1]>0||$.tmpPriorityFaceCount[2]>0))b=($.tmpPriorityDepthSum[1]+$.tmpPriorityDepthSum[2])/($.tmpPriorityFaceCount[1]+$.tmpPriorityFaceCount[2])|0;let E=0;if($.tmpPriorityFaceCount&&$.tmpPriorityDepthSum&&($.tmpPriorityFaceCount[3]>0||$.tmpPriorityFaceCount[4]>0))E=($.tmpPriorityDepthSum[3]+$.tmpPriorityDepthSum[4])/($.tmpPriorityFaceCount[3]+$.tmpPriorityFaceCount[4])|0;let O=0;if($.tmpPriorityFaceCount&&$.tmpPriorityDepthSum&&($.tmpPriorityFaceCount[6]>0||$.tmpPriorityFaceCount[8]>0))O=($.tmpPriorityDepthSum[6]+$.tmpPriorityDepthSum[8])/($.tmpPriorityFaceCount[6]+$.tmpPriorityFaceCount[8])|0;if($.tmpPriorityFaceCount&&$.tmpPriorityFaces){let L=0,I=$.tmpPriorityFaceCount[10],N=$.tmpPriorityFaces[10],H=$.tmpPriority10FaceDepth;if(L===I)L=0,I=$.tmpPriorityFaceCount[11],N=$.tmpPriorityFaces[11],H=$.tmpPriority11FaceDepth;let G;if(L<I&&H)G=H[L];else G=-1000;for(let T=0;T<10;T++){while(T===0&&G>b)try{if(this.drawFace(N[L++],R),L===I&&N!==$.tmpPriorityFaces[11])L=0,I=$.tmpPriorityFaceCount[11],N=$.tmpPriorityFaces[11],H=$.tmpPriority11FaceDepth;if(L<I&&H)G=H[L];else G=-1000}catch(n){}while(T===3&&G>E)try{if(this.drawFace(N[L++],R),L===I&&N!==$.tmpPriorityFaces[11])L=0,I=$.tmpPriorityFaceCount[11],N=$.tmpPriorityFaces[11],H=$.tmpPriority11FaceDepth;if(L<I&&H)G=H[L];else G=-1000}catch(n){}while(T===5&&G>O)try{if(this.drawFace(N[L++],R),L===I&&N!==$.tmpPriorityFaces[11])L=0,I=$.tmpPriorityFaceCount[11],N=$.tmpPriorityFaces[11],H=$.tmpPriority11FaceDepth;if(L<I&&H)G=H[L];else G=-1000}catch(n){}let q=$.tmpPriorityFaceCount[T],Q=$.tmpPriorityFaces[T];for(let n=0;n<q;n++)try{this.drawFace(Q[n],R)}catch(J){}}while(G!==-1000)try{if(this.drawFace(N[L++],R),L===I&&N!==$.tmpPriorityFaces[11])L=0,N=$.tmpPriorityFaces[11],I=$.tmpPriorityFaceCount[11],H=$.tmpPriority11FaceDepth;if(L<I&&H)G=H[L];else G=-1000}catch(T){}}}drawFace(u,_=!1){if($.faceNearClipped&&$.faceNearClipped[u]){this.drawNearClippedFace(u,_);return}let m=this.faceVertexA[u],R=this.faceVertexB[u],b=this.faceVertexC[u];if($.faceClippedX)h.clipX=$.faceClippedX[u];if(!this.faceAlpha)h.alpha=0;else h.alpha=this.faceAlpha[u];let E;if(!this.faceInfo)E=0;else E=this.faceInfo[u]&3;if(_&&$.vertexScreenX&&$.vertexScreenY&&this.faceColourA&&this.faceColourB&&this.faceColourC)h.drawLine($.vertexScreenX[m],$.vertexScreenY[m],$.vertexScreenX[R],$.vertexScreenY[R],h.colourTable[this.faceColourA[u]]),h.drawLine($.vertexScreenX[R],$.vertexScreenY[R],$.vertexScreenX[b],$.vertexScreenY[b],h.colourTable[this.faceColourB[u]]),h.drawLine($.vertexScreenX[b],$.vertexScreenY[b],$.vertexScreenX[m],$.vertexScreenY[m],h.colourTable[this.faceColourC[u]]);else if(E===0&&this.faceColourA&&this.faceColourB&&this.faceColourC&&$.vertexScreenX&&$.vertexScreenY)h.gouraudTriangle($.vertexScreenX[m],$.vertexScreenX[R],$.vertexScreenX[b],$.vertexScreenY[m],$.vertexScreenY[R],$.vertexScreenY[b],this.faceColourA[u],this.faceColourB[u],this.faceColourC[u]);else if(E===1&&this.faceColourA&&$.vertexScreenX&&$.vertexScreenY)h.flatTriangle($.vertexScreenX[m],$.vertexScreenX[R],$.vertexScreenX[b],$.vertexScreenY[m],$.vertexScreenY[R],$.vertexScreenY[b],h.colourTable[this.faceColourA[u]]);else if(E===2&&this.faceInfo&&this.faceColour&&this.faceColourA&&this.faceColourB&&this.faceColourC&&$.vertexScreenX&&$.vertexScreenY&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let O=this.faceInfo[u]>>2,L=this.texturedVertexA[O],I=this.texturedVertexB[O],N=this.texturedVertexC[O];h.textureTriangle($.vertexScreenX[m],$.vertexScreenX[R],$.vertexScreenX[b],$.vertexScreenY[m],$.vertexScreenY[R],$.vertexScreenY[b],this.faceColourA[u],this.faceColourB[u],this.faceColourC[u],$.vertexViewSpaceX[L],$.vertexViewSpaceY[L],$.vertexViewSpaceZ[L],$.vertexViewSpaceX[I],$.vertexViewSpaceX[N],$.vertexViewSpaceY[I],$.vertexViewSpaceY[N],$.vertexViewSpaceZ[I],$.vertexViewSpaceZ[N],this.faceColour[u])}else if(E===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&$.vertexScreenX&&$.vertexScreenY&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let O=this.faceInfo[u]>>2,L=this.texturedVertexA[O],I=this.texturedVertexB[O],N=this.texturedVertexC[O];h.textureTriangle($.vertexScreenX[m],$.vertexScreenX[R],$.vertexScreenX[b],$.vertexScreenY[m],$.vertexScreenY[R],$.vertexScreenY[b],this.faceColourA[u],this.faceColourA[u],this.faceColourA[u],$.vertexViewSpaceX[L],$.vertexViewSpaceY[L],$.vertexViewSpaceZ[L],$.vertexViewSpaceX[I],$.vertexViewSpaceX[N],$.vertexViewSpaceY[I],$.vertexViewSpaceY[N],$.vertexViewSpaceZ[I],$.vertexViewSpaceZ[N],this.faceColour[u])}}drawNearClippedFace(u,_=!1){let m=0;if($.vertexViewSpaceZ){let N=h.centerX,H=h.centerY,G=this.faceVertexA[u],T=this.faceVertexB[u],q=this.faceVertexC[u],Q=$.vertexViewSpaceZ[G],n=$.vertexViewSpaceZ[T],J=$.vertexViewSpaceZ[q];if(Q>=50&&$.vertexScreenX&&$.vertexScreenY&&this.faceColourA)$.clippedX[m]=$.vertexScreenX[G],$.clippedY[m]=$.vertexScreenY[G],$.clippedColour[m++]=this.faceColourA[u];else if($.vertexViewSpaceX&&$.vertexViewSpaceY&&this.faceColourA){let U=$.vertexViewSpaceX[G],w=$.vertexViewSpaceY[G],k=this.faceColourA[u];if(J>=50&&this.faceColourC){let V=(50-Q)*h.divTable2[J-Q];$.clippedX[m]=N+((U+(($.vertexViewSpaceX[q]-U)*V>>16)<<9)/50|0),$.clippedY[m]=H+((w+(($.vertexViewSpaceY[q]-w)*V>>16)<<9)/50|0),$.clippedColour[m++]=k+((this.faceColourC[u]-k)*V>>16)}if(n>=50&&this.faceColourB){let V=(50-Q)*h.divTable2[n-Q];$.clippedX[m]=N+((U+(($.vertexViewSpaceX[T]-U)*V>>16)<<9)/50|0),$.clippedY[m]=H+((w+(($.vertexViewSpaceY[T]-w)*V>>16)<<9)/50|0),$.clippedColour[m++]=k+((this.faceColourB[u]-k)*V>>16)}}if(n>=50&&$.vertexScreenX&&$.vertexScreenY&&this.faceColourB)$.clippedX[m]=$.vertexScreenX[T],$.clippedY[m]=$.vertexScreenY[T],$.clippedColour[m++]=this.faceColourB[u];else if($.vertexViewSpaceX&&$.vertexViewSpaceY&&this.faceColourB){let U=$.vertexViewSpaceX[T],w=$.vertexViewSpaceY[T],k=this.faceColourB[u];if(Q>=50&&this.faceColourA){let V=(50-n)*h.divTable2[Q-n];$.clippedX[m]=N+((U+(($.vertexViewSpaceX[G]-U)*V>>16)<<9)/50|0),$.clippedY[m]=H+((w+(($.vertexViewSpaceY[G]-w)*V>>16)<<9)/50|0),$.clippedColour[m++]=k+((this.faceColourA[u]-k)*V>>16)}if(J>=50&&this.faceColourC){let V=(50-n)*h.divTable2[J-n];$.clippedX[m]=N+((U+(($.vertexViewSpaceX[q]-U)*V>>16)<<9)/50|0),$.clippedY[m]=H+((w+(($.vertexViewSpaceY[q]-w)*V>>16)<<9)/50|0),$.clippedColour[m++]=k+((this.faceColourC[u]-k)*V>>16)}}if(J>=50&&$.vertexScreenX&&$.vertexScreenY&&this.faceColourC)$.clippedX[m]=$.vertexScreenX[q],$.clippedY[m]=$.vertexScreenY[q],$.clippedColour[m++]=this.faceColourC[u];else if($.vertexViewSpaceX&&$.vertexViewSpaceY&&this.faceColourC){let U=$.vertexViewSpaceX[q],w=$.vertexViewSpaceY[q],k=this.faceColourC[u];if(n>=50&&this.faceColourB){let V=(50-J)*h.divTable2[n-J];$.clippedX[m]=N+((U+(($.vertexViewSpaceX[T]-U)*V>>16)<<9)/50|0),$.clippedY[m]=H+((w+(($.vertexViewSpaceY[T]-w)*V>>16)<<9)/50|0),$.clippedColour[m++]=k+((this.faceColourB[u]-k)*V>>16)}if(Q>=50&&this.faceColourA){let V=(50-J)*h.divTable2[Q-J];$.clippedX[m]=N+((U+(($.vertexViewSpaceX[G]-U)*V>>16)<<9)/50|0),$.clippedY[m]=H+((w+(($.vertexViewSpaceY[G]-w)*V>>16)<<9)/50|0),$.clippedColour[m++]=k+((this.faceColourA[u]-k)*V>>16)}}}let R=$.clippedX[0],b=$.clippedX[1],E=$.clippedX[2],O=$.clippedY[0],L=$.clippedY[1],I=$.clippedY[2];if((R-b)*(I-L)-(O-L)*(E-b)<=0)return;if(h.clipX=!1,m===3){if(R<0||b<0||E<0||R>K.boundX||b>K.boundX||E>K.boundX)h.clipX=!0;let N;if(!this.faceInfo)N=0;else N=this.faceInfo[u]&3;if(_)h.drawLine(R,b,O,L,$.clippedColour[0]),h.drawLine(b,E,L,I,$.clippedColour[1]),h.drawLine(E,R,I,O,$.clippedColour[2]);else if(N===0)h.gouraudTriangle(R,b,E,O,L,I,$.clippedColour[0],$.clippedColour[1],$.clippedColour[2]);else if(N===1&&this.faceColourA)h.flatTriangle(R,b,E,O,L,I,h.colourTable[this.faceColourA[u]]);else if(N===2&&this.faceInfo&&this.faceColour&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let H=this.faceInfo[u]>>2,G=this.texturedVertexA[H],T=this.texturedVertexB[H],q=this.texturedVertexC[H];h.textureTriangle(R,b,E,O,L,I,$.clippedColour[0],$.clippedColour[1],$.clippedColour[2],$.vertexViewSpaceX[G],$.vertexViewSpaceY[G],$.vertexViewSpaceZ[G],$.vertexViewSpaceX[T],$.vertexViewSpaceX[q],$.vertexViewSpaceY[T],$.vertexViewSpaceY[q],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[q],this.faceColour[u])}else if(N===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let H=this.faceInfo[u]>>2,G=this.texturedVertexA[H],T=this.texturedVertexB[H],q=this.texturedVertexC[H];h.textureTriangle(R,b,E,O,L,I,this.faceColourA[u],this.faceColourA[u],this.faceColourA[u],$.vertexViewSpaceX[G],$.vertexViewSpaceY[G],$.vertexViewSpaceZ[G],$.vertexViewSpaceX[T],$.vertexViewSpaceX[q],$.vertexViewSpaceY[T],$.vertexViewSpaceY[q],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[q],this.faceColour[u])}}else if(m===4){if(R<0||b<0||E<0||R>K.boundX||b>K.boundX||E>K.boundX||$.clippedX[3]<0||$.clippedX[3]>K.boundX)h.clipX=!0;let N;if(!this.faceInfo)N=0;else N=this.faceInfo[u]&3;if(_)h.drawLine(R,b,O,L,$.clippedColour[0]),h.drawLine(b,E,L,I,$.clippedColour[1]),h.drawLine(E,$.clippedX[3],I,$.clippedY[3],$.clippedColour[2]),h.drawLine($.clippedX[3],R,$.clippedY[3],O,$.clippedColour[3]);else if(N===0)h.gouraudTriangle(R,b,E,O,L,I,$.clippedColour[0],$.clippedColour[1],$.clippedColour[2]),h.gouraudTriangle(R,E,$.clippedX[3],O,I,$.clippedY[3],$.clippedColour[0],$.clippedColour[2],$.clippedColour[3]);else if(N===1){if(this.faceColourA){let H=h.colourTable[this.faceColourA[u]];h.flatTriangle(R,b,E,O,L,I,H),h.flatTriangle(R,E,$.clippedX[3],O,I,$.clippedY[3],H)}}else if(N===2&&this.faceInfo&&this.faceColour&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let H=this.faceInfo[u]>>2,G=this.texturedVertexA[H],T=this.texturedVertexB[H],q=this.texturedVertexC[H];h.textureTriangle(R,b,E,O,L,I,$.clippedColour[0],$.clippedColour[1],$.clippedColour[2],$.vertexViewSpaceX[G],$.vertexViewSpaceY[G],$.vertexViewSpaceZ[G],$.vertexViewSpaceX[T],$.vertexViewSpaceX[q],$.vertexViewSpaceY[T],$.vertexViewSpaceY[q],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[q],this.faceColour[u]),h.textureTriangle(R,E,$.clippedX[3],O,I,$.clippedY[3],$.clippedColour[0],$.clippedColour[2],$.clippedColour[3],$.vertexViewSpaceX[G],$.vertexViewSpaceY[G],$.vertexViewSpaceZ[G],$.vertexViewSpaceX[T],$.vertexViewSpaceX[q],$.vertexViewSpaceY[T],$.vertexViewSpaceY[q],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[q],this.faceColour[u])}else if(N===3&&this.faceInfo&&this.faceColour&&this.faceColourA&&$.vertexViewSpaceX&&$.vertexViewSpaceY&&$.vertexViewSpaceZ){let H=this.faceInfo[u]>>2,G=this.texturedVertexA[H],T=this.texturedVertexB[H],q=this.texturedVertexC[H];h.textureTriangle(R,b,E,O,L,I,this.faceColourA[u],this.faceColourA[u],this.faceColourA[u],$.vertexViewSpaceX[G],$.vertexViewSpaceY[G],$.vertexViewSpaceZ[G],$.vertexViewSpaceX[T],$.vertexViewSpaceX[q],$.vertexViewSpaceY[T],$.vertexViewSpaceY[q],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[q],this.faceColour[u]),h.textureTriangle(R,E,$.clippedX[3],O,I,$.clippedY[3],this.faceColourA[u],this.faceColourA[u],this.faceColourA[u],$.vertexViewSpaceX[G],$.vertexViewSpaceY[G],$.vertexViewSpaceZ[G],$.vertexViewSpaceX[T],$.vertexViewSpaceX[q],$.vertexViewSpaceY[T],$.vertexViewSpaceY[q],$.vertexViewSpaceZ[T],$.vertexViewSpaceZ[q],this.faceColour[u])}}}pointWithinTriangle(u,_,m,R,b,E,O,L){if(_<m&&_<R&&_<b)return!1;else if(_>m&&_>R&&_>b)return!1;else if(u<E&&u<O&&u<L)return!1;else return u<=E||u<=O||u<=L}}class m0 extends K0{static ignoreCache=!1;static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;active=!1;_active=-1;hillskew=!1;sharelight=!1;occlude=!1;static modelCacheStatic=new F0(500);static modelCacheDynamic=new F0(30);ambient=0;contrast=0;anim=-1;wallwidth=16;mapfunction=-1;mapscene=-1;resizex=128;resizey=128;resizez=128;offsetx=0;offsety=0;offsetz=0;forceapproach=0;animHasAlpha=!1;mirror=!1;shadow=!0;forcedecor=!1;breakroutefinding=!1;op=null;static unpack(u){this.data=new W(u.read("loc.dat"));let _=new W(u.read("loc.idx"));this.count=_.g2(),this.idx=new Int32Array(this.count);let m=2;for(let R=0;R<this.count;R++)this.idx[R]=m,m+=_.g2();this.cache=new r(10,null);for(let R=0;R<10;R++)this.cache[R]=new m0(-1)}static get(u){if(!this.cache||!this.idx||!this.data)throw Error();for(let m=0;m<10;m++){let R=this.cache[m];if(!R)continue;if(R.id===u)return R}this.cachePos=(this.cachePos+1)%10;let _=this.cache[this.cachePos];if(this.data.pos=this.idx[u],_.id=u,_.reset(),_.unpackType(this.data),!_.shapes)_.shapes=new Int32Array(1);if(_._active===-1&&_.shapes){if(_.active=_.shapes.length>0&&_.shapes[0]===P.CENTREPIECE_STRAIGHT.id,_.op)_.active=!0}if(_.breakroutefinding)_.blockwalk=!1,_.blockrange=!1;return _}unpack(u,_){if(u===1){let m=_.g1();this.models=new Int32Array(m),this.shapes=new Int32Array(m);for(let R=0;R<m;R++)this.models[R]=_.g2(),this.shapes[R]=_.g1()}else if(u===2)this.name=_.gjstr();else if(u===3)this.desc=_.gjstr();else if(u===14)this.width=_.g1();else if(u===15)this.length=_.g1();else if(u===17)this.blockwalk=!1;else if(u===18)this.blockrange=!1;else if(u===19){if(this._active=_.g1(),this._active===1)this.active=!0}else if(u===21)this.hillskew=!0;else if(u===22)this.sharelight=!0;else if(u===23)this.occlude=!0;else if(u===24){if(this.anim=_.g2(),this.anim===65535)this.anim=-1}else if(u===25)this.animHasAlpha=!0;else if(u===28)this.wallwidth=_.g1();else if(u===29)this.ambient=_.g1b();else if(u===39)this.contrast=_.g1b();else if(u>=30&&u<39){if(!this.op)this.op=new r(5,null);if(this.op[u-30]=_.gjstr(),this.op[u-30]?.toLowerCase()==="hidden")this.op[u-30]=null}else if(u===40){let m=_.g1();this.recol_s=new Uint16Array(m),this.recol_d=new Uint16Array(m);for(let R=0;R<m;R++)this.recol_s[R]=_.g2(),this.recol_d[R]=_.g2()}else if(u===60)this.mapfunction=_.g2();else if(u===62)this.mirror=!0;else if(u===64)this.shadow=!1;else if(u===65)this.resizex=_.g2();else if(u===66)this.resizey=_.g2();else if(u===67)this.resizez=_.g2();else if(u===68)this.mapscene=_.g2();else if(u===69)this.forceapproach=_.g1();else if(u===70)this.offsetx=_.g2b();else if(u===71)this.offsety=_.g2b();else if(u===72)this.offsetz=_.g2b();else if(u===73)this.forcedecor=!0;else if(u===74)this.breakroutefinding=!0}shapeModelsAreReady(u){if(this.shapes===null)return!0;let _=-1;for(let R=0;R<this.shapes.length;R++)if(this.shapes[R]==u){_=R;break}if(_==-1)return!0;if(this.models==null)return!0;let m=this.models[_];return m==-1?!0:$.isReady(m&65535)}modelsAreReady(){let u=!0;if(this.models==null)return!0;for(let _=0;_<this.models.length;_++){let m=this.models[_];if(m!=-1)u&&=$.isReady(m&65535)}return u}prefetch(u){if(this.models==null)return;for(let _=0;_<this.models.length;_++){let m=this.models[_];if(m!=-1)u.prefetch(0,m&65535)}}getModel(u,_,m,R,b,E,O){if(!this.shapes)return null;let L=-1;for(let J=0;J<this.shapes.length;J++)if(this.shapes[J]===u){L=J;break}if(L===-1)return null;let I=(BigInt(O)+1n<<32n)+(BigInt(this.id)<<6n)+(BigInt(L)<<3n)+BigInt(_);if(m0.ignoreCache)I=0n;let N=m0.modelCacheDynamic?.get(I);if(N){if(m0.ignoreCache)return N;if(this.hillskew||this.sharelight)N=$.modelCopyFaces(N,this.hillskew,this.sharelight);if(this.hillskew){let J=(m+R+b+E)/4|0;for(let U=0;U<N.vertexCount;U++){let w=N.vertexX[U],k=N.vertexZ[U],V=m+((R-m)*(w+64)/128|0),j=E+((b-E)*(w+64)/128|0),X=V+((j-V)*(k+64)/128|0);N.vertexY[U]+=X-J}N.calculateBoundsY()}return N}if(!this.models||L>=this.models.length)return null;let H=this.models[L];if(H===-1)return null;let G=this.mirror!==_>3;if(G)H+=65536;let T=m0.modelCacheStatic?.get(BigInt(H));if(!T){if(T=$.tryGet(H&65535),!T)return null;if(G)T.rotateY180();m0.modelCacheStatic?.put(BigInt(H),T)}let q=this.resizex!==128||this.resizey!==128||this.resizez!==128,Q=this.offsetx!==0||this.offsety!==0||this.offsetz!==0,n=$.modelShareColored(T,!this.recol_s,!this.animHasAlpha,_===0&&O===-1&&!q&&!Q);if(O!==-1)n.createLabelReferences(),n.applyTransform(O),n.labelFaces=null,n.labelVertices=null;while(_-- >0)n.rotateY90();if(this.recol_s&&this.recol_d)for(let J=0;J<this.recol_s.length;J++)n.recolour(this.recol_s[J],this.recol_d[J]);if(q)n.scale(this.resizex,this.resizey,this.resizez);if(Q)n.translate(this.offsety,this.offsetx,this.offsetz);if(n.calculateNormals((this.ambient&255)+64,(this.contrast&255)*5+768,-50,-10,-50,!this.sharelight),this.blockwalk)n.objRaise=n.minY;if(m0.modelCacheDynamic?.put(I,n),this.hillskew||this.sharelight)n=$.modelCopyFaces(n,this.hillskew,this.sharelight);if(this.hillskew){let J=(m+R+b+E)/4|0;for(let U=0;U<n.vertexCount;U++){let w=n.vertexX[U],k=n.vertexZ[U],V=m+((R-m)*(w+64)/128|0),j=E+((b-E)*(w+64)/128|0),X=V+((j-V)*(k+64)/128|0);n.vertexY[U]+=X-J}n.calculateBoundsY()}return n}reset(){this.models=null,this.shapes=null,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.width=1,this.length=1,this.blockwalk=!0,this.blockrange=!0,this.active=!1,this._active=-1,this.hillskew=!1,this.sharelight=!1,this.occlude=!1,this.anim=-1,this.wallwidth=16,this.ambient=0,this.contrast=0,this.op=null,this.animHasAlpha=!1,this.mapfunction=-1,this.mapscene=-1,this.mirror=!1,this.shadow=!0,this.resizex=128,this.resizey=128,this.resizez=128,this.forceapproach=0,this.offsetx=0,this.offsety=0,this.offsetz=0,this.forcedecor=!1,this.breakroutefinding=!1}}async function Wu(u){if(u[0]!==255)u[0]=255;URL.revokeObjectURL(z0.src),z0.src=URL.createObjectURL(new Blob([u],{type:"image/jpeg"})),await new Promise((R)=>z0.onload=()=>R()),uu.clearRect(0,0,p0.width,p0.height);let _=z0.naturalWidth,m=z0.naturalHeight;return p0.width=_,p0.height=m,uu.drawImage(z0,0,0),uu.getImageData(0,0,_,m)}class R0 extends K{pixels;cropRight;cropBottom;cropLeft;cropTop;width;height;constructor(u,_){super();this.pixels=new Int32Array(u*_),this.cropRight=this.width=u,this.cropBottom=this.height=_,this.cropLeft=this.cropTop=0}static async fromJpeg(u,_){let m=u.read(_+".dat");if(!m)throw Error();let R=await Wu(m),b=new R0(R.width,R.height),E=new Uint32Array(R.data.buffer),O=b.pixels;for(let L=0;L<O.length;L++){let I=E[L];O[L]=(I>>24&255)<<24|(I&255)<<16|(I>>8&255)<<8|I>>16&255}return b}static fromArchive(u,_,m=0){let R=new W(u.read(_+".dat")),b=new W(u.read("index.dat"));b.pos=R.g2();let E=b.g2(),O=b.g2(),L=b.g1(),I=[],N=L-1;for(let J=0;J<N;J++)if(I[J+1]=b.g3(),I[J+1]===0)I[J+1]=1;for(let J=0;J<m;J++)b.pos+=2,R.pos+=b.g2()*b.g2(),b.pos+=1;if(R.pos>R.length||b.pos>b.length)throw Error();let H=b.g1(),G=b.g1(),T=b.g2(),q=b.g2(),Q=new R0(T,q);Q.cropLeft=H,Q.cropTop=G,Q.width=E,Q.height=O;let n=b.g1();if(n===0){let J=Q.cropRight*Q.cropBottom;for(let U=0;U<J;U++)Q.pixels[U]=I[R.g1()]}else if(n===1){let J=Q.cropRight;for(let U=0;U<J;U++){let w=Q.cropBottom;for(let k=0;k<w;k++)Q.pixels[U+k*J]=I[R.g1()]}}return Q}bind(){K.bind(this.pixels,this.cropRight,this.cropBottom)}draw(u,_){u|=0,_|=0,u+=this.cropLeft,_+=this.cropTop;let m=u+_*K.width2d,R=0,b=this.cropBottom,E=this.cropRight,O=K.width2d-E,L=0;if(_<K.top){let I=K.top-_;b-=I,_=K.top,R+=I*E,m+=I*K.width2d}if(_+b>K.bottom)b-=_+b-K.bottom;if(u<K.left){let I=K.left-u;E-=I,u=K.left,R+=I,m+=I,L+=I,O+=I}if(u+E>K.right){let I=u+E-K.right;E-=I,L+=I,O+=I}if(E>0&&b>0)this.copyImageDraw(E,b,this.pixels,R,L,K.pixels,m,O)}drawAlpha(u,_,m){_|=0,m|=0,_+=this.cropLeft,m+=this.cropTop;let R=_+m*K.width2d,b=0,E=this.cropBottom,O=this.cropRight,L=K.width2d-O,I=0;if(m<K.top){let N=K.top-m;E-=N,m=K.top,b+=N*O,R+=N*K.width2d}if(m+E>K.bottom)E-=m+E-K.bottom;if(_<K.left){let N=K.left-_;O-=N,_=K.left,b+=N,R+=N,I+=N,L+=N}if(_+O>K.right){let N=_+O-K.right;O-=N,I+=N,L+=N}if(O>0&&E>0)this.copyPixelsAlpha(O,E,this.pixels,b,I,K.pixels,R,L,u)}blitOpaque(u,_){u|=0,_|=0,u+=this.cropLeft,_+=this.cropTop;let m=u+_*K.width2d,R=0,b=this.cropBottom,E=this.cropRight,O=K.width2d-E,L=0;if(_<K.top){let I=K.top-_;b-=I,_=K.top,R+=I*E,m+=I*K.width2d}if(_+b>K.bottom)b-=_+b-K.bottom;if(u<K.left){let I=K.left-u;E-=I,u=K.left,R+=I,m+=I,L+=I,O+=I}if(u+E>K.right){let I=u+E-K.right;E-=I,L+=I,O+=I}if(E>0&&b>0)this.copyImageBlitOpaque(E,b,this.pixels,R,L,K.pixels,m,O)}flipHorizontally(){let u=this.pixels,_=this.cropRight,m=this.cropBottom;for(let R=0;R<m;R++){let b=_/2|0;for(let E=0;E<b;E++){let O=E+R*_,L=_-E-1+R*_,I=u[O];u[O]=u[L],u[L]=I}}}flipVertically(){let u=this.pixels,_=this.cropRight,m=this.cropBottom;for(let R=0;R<(m/2|0);R++)for(let b=0;b<_;b++){let E=b+R*_,O=b+(m-R-1)*_,L=u[E];u[E]=u[O],u[O]=L}}translate2d(u,_,m){for(let R=0;R<this.pixels.length;R++){let b=this.pixels[R];if(b!==0){let E=b>>16&255;if(E+=u,E<1)E=1;else if(E>255)E=255;let O=b>>8&255;if(O+=_,O<1)O=1;else if(O>255)O=255;let L=b&255;if(L+=m,L<1)L=1;else if(L>255)L=255;this.pixels[R]=(E<<16)+(O<<8)+L}}}crop(){let u=new Int32Array(this.width*this.height);for(let _=0;_<this.cropBottom;_++)for(let m=0;m<this.cropRight;m++)u[(this.cropTop+_)*this.width+this.cropLeft+m]=this.pixels[this.cropRight*_+m];this.pixels=u,this.cropRight=this.width,this.cropBottom=this.height,this.cropLeft=0,this.cropTop=0}drawRotated(u,_,m,R,b,E,O,L){L|=0,u|=0,E|=0,O|=0;try{let I=-E/2|0,N=-O/2|0,H=Math.sin(_)*65536|0,G=Math.cos(_)*65536|0,T=H*m>>8,q=G*m>>8,Q=(R<<16)+(N*T+I*q),n=(b<<16)+(N*q-I*T),J=L+u*K.width2d;for(let U=0;U<O;U++){let w=J,k=Q,V=n;for(let j=-E;j<0;j++){let X=this.pixels[(k>>16)+(V>>16)*this.width];if(X==0)w++;else K.pixels[w++]=X;k+=q,V-=T}Q+=T,n+=q,J+=K.width2d}}catch(I){}}drawRotatedMasked(u,_,m,R,b,E,O,L,I,N){u|=0,_|=0,m|=0,R|=0;try{let H=-m/2|0,G=-R/2|0,T=Math.sin(I/326.11)*65536|0,q=Math.cos(I/326.11)*65536|0,Q=T*N>>8,n=q*N>>8,J=(O<<16)+G*Q+H*n,U=(L<<16)+(G*n-H*Q),w=u+_*K.width2d;for(let k=0;k<R;k++){let V=b[k],j=w+V,X=J+n*V,A=U-Q*V;for(let Z=-E[k];Z<0;Z++)K.pixels[j++]=this.pixels[(X>>16)+(A>>16)*this.cropRight],X+=n,A-=Q;J+=Q,U+=n,w+=K.width2d}}catch(H){}}drawMasked(u,_,m){u|=0,_|=0,u+=this.cropLeft,_+=this.cropTop;let R=u+_*K.width2d,b=0,E=this.cropBottom,O=this.cropRight,L=K.width2d-O,I=0;if(_<K.top){let N=K.top-_;E-=N,_=K.top,b+=N*O,R+=N*K.width2d}if(_+E>K.bottom)E-=_+E-K.bottom;if(u<K.left){let N=K.left-u;O-=N,u=K.left,b+=N,R+=N,I+=N,L+=N}if(u+O>K.right){let N=u+O-K.right;O-=N,I+=N,L+=N}if(O>0&&E>0)this.copyPixelsMasked(O,E,this.pixels,I,b,K.pixels,R,L,m.pixels)}scale(u,_,m,R,b,E,O,L,I,N,H){try{let G=R;for(let T=-_;T<0;T++){let q=(b>>16)*I;for(let Q=-u;Q<0;Q++){let n=m[(R>>16)+q];if(n===0)L++;else E[L++]=n;R+=N}b+=H,R=G,L+=O}}catch(G){}}copyImageBlitOpaque(u,_,m,R,b,E,O,L){let I=-(u>>2);u=-(u&3);for(let N=-_;N<0;N++){for(let H=I;H<0;H++)E[O++]=m[R++],E[O++]=m[R++],E[O++]=m[R++],E[O++]=m[R++];for(let H=u;H<0;H++)E[O++]=m[R++];O+=L,R+=b}}copyPixelsAlpha(u,_,m,R,b,E,O,L,I){let N=256-I;for(let H=-_;H<0;H++){for(let G=-u;G<0;G++){let T=m[R++];if(T===0)O++;else{let q=E[O];E[O++]=((T&16711935)*I+(q&16711935)*N&4278255360)+((T&65280)*I+(q&65280)*N&16711680)>>8}}O+=L,R+=b}}copyImageDraw(u,_,m,R,b,E,O,L){let I=-(u>>2);u=-(u&3);for(let N=-_;N<0;N++){for(let H=I;H<0;H++){let G=m[R++];if(G===0)O++;else E[O++]=G;if(G=m[R++],G===0)O++;else E[O++]=G;if(G=m[R++],G===0)O++;else E[O++]=G;if(G=m[R++],G===0)O++;else E[O++]=G}for(let H=u;H<0;H++){let G=m[R++];if(G===0)O++;else E[O++]=G}O+=L,R+=b}}copyPixelsMasked(u,_,m,R,b,E,O,L,I){let N=-(u>>2);u=-(u&3);for(let H=-_;H<0;H++){for(let G=N;G<0;G++){let T=m[b++];if(T!==0&&I[O]===0)E[O++]=T;else O++;if(T=m[b++],T!==0&&I[O]===0)E[O++]=T;else O++;if(T=m[b++],T!==0&&I[O]===0)E[O++]=T;else O++;if(T=m[b++],T!==0&&I[O]===0)E[O++]=T;else O++}for(let G=u;G<0;G++){let T=m[b++];if(T!==0&&I[O]===0)E[O++]=T;else O++}O+=L,b+=R}}}class l extends K0{static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;static membersWorld=!0;model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2000;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;static modelCache=new F0(50);static iconCache=new F0(200);manwearOffsetY=0;womanwearOffsetY=0;manwear=-1;manwear2=-1;womanwear=-1;womanwear2=-1;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;certlink=-1;certtemplate=-1;resizex=0;resizey=0;resizez=0;ambient=0;contrast=0;countobj=null;countco=null;op=null;iop=null;static unpack(u,_){this.membersWorld=_,this.data=new W(u.read("obj.dat"));let m=new W(u.read("obj.idx"));this.count=m.g2(),this.idx=new Int32Array(this.count);let R=2;for(let b=0;b<this.count;b++)this.idx[b]=R,R+=m.g2();this.cache=new r(10,null);for(let b=0;b<10;b++)this.cache[b]=new l(-1)}static get(u){if(!this.cache||!this.idx||!this.data)throw Error();for(let m=0;m<10;m++){let R=this.cache[m];if(R&&R.id===u)return R}this.cachePos=(this.cachePos+1)%10;let _=this.cache[this.cachePos];if(this.data.pos=this.idx[u],_.id=u,_.reset(),_.unpackType(this.data),_.certtemplate!==-1)_.toCertificate();if(!this.membersWorld&&_.members)_.name="Members Object",_.desc="Login to a members' server to use this object.",_.op=null,_.iop=null;return _}reset(){this.model=0,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.zoom2d=2000,this.xan2d=0,this.yan2d=0,this.zan2d=0,this.xof2d=0,this.yof2d=0,this.code9=!1,this.code10=-1,this.stackable=!1,this.cost=1,this.members=!1,this.op=null,this.iop=null,this.manwear=-1,this.manwear2=-1,this.manwearOffsetY=0,this.womanwear=-1,this.womanwear2=-1,this.womanwearOffsetY=0,this.manwear3=-1,this.womanwear3=-1,this.manhead=-1,this.manhead2=-1,this.womanhead=-1,this.womanhead2=-1,this.countobj=null,this.countco=null,this.certlink=-1,this.certtemplate=-1,this.resizex=128,this.resizey=128,this.resizez=128,this.ambient=0,this.contrast=0}unpack(u,_){if(u===1)this.model=_.g2();else if(u===2)this.name=_.gjstr();else if(u===3)this.desc=_.gjstr();else if(u===4)this.zoom2d=_.g2();else if(u===5)this.xan2d=_.g2();else if(u===6)this.yan2d=_.g2();else if(u===7){if(this.xof2d=_.g2b(),this.xof2d>32767)this.xof2d-=65536}else if(u===8){if(this.yof2d=_.g2b(),this.yof2d>32767)this.yof2d-=65536}else if(u===9)this.code9=!0;else if(u===10)this.code10=_.g2();else if(u===11)this.stackable=!0;else if(u===12)this.cost=_.g4();else if(u===16)this.members=!0;else if(u===23)this.manwear=_.g2(),this.manwearOffsetY=_.g1b();else if(u===24)this.manwear2=_.g2();else if(u===25)this.womanwear=_.g2(),this.womanwearOffsetY=_.g1b();else if(u===26)this.womanwear2=_.g2();else if(u>=30&&u<35){if(!this.op)this.op=new r(5,null);if(this.op[u-30]=_.gjstr(),this.op[u-30]?.toLowerCase()==="hidden")this.op[u-30]=null}else if(u>=35&&u<40){if(!this.iop)this.iop=new r(5,null);this.iop[u-35]=_.gjstr()}else if(u===40){let m=_.g1();this.recol_s=new Uint16Array(m),this.recol_d=new Uint16Array(m);for(let R=0;R<m;R++)this.recol_s[R]=_.g2(),this.recol_d[R]=_.g2()}else if(u===78)this.manwear3=_.g2();else if(u===79)this.womanwear3=_.g2();else if(u===90)this.manhead=_.g2();else if(u===91)this.womanhead=_.g2();else if(u===92)this.manhead2=_.g2();else if(u===93)this.womanhead2=_.g2();else if(u===95)this.zan2d=_.g2();else if(u===97)this.certlink=_.g2();else if(u===98)this.certtemplate=_.g2();else if(u>=100&&u<110){if(!this.countobj||!this.countco)this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10);this.countobj[u-100]=_.g2(),this.countco[u-100]=_.g2()}else if(u===110)this.resizex=_.g2();else if(u===111)this.resizey=_.g2();else if(u===112)this.resizez=_.g2();else if(u===113)this.ambient=_.g1b();else if(u===114)this.contrast=_.g1b()*5}toCertificate(){let u=l.get(this.certtemplate);this.model=u.model,this.zoom2d=u.zoom2d,this.xan2d=u.xan2d,this.yan2d=u.yan2d,this.zan2d=u.zan2d,this.xof2d=u.xof2d,this.yof2d=u.yof2d,this.recol_s=u.recol_s,this.recol_d=u.recol_d;let _=l.get(this.certlink);this.name=_.name,this.members=_.members,this.cost=_.cost;let m="a",R=(_.name||"").toLowerCase().charAt(0);if(R==="a"||R==="e"||R==="i"||R==="o"||R==="u")m="an";this.desc=`Swap this note at any bank for ${m} ${_.name}.`,this.stackable=!0}getModel(u){if(this.countobj&&this.countco&&u>1){let m=-1;for(let R=0;R<10;R++)if(u>=this.countco[R]&&this.countco[R]!==0)m=this.countobj[R];if(m!==-1)return l.get(m).getModel(1)}let _=null;if(l.modelCache){if(_=l.modelCache.get(BigInt(this.id)),_)return _}if(_=$.tryGet(this.model),!_)return null;if(this.resizex!==128||this.resizey!==128||this.resizez!==128)_.scale(this.resizex,this.resizey,this.resizez);if(this.recol_s&&this.recol_d)for(let m=0;m<this.recol_s.length;m++)_.recolour(this.recol_s[m],this.recol_d[m]);if(_.calculateNormals(this.ambient+64,this.contrast+768,-50,-10,-50,!0),_.picking=!0,l.modelCache)l.modelCache.put(BigInt(this.id),_);return _}getInvModel(u){if(this.countobj&&this.countco&&u>1){let m=-1;for(let R=0;R<10;R++)if(u>=this.countco[R]&&this.countco[R]!==0)m=this.countobj[R];if(m!==-1)return l.get(m).getInvModel(1)}let _=$.tryGet(this.model);if(!_)return null;if(this.recol_s&&this.recol_d)for(let m=0;m<this.recol_s.length;m++)_.recolour(this.recol_s[m],this.recol_d[m]);return _}static getIcon(u,_,m){if(l.iconCache&&m===0){let V=l.iconCache.get(BigInt(u));if(V&&V.height!==_&&V.height!==-1)V.unlink(),V=null;if(V)return V}let R=l.get(u);if(!R.countobj)_=-1;if(R.countobj&&R.countco&&_>1){let V=-1;for(let j=0;j<10;j++)if(_>=R.countco[j]&&R.countco[j]!==0)V=R.countobj[j];if(V!==-1)R=l.get(V)}let b=R.getModel(1);if(!b)return null;let E=null;if(R.certtemplate!==-1){if(E=this.getIcon(R.certlink,10,-1),!E)return null}let O=new R0(32,32),L=h.centerX,I=h.centerY,N=h.lineOffset,H=K.pixels,G=K.width2d,T=K.height2d,q=K.left,Q=K.right,n=K.top,J=K.bottom;h.jagged=!1,K.bind(O.pixels,32,32),K.fillRect2d(0,0,32,32,0),h.init2D();let U=R.zoom2d;if(m===-1)U=U*1.5|0;else if(m>0)U=U*1.04|0;let w=h.sinTable[R.xan2d]*U>>16,k=h.cosTable[R.xan2d]*U>>16;b.drawSimple(0,R.yan2d,R.zan2d,R.xan2d,R.xof2d,w+(b.minY/2|0)+R.yof2d,k+R.yof2d);for(let V=31;V>=0;V--)for(let j=31;j>=0;j--){if(O.pixels[V+j*32]!==0)continue;if(V>0&&O.pixels[V+j*32-1]>1)O.pixels[V+j*32]=1;else if(j>0&&O.pixels[V+(j-1)*32]>1)O.pixels[V+j*32]=1;else if(V<31&&O.pixels[V+j*32+1]>1)O.pixels[V+j*32]=1;else if(j<31&&O.pixels[V+(j+1)*32]>1)O.pixels[V+j*32]=1}if(m>0)for(let V=31;V>=0;V--)for(let j=31;j>=0;j--){if(O.pixels[V+j*32]!==0)continue;if(V>0&&O.pixels[V+j*32-1]===1)O.pixels[V+j*32]=m;else if(j>0&&O.pixels[V+(j-1)*32]===1)O.pixels[V+j*32]=m;else if(V<31&&O.pixels[V+j*32+1]===1)O.pixels[V+j*32]=m;else if(j<31&&O.pixels[V+(j+1)*32]===1)O.pixels[V+j*32]=m}else for(let V=31;V>=0;V--)for(let j=31;j>=0;j--)if(O.pixels[V+j*32]===0&&V>0&&j>0&&O.pixels[V+(j-1)*32-1]>0)O.pixels[V+j*32]=3153952;if(E&&R.certtemplate!==-1){let{width:V,height:j}=E;E.width=32,E.height=32,E.draw(0,0),E.width=V,E.height=j}if(l.iconCache&&m===0)l.iconCache.put(BigInt(u),O);if(K.bind(H,G,T),K.setBounds(q,n,Q,J),h.centerX=L,h.centerY=I,h.lineOffset=N,h.jagged=!0,R.stackable)O.width=33;else O.width=32;return O.height=_,O}wornModelIsReady(u){let _=this.manwear,m=this.manwear2,R=this.manwear3;if(u==1)_=this.womanwear,m=this.womanwear2,R=this.womanwear3;if(_==-1)return!0;let b=!0;if(!$.isReady(_))b=!1;if(m!=-1&&!$.isReady(m))b=!1;if(R!=-1&&!$.isReady(R))b=!1;return b}getWornModel(u){let _=this.manwear;if(u===1)_=this.womanwear;if(_===-1)return null;let m=this.manwear2,R=this.manwear3;if(u===1)m=this.womanwear2,R=this.womanwear3;let b=$.tryGet(_);if(!b)return null;if(m!==-1){let E=$.tryGet(m);if(!E)return null;if(R===-1){let O=[b,E];b=$.modelFromModels(O,2)}else{let O=$.tryGet(R);if(!O)return null;let L=[b,E,O];b=$.modelFromModels(L,3)}}if(u===0&&this.manwearOffsetY!==0)b.translate(this.manwearOffsetY,0,0);else if(u===1&&this.womanwearOffsetY!==0)b.translate(this.womanwearOffsetY,0,0);if(this.recol_s&&this.recol_d)for(let E=0;E<this.recol_s.length;E++)b.recolour(this.recol_s[E],this.recol_d[E]);return b}headModelIsReady(u){let _=this.manhead,m=this.manhead2;if(u==1)_=this.womanhead,m=this.womanhead2;if(_==-1)return!0;let R=!0;if(!$.isReady(_))R=!1;if(m!=-1&&!$.isReady(m))R=!1;return R}getHeadModel(u){let _=this.manhead;if(u===1)_=this.womanhead;if(_===-1)return null;let m=this.manhead2;if(u===1)m=this.womanhead2;let R=$.tryGet(_);if(!R)return null;if(m!==-1){let b=$.tryGet(m);if(!b)return null;let E=[R,b];R=$.modelFromModels(E,2)}if(this.recol_s&&this.recol_d)for(let b=0;b<this.recol_s.length;b++)R.recolour(this.recol_s[b],this.recol_d[b]);return R}}class j0 extends K0{static count=0;static idx=null;static data=null;static cache=null;static cachePos=0;name=null;desc=null;size=1;models=null;heads=null;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;animHasAlpha=!1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;alwaysontop=!1;headicon=-1;static modelCache=new F0(30);ambient=0;contrast=0;static unpack(u){this.data=new W(u.read("npc.dat"));let _=new W(u.read("npc.idx"));this.count=_.g2(),this.idx=new Int32Array(this.count);let m=2;for(let R=0;R<this.count;R++)this.idx[R]=m,m+=_.g2();this.cache=new r(20,null);for(let R=0;R<20;R++)this.cache[R]=new j0(-1)}static get(u){if(!this.cache||!this.idx||!this.data)throw Error();for(let m=0;m<20;m++){let R=this.cache[m];if(R&&R.id===u)return R}this.cachePos=(this.cachePos+1)%20;let _=this.cache[this.cachePos]=new j0(u);return this.data.pos=this.idx[u],_.unpackType(this.data),_}unpack(u,_){if(u===1){let m=_.g1();this.models=new Uint16Array(m);for(let R=0;R<m;R++)this.models[R]=_.g2()}else if(u===2)this.name=_.gjstr();else if(u===3)this.desc=_.gjstr();else if(u===12)this.size=_.g1b();else if(u===13)this.readyanim=_.g2();else if(u===14)this.walkanim=_.g2();else if(u===16)this.animHasAlpha=!0;else if(u===17)this.walkanim=_.g2(),this.walkanim_b=_.g2(),this.walkanim_r=_.g2(),this.walkanim_l=_.g2();else if(u>=30&&u<40){if(!this.op)this.op=new r(5,null);if(this.op[u-30]=_.gjstr(),this.op[u-30]?.toLowerCase()==="hidden")this.op[u-30]=null}else if(u===40){let m=_.g1();this.recol_s=new Uint16Array(m),this.recol_d=new Uint16Array(m);for(let R=0;R<m;R++)this.recol_s[R]=_.g2(),this.recol_d[R]=_.g2()}else if(u===60){let m=_.g1();this.heads=new Uint16Array(m);for(let R=0;R<m;R++)this.heads[R]=_.g2()}else if(u===90)this.resizex=_.g2();else if(u===91)this.resizey=_.g2();else if(u===92)this.resizez=_.g2();else if(u===93)this.minimap=!1;else if(u===95)this.vislevel=_.g2();else if(u===97)this.resizeh=_.g2();else if(u===98)this.resizev=_.g2();else if(u===99)this.alwaysontop=!0;else if(u===100)this.ambient=_.g1b();else if(u===101)this.contrast=_.g1b()*5;else if(u===102)this.headicon=_.g2()}getModel(u,_,m){let R=null;if(j0.modelCache){if(R=j0.modelCache.get(BigInt(this.id)),!R&&this.models){let E=!1;for(let L=0;L<this.models.length;L++)if(!$.isReady(this.models[L]))E=!0;if(E)return null;let O=new r(this.models.length,null);for(let L=0;L<this.models.length;L++)O[L]=$.tryGet(this.models[L]);if(O.length===1)R=O[0];else R=$.modelFromModels(O,O.length);if(R){if(this.recol_s&&this.recol_d)for(let L=0;L<this.recol_s.length;L++)R.recolour(this.recol_s[L],this.recol_d[L]);R.createLabelReferences(),R.calculateNormals(64,850,-30,-50,-30,!0),j0.modelCache.put(BigInt(this.id),R)}}}let b=null;if(R){if(b=$.modelShareAlpha(R,!this.animHasAlpha),u!==-1&&_!==-1)b.applyTransforms(u,_,m);else if(u!==-1)b.applyTransform(u);if(this.resizeh!==128||this.resizev!==128)b.scale(this.resizeh,this.resizev,this.resizeh);if(b.calculateBoundsCylinder(),b.labelFaces=null,b.labelVertices=null,this.size===1)b.picking=!0}return b}getHeadModel(){if(!this.heads)return null;let u=!1;for(let R=0;R<this.heads.length;R++)if(!$.isReady(this.heads[R]))u=!0;if(u)return null;let _=new r(this.heads.length,null);for(let R=0;R<this.heads.length;R++)_[R]=$.tryGet(this.heads[R]);let m;if(_.length===1)m=_[0];else m=$.modelFromModels(_,_.length);if(m&&this.recol_s&&this.recol_d)for(let R=0;R<this.recol_s.length;R++)m.recolour(this.recol_s[R],this.recol_d[R]);return m}}class U0 extends K0{static count=0;static types=[];type=-1;models=null;recol_s=new Int32Array(6);recol_d=new Int32Array(6);heads=new Int32Array(5).fill(-1);disable=!1;static unpack(u){let _=new W(u.read("idk.dat"));this.count=_.g2(),this.types=Array(this.count);for(let m=0;m<this.count;m++){if(!this.types[m])this.types[m]=new U0(m);this.types[m].unpackType(_)}}unpack(u,_){if(u===1)this.type=_.g1();else if(u===2){let m=_.g1();this.models=new Int32Array(m);for(let R=0;R<m;R++)this.models[R]=_.g2()}else if(u===3)this.disable=!0;else if(u>=40&&u<50)this.recol_s[u-40]=_.g2();else if(u>=50&&u<60)this.recol_d[u-50]=_.g2();else if(u>=60&&u<70)this.heads[u-60]=_.g2()}modelIsReady(){if(!this.models)return!0;let u=!0;for(let _=0;_<this.models.length;_++)if(!$.isReady(this.models[_]))u=!1;return u}getModel(){if(!this.models)return null;let u=new r(this.models.length,null);for(let m=0;m<this.models.length;m++)u[m]=$.tryGet(this.models[m]);let _;if(u.length===1)_=u[0];else _=$.modelFromModels(u,u.length);for(let m=0;m<6&&this.recol_s[m]!==0;m++)_?.recolour(this.recol_s[m],this.recol_d[m]);return _}headModelIsReady(){let u=!0;for(let _=0;_<this.heads.length;_++)if(this.heads[_]!=-1&&!$.isReady(this.heads[_]))u=!1;return u}getHeadModel(){let u=0,_=new r(5,null);for(let R=0;R<5;R++)if(this.heads[R]!==-1)_[u++]=$.tryGet(this.heads[R]);let m=$.modelFromModels(_,u);for(let R=0;R<6&&this.recol_s[R]!==0;R++)m.recolour(this.recol_s[R],this.recol_d[R]);return m}}class n0 extends K0{static count=0;static types=[];model=0;anim=-1;seq=null;animHasAlpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;angle=0;ambient=0;contrast=0;static modelCache=new F0(30);static unpack(u){let _=new W(u.read("spotanim.dat"));this.count=_.g2();for(let m=0;m<this.count;m++)this.types[m]=new n0(m).unpackType(_)}unpack(u,_){if(u===1)this.model=_.g2();else if(u===2){if(this.anim=_.g2(),o.types)this.seq=o.types[this.anim]}else if(u===3)this.animHasAlpha=!0;else if(u===4)this.resizeh=_.g2();else if(u===5)this.resizev=_.g2();else if(u===6)this.angle=_.g2();else if(u===7)this.ambient=_.g1();else if(u===8)this.contrast=_.g1();else if(u>=40&&u<50)this.recol_s[u-40]=_.g2();else if(u>=50&&u<60)this.recol_d[u-50]=_.g2()}getModel(){let u=null;if(n0.modelCache){if(u=n0.modelCache.get(BigInt(this.id)),u)return u}if(u=$.tryGet(this.model),!u)return null;for(let _=0;_<6;_++)if(this.recol_s[0]!==0)u.recolour(this.recol_s[_],this.recol_d[_]);if(n0.modelCache)n0.modelCache.put(BigInt(this.id),u);return u}}class S0 extends K0{static count=0;static types=[];static code3s=[];static code3Count=0;code1=0;code2=0;code3=!1;code4=!0;clientcode=0;code7=0;code6=!1;code8=!1;code11=!1;static unpack(u){let _=new W(u.read("varp.dat"));this.count=_.g2();for(let m=0;m<this.count;m++)this.types[m]=new S0(m).unpackType(_)}unpack(u,_){if(u===1)this.code1=_.g1();else if(u===2)this.code2=_.g1();else if(u===3)this.code3=!0,S0.code3s[S0.code3Count++]=this.id;else if(u===4)this.code4=!1;else if(u===5)this.clientcode=_.g2();else if(u===6)this.code6=!0;else if(u===7)this.code7=_.g4();else if(u===8)this.code8=!0,this.code11=!0;else if(u===10)this.debugname=_.gjstr();else if(u===11)this.code11=!0}}class c{static BASE37_LOOKUP=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];static toBase37(u){u=u.trim();let _=0n;for(let m=0;m<u.length&&m<12;m++){let R=u.charCodeAt(m);if(_*=37n,R>=65&&R<=90)_+=BigInt(R+1-65);else if(R>=97&&R<=122)_+=BigInt(R+1-97);else if(R>=48&&R<=57)_+=BigInt(R+27-48)}return _}static fromBase37(u){if(u<0n||u>=6582952005840035281n)return"invalid_name";if(u%37n===0n)return"invalid_name";let _=0,m=Array(12);while(u!==0n){let R=u;u/=37n,m[11-_++]=this.BASE37_LOOKUP[Number(R-u*37n)]}return m.slice(12-_).join("")}static toSentenceCase(u){let _=[...u.toLowerCase()],m=!0;for(let R=0;R<_.length;R++){let b=_[R];if(m&&b>="a"&&b<="z")_[R]=b.toUpperCase(),m=!1;if(b==="."||b==="!")m=!0}return _.join("")}static toAsterisks(u){let _="";for(let m=0;m<u.length;m++)_=_+"*";return _}static formatIPv4(u){return(u>>24&255)+"."+(u>>16&255)+"."+(u>>8&255)+"."+(u&255)}static formatName(u){if(u.length===0)return u;let _=[...u];for(let m=0;m<_.length;m++)if(_[m]==="_"){if(_[m]=" ",m+1<_.length&&_[m+1]>="a"&&_[m+1]<="z")_[m+1]=String.fromCharCode(_[m+1].charCodeAt(0)+65-97)}if(_[0]>="a"&&_[0]<="z")_[0]=String.fromCharCode(_[0].charCodeAt(0)+65-97);return _.join("")}static hashCode(u){let _=u.toUpperCase(),m=0n;for(let R=0;R<_.length;R++)m=m*61n+BigInt(_.charCodeAt(R))-32n,m=m+(m>>56n)&0xffffffffffffffn;return m}}class g{static types=[];invSlotObjId=null;invSlotObjCount=null;seqFrame=0;seqCycle=0;id=-1;layer=-1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;alpha=0;x=0;y=0;scripts=null;scriptComparator=null;scriptOperand=null;overlayer=-1;scroll=0;scrollPosition=0;hide=!1;children=null;activeModelType=0;activeModel=0;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;targetVerb=null;targetText=null;targetMask=-1;option=null;static modelCache=new F0(30);static imageCache=null;marginX=0;marginY=0;colour=0;activeColour=0;overColour=0;activeOverColour=0;modelType=0;model=0;graphic=null;activeGraphic=null;font=null;text=null;activeText=null;draggable=!1;interactable=!1;usable=!1;swappable=!1;fill=!1;center=!1;shadowed=!1;invSlotOffsetX=null;invSlotOffsetY=null;childX=null;childY=null;invSlotGraphic=null;iop=null;static unpack(u,_,m){this.imageCache=new F0(50000);let R=new W(u.read("data")),b=-1,E=R.g2();this.types=Array(E);while(R.pos<R.length){let O=R.g2();if(O===65535)b=R.g2(),O=R.g2();let L=this.types[O]=new g;if(L.id=O,L.layer=b,L.type=R.g1(),L.buttonType=R.g1(),L.clientCode=R.g2(),L.width=R.g2(),L.height=R.g2(),L.alpha=R.g1(),L.overlayer=R.g1(),L.overlayer===0)L.overlayer=-1;else L.overlayer=(L.overlayer-1<<8)+R.g1();let I=R.g1();if(I>0){L.scriptComparator=new Uint8Array(I),L.scriptOperand=new Uint16Array(I);for(let H=0;H<I;H++)L.scriptComparator[H]=R.g1(),L.scriptOperand[H]=R.g2()}let N=R.g1();if(N>0){L.scripts=new r(N,null);for(let H=0;H<N;H++){let G=R.g2(),T=new Uint16Array(G);L.scripts[H]=T;for(let q=0;q<G;q++)T[q]=R.g2()}}if(L.type===0){L.scroll=R.g2(),L.hide=R.g1()===1;let H=R.g2();L.children=Array(H),L.childX=Array(H),L.childY=Array(H);for(let G=0;G<H;G++)L.children[G]=R.g2(),L.childX[G]=R.g2b(),L.childY[G]=R.g2b()}if(L.type===1)R.pos+=3;if(L.type===2){L.invSlotObjId=new Int32Array(L.width*L.height),L.invSlotObjCount=new Int32Array(L.width*L.height),L.draggable=R.g1()===1,L.interactable=R.g1()===1,L.usable=R.g1()===1,L.swappable=R.g1()===1,L.marginX=R.g1(),L.marginY=R.g1(),L.invSlotOffsetX=new Int16Array(20),L.invSlotOffsetY=new Int16Array(20),L.invSlotGraphic=new r(20,null);for(let H=0;H<20;H++)if(R.g1()===1){L.invSlotOffsetX[H]=R.g2b(),L.invSlotOffsetY[H]=R.g2b();let G=R.gjstr();if(_&&G.length>0){let T=G.lastIndexOf(",");L.invSlotGraphic[H]=this.getImage(_,G.substring(0,T),parseInt(G.substring(T+1)))}}L.iop=new r(5,null);for(let H=0;H<5;H++)if(L.iop[H]=R.gjstr(),L.iop[H].length===0)L.iop[H]=null}if(L.type===3)L.fill=R.g1()===1;if(L.type===4||L.type===1){L.center=R.g1()===1;let H=R.g1();if(m)L.font=m[H];L.shadowed=R.g1()===1}if(L.type===4)L.text=R.gjstr(),L.activeText=R.gjstr();if(L.type===1||L.type===3||L.type===4)L.colour=R.g4();if(L.type===3||L.type===4)L.activeColour=R.g4(),L.overColour=R.g4(),L.activeOverColour=R.g4();if(L.type===5){let H=R.gjstr();if(_&&H.length>0){let T=H.lastIndexOf(",");L.graphic=this.getImage(_,H.substring(0,T),parseInt(H.substring(T+1),10))}let G=R.gjstr();if(_&&G.length>0){let T=G.lastIndexOf(",");L.activeGraphic=this.getImage(_,G.substring(0,T),parseInt(G.substring(T+1),10))}}if(L.type===6){let H=R.g1();if(H!==0)L.modelType=1,L.model=(H-1<<8)+R.g1();let G=R.g1();if(G!==0)L.activeModelType=1,L.activeModel=(G-1<<8)+R.g1();if(L.anim=R.g1(),L.anim===0)L.anim=-1;else L.anim=(L.anim-1<<8)+R.g1();if(L.activeAnim=R.g1(),L.activeAnim===0)L.activeAnim=-1;else L.activeAnim=(L.activeAnim-1<<8)+R.g1();L.zoom=R.g2(),L.xan=R.g2(),L.yan=R.g2()}if(L.type===7){L.invSlotObjId=new Int32Array(L.width*L.height),L.invSlotObjCount=new Int32Array(L.width*L.height),L.center=R.g1()===1;let H=R.g1();if(m)L.font=m[H];L.shadowed=R.g1()===1,L.colour=R.g4(),L.marginX=R.g2b(),L.marginY=R.g2b(),L.interactable=R.g1()===1,L.iop=new r(5,null);for(let G=0;G<5;G++)if(L.iop[G]=R.gjstr(),L.iop[G].length===0)L.iop[G]=null}if(L.buttonType===2||L.type===2)L.targetVerb=R.gjstr(),L.targetText=R.gjstr(),L.targetMask=R.g2();if(L.buttonType===1||L.buttonType===4||L.buttonType===5||L.buttonType===6){if(L.option=R.gjstr(),L.option.length===0){if(L.buttonType===1)L.option="Ok";else if(L.buttonType===4)L.option="Select";else if(L.buttonType===5)L.option="Select";else if(L.buttonType===6)L.option="Continue"}}}this.imageCache=null}swapObj(u,_){if(!this.invSlotObjId||!this.invSlotObjCount)return;let m=this.invSlotObjId[u];this.invSlotObjId[u]=this.invSlotObjId[_],this.invSlotObjId[_]=m,m=this.invSlotObjCount[u],this.invSlotObjCount[u]=this.invSlotObjCount[_],this.invSlotObjCount[_]=m}getModel(u,_,m,R){let b=null;if(m)b=this.loadModel(this.activeModelType,this.activeModel,R);else b=this.loadModel(this.modelType,this.model,R);if(!b)return null;if(u===-1&&_===-1&&!b.faceColour)return b;let E=$.modelShareColored(b,!0,!0,!1);if(u!==-1||_!==-1)E.createLabelReferences();if(u!==-1)E.applyTransform(u);if(_!==-1)E.applyTransform(_);return E.calculateNormals(64,768,-50,-10,-50,!0),E}loadModel(u,_,m){let R=g.modelCache.get(BigInt((u<<16)+_));if(R)return R;if(u===1)R=$.tryGet(_);else if(u===2)R=j0.get(_).getHeadModel();else if(u===3){if(m)R=m.getHeadModel()}else if(u===4)R=l.get(_).getInvModel(50);else if(u===5)R=null;if(R)g.modelCache.put(BigInt((u<<16)+_),R);return R}static cacheModel(u,_,m){if(g.modelCache.clear(),u&&_!=4)g.modelCache.put(BigInt((_<<16)+m),u)}getAbsoluteX(){if(this.layer===this.id)return this.x;let u=g.types[this.layer];if(!u.children||!u.childX||!u.childY)return this.x;let _=u.children.indexOf(this.id);if(_===-1)return this.x;let m=u.childX[_];while(u.layer!==u.id){let R=g.types[u.layer];if(R.children&&R.childX&&R.childY){if(_=R.children.indexOf(u.id),_!==-1)m+=R.childX[_]}u=R}return m}static getImage(u,_,m){let R=c.hashCode(_)<<8n|BigInt(m);if(this.imageCache){let b=this.imageCache.get(R);if(b)return b}try{let b=R0.fromArchive(u,_,m);return this.imageCache?.put(R,b),b}catch(b){return null}}}class e{static index=(u,_)=>u*104+_;startX;startZ;sizeX;sizeZ;flags;constructor(){this.startX=0,this.startZ=0,this.sizeX=104,this.sizeZ=104,this.flags=new Int32Array(this.sizeX*this.sizeZ),this.reset()}reset(){for(let u=0;u<this.sizeX;u++)for(let _=0;_<this.sizeZ;_++){let m=e.index(u,_);if(u===0||_===0||u===this.sizeX-1||_===this.sizeZ-1)this.flags[m]=16777215;else this.flags[m]=0}}addFloor(u,_){this.flags[e.index(u-this.startX,_-this.startZ)]|=2097152}removeFloor(u,_){this.flags[e.index(u-this.startX,_-this.startZ)]&=~2097152}addLoc(u,_,m,R,b,E){let O=256;if(E)O|=131072;let L=u-this.startX,I=_-this.startZ;if(b===1||b===3){let N=m;m=R,R=N}for(let N=L;N<L+m;N++){if(!(N>=0&&N<this.sizeX))continue;for(let H=I;H<I+R;H++){if(!(H>=0&&H<this.sizeZ))continue;this.add(N,H,O)}}}removeLoc(u,_,m,R,b,E){let O=256;if(E)O|=131072;let L=u-this.startX,I=_-this.startZ;if(b===1||b===3){let N=m;m=R,R=N}for(let N=L;N<L+m;N++){if(!(N>=0&&N<this.sizeX))continue;for(let H=I;H<I+R;H++){if(!(H>=0&&H<this.sizeZ))continue;this.remove(N,H,O)}}}addWall(u,_,m,R,b){let E=u-this.startX,O=_-this.startZ,L=b?65536:128,I=b?4096:8,N=b?1024:2,H=b?16384:32,G=b?512:1,T=b?8192:16,q=b?2048:4,Q=b?32768:64;if(m===P.WALL_STRAIGHT.id){if(R===0)this.add(E,O,L),this.add(E-1,O,I);else if(R===1)this.add(E,O,N),this.add(E,O+1,H);else if(R===2)this.add(E,O,I),this.add(E+1,O,L);else if(R===3)this.add(E,O,H),this.add(E,O-1,N)}else if(m===P.WALL_DIAGONAL_CORNER.id||m===P.WALL_SQUARE_CORNER.id){if(R===0)this.add(E,O,G),this.add(E-1,O+1,T);else if(R===1)this.add(E,O,q),this.add(E+1,O+1,Q);else if(R===2)this.add(E,O,T),this.add(E+1,O-1,G);else if(R===3)this.add(E,O,Q),this.add(E-1,O-1,q)}else if(m===P.WALL_L.id){if(R===0)this.add(E,O,N|L),this.add(E-1,O,I),this.add(E,O+1,H);else if(R===1)this.add(E,O,N|I),this.add(E,O+1,H),this.add(E+1,O,L);else if(R===2)this.add(E,O,H|I),this.add(E+1,O,L),this.add(E,O-1,N);else if(R===3)this.add(E,O,H|L),this.add(E,O-1,N),this.add(E-1,O,I)}if(b)this.addWall(u,_,m,R,!1)}removeWall(u,_,m,R,b){let E=u-this.startX,O=_-this.startZ,L=b?65536:128,I=b?4096:8,N=b?1024:2,H=b?16384:32,G=b?512:1,T=b?8192:16,q=b?2048:4,Q=b?32768:64;if(m===P.WALL_STRAIGHT.id){if(R===0)this.remove(E,O,L),this.remove(E-1,O,I);else if(R===1)this.remove(E,O,N),this.remove(E,O+1,H);else if(R===2)this.remove(E,O,I),this.remove(E+1,O,L);else if(R===3)this.remove(E,O,H),this.remove(E,O-1,N)}else if(m===P.WALL_DIAGONAL_CORNER.id||m===P.WALL_SQUARE_CORNER.id){if(R===0)this.remove(E,O,G),this.remove(E-1,O+1,T);else if(R===1)this.remove(E,O,q),this.remove(E+1,O+1,Q);else if(R===2)this.remove(E,O,T),this.remove(E+1,O-1,G);else if(R===3)this.remove(E,O,Q),this.remove(E-1,O-1,q)}else if(m===P.WALL_L.id){if(R===0)this.remove(E,O,N|L),this.remove(E-1,O,I),this.remove(E,O+1,H);else if(R===1)this.remove(E,O,N|I),this.remove(E,O+1,H),this.remove(E+1,O,L);else if(R===2)this.remove(E,O,H|I),this.remove(E+1,O,L),this.remove(E,O-1,N);else if(R===3)this.remove(E,O,H|L),this.remove(E,O-1,N),this.remove(E-1,O,I)}if(b)this.removeWall(u,_,m,R,!1)}reachedWall(u,_,m,R,b,E){if(u===m&&_===R)return!0;let O=u-this.startX,L=_-this.startZ,I=m-this.startX,N=R-this.startZ,H=e.index(O,L);if(b===P.WALL_STRAIGHT.id){if(E===0){if(O===I-1&&L===N)return!0;else if(O===I&&L===N+1&&(this.flags[H]&2621728)===0)return!0;else if(O===I&&L===N-1&&(this.flags[H]&2621698)===0)return!0}else if(E===1){if(O===I&&L===N+1)return!0;else if(O===I-1&&L===N&&(this.flags[H]&2621704)===0)return!0;else if(O===I+1&&L===N&&(this.flags[H]&2621824)===0)return!0}else if(E===2){if(O===I+1&&L===N)return!0;else if(O===I&&L===N+1&&(this.flags[H]&2621728)===0)return!0;else if(O===I&&L===N-1&&(this.flags[H]&2621698)===0)return!0}else if(E===3){if(O===I&&L===N-1)return!0;else if(O===I-1&&L===N&&(this.flags[H]&2621704)===0)return!0;else if(O===I+1&&L===N&&(this.flags[H]&2621824)===0)return!0}}else if(b===P.WALL_L.id){if(E===0){if(O===I-1&&L===N)return!0;else if(O===I&&L===N+1)return!0;else if(O===I+1&&L===N&&(this.flags[H]&2621824)===0)return!0;else if(O===I&&L===N-1&&(this.flags[H]&2621698)===0)return!0}else if(E===1){if(O===I-1&&L===N&&(this.flags[H]&2621704)===0)return!0;else if(O===I&&L===N+1)return!0;else if(O===I+1&&L===N)return!0;else if(O===I&&L===N-1&&(this.flags[H]&2621698)===0)return!0}else if(E===2){if(O===I-1&&L===N&&(this.flags[H]&2621704)===0)return!0;else if(O===I&&L===N+1&&(this.flags[H]&2621728)===0)return!0;else if(O===I+1&&L===N)return!0;else if(O===I&&L===N-1)return!0}else if(E===3){if(O===I-1&&L===N)return!0;else if(O===I&&L===N+1&&(this.flags[H]&2621728)===0)return!0;else if(O===I+1&&L===N&&(this.flags[H]&2621824)===0)return!0;else if(O===I&&L===N-1)return!0}}else if(b===P.WALL_DIAGONAL.id){if(O===I&&L===N+1&&(this.flags[H]&32)===0)return!0;else if(O===I&&L===N-1&&(this.flags[H]&2)===0)return!0;else if(O===I-1&&L===N&&(this.flags[H]&8)===0)return!0;else if(O===I+1&&L===N&&(this.flags[H]&128)===0)return!0}return!1}reachedWallDecoration(u,_,m,R,b,E){if(u===m&&_===R)return!0;let O=u-this.startX,L=_-this.startZ,I=m-this.startX,N=R-this.startZ,H=e.index(O,L);if(b===P.WALLDECOR_DIAGONAL_OFFSET.id||b===P.WALLDECOR_DIAGONAL_NOOFFSET.id){if(b===P.WALLDECOR_DIAGONAL_NOOFFSET.id)E=E+2&3;if(E===0){if(O===I+1&&L===N&&(this.flags[H]&128)===0)return!0;else if(O===I&&L===N-1&&(this.flags[H]&2)===0)return!0}else if(E===1){if(O===I-1&&L===N&&(this.flags[H]&8)===0)return!0;else if(O===I&&L===N-1&&(this.flags[H]&2)===0)return!0}else if(E===2){if(O===I-1&&L===N&&(this.flags[H]&8)===0)return!0;else if(O===I&&L===N+1&&(this.flags[H]&32)===0)return!0}else if(E===3){if(O===I+1&&L===N&&(this.flags[H]&128)===0)return!0;else if(O===I&&L===N+1&&(this.flags[H]&32)===0)return!0}}else if(b===P.WALLDECOR_DIAGONAL_BOTH.id){if(O===I&&L===N+1&&(this.flags[H]&32)===0)return!0;else if(O===I&&L===N-1&&(this.flags[H]&2)===0)return!0;else if(O===I-1&&L===N&&(this.flags[H]&8)===0)return!0;else if(O===I+1&&L===N&&(this.flags[H]&128)===0)return!0}return!1}reachedLoc(u,_,m,R,b,E,O){let L=m+b-1,I=R+E-1,N=e.index(u-this.startX,_-this.startZ);if(u>=m&&u<=L&&_>=R&&_<=I)return!0;else if(u===m-1&&_>=R&&_<=I&&(this.flags[N]&8)===0&&(O&8)===0)return!0;else if(u===L+1&&_>=R&&_<=I&&(this.flags[N]&128)===0&&(O&2)===0)return!0;else if(_===R-1&&u>=m&&u<=L&&(this.flags[N]&2)===0&&(O&4)===0)return!0;else if(_===I+1&&u>=m&&u<=L&&(this.flags[N]&32)===0&&(O&1)===0)return!0;return!1}add(u,_,m){this.flags[e.index(u,_)]|=m}remove(u,_,m){this.flags[e.index(u,_)]&=16777215-m}}class Ou{minTileX;maxTileX;minTileZ;maxTileZ;type;minX;maxX;minZ;maxZ;minY;maxY;mode=0;minDeltaX=0;maxDeltaX=0;minDeltaZ=0;maxDeltaZ=0;minDeltaY=0;maxDeltaY=0;constructor(u,_,m,R,b,E,O,L,I,N,H){this.minTileX=u,this.maxTileX=_,this.minTileZ=m,this.maxTileZ=R,this.type=b,this.minX=E,this.maxX=O,this.minZ=L,this.maxZ=I,this.minY=N,this.maxY=H}}class Lu{y;x;z;model;typecode;info;constructor(u,_,m,R,b,E){this.y=u,this.x=_,this.z=m,this.model=R,this.typecode=b,this.info=E}}class Iu{locLevel;y;x;z;model;yaw;minSceneTileX;maxSceneTileX;minSceneTileZ;maxSceneTileZ;typecode;info;distance=0;cycle=0;constructor(u,_,m,R,b,E,O,L,I,N,H,G){this.locLevel=u,this.y=_,this.x=m,this.z=R,this.model=b,this.yaw=E,this.minSceneTileX=O,this.maxSceneTileX=L,this.minSceneTileZ=I,this.maxSceneTileZ=N,this.typecode=H,this.info=G}}class Nu{y;x;z;topObj;middleObj;bottomObj;typecode;offset;constructor(u,_,m,R,b,E,O,L){this.y=u,this.x=_,this.z=m,this.topObj=R,this.middleObj=b,this.bottomObj=E,this.typecode=O,this.offset=L}}class A0 extends f0{level;x;z;originalLevel;locs;primaryExtendDirections;quickGround=null;ground=null;wall=null;decor=null;groundDecor=null;groundObject=null;linkedSquare=null;primaryCount=0;combinedPrimaryExtendDirections=0;drawLevel=0;drawFront=!1;drawBack=!1;drawPrimaries=!1;cornerSides=0;sidesBeforeCorner=0;sidesAfterCorner=0;backWallTypes=0;constructor(u,_,m){super();this.originalLevel=this.level=u,this.x=_,this.z=m,this.locs=new r(5,null),this.primaryExtendDirections=new Int32Array(5)}}class t{static tmpScreenX=new Int32Array(6);static tmpScreenY=new Int32Array(6);static tmpViewspaceX=new Int32Array(6);static tmpViewspaceY=new Int32Array(6);static tmpViewspaceZ=new Int32Array(6);static SHAPE_POINTS=[Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,2,6),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,13,14)];static SHAPE_PATHS=[Int8Array.of(0,1,2,3,0,0,1,3),Int8Array.of(1,1,2,3,1,0,1,3),Int8Array.of(0,1,2,3,1,0,1,3),Int8Array.of(0,0,1,2,0,0,2,4,1,0,4,3),Int8Array.of(0,0,1,4,0,0,4,3,1,1,2,4),Int8Array.of(0,0,4,3,1,0,1,2,1,0,2,4),Int8Array.of(0,1,2,4,1,0,1,4,1,0,4,3),Int8Array.of(0,4,1,2,0,4,2,5,1,0,4,5,1,0,5,3),Int8Array.of(0,4,1,2,0,4,2,3,0,4,3,5,1,0,4,5),Int8Array.of(0,0,4,5,1,4,1,2,1,4,2,3,1,4,3,5),Int8Array.of(0,0,1,5,0,1,4,5,0,1,2,4,1,0,5,3,1,5,4,3,1,4,2,3),Int8Array.of(1,0,1,5,1,1,4,5,1,1,2,4,0,0,5,3,0,5,4,3,0,4,2,3),Int8Array.of(1,0,5,4,1,0,1,5,0,0,4,3,0,4,5,3,0,5,2,3,0,1,2,5)];static FULL_SQUARE=128;static HALF_SQUARE=this.FULL_SQUARE/2|0;static CORNER_SMALL=this.FULL_SQUARE/4|0;static CORNER_BIG=this.FULL_SQUARE*3/4|0;vertexX;vertexY;vertexZ;triangleColorA;triangleColorB;triangleColorC;triangleVertexA;triangleVertexB;triangleVertexC;triangleTextureIds;flat;shape;shapeAngle;backgroundRgb;foregroundRgb;constructor(u,_,m,R,b,E,O,L,I,N,H,G,T,q,Q,n,J,U,w){this.flat=!(J!==R||J!==q||J!==L),this.shape=_,this.shapeAngle=E,this.backgroundRgb=T,this.foregroundRgb=I;let k=t.SHAPE_POINTS[_],V=k.length;this.vertexX=new Int32Array(V),this.vertexY=new Int32Array(V),this.vertexZ=new Int32Array(V);let j=new Int32Array(V),X=new Int32Array(V),A=u*t.FULL_SQUARE,Z=U*t.FULL_SQUARE;for(let s=0;s<V;s++){let f=k[s];if((f&1)===0&&f<=8)f=(f-E-E-1&7)+1;if(f>8&&f<=12)f=(f-E-9&3)+9;if(f>12&&f<=16)f=(f-E-13&3)+13;let z,p,B,a,y;if(f===1)z=A,p=Z,B=J,a=O,y=N;else if(f===2)z=A+t.HALF_SQUARE,p=Z,B=J+R>>1,a=O+w>>1,y=N+m>>1;else if(f===3)z=A+t.FULL_SQUARE,p=Z,B=R,a=w,y=m;else if(f===4)z=A+t.FULL_SQUARE,p=Z+t.HALF_SQUARE,B=R+q>>1,a=w+b>>1,y=m+Q>>1;else if(f===5)z=A+t.FULL_SQUARE,p=Z+t.FULL_SQUARE,B=q,a=b,y=Q;else if(f===6)z=A+t.HALF_SQUARE,p=Z+t.FULL_SQUARE,B=q+L>>1,a=b+n>>1,y=Q+G>>1;else if(f===7)z=A,p=Z+t.FULL_SQUARE,B=L,a=n,y=G;else if(f===8)z=A,p=Z+t.HALF_SQUARE,B=L+J>>1,a=n+O>>1,y=G+N>>1;else if(f===9)z=A+t.HALF_SQUARE,p=Z+t.CORNER_SMALL,B=J+R>>1,a=O+w>>1,y=N+m>>1;else if(f===10)z=A+t.CORNER_BIG,p=Z+t.HALF_SQUARE,B=R+q>>1,a=w+b>>1,y=m+Q>>1;else if(f===11)z=A+t.HALF_SQUARE,p=Z+t.CORNER_BIG,B=q+L>>1,a=b+n>>1,y=Q+G>>1;else if(f===12)z=A+t.CORNER_SMALL,p=Z+t.HALF_SQUARE,B=L+J>>1,a=n+O>>1,y=G+N>>1;else if(f===13)z=A+t.CORNER_SMALL,p=Z+t.CORNER_SMALL,B=J,a=O,y=N;else if(f===14)z=A+t.CORNER_BIG,p=Z+t.CORNER_SMALL,B=R,a=w,y=m;else if(f===15)z=A+t.CORNER_BIG,p=Z+t.CORNER_BIG,B=q,a=b,y=Q;else z=A+t.CORNER_SMALL,p=Z+t.CORNER_BIG,B=L,a=n,y=G;this.vertexX[s]=z,this.vertexY[s]=B,this.vertexZ[s]=p,j[s]=a,X[s]=y}let D=t.SHAPE_PATHS[_],Y=D.length/4|0;if(this.triangleVertexA=new Int32Array(Y),this.triangleVertexB=new Int32Array(Y),this.triangleVertexC=new Int32Array(Y),this.triangleColorA=new Int32Array(Y),this.triangleColorB=new Int32Array(Y),this.triangleColorC=new Int32Array(Y),H!==-1)this.triangleTextureIds=new Int32Array(Y);else this.triangleTextureIds=null;let S=0;for(let s=0;s<Y;s++){let f=D[S],z=D[S+1],p=D[S+2],B=D[S+3];if(S+=4,z<4)z=z-E&3;if(p<4)p=p-E&3;if(B<4)B=B-E&3;if(this.triangleVertexA[s]=z,this.triangleVertexB[s]=p,this.triangleVertexC[s]=B,f===0){if(this.triangleColorA[s]=j[z],this.triangleColorB[s]=j[p],this.triangleColorC[s]=j[B],this.triangleTextureIds)this.triangleTextureIds[s]=-1}else if(this.triangleColorA[s]=X[z],this.triangleColorB[s]=X[p],this.triangleColorC[s]=X[B],this.triangleTextureIds)this.triangleTextureIds[s]=H}}}class d0{southwestColor;southeastColor;northeastColor;northwestColor;textureId;colour;flat;constructor(u,_,m,R,b,E,O){this.southwestColor=u,this.southeastColor=_,this.northeastColor=m,this.northwestColor=R,this.textureId=b,this.colour=E,this.flat=O}}class Hu{y;x;z;angle1;angle2;model1;model2;typecode;typecode2;constructor(u,_,m,R,b,E,O,L,I){this.y=u,this.x=_,this.z=m,this.angle1=R,this.angle2=b,this.model1=E,this.model2=O,this.typecode=L,this.typecode2=I}}class Gu{y;x;z;angle1;angle2;model;typecode;info;constructor(u,_,m,R,b,E,O,L){this.y=u,this.x=_,this.z=m,this.angle1=R,this.angle2=b,this.model=E,this.typecode=O,this.info=L}}class F{static visibilityMatrix=new _u(8,32,51,51,!1);static locBuffer=new r(100,null);static levelOccluderCount=new Int32Array(4);static levelOccluders=new wu(4,500,null);static activeOccluders=new r(500,null);static drawTileQueue=new $0;static cycle=0;static viewportLeft=0;static viewportTop=0;static viewportRight=0;static viewportBottom=0;static viewportCenterX=0;static viewportCenterY=0;static sinEyePitch=0;static cosEyePitch=0;static sinEyeYaw=0;static cosEyeYaw=0;static eyeX=0;static eyeY=0;static eyeZ=0;static eyeTileX=0;static eyeTileZ=0;static minDrawTileX=0;static maxDrawTileX=0;static minDrawTileZ=0;static maxDrawTileZ=0;static topLevel=0;static tilesRemaining=0;static takingInput=!1;static visibilityMap=null;static FRONT_WALL_TYPES=Uint8Array.of(19,55,38,155,255,110,137,205,76);static DIRECTION_ALLOW_WALL_CORNER_TYPE=Uint8Array.of(160,192,80,96,0,144,80,48,160);static BACK_WALL_TYPES=Uint8Array.of(76,8,137,4,0,1,38,2,19);static MIDDEP_16=Int8Array.of(0,0,2,0,0,2,1,1,0);static MIDDEP_32=Int8Array.of(2,0,0,2,0,0,0,4,4);static MIDDEP_64=Int8Array.of(0,4,4,8,0,0,8,0,0);static MIDDEP_128=Int8Array.of(1,1,0,0,0,8,0,0,8);static WALL_DECORATION_INSET_X=Int8Array.of(53,-53,-53,53);static WALL_DECORATION_INSET_Z=Int8Array.of(-53,-53,53,53);static WALL_DECORATION_OUTSET_X=Int8Array.of(-45,45,45,-45);static WALL_DECORATION_OUTSET_Z=Int8Array.of(45,45,-45,-45);static MINIMAP_TILE_MASK=[new Int8Array(16),Int8Array.of(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,0,0,0,1,1,0,0,1,1,1,0,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,1),Int8Array.of(0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0),Int8Array.of(0,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0),Int8Array.of(1,1,1,1,1,1,1,1,0,1,1,1,0,0,1,1),Int8Array.of(1,1,1,1,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,0,0,0,0,1,1,0,1,1,1,0,1,1,1),Int8Array.of(0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1)];static MINIMAP_TILE_ROTATION_MAP=[Int8Array.of(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15),Int8Array.of(12,8,4,0,13,9,5,1,14,10,6,2,15,11,7,3),Int8Array.of(15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0),Int8Array.of(3,7,11,15,2,6,10,14,1,5,9,13,0,4,8,12)];static TEXTURE_HSL=Int32Array.of(41,39248,41,4643,41,41,41,41,41,41,41,41,41,41,41,43086,41,41,41,41,41,41,41,8602,41,28992,41,41,41,41,41,5056,41,41,41,41,41,41,41,41,41,41,41,41,41,41,3131,41,41,41);static activeOccluderCount=0;static mouseX=0;static mouseY=0;static clickTileX=-1;static clickTileZ=-1;static lowMemory=!0;static init(u,_,m,R,b){this.viewportLeft=0,this.viewportTop=0,this.viewportRight=u,this.viewportBottom=_,this.viewportCenterX=u/2|0,this.viewportCenterY=_/2|0;let E=new _u(9,32,53,53,!1);for(let O=128;O<=384;O+=32)for(let L=0;L<2048;L+=64){this.sinEyePitch=h.sinTable[O],this.cosEyePitch=h.cosTable[O],this.sinEyeYaw=h.sinTable[L],this.cosEyeYaw=h.cosTable[L];let I=(O-128)/32|0,N=L/64|0;for(let H=-26;H<=26;H++)for(let G=-26;G<=26;G++){let T=H*128,q=G*128,Q=!1;for(let n=-m;n<=R;n+=128)if(this.testPoint(T,q,b[I]+n)){Q=!0;break}E[I][N][H+25+1][G+25+1]=Q}}for(let O=0;O<8;O++)for(let L=0;L<32;L++)for(let I=-25;I<25;I++)for(let N=-25;N<25;N++){let H=!1;u:for(let G=-1;G<=1;G++)for(let T=-1;T<=1;T++){if(E[O][L][I+G+25+1][N+T+25+1]){H=!0;break u}if(E[O][(L+1)%31][I+G+25+1][N+T+25+1]){H=!0;break u}if(E[O+1][L][I+G+25+1][N+T+25+1]){H=!0;break u}if(E[O+1][(L+1)%31][I+G+25+1][N+T+25+1]){H=!0;break u}}this.visibilityMatrix[O][L][I+25][N+25]=H}}static addOccluder(u,_,m,R,b,E,O,L){F.levelOccluders[u][F.levelOccluderCount[u]++]=new Ou(m/128|0,E/128|0,b/128|0,L/128|0,_,m,E,b,L,R,O)}static testPoint(u,_,m){let R=_*this.sinEyeYaw+u*this.cosEyeYaw>>16,b=_*this.cosEyeYaw-u*this.sinEyeYaw>>16,E=m*this.sinEyePitch+b*this.cosEyePitch>>16,O=m*this.cosEyePitch-b*this.sinEyePitch>>16;if(E<50||E>3500)return!1;let L=this.viewportCenterX+((R<<9)/E|0),I=this.viewportCenterY+((O<<9)/E|0);return L>=this.viewportLeft&&L<=this.viewportRight&&I>=this.viewportTop&&I<=this.viewportBottom}maxLevel;maxTileX;maxTileZ;levelHeightmaps;levelTiles;changedLocs;levelTileOcclusionCycles;mergeIndexA;mergeIndexB;changedLocCount=0;minLevel=0;tmpMergeIndex=0;constructor(u,_,m,R){this.maxLevel=m,this.maxTileX=R,this.maxTileZ=_,this.levelTiles=new c0(m,R,_,null),this.levelTileOcclusionCycles=new g0(m,R+1,_+1),this.levelHeightmaps=u,this.changedLocs=new r(5000,null),this.mergeIndexA=new Int32Array(1e4),this.mergeIndexB=new Int32Array(1e4),this.reset()}reset(){for(let u=0;u<this.maxLevel;u++)for(let _=0;_<this.maxTileX;_++)for(let m=0;m<this.maxTileZ;m++)this.levelTiles[u][_][m]=null;for(let u=0;u<4;u++){for(let _=0;_<F.levelOccluderCount[u];_++)F.levelOccluders[u][_]=null;F.levelOccluderCount[u]=0}for(let u=0;u<this.changedLocCount;u++)this.changedLocs[u]=null;this.changedLocCount=0,F.locBuffer.fill(null)}setMinLevel(u){this.minLevel=u;for(let _=0;_<this.maxTileX;_++)for(let m=0;m<this.maxTileZ;m++)this.levelTiles[u][_][m]=new A0(u,_,m)}setLinkBelow(u,_){let m=this.levelTiles[0][u][_];for(let b=0;b<3;b++){this.levelTiles[b][u][_]=this.levelTiles[b+1][u][_];let E=this.levelTiles[b][u][_];if(E)E.level--}if(!this.levelTiles[0][u][_])this.levelTiles[0][u][_]=new A0(0,u,_);let R=this.levelTiles[0][u][_];if(R)R.linkedSquare=m;this.levelTiles[3][u][_]=null}setDrawLevel(u,_,m,R){let b=this.levelTiles[u][_][m];if(!b)return;b.drawLevel=R}setTile(u,_,m,R,b,E,O,L,I,N,H,G,T,q,Q,n,J,U,w,k){if(R===0){for(let j=u;j>=0;j--)if(!this.levelTiles[j][_][m])this.levelTiles[j][_][m]=new A0(j,_,m);let V=this.levelTiles[u][_][m];if(V)V.quickGround=new d0(H,G,T,q,-1,w,!1)}else if(R===1){for(let j=u;j>=0;j--)if(!this.levelTiles[j][_][m])this.levelTiles[j][_][m]=new A0(j,_,m);let V=this.levelTiles[u][_][m];if(V)V.quickGround=new d0(Q,n,J,U,E,k,O===L&&O===I&&O===N)}else{for(let j=u;j>=0;j--)if(!this.levelTiles[j][_][m])this.levelTiles[j][_][m]=new A0(j,_,m);let V=this.levelTiles[u][_][m];if(V)V.ground=new t(_,R,n,L,T,b,H,N,k,Q,E,U,w,I,J,q,O,m,G)}}addGroundDecoration(u,_,m,R,b,E,O){if(!this.levelTiles[_][m][R])this.levelTiles[_][m][R]=new A0(_,m,R);let L=this.levelTiles[_][m][R];if(L)L.groundDecor=new Lu(b,m*128+64,R*128+64,u,E,O)}removeGroundDecoration(u,_,m){let R=this.levelTiles[u][_][m];if(!R)return;R.groundDecor=null}addGroundObject(u,_,m,R,b,E,O,L){let I=0,N=this.levelTiles[R][u][_];if(N)for(let G=0;G<N.primaryCount;G++){let T=N.locs[G];if(!T||!T.model||!(T.model instanceof $))continue;let q=T.model.objRaise;if(q>I)I=q}else this.levelTiles[R][u][_]=new A0(R,u,_);let H=this.levelTiles[R][u][_];if(H)H.groundObject=new Nu(m,u*128+64,_*128+64,E,O,L,b,I)}removeGroundObject(u,_,m){let R=this.levelTiles[u][_][m];if(!R)return;R.groundObject=null}addWall(u,_,m,R,b,E,O,L,I,N){if(!O&&!L)return;for(let G=u;G>=0;G--)if(!this.levelTiles[G][_][m])this.levelTiles[G][_][m]=new A0(G,_,m);let H=this.levelTiles[u][_][m];if(H)H.wall=new Hu(R,_*128+64,m*128+64,b,E,O,L,I,N)}removeWall(u,_,m,R){let b=this.levelTiles[u][_][m];if(R===1&&b)b.wall=null}setWallDecoration(u,_,m,R,b,E,O,L,I,N,H){if(!L)return;for(let T=u;T>=0;T--)if(!this.levelTiles[T][_][m])this.levelTiles[T][_][m]=new A0(T,_,m);let G=this.levelTiles[u][_][m];if(G)G.decor=new Gu(R,_*128+b+64,m*128+E+64,H,N,L,O,I)}removeWallDecoration(u,_,m){let R=this.levelTiles[u][_][m];if(!R)return;R.decor=null}setWallDecorationOffset(u,_,m,R){let b=this.levelTiles[u][_][m];if(!b)return;let E=b.decor;if(!E)return;let O=_*128+64,L=m*128+64;E.x=O+((E.x-O)*R/16|0),E.z=L+((E.z-L)*R/16|0)}setWallDecorationModel(u,_,m,R){if(!R)return;let b=this.levelTiles[u][_][m];if(!b)return;let E=b.decor;if(!E)return;E.model=R}setGroundDecorationModel(u,_,m,R){if(!R)return;let b=this.levelTiles[u][_][m];if(!b)return;let E=b.groundDecor;if(!E)return;E.model=R}setWallModel(u,_,m,R){if(!R)return;let b=this.levelTiles[u][_][m];if(!b)return;let E=b.wall;if(!E)return;E.model1=R}setWallModels(u,_,m,R,b){if(!R)return;let E=this.levelTiles[m][u][_];if(!E)return;let O=E.wall;if(!O)return;O.model1=R,O.model2=b}addLoc(u,_,m,R,b,E,O,L,I,N){if(!b)return!0;let H=_*128+L*64,G=m*128+I*64;return this.addModel(H,G,R,u,_,m,L,I,b,E,O,N,!1)}changeLoc(u,_,m,R,b,E,O,L,I){if(!b)return!0;let N=_-L,H=R-L,G=_+L,T=R+L;if(I){if(O>640&&O<1408)T+=128;if(O>1152&&O<1920)G+=128;if(O>1664||O<384)H-=128;if(O>128&&O<896)N-=128}return N=N/128|0,H=H/128|0,G=G/128|0,T=T/128|0,this.addModel(_,R,m,u,N,H,G+1-N,T-H+1,b,E,0,O,!0)}changeLoc2(u,_,m,R,b,E,O,L,I,N,H){return!I||this.addModel(_,R,m,u,b,E,O+1-b,L-E+1,I,N,0,H,!0)}removeLoc(u,_,m){let R=this.levelTiles[u][_][m];if(!R)return;for(let b=0;b<R.primaryCount;b++){let E=R.locs[b];if(E&&(E.typecode>>29&3)===2&&E.minSceneTileX===_&&E.minSceneTileZ===m){this.removeLoc2(E);return}}}clearLocChanges(){for(let u=0;u<this.changedLocCount;u++){let _=this.changedLocs[u];if(_)this.removeLoc2(_);this.changedLocs[u]=null}this.changedLocCount=0}getWallTypecode(u,_,m){let R=this.levelTiles[u][_][m];return!R||!R.wall?0:R.wall.typecode}getDecorTypecode(u,_,m){let R=this.levelTiles[u][m][_];return!R||!R.decor?0:R.decor.typecode}getLocTypecode(u,_,m){let R=this.levelTiles[u][_][m];if(!R)return 0;for(let b=0;b<R.primaryCount;b++){let E=R.locs[b];if(E&&(E.typecode>>29&3)===2&&E.minSceneTileX===_&&E.minSceneTileZ===m)return E.typecode}return 0}getGroundDecorTypecode(u,_,m){let R=this.levelTiles[u][_][m];return!R||!R.groundDecor?0:R.groundDecor.typecode}getWall(u,_,m){let R=this.levelTiles[u][_][m];return!R||!R.wall?null:R.wall}getDecor(u,_,m){let R=this.levelTiles[u][m][_];return!R||!R.decor?null:R.decor}getLoc(u,_,m){let R=this.levelTiles[u][_][m];if(!R)return null;for(let b=0;b<R.primaryCount;b++){let E=R.locs[b];if(E&&(E.typecode>>29&3)===2&&E.minSceneTileX===_&&E.minSceneTileZ===m)return E}return null}getGroundDecor(u,_,m){let R=this.levelTiles[u][_][m];return!R||!R.groundDecor?null:R.groundDecor}getInfo(u,_,m,R){let b=this.levelTiles[u][_][m];if(!b)return-1;else if(b.wall&&b.wall.typecode===R)return b.wall.typecode2&255;else if(b.decor&&b.decor.typecode===R)return b.decor.info&255;else if(b.groundDecor&&b.groundDecor.typecode===R)return b.groundDecor.info&255;else{for(let E=0;E<b.primaryCount;E++){let O=b.locs[E];if(O&&O.typecode===R)return O.info&255}return-1}}buildModels(u,_,m,R,b){let E=Math.sqrt(m*m+R*R+b*b)|0,O=_*E>>8;for(let L=0;L<this.maxLevel;L++)for(let I=0;I<this.maxTileX;I++)for(let N=0;N<this.maxTileZ;N++){let H=this.levelTiles[L][I][N];if(!H)continue;let G=H.wall;if(G&&G.model1&&G.model1.vertexNormal){if(this.mergeLocNormals(L,I,N,1,1,G.model1),G.model2&&G.model2.vertexNormal)this.mergeLocNormals(L,I,N,1,1,G.model2),this.mergeNormals(G.model1,G.model2,0,0,0,!1),G.model2.applyLighting(u,O,m,R,b);G.model1.applyLighting(u,O,m,R,b)}for(let q=0;q<H.primaryCount;q++){let Q=H.locs[q];if(Q&&Q.model&&Q.model.vertexNormal)this.mergeLocNormals(L,I,N,Q.maxSceneTileX+1-Q.minSceneTileX,Q.maxSceneTileZ-Q.minSceneTileZ+1,Q.model),Q.model.applyLighting(u,O,m,R,b)}let T=H.groundDecor;if(T&&T.model&&T.model.vertexNormal)this.mergeGroundDecorationNormals(L,I,N,T.model),T.model.applyLighting(u,O,m,R,b)}}mergeGroundDecorationNormals(u,_,m,R){if(_<this.maxTileX){let b=this.levelTiles[u][_+1][m];if(b&&b.groundDecor&&b.groundDecor.model&&b.groundDecor.model.vertexNormal)this.mergeNormals(R,b.groundDecor.model,128,0,0,!0)}if(m<this.maxTileX){let b=this.levelTiles[u][_][m+1];if(b&&b.groundDecor&&b.groundDecor.model&&b.groundDecor.model.vertexNormal)this.mergeNormals(R,b.groundDecor.model,0,0,128,!0)}if(_<this.maxTileX&&m<this.maxTileZ){let b=this.levelTiles[u][_+1][m+1];if(b&&b.groundDecor&&b.groundDecor.model&&b.groundDecor.model.vertexNormal)this.mergeNormals(R,b.groundDecor.model,128,0,128,!0)}if(_<this.maxTileX&&m>0){let b=this.levelTiles[u][_+1][m-1];if(b&&b.groundDecor&&b.groundDecor.model&&b.groundDecor.model.vertexNormal)this.mergeNormals(R,b.groundDecor.model,128,0,-128,!0)}}mergeLocNormals(u,_,m,R,b,E){let O=!0,L=_,I=_+R,N=m-1,H=m+b;for(let G=u;G<=u+1;G++){if(G===this.maxLevel)continue;for(let T=L;T<=I;T++){if(T<0||T>=this.maxTileX)continue;for(let q=N;q<=H;q++){if(q<0||q>=this.maxTileZ||O&&T<I&&q<H&&(q>=m||T===_))continue;let Q=this.levelTiles[G][T][q];if(!Q)continue;let n=(T-_)*128+(1-R)*64,J=(q-m)*128+(1-b)*64,U=((this.levelHeightmaps[G][T][q]+this.levelHeightmaps[G][T+1][q]+this.levelHeightmaps[G][T][q+1]+this.levelHeightmaps[G][T+1][q+1])/4|0)-((this.levelHeightmaps[u][_][m]+this.levelHeightmaps[u][_+1][m]+this.levelHeightmaps[u][_][m+1]+this.levelHeightmaps[u][_+1][m+1])/4|0),w=Q.wall;if(w&&w.model1&&w.model1.vertexNormal)this.mergeNormals(E,w.model1,n,U,J,O);if(w&&w.model2&&w.model2.vertexNormal)this.mergeNormals(E,w.model2,n,U,J,O);for(let k=0;k<Q.primaryCount;k++){let V=Q.locs[k];if(!V||!V.model||!V.model.vertexNormal)continue;let j=V.maxSceneTileX+1-V.minSceneTileX,X=V.maxSceneTileZ+1-V.minSceneTileZ;this.mergeNormals(E,V.model,(V.minSceneTileX-_)*128+(j-R)*64,U,(V.minSceneTileZ-m)*128+(X-b)*64,O)}}}L--,O=!1}}mergeNormals(u,_,m,R,b,E){this.tmpMergeIndex++;let O=0,L=_.vertexX,I=_.vertexCount;if(u.vertexNormal&&u.vertexNormalOriginal)for(let N=0;N<u.vertexCount;N++){let H=u.vertexNormal[N],G=u.vertexNormalOriginal[N];if(G&&G.w!==0){let T=u.vertexY[N]-R;if(T>_.maxY)continue;let q=u.vertexX[N]-m;if(q<_.minX||q>_.maxX)continue;let Q=u.vertexZ[N]-b;if(Q<_.minZ||Q>_.maxZ)continue;if(_.vertexNormal&&_.vertexNormalOriginal)for(let n=0;n<I;n++){let J=_.vertexNormal[n],U=_.vertexNormalOriginal[n];if(q!==L[n]||Q!==_.vertexZ[n]||T!==_.vertexY[n]||U&&U.w===0)continue;if(H&&J&&U)H.x+=U.x,H.y+=U.y,H.z+=U.z,H.w+=U.w,J.x+=G.x,J.y+=G.y,J.z+=G.z,J.w+=G.w,O++;this.mergeIndexA[N]=this.tmpMergeIndex,this.mergeIndexB[n]=this.tmpMergeIndex}}}if(O<3||!E)return;if(u.faceInfo){for(let N=0;N<u.faceCount;N++)if(this.mergeIndexA[u.faceVertexA[N]]===this.tmpMergeIndex&&this.mergeIndexA[u.faceVertexB[N]]===this.tmpMergeIndex&&this.mergeIndexA[u.faceVertexC[N]]===this.tmpMergeIndex)u.faceInfo[N]=-1}if(_.faceInfo){for(let N=0;N<_.faceCount;N++)if(this.mergeIndexB[_.faceVertexA[N]]===this.tmpMergeIndex&&this.mergeIndexB[_.faceVertexB[N]]===this.tmpMergeIndex&&this.mergeIndexB[_.faceVertexC[N]]===this.tmpMergeIndex)_.faceInfo[N]=-1}}drawMinimapTile(u,_,m,R,b,E){let O=this.levelTiles[u][_][m];if(!O)return;let L=O.quickGround;if(L){let J=L.colour;if(J!==0)for(let U=0;U<4;U++)R[b]=J,R[b+1]=J,R[b+2]=J,R[b+3]=J,b+=E;return}let I=O.ground;if(!I)return;let{shape:N,shapeAngle:H,backgroundRgb:G,foregroundRgb:T}=I,q=F.MINIMAP_TILE_MASK[N],Q=F.MINIMAP_TILE_ROTATION_MAP[H],n=0;if(G!==0){for(let J=0;J<4;J++)R[b]=q[Q[n++]]===0?G:T,R[b+1]=q[Q[n++]]===0?G:T,R[b+2]=q[Q[n++]]===0?G:T,R[b+3]=q[Q[n++]]===0?G:T,b+=E;return}for(let J=0;J<4;J++){if(q[Q[n++]]!==0)R[b]=T;if(q[Q[n++]]!==0)R[b+1]=T;if(q[Q[n++]]!==0)R[b+2]=T;if(q[Q[n++]]!==0)R[b+3]=T;b+=E}}click(u,_){F.takingInput=!0,F.mouseX=u,F.mouseY=_,F.clickTileX=-1,F.clickTileZ=-1}draw(u,_,m,R,b,E,O){if(u<0)u=0;else if(u>=this.maxTileX*128)u=this.maxTileX*128-1;if(m<0)m=0;else if(m>=this.maxTileZ*128)m=this.maxTileZ*128-1;if(F.cycle++,F.sinEyePitch=h.sinTable[E],F.cosEyePitch=h.cosTable[E],F.sinEyeYaw=h.sinTable[b],F.cosEyeYaw=h.cosTable[b],F.visibilityMap=F.visibilityMatrix[(E-128)/32|0][b/64|0],F.eyeX=u,F.eyeY=_,F.eyeZ=m,F.eyeTileX=u/128|0,F.eyeTileZ=m/128|0,F.topLevel=R,F.minDrawTileX=F.eyeTileX-25,F.minDrawTileX<0)F.minDrawTileX=0;if(F.minDrawTileZ=F.eyeTileZ-25,F.minDrawTileZ<0)F.minDrawTileZ=0;if(F.maxDrawTileX=F.eyeTileX+25,F.maxDrawTileX>this.maxTileX)F.maxDrawTileX=this.maxTileX;if(F.maxDrawTileZ=F.eyeTileZ+25,F.maxDrawTileZ>this.maxTileZ)F.maxDrawTileZ=this.maxTileZ;this.updateActiveOccluders(),F.tilesRemaining=0;for(let L=this.minLevel;L<this.maxLevel;L++){let I=this.levelTiles[L];for(let N=F.minDrawTileX;N<F.maxDrawTileX;N++)for(let H=F.minDrawTileZ;H<F.maxDrawTileZ;H++){let G=I[N][H];if(!G)continue;if(G.drawLevel<=R&&(F.visibilityMap[N+25-F.eyeTileX][H+25-F.eyeTileZ]||this.levelHeightmaps[L][N][H]-_>=2000))G.drawFront=!0,G.drawBack=!0,G.drawPrimaries=G.primaryCount>0,F.tilesRemaining++;else G.drawFront=!1,G.drawBack=!1,G.cornerSides=0}}for(let L=this.minLevel;L<this.maxLevel;L++){let I=this.levelTiles[L];for(let N=-25;N<=0;N++){let H=F.eyeTileX+N,G=F.eyeTileX-N;if(H<F.minDrawTileX&&G>=F.maxDrawTileX)continue;for(let T=-25;T<=0;T++){let q=F.eyeTileZ+T,Q=F.eyeTileZ-T,n;if(H>=F.minDrawTileX){if(q>=F.minDrawTileZ){if(n=I[H][q],n&&n.drawFront)this.drawTile(n,!0,O)}if(Q<F.maxDrawTileZ){if(n=I[H][Q],n&&n.drawFront)this.drawTile(n,!0,O)}}if(G<F.maxDrawTileX){if(q>=F.minDrawTileZ){if(n=I[G][q],n&&n.drawFront)this.drawTile(n,!0,O)}if(Q<F.maxDrawTileZ){if(n=I[G][Q],n&&n.drawFront)this.drawTile(n,!0,O)}}if(F.tilesRemaining===0){F.takingInput=!1;return}}}}for(let L=this.minLevel;L<this.maxLevel;L++){let I=this.levelTiles[L];for(let N=-25;N<=0;N++){let H=F.eyeTileX+N,G=F.eyeTileX-N;if(H<F.minDrawTileX&&G>=F.maxDrawTileX)continue;for(let T=-25;T<=0;T++){let q=F.eyeTileZ+T,Q=F.eyeTileZ-T,n;if(H>=F.minDrawTileX){if(q>=F.minDrawTileZ){if(n=I[H][q],n&&n.drawFront)this.drawTile(n,!1,O)}if(Q<F.maxDrawTileZ){if(n=I[H][Q],n&&n.drawFront)this.drawTile(n,!1,O)}}if(G<F.maxDrawTileX){if(q>=F.minDrawTileZ){if(n=I[G][q],n&&n.drawFront)this.drawTile(n,!1,O)}if(Q<F.maxDrawTileZ){if(n=I[G][Q],n&&n.drawFront)this.drawTile(n,!1,O)}}if(F.tilesRemaining===0){F.takingInput=!1;return}}}}}addModel(u,_,m,R,b,E,O,L,I,N,H,G,T){if(!I)return!1;for(let Q=b;Q<b+O;Q++)for(let n=E;n<E+L;n++){if(Q<0||n<0||Q>=this.maxTileX||n>=this.maxTileZ)return!1;let J=this.levelTiles[R][Q][n];if(J&&J.primaryCount>=5)return!1}let q=new Iu(R,m,u,_,I,G,b,b+O-1,E,E+L-1,N,H);for(let Q=b;Q<b+O;Q++)for(let n=E;n<E+L;n++){let J=0;if(Q>b)J|=1;if(Q<b+O-1)J+=4;if(n>E)J+=8;if(n<E+L-1)J+=2;for(let w=R;w>=0;w--)if(!this.levelTiles[w][Q][n])this.levelTiles[w][Q][n]=new A0(w,Q,n);let U=this.levelTiles[R][Q][n];if(U)U.locs[U.primaryCount]=q,U.primaryExtendDirections[U.primaryCount]=J,U.combinedPrimaryExtendDirections|=J,U.primaryCount++}if(T)this.changedLocs[this.changedLocCount++]=q;return!0}removeLoc2(u){for(let _=u.minSceneTileX;_<=u.maxSceneTileX;_++)for(let m=u.minSceneTileZ;m<=u.maxSceneTileZ;m++){let R=this.levelTiles[u.locLevel][_][m];if(!R)continue;for(let b=0;b<R.primaryCount;b++)if(R.locs[b]===u){R.primaryCount--;for(let E=b;E<R.primaryCount;E++)R.locs[E]=R.locs[E+1],R.primaryExtendDirections[E]=R.primaryExtendDirections[E+1];R.locs[R.primaryCount]=null;break}R.combinedPrimaryExtendDirections=0;for(let b=0;b<R.primaryCount;b++)R.combinedPrimaryExtendDirections|=R.primaryExtendDirections[b]}}updateActiveOccluders(){let u=F.levelOccluderCount[F.topLevel],_=F.levelOccluders[F.topLevel];F.activeOccluderCount=0;for(let m=0;m<u;m++){let R=_[m];if(!R)continue;let b,E,O,L;if(R.type===1){if(b=R.minTileX+25-F.eyeTileX,b>=0&&b<=50){if(E=R.minTileZ+25-F.eyeTileZ,E<0)E=0;if(O=R.maxTileZ+25-F.eyeTileZ,O>50)O=50;let I=!1;while(E<=O)if(F.visibilityMap&&F.visibilityMap[b][E++]){I=!0;break}if(I){if(L=F.eyeX-R.minX,L>32)R.mode=1;else{if(L>=-32)continue;R.mode=2,L=-L}R.minDeltaZ=(R.minZ-F.eyeZ<<8)/L|0,R.maxDeltaZ=(R.maxZ-F.eyeZ<<8)/L|0,R.minDeltaY=(R.minY-F.eyeY<<8)/L|0,R.maxDeltaY=(R.maxY-F.eyeY<<8)/L|0,F.activeOccluders[F.activeOccluderCount++]=R}}}else if(R.type===2){if(b=R.minTileZ+25-F.eyeTileZ,b>=0&&b<=50){if(E=R.minTileX+25-F.eyeTileX,E<0)E=0;if(O=R.maxTileX+25-F.eyeTileX,O>50)O=50;let I=!1;while(E<=O)if(F.visibilityMap&&F.visibilityMap[E++][b]){I=!0;break}if(I){if(L=F.eyeZ-R.minZ,L>32)R.mode=3;else{if(L>=-32)continue;R.mode=4,L=-L}R.minDeltaX=(R.minX-F.eyeX<<8)/L|0,R.maxDeltaX=(R.maxX-F.eyeX<<8)/L|0,R.minDeltaY=(R.minY-F.eyeY<<8)/L|0,R.maxDeltaY=(R.maxY-F.eyeY<<8)/L|0,F.activeOccluders[F.activeOccluderCount++]=R}}}else if(R.type===4){if(b=R.minY-F.eyeY,b>128){if(E=R.minTileZ+25-F.eyeTileZ,E<0)E=0;if(O=R.maxTileZ+25-F.eyeTileZ,O>50)O=50;if(E<=O){let I=R.minTileX+25-F.eyeTileX;if(I<0)I=0;if(L=R.maxTileX+25-F.eyeTileX,L>50)L=50;let N=!1;u:for(let H=I;H<=L;H++)for(let G=E;G<=O;G++)if(F.visibilityMap&&F.visibilityMap[H][G]){N=!0;break u}if(N)R.mode=5,R.minDeltaX=(R.minX-F.eyeX<<8)/b|0,R.maxDeltaX=(R.maxX-F.eyeX<<8)/b|0,R.minDeltaZ=(R.minZ-F.eyeZ<<8)/b|0,R.maxDeltaZ=(R.maxZ-F.eyeZ<<8)/b|0,F.activeOccluders[F.activeOccluderCount++]=R}}}}}drawTile(u,_,m){F.drawTileQueue.push(u);while(!0){let R;do if(R=F.drawTileQueue.pop(),!R)return;while(!R.drawBack);let{x:b,z:E,level:O,originalLevel:L}=R,I=this.levelTiles[O];if(R.drawFront){if(_){if(O>0){let J=this.levelTiles[O-1][b][E];if(J&&J.drawBack)continue}if(b<=F.eyeTileX&&b>F.minDrawTileX){let J=I[b-1][E];if(J&&J.drawBack&&(J.drawFront||(R.combinedPrimaryExtendDirections&1)===0))continue}if(b>=F.eyeTileX&&b<F.maxDrawTileX-1){let J=I[b+1][E];if(J&&J.drawBack&&(J.drawFront||(R.combinedPrimaryExtendDirections&4)===0))continue}if(E<=F.eyeTileZ&&E>F.minDrawTileZ){let J=I[b][E-1];if(J&&J.drawBack&&(J.drawFront||(R.combinedPrimaryExtendDirections&8)===0))continue}if(E>=F.eyeTileZ&&E<F.maxDrawTileZ-1){let J=I[b][E+1];if(J&&J.drawBack&&(J.drawFront||(R.combinedPrimaryExtendDirections&2)===0))continue}}else _=!0;if(R.drawFront=!1,R.linkedSquare){let J=R.linkedSquare;if(!J.quickGround){if(J.ground&&!this.tileVisible(0,b,E))this.drawGround(b,E,J.ground,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw)}else if(!this.tileVisible(0,b,E))this.drawQuickGround(J.quickGround,0,b,E,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw);let U=J.wall;if(U)U.model1?.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,U.x-F.eyeX,U.y-F.eyeY,U.z-F.eyeZ,U.typecode);for(let w=0;w<J.primaryCount;w++){let k=J.locs[w];if(k)k.model?.draw(m,k.yaw,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,k.x-F.eyeX,k.y-F.eyeY,k.z-F.eyeZ,k.typecode)}}let H=!1;if(!R.quickGround){if(R.ground&&!this.tileVisible(L,b,E))H=!0,this.drawGround(b,E,R.ground,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw)}else if(!this.tileVisible(L,b,E))H=!0,this.drawQuickGround(R.quickGround,L,b,E,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw);let G=0,T=0,q=R.wall,Q=R.decor;if(q||Q){if(F.eyeTileX===b)G+=1;else if(F.eyeTileX<b)G+=2;if(F.eyeTileZ===E)G+=3;else if(F.eyeTileZ>E)G+=6;T=F.FRONT_WALL_TYPES[G],R.backWallTypes=F.BACK_WALL_TYPES[G]}if(q){if((q.angle1&F.DIRECTION_ALLOW_WALL_CORNER_TYPE[G])===0)R.cornerSides=0;else if(q.angle1===16)R.cornerSides=3,R.sidesBeforeCorner=F.MIDDEP_16[G],R.sidesAfterCorner=3-R.sidesBeforeCorner;else if(q.angle1===32)R.cornerSides=6,R.sidesBeforeCorner=F.MIDDEP_32[G],R.sidesAfterCorner=6-R.sidesBeforeCorner;else if(q.angle1===64)R.cornerSides=12,R.sidesBeforeCorner=F.MIDDEP_64[G],R.sidesAfterCorner=12-R.sidesBeforeCorner;else R.cornerSides=9,R.sidesBeforeCorner=F.MIDDEP_128[G],R.sidesAfterCorner=9-R.sidesBeforeCorner;if((q.angle1&T)!==0&&!this.isTileSideOccluded(L,b,E,q.angle1))q.model1?.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,q.x-F.eyeX,q.y-F.eyeY,q.z-F.eyeZ,q.typecode);if((q.angle2&T)!==0&&!this.isTileSideOccluded(L,b,E,q.angle2))q.model2?.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,q.x-F.eyeX,q.y-F.eyeY,q.z-F.eyeZ,q.typecode)}if(Q&&!this.isTileColumnOccluded(L,b,E,Q.model.minY)){if((Q.angle1&T)!==0)Q.model.draw(m,Q.angle2,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,Q.x-F.eyeX,Q.y-F.eyeY,Q.z-F.eyeZ,Q.typecode);else if((Q.angle1&768)!==0){let J=Q.x-F.eyeX,U=Q.y-F.eyeY,w=Q.z-F.eyeZ,k=Q.angle2,V;if(k===1||k===2)V=-J;else V=J;let j;if(k===2||k===3)j=-w;else j=w;if((Q.angle1&256)!==0&&j<V){let X=J+F.WALL_DECORATION_INSET_X[k],A=w+F.WALL_DECORATION_INSET_Z[k];Q.model.draw(m,k*512+256,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,X,U,A,Q.typecode)}if((Q.angle1&512)!==0&&j>V){let X=J+F.WALL_DECORATION_OUTSET_X[k],A=w+F.WALL_DECORATION_OUTSET_Z[k];Q.model.draw(m,k*512+1280&2047,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,X,U,A,Q.typecode)}}}if(H){let J=R.groundDecor;if(J)J.model?.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,J.x-F.eyeX,J.y-F.eyeY,J.z-F.eyeZ,J.typecode);let U=R.groundObject;if(U&&U.offset===0){if(U.bottomObj)U.bottomObj.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,U.x-F.eyeX,U.y-F.eyeY,U.z-F.eyeZ,U.typecode);if(U.middleObj)U.middleObj.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,U.x-F.eyeX,U.y-F.eyeY,U.z-F.eyeZ,U.typecode);if(U.topObj)U.topObj.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,U.x-F.eyeX,U.y-F.eyeY,U.z-F.eyeZ,U.typecode)}}let n=R.combinedPrimaryExtendDirections;if(n!==0){if(b<F.eyeTileX&&(n&4)!==0){let J=I[b+1][E];if(J&&J.drawBack)F.drawTileQueue.push(J)}if(E<F.eyeTileZ&&(n&2)!==0){let J=I[b][E+1];if(J&&J.drawBack)F.drawTileQueue.push(J)}if(b>F.eyeTileX&&(n&1)!==0){let J=I[b-1][E];if(J&&J.drawBack)F.drawTileQueue.push(J)}if(E>F.eyeTileZ&&(n&8)!==0){let J=I[b][E-1];if(J&&J.drawBack)F.drawTileQueue.push(J)}}}if(R.cornerSides!==0){let H=!0;for(let G=0;G<R.primaryCount;G++){let T=R.locs[G];if(!T)continue;if(T.cycle!==F.cycle&&(R.primaryExtendDirections[G]&R.cornerSides)===R.sidesBeforeCorner){H=!1;break}}if(H){let G=R.wall;if(G&&!this.isTileSideOccluded(L,b,E,G.angle1))G.model1?.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,G.x-F.eyeX,G.y-F.eyeY,G.z-F.eyeZ,G.typecode);R.cornerSides=0}}if(R.drawPrimaries){let H=R.primaryCount;R.drawPrimaries=!1;let G=0;u:for(let T=0;T<H;T++){let q=R.locs[T];if(!q||q.cycle===F.cycle)continue;for(let w=q.minSceneTileX;w<=q.maxSceneTileX;w++)for(let k=q.minSceneTileZ;k<=q.maxSceneTileZ;k++){let V=I[w][k];if(!V)continue;if(V.drawFront){R.drawPrimaries=!0;continue u}if(V.cornerSides===0)continue;let j=0;if(w>q.minSceneTileX)j+=1;if(w<q.maxSceneTileX)j+=4;if(k>q.minSceneTileZ)j+=8;if(k<q.maxSceneTileZ)j+=2;if((j&V.cornerSides)!==R.sidesAfterCorner)continue}F.locBuffer[G++]=q;let Q=F.eyeTileX-q.minSceneTileX,n=q.maxSceneTileX-F.eyeTileX;if(n>Q)Q=n;let J=F.eyeTileZ-q.minSceneTileZ,U=q.maxSceneTileZ-F.eyeTileZ;if(U>J)q.distance=Q+U;else q.distance=Q+J}while(G>0){let T=-50,q=-1;for(let n=0;n<G;n++){let J=F.locBuffer[n];if(!J)continue;if(J.distance>T&&J.cycle!==F.cycle)T=J.distance,q=n}if(q===-1)break;let Q=F.locBuffer[q];if(Q){if(Q.cycle=F.cycle,!this.locVisible(L,Q.minSceneTileX,Q.maxSceneTileX,Q.minSceneTileZ,Q.maxSceneTileZ,Q.model?.minY??0))Q.model?.draw(m,Q.yaw,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,Q.x-F.eyeX,Q.y-F.eyeY,Q.z-F.eyeZ,Q.typecode);for(let n=Q.minSceneTileX;n<=Q.maxSceneTileX;n++)for(let J=Q.minSceneTileZ;J<=Q.maxSceneTileZ;J++){let U=I[n][J];if(!U)continue;if(U.cornerSides!==0)F.drawTileQueue.push(U);else if((n!==b||J!==E)&&U.drawBack)F.drawTileQueue.push(U)}}}if(R.drawPrimaries)continue}if(!R.drawBack||R.cornerSides!==0)continue;if(b<=F.eyeTileX&&b>F.minDrawTileX){let H=I[b-1][E];if(H&&H.drawBack)continue}if(b>=F.eyeTileX&&b<F.maxDrawTileX-1){let H=I[b+1][E];if(H&&H.drawBack)continue}if(E<=F.eyeTileZ&&E>F.minDrawTileZ){let H=I[b][E-1];if(H&&H.drawBack)continue}if(E>=F.eyeTileZ&&E<F.maxDrawTileZ-1){let H=I[b][E+1];if(H&&H.drawBack)continue}R.drawBack=!1,F.tilesRemaining--;let N=R.groundObject;if(N&&N.offset!==0){if(N.bottomObj)N.bottomObj.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,N.x-F.eyeX,N.y-F.eyeY-N.offset,N.z-F.eyeZ,N.typecode);if(N.middleObj)N.middleObj.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,N.x-F.eyeX,N.y-F.eyeY-N.offset,N.z-F.eyeZ,N.typecode);if(N.topObj)N.topObj.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,N.x-F.eyeX,N.y-F.eyeY-N.offset,N.z-F.eyeZ,N.typecode)}if(R.backWallTypes!==0){let H=R.decor;if(H&&!this.isTileColumnOccluded(L,b,E,H.model.minY)){if((H.angle1&R.backWallTypes)!==0)H.model.draw(m,H.angle2,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,H.x-F.eyeX,H.y-F.eyeY,H.z-F.eyeZ,H.typecode);else if((H.angle1&768)!==0){let T=H.x-F.eyeX,q=H.y-F.eyeY,Q=H.z-F.eyeZ,n=H.angle2,J;if(n===1||n===2)J=-T;else J=T;let U;if(n===2||n===3)U=-Q;else U=Q;if((H.angle1&256)!==0&&U>=J){let w=T+F.WALL_DECORATION_INSET_X[n],k=Q+F.WALL_DECORATION_INSET_Z[n];H.model.draw(m,n*512+256,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,w,q,k,H.typecode)}if((H.angle1&512)!==0&&U<=J){let w=T+F.WALL_DECORATION_OUTSET_X[n],k=Q+F.WALL_DECORATION_OUTSET_Z[n];H.model.draw(m,n*512+1280&2047,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,w,q,k,H.typecode)}}}let G=R.wall;if(G){if((G.angle2&R.backWallTypes)!==0&&!this.isTileSideOccluded(L,b,E,G.angle2))G.model2?.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,G.x-F.eyeX,G.y-F.eyeY,G.z-F.eyeZ,G.typecode);if((G.angle1&R.backWallTypes)!==0&&!this.isTileSideOccluded(L,b,E,G.angle1))G.model1?.draw(m,0,F.sinEyePitch,F.cosEyePitch,F.sinEyeYaw,F.cosEyeYaw,G.x-F.eyeX,G.y-F.eyeY,G.z-F.eyeZ,G.typecode)}}if(O<this.maxLevel-1){let H=this.levelTiles[O+1][b][E];if(H&&H.drawBack)F.drawTileQueue.push(H)}if(b<F.eyeTileX){let H=I[b+1][E];if(H&&H.drawBack)F.drawTileQueue.push(H)}if(E<F.eyeTileZ){let H=I[b][E+1];if(H&&H.drawBack)F.drawTileQueue.push(H)}if(b>F.eyeTileX){let H=I[b-1][E];if(H&&H.drawBack)F.drawTileQueue.push(H)}if(E>F.eyeTileZ){let H=I[b][E-1];if(H&&H.drawBack)F.drawTileQueue.push(H)}}}drawQuickGround(u,_,m,R,b,E,O,L){let I,N=I=(m<<7)-F.eyeX,H,G=H=(R<<7)-F.eyeZ,T,q=T=N+128,Q,n=Q=G+128,J=this.levelHeightmaps[_][m][R]-F.eyeY,U=this.levelHeightmaps[_][m+1][R]-F.eyeY,w=this.levelHeightmaps[_][m+1][R+1]-F.eyeY,k=this.levelHeightmaps[_][m][R+1]-F.eyeY,V=G*O+N*L>>16;if(G=G*L-N*O>>16,N=V,V=J*E-G*b>>16,G=J*b+G*E>>16,J=V,G<50)return;if(V=H*O+q*L>>16,H=H*L-q*O>>16,q=V,V=U*E-H*b>>16,H=U*b+H*E>>16,U=V,H<50)return;if(V=n*O+T*L>>16,n=n*L-T*O>>16,T=V,V=w*E-n*b>>16,n=w*b+n*E>>16,w=V,n<50)return;if(V=Q*O+I*L>>16,Q=Q*L-I*O>>16,I=V,V=k*E-Q*b>>16,Q=k*b+Q*E>>16,k=V,Q<50)return;let j=h.centerX+((N<<9)/G|0),X=h.centerY+((J<<9)/G|0),A=h.centerX+((q<<9)/H|0),Z=h.centerY+((U<<9)/H|0),D=h.centerX+((T<<9)/n|0),Y=h.centerY+((w<<9)/n|0),S=h.centerX+((I<<9)/Q|0),s=h.centerY+((k<<9)/Q|0);if(h.alpha=0,(D-S)*(Z-s)-(Y-s)*(A-S)>0){if(h.clipX=D<0||S<0||A<0||D>K.boundX||S>K.boundX||A>K.boundX,F.takingInput&&this.pointInsideTriangle(F.mouseX,F.mouseY,Y,s,Z,D,S,A))F.clickTileX=m,F.clickTileZ=R;if(u.textureId===-1){if(u.northeastColor!==12345678)h.gouraudTriangle(D,S,A,Y,s,Z,u.northeastColor,u.northwestColor,u.southeastColor)}else if(F.lowMemory){let f=F.TEXTURE_HSL[u.textureId];h.gouraudTriangle(D,S,A,Y,s,Z,this.mulLightness(f,u.northeastColor),this.mulLightness(f,u.northwestColor),this.mulLightness(f,u.southeastColor))}else if(u.flat)h.textureTriangle(D,S,A,Y,s,Z,u.northeastColor,u.northwestColor,u.southeastColor,N,J,G,q,I,U,k,H,Q,u.textureId);else h.textureTriangle(D,S,A,Y,s,Z,u.northeastColor,u.northwestColor,u.southeastColor,T,w,n,I,q,k,U,Q,H,u.textureId)}if((j-A)*(s-Z)-(X-Z)*(S-A)<=0)return;if(h.clipX=j<0||A<0||S<0||j>K.boundX||A>K.boundX||S>K.boundX,F.takingInput&&this.pointInsideTriangle(F.mouseX,F.mouseY,X,Z,s,j,A,S))F.clickTileX=m,F.clickTileZ=R;if(u.textureId!==-1)if(!F.lowMemory)h.textureTriangle(j,A,S,X,Z,s,u.southwestColor,u.southeastColor,u.northwestColor,N,J,G,q,I,U,k,H,Q,u.textureId);else{let f=F.TEXTURE_HSL[u.textureId];h.gouraudTriangle(j,A,S,X,Z,s,this.mulLightness(f,u.southwestColor),this.mulLightness(f,u.southeastColor),this.mulLightness(f,u.northwestColor))}else if(u.southwestColor!==12345678)h.gouraudTriangle(j,A,S,X,Z,s,u.southwestColor,u.southeastColor,u.northwestColor)}drawGround(u,_,m,R,b,E,O){let L=m.vertexX.length;for(let I=0;I<L;I++){let N=m.vertexX[I]-F.eyeX,H=m.vertexY[I]-F.eyeY,G=m.vertexZ[I]-F.eyeZ,T=G*E+N*O>>16;if(G=G*O-N*E>>16,N=T,T=H*b-G*R>>16,G=H*R+G*b>>16,H=T,G<50)return;if(m.triangleTextureIds)t.tmpViewspaceX[I]=N,t.tmpViewspaceY[I]=H,t.tmpViewspaceZ[I]=G;t.tmpScreenX[I]=h.centerX+((N<<9)/G|0),t.tmpScreenY[I]=h.centerY+((H<<9)/G|0)}h.alpha=0,L=m.triangleVertexA.length;for(let I=0;I<L;I++){let N=m.triangleVertexA[I],H=m.triangleVertexB[I],G=m.triangleVertexC[I],T=t.tmpScreenX[N],q=t.tmpScreenX[H],Q=t.tmpScreenX[G],n=t.tmpScreenY[N],J=t.tmpScreenY[H],U=t.tmpScreenY[G];if((T-q)*(U-J)-(n-J)*(Q-q)>0){if(h.clipX=T<0||q<0||Q<0||T>K.boundX||q>K.boundX||Q>K.boundX,F.takingInput&&this.pointInsideTriangle(F.mouseX,F.mouseY,n,J,U,T,q,Q))F.clickTileX=u,F.clickTileZ=_;if(!m.triangleTextureIds||m.triangleTextureIds[I]===-1){if(m.triangleColorA[I]!==12345678)h.gouraudTriangle(T,q,Q,n,J,U,m.triangleColorA[I],m.triangleColorB[I],m.triangleColorC[I])}else if(F.lowMemory){let w=F.TEXTURE_HSL[m.triangleTextureIds[I]];h.gouraudTriangle(T,q,Q,n,J,U,this.mulLightness(w,m.triangleColorA[I]),this.mulLightness(w,m.triangleColorB[I]),this.mulLightness(w,m.triangleColorC[I]))}else if(m.flat)h.textureTriangle(T,q,Q,n,J,U,m.triangleColorA[I],m.triangleColorB[I],m.triangleColorC[I],t.tmpViewspaceX[0],t.tmpViewspaceY[0],t.tmpViewspaceZ[0],t.tmpViewspaceX[1],t.tmpViewspaceX[3],t.tmpViewspaceY[1],t.tmpViewspaceY[3],t.tmpViewspaceZ[1],t.tmpViewspaceZ[3],m.triangleTextureIds[I]);else h.textureTriangle(T,q,Q,n,J,U,m.triangleColorA[I],m.triangleColorB[I],m.triangleColorC[I],t.tmpViewspaceX[N],t.tmpViewspaceY[N],t.tmpViewspaceZ[N],t.tmpViewspaceX[H],t.tmpViewspaceX[G],t.tmpViewspaceY[H],t.tmpViewspaceY[G],t.tmpViewspaceZ[H],t.tmpViewspaceZ[G],m.triangleTextureIds[I])}}}tileVisible(u,_,m){let R=this.levelTileOcclusionCycles[u][_][m];if(R===-F.cycle)return!1;else if(R===F.cycle)return!0;else{let b=_<<7,E=m<<7;if(this.occluded(b+1,this.levelHeightmaps[u][_][m],E+1)&&this.occluded(b+128-1,this.levelHeightmaps[u][_+1][m],E+1)&&this.occluded(b+128-1,this.levelHeightmaps[u][_+1][m+1],E+128-1)&&this.occluded(b+1,this.levelHeightmaps[u][_][m+1],E+128-1))return this.levelTileOcclusionCycles[u][_][m]=F.cycle,!0;else return this.levelTileOcclusionCycles[u][_][m]=-F.cycle,!1}}isTileSideOccluded(u,_,m,R){if(!this.tileVisible(u,_,m))return!1;let b=_<<7,E=m<<7,O=this.levelHeightmaps[u][_][m]-1,L=O-120,I=O-230,N=O-238;if(R<16){if(R===1){if(b>F.eyeX){if(!this.occluded(b,O,E))return!1;if(!this.occluded(b,O,E+128))return!1}if(u>0){if(!this.occluded(b,L,E))return!1;if(!this.occluded(b,L,E+128))return!1}if(!this.occluded(b,I,E))return!1;return this.occluded(b,I,E+128)}if(R===2){if(E<F.eyeZ){if(!this.occluded(b,O,E+128))return!1;if(!this.occluded(b+128,O,E+128))return!1}if(u>0){if(!this.occluded(b,L,E+128))return!1;if(!this.occluded(b+128,L,E+128))return!1}if(!this.occluded(b,I,E+128))return!1;return this.occluded(b+128,I,E+128)}if(R===4){if(b<F.eyeX){if(!this.occluded(b+128,O,E))return!1;if(!this.occluded(b+128,O,E+128))return!1}if(u>0){if(!this.occluded(b+128,L,E))return!1;if(!this.occluded(b+128,L,E+128))return!1}if(!this.occluded(b+128,I,E))return!1;return this.occluded(b+128,I,E+128)}if(R===8){if(E>F.eyeZ){if(!this.occluded(b,O,E))return!1;if(!this.occluded(b+128,O,E))return!1}if(u>0){if(!this.occluded(b,L,E))return!1;if(!this.occluded(b+128,L,E))return!1}if(!this.occluded(b,I,E))return!1;return this.occluded(b+128,I,E)}}if(!this.occluded(b+64,N,E+64))return!1;else if(R===16)return this.occluded(b,I,E+128);else if(R===32)return this.occluded(b+128,I,E+128);else if(R===64)return this.occluded(b+128,I,E);else if(R===128)return this.occluded(b,I,E);return!0}isTileColumnOccluded(u,_,m,R){if(this.tileVisible(u,_,m)){let b=_<<7,E=m<<7;return this.occluded(b+1,this.levelHeightmaps[u][_][m]-R,E+1)&&this.occluded(b+128-1,this.levelHeightmaps[u][_+1][m]-R,E+1)&&this.occluded(b+128-1,this.levelHeightmaps[u][_+1][m+1]-R,E+128-1)&&this.occluded(b+1,this.levelHeightmaps[u][_][m+1]-R,E+128-1)}return!1}locVisible(u,_,m,R,b,E){let O,L;if(_!==m||R!==b){for(O=_;O<=m;O++)for(L=R;L<=b;L++)if(this.levelTileOcclusionCycles[u][O][L]===-F.cycle)return!1;L=(_<<7)+1;let I=(R<<7)+2,N=this.levelHeightmaps[u][_][R]-E;if(!this.occluded(L,N,I))return!1;let H=(m<<7)-1;if(!this.occluded(H,N,I))return!1;let G=(b<<7)-1;if(!this.occluded(L,N,G))return!1;else return this.occluded(H,N,G)}else if(this.tileVisible(u,_,R))return O=_<<7,L=R<<7,this.occluded(O+1,this.levelHeightmaps[u][_][R]-E,L+1)&&this.occluded(O+128-1,this.levelHeightmaps[u][_+1][R]-E,L+1)&&this.occluded(O+128-1,this.levelHeightmaps[u][_+1][R+1]-E,L+128-1)&&this.occluded(O+1,this.levelHeightmaps[u][_][R+1]-E,L+128-1);return!1}occluded(u,_,m){for(let R=0;R<F.activeOccluderCount;R++){let b=F.activeOccluders[R];if(!b)continue;if(b.mode===1){let E=b.minX-u;if(E>0){let O=b.minZ+(b.minDeltaZ*E>>8),L=b.maxZ+(b.maxDeltaZ*E>>8),I=b.minY+(b.minDeltaY*E>>8),N=b.maxY+(b.maxDeltaY*E>>8);if(m>=O&&m<=L&&_>=I&&_<=N)return!0}}else if(b.mode===2){let E=u-b.minX;if(E>0){let O=b.minZ+(b.minDeltaZ*E>>8),L=b.maxZ+(b.maxDeltaZ*E>>8),I=b.minY+(b.minDeltaY*E>>8),N=b.maxY+(b.maxDeltaY*E>>8);if(m>=O&&m<=L&&_>=I&&_<=N)return!0}}else if(b.mode===3){let E=b.minZ-m;if(E>0){let O=b.minX+(b.minDeltaX*E>>8),L=b.maxX+(b.maxDeltaX*E>>8),I=b.minY+(b.minDeltaY*E>>8),N=b.maxY+(b.maxDeltaY*E>>8);if(u>=O&&u<=L&&_>=I&&_<=N)return!0}}else if(b.mode===4){let E=m-b.minZ;if(E>0){let O=b.minX+(b.minDeltaX*E>>8),L=b.maxX+(b.maxDeltaX*E>>8),I=b.minY+(b.minDeltaY*E>>8),N=b.maxY+(b.maxDeltaY*E>>8);if(u>=O&&u<=L&&_>=I&&_<=N)return!0}}else if(b.mode===5){let E=_-b.minY;if(E>0){let O=b.minX+(b.minDeltaX*E>>8),L=b.maxX+(b.maxDeltaX*E>>8),I=b.minZ+(b.minDeltaZ*E>>8),N=b.maxZ+(b.maxDeltaZ*E>>8);if(u>=O&&u<=L&&m>=I&&m<=N)return!0}}}return!1}pointInsideTriangle(u,_,m,R,b,E,O,L){if(_<m&&_<R&&_<b)return!1;else if(_>m&&_>R&&_>b)return!1;else if(u<E&&u<O&&u<L)return!1;else if(u>E&&u>O&&u>L)return!1;let I=(_-m)*(O-E)-(u-E)*(R-m),N=(_-b)*(E-L)-(u-L)*(m-b),H=(_-R)*(L-O)-(u-O)*(b-R);return I*H>0&&H*N>0}mulLightness(u,_){if(_=(127-_)*(u&127)/160|0,_<2)_=2;else if(_>126)_=126;return(u&65408)+_}}class u0 extends w0{index;shape;angle;heightmapSW;heightmapSE;heightmapNE;heightmapNW;seq;seqFrame;seqCycle;constructor(u,_,m,R,b,E,O,L,I,N){super();if(this.index=_,this.shape=m,this.angle=R,this.heightmapSW=b,this.heightmapSE=E,this.heightmapNE=O,this.heightmapNW=L,this.seq=o.types[I],this.seqFrame=0,this.seqCycle=u,N&&this.seq.loops!==-1)this.seqFrame=Math.random()*this.seq.frameCount|0,this.seqCycle-=Math.random()*this.seq.getFrameDuration(this.seqFrame)|0}getModel(u){if(this.seq){let R=u-this.seqCycle;if(R>100&&this.seq.loops>0)R=100;while(R>this.seq.getFrameDuration(this.seqFrame)){if(R-=this.seq.getFrameDuration(this.seqFrame),this.seqFrame++,this.seqFrame<this.seq.frameCount)continue;if(this.seqFrame-=this.seq.loops,this.seqFrame<0||this.seqFrame>=this.seq.frameCount){this.seq=null;break}}this.seqCycle=u-R}let _=-1;if(this.seq&&this.seq.frames&&typeof this.seq.frames[this.seqFrame]<"u")_=this.seq.frames[this.seqFrame];return m0.get(this.index).getModel(this.shape,this.angle,this.heightmapSW,this.heightmapSE,this.heightmapNE,this.heightmapNW,_)}}class C{static ROTATION_WALL_TYPE=Int8Array.of(1,2,4,8);static ROTATION_WALL_CORNER_TYPE=Uint8Array.of(16,32,64,128);static WALL_DECORATION_ROTATION_FORWARD_X=Int8Array.of(1,0,-1,0);static WALL_DECORATION_ROTATION_FORWARD_Z=Int8Array.of(0,-1,0,1);static randomHueOffset=(Math.random()*17|0)-8;static randomLightnessOffset=(Math.random()*33|0)-16;static lowMemory=!0;static levelBuilt=0;static fullbright=!1;static perlin(u,_){let m=this.perlinScale(u+45365,_+91923,4)+(this.perlinScale(u+10294,_+37821,2)-128>>1)+(this.perlinScale(u,_,1)-128>>2)-128;if(m=(m*0.3|0)+35,m<10)m=10;else if(m>60)m=60;return m}static perlinScale(u,_,m){let R=u/m|0,b=u&m-1,E=_/m|0,O=_&m-1,L=this.smoothNoise(R,E),I=this.smoothNoise(R+1,E),N=this.smoothNoise(R,E+1),H=this.smoothNoise(R+1,E+1),G=this.interpolate(L,I,b,m),T=this.interpolate(N,H,b,m);return this.interpolate(G,T,O,m)}static interpolate(u,_,m,R){let b=65536-h.cosTable[m*1024/R|0]>>1;return(u*(65536-b)>>16)+(_*b>>16)}static smoothNoise(u,_){let m=this.noise(u-1,_-1)+this.noise(u+1,_-1)+this.noise(u-1,_+1)+this.noise(u+1,_+1),R=this.noise(u-1,_)+this.noise(u+1,_)+this.noise(u,_-1)+this.noise(u,_+1),b=this.noise(u,_);return(m/16|0)+(R/8|0)+(b/4|0)}static noise(u,_){let m=u+_*57,R=BigInt(m<<13^m);return Number((R*(R*R*15731n+789221n)+1376312589n&0x7fffffffn)>>19n)&255}static isLocReady(u,_){let m=m0.get(u);if(_==11)_=10;if(_>=5&&_<=8)_=4;return m.shapeModelsAreReady(_)}static addLoc(u,_,m,R,b,E,O,L,I,N,H){let G=E[H][m][R],T=E[H][m+1][R],q=E[H][m+1][R+1],Q=E[H][m][R+1],n=G+T+q+Q>>2,J=m0.get(L),U=m+(R<<7)+(L<<14)+1073741824|0;if(!J.active)U+=-2147483648;U|=0;let w=((N<<6)+I|0)<<24>>24;if(I===P.GROUND_DECOR.id){let k;if(J.anim===-1)k=J.getModel(22,N,G,T,Q,q,-1);else k=new u0(u,L,22,I,G,T,Q,q,J.anim,!0);if(b?.addGroundDecoration(k,_,m,R,n,U,w),J.blockwalk&&J.active&&O)O.addFloor(m,R)}else if(I===P.CENTREPIECE_STRAIGHT.id||I===P.CENTREPIECE_DIAGONAL.id){let k;if(J.anim===-1)k=J.getModel(10,N,G,T,Q,q,-1);else k=new u0(u,L,10,N,G,T,Q,q,J.anim,!0);if(k){let V=0;if(I===P.CENTREPIECE_DIAGONAL.id)V+=256;let j,X;if(N===1||N===3)j=J.length,X=J.width;else j=J.width,X=J.length;b?.addLoc(_,m,R,n,k,U,w,j,X,V)}if(J.blockwalk&&O)O.addLoc(m,R,J.width,J.length,N,J.blockrange)}else if(I>=P.ROOF_STRAIGHT.id){let k;if(J.anim===-1)k=J.getModel(I,N,G,T,Q,q,-1);else k=new u0(u,L,I,N,G,T,Q,q,J.anim,!0);if(b?.addLoc(_,m,R,n,k,U,w,1,1,0),J.blockwalk&&O)O.addLoc(m,R,J.width,J.length,N,J.blockrange)}else if(I===P.WALL_STRAIGHT.id){let k;if(J.anim===-1)k=J.getModel(0,N,G,T,Q,q,-1);else k=new u0(u,L,0,N,G,T,Q,q,J.anim,!0);if(b?.addWall(_,m,R,n,C.ROTATION_WALL_TYPE[N],0,k,null,U,w),J.blockwalk&&O)O.addWall(m,R,I,N,J.blockrange)}else if(I===P.WALL_DIAGONAL_CORNER.id){let k;if(J.anim===-1)k=J.getModel(1,N,G,T,Q,q,-1);else k=new u0(u,L,1,N,G,T,Q,q,J.anim,!0);if(b?.addWall(_,m,R,n,C.ROTATION_WALL_CORNER_TYPE[N],0,k,null,U,w),J.blockwalk&&O)O.addWall(m,R,I,N,J.blockrange)}else if(I===P.WALL_L.id){let k=N+1&3,V,j;if(J.anim===-1)V=J.getModel(2,N+4,G,T,Q,q,-1),j=J.getModel(2,k,G,T,Q,q,-1);else V=new u0(u,L,2,N+4,G,T,Q,q,J.anim,!0),j=new u0(u,L,2,k,G,T,Q,q,J.anim,!0);if(b?.addWall(_,m,R,n,C.ROTATION_WALL_TYPE[N],C.ROTATION_WALL_TYPE[k],V,j,U,w),J.blockwalk&&O)O.addWall(m,R,I,N,J.blockrange)}else if(I===P.WALL_SQUARE_CORNER.id){let k;if(J.anim===-1)k=J.getModel(3,N,G,T,Q,q,-1);else k=new u0(u,L,3,N,G,T,Q,q,J.anim,!0);if(b?.addWall(_,m,R,n,C.ROTATION_WALL_CORNER_TYPE[N],0,k,null,U,w),J.blockwalk&&O)O.addWall(m,R,I,N,J.blockrange)}else if(I===P.WALL_DIAGONAL.id){let k;if(J.anim===-1)k=J.getModel(I,N,G,T,Q,q,-1);else k=new u0(u,L,I,N,G,T,Q,q,J.anim,!0);if(b?.addLoc(_,m,R,n,k,U,w,1,1,0),J.blockwalk&&O)O.addLoc(m,R,J.width,J.length,N,J.blockrange)}else if(I===P.WALLDECOR_STRAIGHT_NOOFFSET.id){let k;if(J.anim===-1)k=J.getModel(4,0,G,T,Q,q,-1);else k=new u0(u,L,4,0,G,T,Q,q,J.anim,!0);b?.setWallDecoration(_,m,R,n,0,0,U,k,w,N*512,C.ROTATION_WALL_TYPE[N])}else if(I===P.WALLDECOR_STRAIGHT_OFFSET.id){let k=16;if(b){let j=b.getWallTypecode(_,m,R);if(j>0)k=m0.get(j>>14&32767).wallwidth}let V;if(J.anim===-1)V=J.getModel(4,0,G,T,Q,q,-1);else V=new u0(u,L,4,0,G,T,Q,q,J.anim,!0);b?.setWallDecoration(_,m,R,n,C.WALL_DECORATION_ROTATION_FORWARD_X[N]*k,C.WALL_DECORATION_ROTATION_FORWARD_Z[N]*k,U,V,w,N*512,C.ROTATION_WALL_TYPE[N])}else if(I===P.WALLDECOR_DIAGONAL_OFFSET.id){let k;if(J.anim===-1)k=J.getModel(4,0,G,T,Q,q,-1);else k=new u0(u,L,4,0,G,T,Q,q,J.anim,!0);b?.setWallDecoration(_,m,R,n,0,0,U,k,w,N,256)}else if(I===P.WALLDECOR_DIAGONAL_NOOFFSET.id){let k;if(J.anim===-1)k=J.getModel(4,0,G,T,Q,q,-1);else k=new u0(u,L,4,0,G,T,Q,q,J.anim,!0);b?.setWallDecoration(_,m,R,n,0,0,U,k,w,N,512)}else if(I===P.WALLDECOR_DIAGONAL_BOTH.id){let k;if(J.anim===-1)k=J.getModel(4,0,G,T,Q,q,-1);else k=new u0(u,L,4,0,G,T,Q,q,J.anim,!0);b?.setWallDecoration(_,m,R,n,0,0,U,k,w,N,768)}}maxTileX;maxTileZ;heightmap;flags;underlayType;overlayType;overlayShape;overlayAngle;shadow;lightness;blendChroma;blendSaturation;blendLightness;blendLuminance;blendMagnitude;occlusion;constructor(u,_,m,R){this.maxTileX=u,this.maxTileZ=_,this.heightmap=m,this.flags=R,this.underlayType=new B0(4,u,_),this.overlayType=new B0(4,u,_),this.overlayShape=new B0(4,u,_),this.overlayAngle=new B0(4,u,_),this.occlusion=new g0(4,u+1,_+1),this.shadow=new B0(4,u+1,_+1),this.lightness=new X0(u+1,_+1),this.blendChroma=new Int32Array(_),this.blendSaturation=new Int32Array(_),this.blendLightness=new Int32Array(_),this.blendLuminance=new Int32Array(_),this.blendMagnitude=new Int32Array(_)}build(u,_){for(let m=0;m<4;m++)for(let R=0;R<104;R++)for(let b=0;b<104;b++)if((this.flags[m][R][b]&1)===1){let E=m;if((this.flags[1][R][b]&2)===2)E--;if(E>=0)_[E]?.addFloor(R,b)}if(C.randomHueOffset+=(Math.random()*5|0)-2,C.randomHueOffset<-8)C.randomHueOffset=-8;else if(C.randomHueOffset>8)C.randomHueOffset=8;if(C.randomLightnessOffset+=(Math.random()*5|0)-2,C.randomLightnessOffset<-16)C.randomLightnessOffset=-16;else if(C.randomLightnessOffset>16)C.randomLightnessOffset=16;for(let m=0;m<4;m++){let R=this.shadow[m],b=96,E=768,O=-50,L=-10,I=-50,H=768*(Math.sqrt(5100)|0)>>8;for(let G=1;G<this.maxTileZ-1;G++)for(let T=1;T<this.maxTileX-1;T++){let q=this.heightmap[m][T+1][G]-this.heightmap[m][T-1][G],Q=this.heightmap[m][T][G+1]-this.heightmap[m][T][G-1],n=Math.sqrt(q*q+65536+Q*Q)|0,J=(q<<8)/n|0,U=65536/n|0,w=(Q<<8)/n|0,k=96+((-50*J+-10*U+-50*w)/H|0),V=(R[T-1][G]>>2)+(R[T+1][G]>>3)+(R[T][G-1]>>2)+(R[T][G+1]>>3)+(R[T][G]>>1);this.lightness[T][G]=k-V}for(let G=0;G<this.maxTileZ;G++)this.blendChroma[G]=0,this.blendSaturation[G]=0,this.blendLightness[G]=0,this.blendLuminance[G]=0,this.blendMagnitude[G]=0;for(let G=-5;G<this.maxTileX+5;G++){for(let T=0;T<this.maxTileZ;T++){let q=G+5;if(q>=0&&q<this.maxTileX){let n=this.underlayType[m][q][T]&255;if(n>0){let J=s0.types[n-1];this.blendChroma[T]+=J.chroma,this.blendSaturation[T]+=J.saturation,this.blendLightness[T]+=J.lightness,this.blendLuminance[T]+=J.luminance,this.blendMagnitude[T]++}}let Q=G-5;if(Q>=0&&Q<this.maxTileX){let n=this.underlayType[m][Q][T]&255;if(n>0){let J=s0.types[n-1];this.blendChroma[T]-=J.chroma,this.blendSaturation[T]-=J.saturation,this.blendLightness[T]-=J.lightness,this.blendLuminance[T]-=J.luminance,this.blendMagnitude[T]--}}}if(G>=1&&G<this.maxTileX-1){let T=0,q=0,Q=0,n=0,J=0;for(let U=-5;U<this.maxTileZ+5;U++){let w=U+5;if(w>=0&&w<this.maxTileZ)T+=this.blendChroma[w],q+=this.blendSaturation[w],Q+=this.blendLightness[w],n+=this.blendLuminance[w],J+=this.blendMagnitude[w];let k=U-5;if(k>=0&&k<this.maxTileZ)T-=this.blendChroma[k],q-=this.blendSaturation[k],Q-=this.blendLightness[k],n-=this.blendLuminance[k],J-=this.blendMagnitude[k];if(U>=1&&U<this.maxTileZ-1&&(!C.lowMemory||(this.flags[m][G][U]&16)===0&&this.getDrawLevel(m,G,U)===C.levelBuilt)){let V=this.underlayType[m][G][U]&255,j=this.overlayType[m][G][U]&255;if(V>0||j>0){let X=this.heightmap[m][G][U],A=this.heightmap[m][G+1][U],Z=this.heightmap[m][G+1][U+1],D=this.heightmap[m][G][U+1],Y=this.lightness[G][U],S=this.lightness[G+1][U],s=this.lightness[G+1][U+1],f=this.lightness[G][U+1],z=-1,p=-1;if(V>0){let a=T*256/n|0,y=q/J|0,x=Q/J|0;z=this.hsl24to16(a,y,x);let L0=a+C.randomHueOffset&255;if(x+=C.randomLightnessOffset,x<0)x=0;else if(x>255)x=255;p=this.hsl24to16(L0,y,x)}if(m>0){let a=V!==0||this.overlayShape[m][G][U]===0;if(j>0&&!s0.types[j-1].occlude)a=!1;if(a&&X===A&&X===Z&&X===D)this.occlusion[m][G][U]|=2340}let B=0;if(z!==-1)B=h.colourTable[C.mulHSL(p,96)];if(j===0)u?.setTile(m,G,U,0,0,-1,X,A,Z,D,C.mulHSL(z,Y),C.mulHSL(z,S),C.mulHSL(z,s),C.mulHSL(z,f),0,0,0,0,B,0);else{let a=this.overlayShape[m][G][U]+1,y=this.overlayAngle[m][G][U],x=s0.types[j-1],L0=x.texture,_0,G0;if(L0>=0)G0=h.getAverageTextureRgb(L0),_0=-1;else if(x.rgb===16711935)G0=0,_0=-2,L0=-1;else _0=this.hsl24to16(x.hue,x.saturation,x.lightness),G0=h.colourTable[this.adjustLightness(x.hsl,96)];u?.setTile(m,G,U,a,y,L0,X,A,Z,D,C.mulHSL(z,Y),C.mulHSL(z,S),C.mulHSL(z,s),C.mulHSL(z,f),this.adjustLightness(_0,Y),this.adjustLightness(_0,S),this.adjustLightness(_0,s),this.adjustLightness(_0,f),B,G0)}}}}}}for(let G=1;G<this.maxTileZ-1;G++)for(let T=1;T<this.maxTileX-1;T++)u?.setDrawLevel(m,T,G,this.getDrawLevel(m,T,G))}if(!C.fullbright)u?.buildModels(64,768,-50,-10,-50);for(let m=0;m<this.maxTileX;m++)for(let R=0;R<this.maxTileZ;R++)if((this.flags[1][m][R]&2)===2)u?.setLinkBelow(m,R);if(!C.fullbright){let m=1,R=2,b=4;for(let E=0;E<4;E++){if(E>0)m<<=3,R<<=3,b<<=3;for(let O=0;O<=E;O++)for(let L=0;L<=this.maxTileZ;L++)for(let I=0;I<=this.maxTileX;I++){if((this.occlusion[O][I][L]&m)!==0){let N=L,H=L,G=O,T=O;while(N>0&&(this.occlusion[O][I][N-1]&m)!==0)N--;while(H<this.maxTileZ&&(this.occlusion[O][I][H+1]&m)!==0)H++;u:while(G>0){for(let Q=N;Q<=H;Q++)if((this.occlusion[G-1][I][Q]&m)===0)break u;G--}u:while(T<E){for(let Q=N;Q<=H;Q++)if((this.occlusion[T+1][I][Q]&m)===0)break u;T++}if((T+1-G)*(H+1-N)>=8){let Q=this.heightmap[T][I][N]-240,n=this.heightmap[G][I][N];F.addOccluder(E,1,I*128,Q,N*128,I*128,n,H*128+128);for(let J=G;J<=T;J++)for(let U=N;U<=H;U++)this.occlusion[J][I][U]&=~m}}if((this.occlusion[O][I][L]&R)!==0){let N=I,H=I,G=O,T=O;while(N>0&&(this.occlusion[O][N-1][L]&R)!==0)N--;while(H<this.maxTileX&&(this.occlusion[O][H+1][L]&R)!==0)H++;u:while(G>0){for(let Q=N;Q<=H;Q++)if((this.occlusion[G-1][Q][L]&R)===0)break u;G--}u:while(T<E){for(let Q=N;Q<=H;Q++)if((this.occlusion[T+1][Q][L]&R)===0)break u;T++}if((T+1-G)*(H+1-N)>=8){let Q=this.heightmap[T][N][L]-240,n=this.heightmap[G][N][L];F.addOccluder(E,2,N*128,Q,L*128,H*128+128,n,L*128);for(let J=G;J<=T;J++)for(let U=N;U<=H;U++)this.occlusion[J][U][L]&=~R}}if((this.occlusion[O][I][L]&b)!==0){let N=I,H=I,G=L,T=L;while(G>0&&(this.occlusion[O][I][G-1]&b)!==0)G--;while(T<this.maxTileZ&&(this.occlusion[O][I][T+1]&b)!==0)T++;u:while(N>0){for(let q=G;q<=T;q++)if((this.occlusion[O][N-1][q]&b)===0)break u;N--}u:while(H<this.maxTileX){for(let q=G;q<=T;q++)if((this.occlusion[O][H+1][q]&b)===0)break u;H++}if((H+1-N)*(T+1-G)>=4){let q=this.heightmap[O][N][G];F.addOccluder(E,4,N*128,q,G*128,H*128+128,q,T*128+128);for(let Q=N;Q<=H;Q++)for(let n=G;n<=T;n++)this.occlusion[O][Q][n]&=~b}}}}}}spreadHeight(u,_,m,R){for(let b=u;b<=u+m;b++)for(let E=_;E<=_+R;E++)if(E>=0&&E<this.maxTileX&&b>=0&&b<this.maxTileZ){if(this.shadow[0][E][b]=127,_==E&&E>0)this.heightmap[0][E][b]=this.heightmap[0][E-1][b];if(_+R==E&&E<this.maxTileX-1)this.heightmap[0][E][b]=this.heightmap[0][E+1][b];if(u==b&&b>0)this.heightmap[0][E][b]=this.heightmap[0][E][b-1];if(u+m==b&&b<this.maxTileZ-1)this.heightmap[0][E][b]=this.heightmap[0][E][b+1]}}loadGround(u,_,m,R,b){let E=new W(b);for(let O=0;O<4;O++)for(let L=0;L<64;L++)for(let I=0;I<64;I++){let N=L+m,H=I+R,G;if(N>=0&&N<104&&H>=0&&H<104){this.flags[O][N][H]=0;while(!0){if(G=E.g1(),G===0){if(O===0)this.heightmap[0][N][H]=-C.perlin(N+u+932731,H+556238+_)*8;else this.heightmap[O][N][H]=this.heightmap[O-1][N][H]-240;break}if(G===1){let T=E.g1();if(T===1)T=0;if(O===0)this.heightmap[0][N][H]=-T*8;else this.heightmap[O][N][H]=this.heightmap[O-1][N][H]-T*8;break}if(G<=49)this.overlayType[O][N][H]=E.g1b(),this.overlayShape[O][N][H]=((G-2)/4|0)<<24>>24,this.overlayAngle[O][N][H]=(G-2&3)<<24>>24;else if(G<=81)this.flags[O][N][H]=G-49<<24>>24;else this.underlayType[O][N][H]=G-81<<24>>24}}else while(!0){if(G=E.g1(),G===0)break;if(G===1){E.g1();break}if(G<=49)E.g1()}}}static locsAreReady(u,_,m){let R=!0,b=new W(u),E=-1;while(!0){let O=b.gsmarts();if(O==0)break;E+=O;let L=0,I=!1;while(!0)if(I){if(b.gsmarts()==0)break;b.g1()}else{let N=b.gsmarts();if(N==0)break;L+=N-1;let H=L&63,G=L>>6&63,T=b.g1()>>2,q=_+G,Q=m+H;if(q>0&&Q>0&&q<103&&Q<103){let n=m0.get(E);if(T!=22||!C.lowMemory||n.active||n.forcedecor){if(!n.modelsAreReady())R=!1;I=!0}}}}return R}static prefetchLocs(u,_){let m=-1;while(!0){let R=u.gsmarts();if(R==0)return;m+=R,m0.get(m).prefetch(_);while(!0){if(u.gsmarts()==0)break;u.g1()}}}loadLocations(u,_,m,R,b,E){let O=new W(R),L=-1;while(!0){let I=O.gsmarts();if(I===0)return;L+=I;let N=0;while(!0){let H=O.gsmarts();if(H===0)break;N+=H-1;let G=N&63,T=N>>6&63,q=N>>12,Q=O.g1(),n=Q>>2,J=Q&3,U=T+b,w=G+E;if(U>0&&w>0&&U<104-1&&w<104-1){let k=q;if((this.flags[1][U][w]&2)===2)k=q-1;let V=null;if(k>=0)V=m[k];this.addLoc(u,q,U,w,_,V,L,n,J)}}}}addLoc(u,_,m,R,b,E,O,L,I){if(C.lowMemory){if((this.flags[_][m][R]&16)!==0)return;if(this.getDrawLevel(_,m,R)!==C.levelBuilt)return}let N=this.heightmap[_][m][R],H=this.heightmap[_][m+1][R],G=this.heightmap[_][m+1][R+1],T=this.heightmap[_][m][R+1],q=N+H+G+T>>2,Q=m0.get(O),n=m+(R<<7)+(O<<14)+1073741824|0;if(!Q.active)n+=-2147483648;n|=0;let J=((I<<6)+L|0)<<24>>24;if(L===P.GROUND_DECOR.id){if(!C.lowMemory||Q.active||Q.forcedecor){let U;if(Q.anim===-1)U=Q.getModel(22,I,N,H,G,T,-1);else U=new u0(u,O,22,L,N,H,G,T,Q.anim,!0);if(b?.addGroundDecoration(U,_,m,R,q,n,J),Q.blockwalk&&Q.active&&E)E.addFloor(m,R)}}else if(L===P.CENTREPIECE_STRAIGHT.id||L===P.CENTREPIECE_DIAGONAL.id){let U;if(Q.anim===-1)U=Q.getModel(10,I,N,H,G,T,-1);else U=new u0(u,O,10,I,N,H,G,T,Q.anim,!0);if(U){let w=0;if(L===P.CENTREPIECE_DIAGONAL.id)w+=256;let k,V;if(I===1||I===3)k=Q.length,V=Q.width;else k=Q.width,V=Q.length;if(b?.addLoc(_,m,R,q,U,n,J,k,V,w)&&Q.shadow){let j;if(U instanceof $)j=U;else j=Q.getModel(10,I,N,H,G,T,-1);if(j)for(let X=0;X<=k;X++)for(let A=0;A<=V;A++){let Z=j.radius/4|0;if(Z>30)Z=30;if(Z>this.shadow[_][m+X][R+A])this.shadow[_][m+X][R+A]=Z<<24>>24}}}if(Q.blockwalk&&E)E.addLoc(m,R,Q.width,Q.length,I,Q.blockrange)}else if(L>=P.ROOF_STRAIGHT.id){let U;if(Q.anim===-1)U=Q.getModel(L,I,N,H,G,T,-1);else U=new u0(u,O,L,I,N,H,G,T,Q.anim,!0);if(b?.addLoc(_,m,R,q,U,n,J,1,1,0),L>=P.ROOF_STRAIGHT.id&&L<=P.ROOF_FLAT.id&&L!==P.ROOF_DIAGONAL_WITH_ROOFEDGE.id&&_>0)this.occlusion[_][m][R]|=2340;if(Q.blockwalk&&E)E.addLoc(m,R,Q.width,Q.length,I,Q.blockrange)}else if(L===P.WALL_STRAIGHT.id){let U;if(Q.anim===-1)U=Q.getModel(0,I,N,H,G,T,-1);else U=new u0(u,O,0,I,N,H,G,T,Q.anim,!0);if(b?.addWall(_,m,R,q,C.ROTATION_WALL_TYPE[I],0,U,null,n,J),I===0){if(Q.shadow)this.shadow[_][m][R]=50,this.shadow[_][m][R+1]=50;if(Q.occlude)this.occlusion[_][m][R]|=585}else if(I===1){if(Q.shadow)this.shadow[_][m][R+1]=50,this.shadow[_][m+1][R+1]=50;if(Q.occlude)this.occlusion[_][m][R+1]|=1170}else if(I===2){if(Q.shadow)this.shadow[_][m+1][R]=50,this.shadow[_][m+1][R+1]=50;if(Q.occlude)this.occlusion[_][m+1][R]|=585}else if(I===3){if(Q.shadow)this.shadow[_][m][R]=50,this.shadow[_][m+1][R]=50;if(Q.occlude)this.occlusion[_][m][R]|=1170}if(Q.blockwalk&&E)E.addWall(m,R,L,I,Q.blockrange);if(Q.wallwidth!==16)b?.setWallDecorationOffset(_,m,R,Q.wallwidth)}else if(L===P.WALL_DIAGONAL_CORNER.id){let U;if(Q.anim===-1)U=Q.getModel(1,I,N,H,G,T,-1);else U=new u0(u,O,1,I,N,H,G,T,Q.anim,!0);if(b?.addWall(_,m,R,q,C.ROTATION_WALL_CORNER_TYPE[I],0,U,null,n,J),Q.shadow){if(I===0)this.shadow[_][m][R+1]=50;else if(I===1)this.shadow[_][m+1][R+1]=50;else if(I===2)this.shadow[_][m+1][R]=50;else if(I===3)this.shadow[_][m][R]=50}if(Q.blockwalk&&E)E.addWall(m,R,L,I,Q.blockrange)}else if(L===P.WALL_L.id){let U=I+1&3,w,k;if(Q.anim===-1)w=Q.getModel(2,I+4,N,H,G,T,-1),k=Q.getModel(2,U,N,H,G,T,-1);else w=new u0(u,O,2,I+4,N,H,G,T,Q.anim,!0),k=new u0(u,O,2,U,N,H,G,T,Q.anim,!0);if(b?.addWall(_,m,R,q,C.ROTATION_WALL_TYPE[I],C.ROTATION_WALL_TYPE[U],w,k,n,J),Q.occlude){if(I===0)this.occlusion[_][m][R]|=265,this.occlusion[_][m][R+1]|=1170;else if(I===1)this.occlusion[_][m][R+1]|=1170,this.occlusion[_][m+1][R]|=585;else if(I===2)this.occlusion[_][m+1][R]|=585,this.occlusion[_][m][R]|=1170;else if(I===3)this.occlusion[_][m][R]|=1170,this.occlusion[_][m][R]|=585}if(Q.blockwalk&&E)E.addWall(m,R,L,I,Q.blockrange);if(Q.wallwidth!==16)b?.setWallDecorationOffset(_,m,R,Q.wallwidth)}else if(L===P.WALL_SQUARE_CORNER.id){let U;if(Q.anim===-1)U=Q.getModel(3,I,N,H,G,T,-1);else U=new u0(u,O,3,I,N,H,G,T,Q.anim,!0);if(b?.addWall(_,m,R,q,C.ROTATION_WALL_CORNER_TYPE[I],0,U,null,n,J),Q.shadow){if(I===0)this.shadow[_][m][R+1]=50;else if(I===1)this.shadow[_][m+1][R+1]=50;else if(I===2)this.shadow[_][m+1][R]=50;else if(I===3)this.shadow[_][m][R]=50}if(Q.blockwalk&&E)E.addWall(m,R,L,I,Q.blockrange)}else if(L===P.WALL_DIAGONAL.id){let U;if(Q.anim===-1)U=Q.getModel(L,I,N,H,G,T,-1);else U=new u0(u,O,L,I,N,H,G,T,Q.anim,!0);if(b?.addLoc(_,m,R,q,U,n,J,1,1,0),Q.blockwalk&&E)E.addLoc(m,R,Q.width,Q.length,I,Q.blockrange)}else if(L===P.WALLDECOR_STRAIGHT_NOOFFSET.id){let U;if(Q.anim===-1)U=Q.getModel(4,0,N,H,G,T,-1);else U=new u0(u,O,4,0,N,H,G,T,Q.anim,!0);b?.setWallDecoration(_,m,R,q,0,0,n,U,J,I*512,C.ROTATION_WALL_TYPE[I])}else if(L===P.WALLDECOR_STRAIGHT_OFFSET.id){let U=16;if(b){let k=b.getWallTypecode(_,m,R);if(k>0)U=m0.get(k>>14&32767).wallwidth}let w;if(Q.anim===-1)w=Q.getModel(4,0,N,H,G,T,-1);else w=new u0(u,O,4,0,N,H,G,T,Q.anim,!0);b?.setWallDecoration(_,m,R,q,C.WALL_DECORATION_ROTATION_FORWARD_X[I]*U,C.WALL_DECORATION_ROTATION_FORWARD_Z[I]*U,n,w,J,I*512,C.ROTATION_WALL_TYPE[I])}else if(L===P.WALLDECOR_DIAGONAL_OFFSET.id){let U;if(Q.anim===-1)U=Q.getModel(4,0,N,H,G,T,-1);else U=new u0(u,O,4,0,N,H,G,T,Q.anim,!0);b?.setWallDecoration(_,m,R,q,0,0,n,U,J,I,256)}else if(L===P.WALLDECOR_DIAGONAL_NOOFFSET.id){let U;if(Q.anim===-1)U=Q.getModel(4,0,N,H,G,T,-1);else U=new u0(u,O,4,0,N,H,G,T,Q.anim,!0);b?.setWallDecoration(_,m,R,q,0,0,n,U,J,I,512)}else if(L===P.WALLDECOR_DIAGONAL_BOTH.id){let U;if(Q.anim===-1)U=Q.getModel(4,0,N,H,G,T,-1);else U=new u0(u,O,4,0,N,H,G,T,Q.anim,!0);b?.setWallDecoration(_,m,R,q,0,0,n,U,J,I,768)}}getDrawLevel(u,_,m){if((this.flags[u][_][m]&8)===0)return u<=0||(this.flags[1][_][m]&2)===0?u:u-1;return 0}hsl24to16(u,_,m){if(m>179)_=_/2|0;if(m>192)_=_/2|0;if(m>217)_=_/2|0;if(m>243)_=_/2|0;return((u/4|0)<<10)+((_/32|0)<<7)+(m/2|0)}static mulHSL(u,_){if(u===-1)return 12345678;if(_=_*(u&127)/128|0,_<2)_=2;else if(_>126)_=126;return(u&65408)+_}adjustLightness(u,_){if(u===-2)return 12345678;if(u===-1){if(_<0)_=0;else if(_>127)_=127;return 127-_}else{if(_=_*(u&127)/128|0,_<2)_=2;else if(_>126)_=126;return(u&65408)+_}}}class C0 extends w0{x=0;z=0;yaw=0;needsForwardDrawPadding=!1;size=1;readyanim=-1;turnanim=-1;walkanim=-1;walkanim_b=-1;walkanim_l=-1;walkanim_r=-1;runanim=-1;chatMessage=null;chatTimer=100;chatColour=0;chatEffect=0;combatCycle=-1000;damageValues=new Int32Array(4);damageTypes=new Int32Array(4);damageCycles=new Int32Array(4);health=0;totalHealth=0;targetId=-1;targetTileX=0;targetTileZ=0;secondarySeqId=-1;secondarySeqFrame=0;secondarySeqCycle=0;primarySeqId=-1;primarySeqFrame=0;primarySeqCycle=0;primarySeqDelay=0;primarySeqLoop=0;spotanimId=-1;spotanimFrame=0;spotanimCycle=0;spotanimLastCycle=0;spotanimHeight=0;forceMoveStartSceneTileX=0;forceMoveEndSceneTileX=0;forceMoveStartSceneTileZ=0;forceMoveEndSceneTileZ=0;forceMoveEndCycle=0;forceMoveStartCycle=0;forceMoveFaceDirection=0;cycle=0;height=0;dstYaw=0;routeLength=0;routeTileX=new Int32Array(10);routeTileZ=new Int32Array(10);routeRun=new r(10,!1);seqDelayMove=0;preanimRouteLength=0;move(u,_,m){if(this.primarySeqId!==-1&&o.types[this.primarySeqId].postanim_move===1)this.primarySeqId=-1;if(!u){let R=_-this.routeTileX[0],b=m-this.routeTileZ[0];if(R>=-8&&R<=8&&b>=-8&&b<=8){if(this.routeLength<9)this.routeLength++;for(let E=this.routeLength;E>0;E--)this.routeTileX[E]=this.routeTileX[E-1],this.routeTileZ[E]=this.routeTileZ[E-1],this.routeRun[E]=this.routeRun[E-1];this.routeTileX[0]=_,this.routeTileZ[0]=m,this.routeRun[0]=!1;return}}this.routeLength=0,this.preanimRouteLength=0,this.seqDelayMove=0,this.routeTileX[0]=_,this.routeTileZ[0]=m,this.x=this.routeTileX[0]*128+this.size*64,this.z=this.routeTileZ[0]*128+this.size*64}step(u,_){let m=this.routeTileX[0],R=this.routeTileZ[0];if(_===0)m--,R++;else if(_===1)R++;else if(_===2)m++,R++;else if(_===3)m--;else if(_===4)m++;else if(_===5)m--,R--;else if(_===6)R--;else if(_===7)m++,R--;if(this.primarySeqId!==-1&&o.types[this.primarySeqId].postanim_move===1)this.primarySeqId=-1;if(this.routeLength<9)this.routeLength++;for(let b=this.routeLength;b>0;b--)this.routeTileX[b]=this.routeTileX[b-1],this.routeTileZ[b]=this.routeTileZ[b-1],this.routeRun[b]=this.routeRun[b-1];this.routeTileX[0]=m,this.routeTileZ[0]=R,this.routeRun[0]=u}clearRoute(){this.routeLength=0,this.preanimRouteLength=0}hit(u,_,m){for(let R=0;R<4;R++)if(this.damageCycles[R]<=u){this.damageValues[R]=m,this.damageTypes[R]=_,this.damageCycles[R]=u+70;return}}}class Tu extends C0{type=null;getModel(){if(this.type==null)return null;let u=this.getAnimatedModel();if(u==null)return null;if(this.height=u.minY,this.spotanimId!=-1&&this.spotanimFrame!=-1){let _=n0.types[this.spotanimId],m=_.getModel();if(m!=null){let R=$.modelShareColored(m,!0,!_.animHasAlpha,!1);if(R.translate(-this.spotanimHeight,0,0),R.createLabelReferences(),_.seq&&_.seq.frames)R.applyTransform(_.seq.frames[this.spotanimFrame]);if(R.labelFaces=null,R.labelVertices=null,_.resizeh!=128||_.resizev!=128)R.scale(_.resizev,_.resizeh,_.resizeh);R.calculateNormals(_.ambient+64,_.contrast+850,-30,-50,-30,!0);let b=[u,R];u=$.modelFromModelsBounds(b,2)}}if(this.type.size==1)u.picking=!0;return u}getAnimatedModel(){if(!this.type)return null;if(this.primarySeqId<0||this.primarySeqDelay!=0){let u=o.types[this.secondarySeqId],_=-1;if(this.secondarySeqId>=0&&u.frames)_=u.frames[this.secondarySeqFrame];return this.type.getModel(_,-1,null)}else{let u=o.types[this.primarySeqId],_=-1;if(u.frames)_=u.frames[this.primarySeqFrame];let m=o.types[this.secondarySeqId],R=-1;if(this.secondarySeqId>=0&&this.secondarySeqId!=this.readyanim&&m.frames)R=m.frames[this.secondarySeqFrame];return this.type.getModel(_,R,u.walkmerge)}}isVisible(){return this.type!==null}}class T0 extends C0{static TORSO_RECOLORS=[9104,10275,7595,3610,7975,8526,918,38802,24466,10145,58654,5027,1457,16565,34991,25486];static DESIGN_IDK_COLORS=[[6798,107,10283,16,4797,7744,5799,4634,33697,22433,2983,54193],[8741,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003,25239],[25238,8742,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003],[4626,11146,6439,12,4758,10270],[4550,4537,5681,5673,5790,6806,8076,4574]];name=null;visible=!1;gender=0;headicons=0;appearance=new Uint16Array(12);colour=new Uint16Array(5);combatLevel=0;hash=0n;lowMemory=!1;modelCacheKey=-1n;static modelCache=new F0(200);y=0;locStartCycle=0;locStopCycle=0;locOffsetX=0;locOffsetY=0;locOffsetZ=0;locModel=null;minTileX=0;minTileZ=0;maxTileX=0;maxTileZ=0;read(u){u.pos=0,this.gender=u.g1(),this.headicons=u.g1();for(let _=0;_<12;_++){let m=u.g1();if(m===0)this.appearance[_]=0;else this.appearance[_]=(m<<8)+u.g1()}for(let _=0;_<5;_++){let m=u.g1();if(m<0||m>=T0.DESIGN_IDK_COLORS[_].length)m=0;this.colour[_]=m}if(this.readyanim=u.g2(),this.readyanim===65535)this.readyanim=-1;if(this.turnanim=u.g2(),this.turnanim===65535)this.turnanim=-1;if(this.walkanim=u.g2(),this.walkanim===65535)this.walkanim=-1;if(this.walkanim_b=u.g2(),this.walkanim_b===65535)this.walkanim_b=-1;if(this.walkanim_l=u.g2(),this.walkanim_l===65535)this.walkanim_l=-1;if(this.walkanim_r=u.g2(),this.walkanim_r===65535)this.walkanim_r=-1;if(this.runanim=u.g2(),this.runanim===65535)this.runanim=-1;this.name=c.formatName(c.fromBase37(u.g8())),this.combatLevel=u.g1(),this.visible=!0,this.hash=0n;for(let _=0;_<12;_++)if(this.hash<<=0x4n,this.appearance[_]>=256)this.hash+=BigInt(this.appearance[_])-256n;if(this.appearance[0]>=256)this.hash+=BigInt(this.appearance[0])-256n>>4n;if(this.appearance[1]>=256)this.hash+=BigInt(this.appearance[1])-256n>>8n;for(let _=0;_<5;_++)this.hash<<=0x3n,this.hash+=BigInt(this.colour[_]);this.hash<<=0x1n,this.hash+=BigInt(this.gender)}getModel(u){if(!this.visible)return null;let _=this.getAnimatedModel();if(_==null)return null;if(this.height=_.minY,_.picking=!0,this.lowMemory)return _;if(this.spotanimId!=-1&&this.spotanimFrame!=-1){let m=n0.types[this.spotanimId],R=m.getModel();if(R!=null){let b=$.modelShareColored(R,!0,!m.animHasAlpha,!1);if(b.translate(-this.spotanimHeight,0,0),b.createLabelReferences(),m.seq&&m.seq.frames)b.applyTransform(m.seq.frames[this.spotanimFrame]);if(b.labelFaces=null,b.labelVertices=null,m.resizeh!=128||m.resizev!=128)b.scale(m.resizev,m.resizeh,m.resizeh);b.calculateNormals(m.ambient+64,m.contrast+850,-30,-50,-30,!0);let E=[_,b];_=$.modelFromModelsBounds(E,2)}}if(this.locModel!=null){if(u>=this.locStopCycle)this.locModel=null;if(u>=this.locStartCycle&&u<this.locStopCycle){let m=this.locModel;if(m){if(m.translate(this.locOffsetY-this.y,this.locOffsetX-this.x,this.locOffsetZ-this.z),this.dstYaw==512)m.rotateY90(),m.rotateY90(),m.rotateY90();else if(this.dstYaw==1024)m.rotateY90(),m.rotateY90();else if(this.dstYaw==1536)m.rotateY90();let R=[_,m];if(_=$.modelFromModelsBounds(R,2),this.dstYaw==512)m.rotateY90();else if(this.dstYaw==1024)m.rotateY90(),m.rotateY90();else if(this.dstYaw==1536)m.rotateY90(),m.rotateY90(),m.rotateY90();m.translate(this.y-this.locOffsetY,this.x-this.locOffsetX,this.z-this.locOffsetZ)}}}return _.picking=!0,_}getAnimatedModel(){let u=this.hash,_=-1,m=-1,R=-1,b=-1;if(this.primarySeqId>=0&&this.primarySeqDelay===0){let L=o.types[this.primarySeqId];if(L.frames)_=L.frames[this.primarySeqFrame];if(this.secondarySeqId>=0&&this.secondarySeqId!==this.readyanim){let I=o.types[this.secondarySeqId].frames;if(I)m=I[this.secondarySeqFrame]}if(L.replaceheldleft>=0)R=L.replaceheldleft,u+=BigInt(R-this.appearance[5])<<40n;if(L.replaceheldright>=0)b=L.replaceheldright,u+=BigInt(b-this.appearance[3])<<48n}else if(this.secondarySeqId>=0){let L=o.types[this.secondarySeqId].frames;if(L)_=L[this.secondarySeqFrame]}let E=T0.modelCache?.get(u);if(!E){let L=!1;for(let I=0;I<12;I++){let N=this.appearance[I];if(b>=0&&I==3)N=b;if(R>=0&&I==5)N=R;if(N>=256&&N<512&&!U0.types[N-256].modelIsReady())L=!0;if(N>=512&&!l.get(N-512).wornModelIsReady(this.gender))L=!0}if(L){if(this.modelCacheKey!==-1n&&T0.modelCache)E=T0.modelCache.get(this.hash);if(E==null)return null}}if(!E){let L=new r(12,null),I=0;for(let N=0;N<12;N++){let H=this.appearance[N];if(b>=0&&N===3)H=b;if(R>=0&&N===5)H=R;if(H>=256&&H<512){let G=U0.types[H-256].getModel();if(G)L[I++]=G}if(H>=512){let T=l.get(H-512).getWornModel(this.gender);if(T)L[I++]=T}}E=$.modelFromModels(L,I);for(let N=0;N<5;N++){if(this.colour[N]===0)continue;if(E.recolour(T0.DESIGN_IDK_COLORS[N][0],T0.DESIGN_IDK_COLORS[N][this.colour[N]]),N===1)E.recolour(T0.TORSO_RECOLORS[0],T0.TORSO_RECOLORS[this.colour[N]])}E.createLabelReferences(),E.calculateNormals(64,850,-30,-50,-30,!0),T0.modelCache?.put(u,E),this.modelCacheKey=u}if(this.lowMemory)return E;let O=$.modelShareAlpha(E,!0);if(_!==-1&&m!==-1)O.applyTransforms(_,m,o.types[this.primarySeqId].walkmerge);else if(_!==-1)O.applyTransform(_);return O.calculateBoundsCylinder(),O.labelFaces=null,O.labelVertices=null,O}getHeadModel(){if(!this.visible)return null;let u=!1;for(let b=0;b<12;b++){let E=this.appearance[b];if(E>=256&&E<512&&!U0.types[E-256].headModelIsReady())u=!0;if(E>=512&&!l.get(E-512).headModelIsReady(this.gender))u=!0}if(u)return null;let _=new r(12,null),m=0;for(let b=0;b<12;b++){let E=this.appearance[b];if(E>=256&&E<512){let O=U0.types[E-256].getHeadModel();if(O)_[m++]=O}if(E>=512){let O=l.get(E-512).getHeadModel(this.gender);if(O)_[m++]=O}}let R=$.modelFromModels(_,m);for(let b=0;b<5;b++){if(this.colour[b]===0)continue;if(R.recolour(T0.DESIGN_IDK_COLORS[b][0],T0.DESIGN_IDK_COLORS[b][this.colour[b]]),b===1)R.recolour(T0.TORSO_RECOLORS[0],T0.TORSO_RECOLORS[this.colour[b]])}return R}isVisible(){return this.visible}}class Qu extends f0{endTime=-1;newType=0;newAngle=0;newShape=0;level=0;layer=0;x=0;z=0;oldType=0;oldAngle=0;oldShape=0;startTime=0}class l0 extends w0{index;count;constructor(u,_){super();this.index=u,this.count=_}getModel(){return l.get(this.index).getModel(this.count)}}class qu extends w0{spotanim;projLevel;srcX;srcZ;srcY;projOffsetY;startCycle;lastCycle;peakPitch;projArc;projTarget;mobile=!1;x=0;z=0;y=0;projVelocityX=0;projVelocityZ=0;projVelocity=0;projVelocityY=0;accelerationY=0;yaw=0;pitch=0;seqFrame=0;seqCycle=0;constructor(u,_,m,R,b,E,O,L,I,N,H){super();this.spotanim=n0.types[u],this.projLevel=_,this.srcX=m,this.srcZ=b,this.srcY=R,this.startCycle=E,this.lastCycle=O,this.peakPitch=L,this.projArc=I,this.projTarget=N,this.projOffsetY=H}updateVelocity(u,_,m,R){if(!this.mobile){let E=u-this.srcX,O=m-this.srcZ,L=Math.sqrt(E*E+O*O);this.x=this.srcX+E*this.projArc/L,this.z=this.srcZ+O*this.projArc/L,this.y=this.srcY}let b=this.lastCycle+1-R;if(this.projVelocityX=(u-this.x)/b,this.projVelocityZ=(m-this.z)/b,this.projVelocity=Math.sqrt(this.projVelocityX*this.projVelocityX+this.projVelocityZ*this.projVelocityZ),!this.mobile)this.projVelocityY=-this.projVelocity*Math.tan(this.peakPitch*0.02454369);this.accelerationY=(_-this.y-this.projVelocityY*b)*2/(b*b)}update(u){if(this.mobile=!0,this.x+=this.projVelocityX*u,this.z+=this.projVelocityZ*u,this.y+=this.projVelocityY*u+this.accelerationY*0.5*u*u,this.projVelocityY+=this.accelerationY*u,this.yaw=(Math.atan2(this.projVelocityX,this.projVelocityZ)*325.949+1024|0)&2047,this.pitch=(Math.atan2(this.projVelocityY,this.projVelocity)*325.949|0)&2047,!this.spotanim.seq)return;this.seqCycle+=u;while(this.seqCycle>this.spotanim.seq.getFrameDuration(this.seqFrame))if(this.seqCycle-=this.spotanim.seq.getFrameDuration(this.seqFrame)+1,this.seqFrame++,this.seqFrame>=this.spotanim.seq.frameCount)this.seqFrame=0}getModel(){let u=this.spotanim.getModel();if(!u)return null;let _=$.modelShareColored(u,!0,!this.spotanim.animHasAlpha,!1);if(this.spotanim.seq&&this.spotanim.seq.frames)_.createLabelReferences(),_.applyTransform(this.spotanim.seq.frames[this.seqFrame]),_.labelFaces=null,_.labelVertices=null;if(this.spotanim.resizeh!==128||this.spotanim.resizev!==128)_.scale(this.spotanim.resizeh,this.spotanim.resizev,this.spotanim.resizeh);return _.rotateX(this.pitch),_.calculateNormals(64+this.spotanim.ambient,850+this.spotanim.contrast,-30,-50,-30,!0),_}}class $u extends w0{spotType;spotLevel;x;z;y;startCycle;seqComplete=!1;seqFrame=0;seqCycle=0;constructor(u,_,m,R,b,E,O){super();this.spotType=n0.types[u],this.spotLevel=_,this.x=m,this.z=R,this.y=b,this.startCycle=E+O}update(u){if(!this.spotType.seq)return;for(this.seqCycle+=u;this.seqCycle>this.spotType.seq.getFrameDuration(this.seqFrame);)if(this.seqCycle-=this.spotType.seq.getFrameDuration(this.seqFrame)+1,this.seqFrame++,this.seqFrame>=this.spotType.seq.frameCount)this.seqFrame=0,this.seqComplete=!0}getModel(){let u=this.spotType.getModel();if(!u)return null;let _=$.modelShareColored(u,!0,!this.spotType.animHasAlpha,!1);if(!this.seqComplete&&this.spotType.seq&&this.spotType.seq.frames)_.createLabelReferences(),_.applyTransform(this.spotType.seq.frames[this.seqFrame]),_.labelFaces=null,_.labelVertices=null;if(this.spotType.resizeh!==128||this.spotType.resizev!==128)_.scale(this.spotType.resizeh,this.spotType.resizev,this.spotType.resizeh);if(this.spotType.angle!==0){if(this.spotType.angle===90)_.rotateY90();else if(this.spotType.angle===180)_.rotateY90(),_.rotateY90();else if(this.spotType.angle===270)_.rotateY90(),_.rotateY90(),_.rotateY90()}return _.calculateNormals(64+this.spotType.ambient,850+this.spotType.contrast,-30,-50,-30,!0),_}}class Ju{seed;constructor(u){this.seed=(u^0x5deece66dn)&(1n<<48n)-1n}setSeed(u){this.seed=(u^0x5deece66dn)&(1n<<48n)-1n}nextInt(){return this.next(32)}next(u){return this.seed=this.seed*0x5deece66dn+0xbn&(1n<<48n)-1n,Number(this.seed)>>>48-u}}class k0 extends V0{static CHARSET=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"£$%^&*()-_=+[{]};:'@#~,<.>/?\\| `;static CHARCODESET=[];charMask=[];charMaskWidth=new Int32Array(94);charMaskHeight=new Int32Array(94);charOffsetX=new Int32Array(94);charOffsetY=new Int32Array(94);charAdvance=new Int32Array(95);drawWidth=new Int32Array(256);random=new Ju(BigInt(Date.now()));height2d=0;static{let u=navigator.userAgent.includes("Capacitor");for(let _=0;_<256;_++){let m=k0.CHARSET.indexOf(String.fromCharCode(_));if(u){if(m>=63)m--}if(m===-1)m=74;k0.CHARCODESET[_]=m}}static fromArchive(u,_){let m=new W(u.read(_+".dat")),R=new W(u.read("index.dat"));R.pos=m.g2()+4;let b=R.g1();if(b>0)R.pos+=(b-1)*3;let E=new k0;for(let O=0;O<94;O++){E.charOffsetX[O]=R.g1(),E.charOffsetY[O]=R.g1();let L=E.charMaskWidth[O]=R.g2(),I=E.charMaskHeight[O]=R.g2(),N=R.g1(),H=L*I;if(E.charMask[O]=new Int8Array(H),N===0)for(let G=0;G<L*I;G++)E.charMask[O][G]=m.g1b();else if(N===1)for(let G=0;G<L;G++)for(let T=0;T<I;T++)E.charMask[O][G+T*L]=m.g1b();if(I>E.height2d)E.height2d=I;E.charOffsetX[O]=1,E.charAdvance[O]=L+2;{let G=0;for(let T=I/7|0;T<I;T++)G+=E.charMask[O][T*L];if(G<=(I/7|0))E.charAdvance[O]--,E.charOffsetX[O]=0}{let G=0;for(let T=I/7|0;T<I;T++)G+=E.charMask[O][L+T*L-1];if(G<=(I/7|0))E.charAdvance[O]--}}E.charAdvance[94]=E.charAdvance[8];for(let O=0;O<256;O++)E.drawWidth[O]=E.charAdvance[k0.CHARCODESET[O]];return E}drawString(u,_,m,R){if(!m)return;u|=0,_|=0;let b=m.length;_-=this.height2d;for(let E=0;E<b;E++){let O=k0.CHARCODESET[m.charCodeAt(E)];if(O!==94)this.drawChar(this.charMask[O],u+this.charOffsetX[O],_+this.charOffsetY[O],this.charMaskWidth[O],this.charMaskHeight[O],R);u+=this.charAdvance[O]}}drawStringTaggable(u,_,m,R,b){u|=0,_|=0;let E=m.length;_-=this.height2d;for(let O=0;O<E;O++)if(m.charAt(O)==="@"&&O+4<E&&m.charAt(O+4)==="@")R=this.evaluateTag(m.substring(O+1,O+4)),O+=4;else{let L=k0.CHARCODESET[m.charCodeAt(O)];if(L!==94){if(b)this.drawChar(this.charMask[L],u+this.charOffsetX[L]+1,_+this.charOffsetY[L]+1,this.charMaskWidth[L],this.charMaskHeight[L],0);this.drawChar(this.charMask[L],u+this.charOffsetX[L],_+this.charOffsetY[L],this.charMaskWidth[L],this.charMaskHeight[L],R)}u+=this.charAdvance[L]}}stringWidth(u){if(!u)return 0;let _=u.length,m=0;for(let R=0;R<_;R++)if(u.charAt(R)==="@"&&R+4<_&&u.charAt(R+4)==="@")R+=4;else m+=this.drawWidth[u.charCodeAt(R)];return m}drawStringTaggableCenter(u,_,m,R,b){u|=0,_|=0,this.drawStringTaggable(u-(this.stringWidth(m)/2|0),_,m,R,b)}drawStringCenter(u,_,m,R){if(!m)return;u|=0,_|=0,this.drawString(u-(this.stringWidth(m)/2|0),_,m,R)}drawStringTooltip(u,_,m,R,b,E){u|=0,_|=0,this.random.setSeed(BigInt(E));let O=(this.random.nextInt()&31)+192,L=_-this.height2d;for(let I=0;I<m.length;I++)if(m.charAt(I)==="@"&&I+4<m.length&&m.charAt(I+4)==="@")R=this.evaluateTag(m.substring(I+1,I+4)),I+=4;else{let N=k0.CHARCODESET[m.charCodeAt(I)];if(N!==94){if(b)this.drawCharAlpha(u+this.charOffsetX[N]+1,L+this.charOffsetY[N]+1,this.charMaskWidth[N],this.charMaskHeight[N],0,192,this.charMask[N]);this.drawCharAlpha(u+this.charOffsetX[N],L+this.charOffsetY[N],this.charMaskWidth[N],this.charMaskHeight[N],R,O,this.charMask[N])}if(u+=this.charAdvance[N],(this.random.nextInt()&3)===0)u++}}drawStringRight(u,_,m,R,b=!0){if(u|=0,_|=0,b)this.drawString(u-this.stringWidth(m)+1,_+1,m,0);this.drawString(u-this.stringWidth(m),_,m,R)}drawCenteredWave(u,_,m,R,b){if(!m)return;u|=0,_|=0,u-=this.stringWidth(m)/2|0;let E=_-this.height2d;for(let O=0;O<m.length;O++){let L=k0.CHARCODESET[m.charCodeAt(O)];if(L!=94)this.drawChar(this.charMask[L],u+this.charOffsetX[L],E+this.charOffsetY[L]+(Math.sin(O/2+b/5)*5|0),this.charMaskWidth[L],this.charMaskHeight[L],R);u+=this.charAdvance[L]}}drawChar(u,_,m,R,b,E){_|=0,m|=0,R|=0,b|=0;let O=_+m*K.width2d,L=K.width2d-R,I=0,N=0;if(m<K.top){let H=K.top-m;b-=H,m=K.top,N+=H*R,O+=H*K.width2d}if(m+b>=K.bottom)b-=m+b+1-K.bottom;if(_<K.left){let H=K.left-_;R-=H,_=K.left,N+=H,O+=H,I+=H,L+=H}if(_+R>=K.right){let H=_+R+1-K.right;R-=H,I+=H,L+=H}if(R>0&&b>0)this.drawMask(R,b,u,N,I,K.pixels,O,L,E)}drawCharAlpha(u,_,m,R,b,E,O){u|=0,_|=0,m|=0,R|=0;let L=u+_*K.width2d,I=K.width2d-m,N=0,H=0;if(_<K.top){let G=K.top-_;R-=G,_=K.top,H+=G*m,L+=G*K.width2d}if(_+R>=K.bottom)R-=_+R+1-K.bottom;if(u<K.left){let G=K.left-u;m-=G,u=K.left,H+=G,L+=G,N+=G,I+=G}if(u+m>=K.right){let G=u+m+1-K.right;m-=G,N+=G,I+=G}if(m>0&&R>0)this.drawMaskAlpha(m,R,K.pixels,L,I,O,H,N,b,E)}drawMask(u,_,m,R,b,E,O,L,I){u|=0,_|=0;let N=-(u>>2);u=-(u&3);for(let H=-_;H<0;H++){for(let G=N;G<0;G++){if(m[R++]===0)O++;else E[O++]=I;if(m[R++]===0)O++;else E[O++]=I;if(m[R++]===0)O++;else E[O++]=I;if(m[R++]===0)O++;else E[O++]=I}for(let G=u;G<0;G++)if(m[R++]===0)O++;else E[O++]=I;O+=L,R+=b}}drawMaskAlpha(u,_,m,R,b,E,O,L,I,N){u|=0,_|=0;let H=((I&16711935)*N&4278255360)+((I&65280)*N&16711680)>>8,G=256-N;for(let T=-_;T<0;T++){for(let q=-u;q<0;q++)if(E[O++]===0)R++;else{let Q=m[R];m[R++]=(((Q&16711935)*G&4278255360)+((Q&65280)*G&16711680)>>8)+H}R+=b,O+=L}}evaluateTag(u){if(u==="red")return 16711680;else if(u==="gre")return 65280;else if(u==="blu")return 255;else if(u==="yel")return 16776960;else if(u==="cya")return 65535;else if(u==="mag")return 16711935;else if(u==="whi")return 16777215;else if(u==="bla")return 0;else if(u==="lre")return 16748608;else if(u==="dre")return 8388608;else if(u==="dbl")return 128;else if(u==="or1")return 16756736;else if(u==="or2")return 16740352;else if(u==="or3")return 16723968;else if(u==="gr1")return 12648192;else if(u==="gr2")return 8453888;else if(u==="gr3")return 4259584;else return 0}split(u,_){if(u.length===0)return[u];let m=[];while(u.length>0){if(this.stringWidth(u)<=_&&u.indexOf("|")===-1){m.push(u);break}let b=u.length;for(let E=0;E<u.length;E++)if(u[E]===" "){if(this.stringWidth(u.substring(0,E))>_)break;b=E}else if(u[E]==="|"){b=E;break}m.push(u.substring(0,b)),u=u.substring(b+1)}return m}}class W0{socket;wsin;wsout;closed=!1;ioerror=!1;static async openSocket(u,_){return await new Promise((m,R)=>{let E=new WebSocket(`${_?"wss":"ws"}://${u}`,"binary");E.addEventListener("open",()=>{m(E)}),E.addEventListener("error",()=>{R(E)})})}constructor(u){u.onclose=this.onclose,u.onerror=this.onerror,this.wsin=new gu(u,5000),this.wsout=new zu(u,5000),this.socket=u}get host(){return this.socket.url.split("/")[2]}get port(){return parseInt(this.socket.url.split(":")[2],10)}get available(){return this.closed?0:this.wsin.available}write(u,_){if(!this.closed)this.wsout.write(u,_)}async read(){return this.closed?0:await this.wsin.read()}async readBytes(u,_,m){if(this.closed)return;await this.wsin.readBytes(u,_,m)}close(){this.closed=!0,this.socket.close(),this.wsin.close(),this.wsout.close()}onclose=(u)=>{if(this.closed)return;this.close()};onerror=(u)=>{if(this.closed)return;this.ioerror=!0,this.close()}}class zu{socket;limit;closed=!1;ioerror=!1;constructor(u,_){this.socket=u,this.limit=_}write(u,_){if(this.closed)return;if(this.ioerror)throw this.ioerror=!1,Error();if(_>this.limit||u.length>this.limit)throw Error();try{this.socket.send(u.slice(0,_))}catch(m){this.ioerror=!0}}close(){this.closed=!0}}class Pu{bytes;position;constructor(u){this.bytes=u,this.position=0}get available(){return this.bytes.length-this.position}get read(){return this.bytes[this.position++]}get len(){return this.bytes.length}}class gu{limit;queue=[];event=null;callback=null;closed=!1;total=0;constructor(u,_){this.limit=_,u.binaryType="arraybuffer",u.onmessage=this.onmessage}get available(){return this.total}onmessage=(u)=>{if(this.closed)throw Error();let _=new Pu(new Uint8Array(u.data));if(this.total+=_.available,this.callback){let m=this.callback;this.callback=null,m(_)}else this.queue.push(_)};async read(){if(this.closed)throw Error();return await Promise.race([new Promise((u)=>{if(!this.event||this.event.available===0)this.event=this.queue.shift()??null;if(this.event&&this.event.available>0)u(this.event.read),this.total--;else this.callback=(_)=>{this.event=_,this.total--,u(_.read)}}),new Promise((u,_)=>{setTimeout(()=>{if(this.closed)_(Error());else _(Error())},20000)})])}async readBytes(u,_,m){if(this.closed)throw Error();for(let R=0;R<m;R++)u[_+R]=await this.read();return u}close(){this.closed=!0,this.callback=null,this.event=null,this.queue=[]}}class o0{db;constructor(u){u.onerror=this.onerror,u.onclose=this.onclose,this.db=u}static async openDatabase(){return await new Promise((u,_)=>{let m=indexedDB.open("lostcity",1);m.onsuccess=(R)=>{let b=R.target;u(b.result)},m.onupgradeneeded=(R)=>{R.target.result.createObjectStore("cache")},m.onerror=(R)=>{let b=R.target;_(b.result)}})}async read(u,_){return await new Promise((m)=>{let E=this.db.transaction("cache","readonly").objectStore("cache").get(`${u}.${_}`);E.onsuccess=()=>{if(E.result)m(new Uint8Array(E.result));else m(void 0)},E.onerror=()=>{m(void 0)}})}async cacheload(u){return await new Promise((_)=>{let b=this.db.transaction("cache","readonly").objectStore("cache").get(u);b.onsuccess=()=>{if(b.result)_(new Uint8Array(b.result));else _(void 0)},b.onerror=()=>{_(void 0)}})}async write(u,_,m){if(m===null)return;return await new Promise((R,b)=>{let L=this.db.transaction("cache","readwrite").objectStore("cache").put(m,`${u}.${_}`);L.onsuccess=()=>{R()},L.onerror=()=>{R()}})}async cachesave(u,_){if(_===null)return;return await new Promise((m,R)=>{let O=this.db.transaction("cache","readwrite").objectStore("cache").put(_,u);O.onsuccess=()=>{m()},O.onerror=()=>{m()}})}onclose=(u)=>{};onerror=(u)=>{}}class e0{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(u){for(let _=0;_<u.length;_++)this.rsl[_]=u[_];this.init()}get nextInt(){if(this.count--===0)this.isaac(),this.count=255;return this.rsl[this.count]}init(){let u=2654435769,_=2654435769,m=2654435769,R=2654435769,b=2654435769,E=2654435769,O=2654435769,L=2654435769;for(let I=0;I<4;I++)u^=_<<11,R+=u,_+=m,_^=m>>>2,b+=_,m+=R,m^=R<<8,E+=m,R+=b,R^=b>>>16,O+=R,b+=E,b^=E<<10,L+=b,E+=O,E^=O>>>4,u+=E,O+=L,O^=L<<8,_+=O,L+=u,L^=u>>>9,m+=L,u+=_;for(let I=0;I<256;I+=8)u+=this.rsl[I],_+=this.rsl[I+1],m+=this.rsl[I+2],R+=this.rsl[I+3],b+=this.rsl[I+4],E+=this.rsl[I+5],O+=this.rsl[I+6],L+=this.rsl[I+7],u^=_<<11,R+=u,_+=m,_^=m>>>2,b+=_,m+=R,m^=R<<8,E+=m,R+=b,R^=b>>>16,O+=R,b+=E,b^=E<<10,L+=b,E+=O,E^=O>>>4,u+=E,O+=L,O^=L<<8,_+=O,L+=u,L^=u>>>9,m+=L,u+=_,this.mem[I]=u,this.mem[I+1]=_,this.mem[I+2]=m,this.mem[I+3]=R,this.mem[I+4]=b,this.mem[I+5]=E,this.mem[I+6]=O,this.mem[I+7]=L;for(let I=0;I<256;I+=8)u+=this.mem[I],_+=this.mem[I+1],m+=this.mem[I+2],R+=this.mem[I+3],b+=this.mem[I+4],E+=this.mem[I+5],O+=this.mem[I+6],L+=this.mem[I+7],u^=_<<11,R+=u,_+=m,_^=m>>>2,b+=_,m+=R,m^=R<<8,E+=m,R+=b,R^=b>>>16,O+=R,b+=E,b^=E<<10,L+=b,E+=O,E^=O>>>4,u+=E,O+=L,O^=L<<8,_+=O,L+=u,L^=u>>>9,m+=L,u+=_,this.mem[I]=u,this.mem[I+1]=_,this.mem[I+2]=m,this.mem[I+3]=R,this.mem[I+4]=b,this.mem[I+5]=E,this.mem[I+6]=O,this.mem[I+7]=L;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let u=0;u<256;u++){let _=this.mem[u],m=u&3;if(m===0)this.a^=this.a<<13;else if(m===1)this.a^=this.a>>>6;else if(m===2)this.a^=this.a<<2;else if(m===3)this.a^=this.a>>>16;this.a+=this.mem[u+128&255];let R;this.mem[u]=R=this.mem[_>>>2&255]+this.a+this.b,this.rsl[u]=this.b=this.mem[R>>>8>>>2&255]+_}}}import{BZip2 as vu}from"./deps.js";class a0{static genHash(u){let _=0;u=u.toUpperCase();for(let m=0;m<u.length;m++)_=_*61+u.charCodeAt(m)-32|0;return _}jagSrc;compressedWhole;fileCount;fileHash;fileUnpackedSize;filePackedSize;fileOffset;fileUnpacked=[];constructor(u){let _=new W(new Uint8Array(u)),m=_.g3(),R=_.g3();if(m===R)this.jagSrc=u,this.compressedWhole=!1;else this.jagSrc=vu.decompress(u.subarray(6),m,!0),_=new W(new Uint8Array(this.jagSrc)),this.compressedWhole=!0;this.fileCount=_.g2(),this.fileHash=[],this.fileUnpackedSize=[],this.filePackedSize=[],this.fileOffset=[];let b=_.pos+this.fileCount*10;for(let E=0;E<this.fileCount;E++)this.fileHash.push(_.g4()),this.fileUnpackedSize.push(_.g3()),this.filePackedSize.push(_.g3()),this.fileOffset.push(b),b+=this.filePackedSize[E]}read(u){let _=a0.genHash(u),m=this.fileHash.indexOf(_);if(m===-1)return null;return this.readIndex(m)}readIndex(u){if(u<0||u>=this.fileCount)return null;if(this.fileUnpacked[u])return this.fileUnpacked[u];let _=this.fileOffset[u],m=this.filePackedSize[u],R=new Uint8Array(this.jagSrc.subarray(_,_+m));if(this.compressedWhole)return this.fileUnpacked[u]=R,R;else{let b=vu.decompress(R,this.fileUnpackedSize[u],!0);return this.fileUnpacked[u]=b,b}}}var ru=[0,0,3,0,0,0,0,2,1,0,0,0,0,3,0,-2,0,0,0,0,0,0,0,0,0,0,2,0,0,3,0,0,-2,0,0,1,0,0,0,4,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,4,0,0,4,2,4,0,0,0,6,4,0,0,0,0,0,0,2,0,0,6,0,0,0,0,0,0,0,5,-2,2,0,0,0,0,0,0,4,0,-2,0,0,0,9,6,0,0,0,0,0,0,0,0,4,0,0,0,6,0,0,0,0,0,0,0,0,1,0,0,4,0,0,0,0,2,6,0,2,0,0,0,0,0,0,0,7,2,6,0,0,-2,0,0,0,0,-2,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,2,0,0,0,-2,0,0,0,0,0,15,14,0,7,0,3,0,0,0,0,0,2,0,0,0,0,2,0,0,0,-1,1,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,4,0,0,4,6,0,0,0,0,0,2,0,10,0,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0];class D0{static PERIOD=new Uint16Array(["d","o","t"].join("").split("").map((u)=>u.charCodeAt(0)));static AMPERSAT=new Uint16Array(["(","a",")"].join("").split("").map((u)=>u.charCodeAt(0)));static SLASH=new Uint16Array(["s","l","a","s","h"].join("").split("").map((u)=>u.charCodeAt(0)));static whitelist=["cook","cook's","cooks","seeks","sheet"];static tlds=[];static tldTypes=[];static bads=[];static badCombinations=[];static domains=[];static fragments=[];static unpack(u){let _=new W(u.read("fragmentsenc.txt")),m=new W(u.read("badenc.txt")),R=new W(u.read("domainenc.txt")),b=new W(u.read("tldlist.txt"));this.read(m,R,_,b)}static filter(u){let _=[...u];this.format(_);let m=_.join("").trim(),R=m.toLowerCase(),b=[...R];this.filterTlds(b),this.filterBadWords(b),this.filterDomains(b),this.filterFragments(b);for(let E=0;E<this.whitelist.length;E++){let O=-1;while((O=R.indexOf(this.whitelist[E],O+1))!==-1){let L=[...this.whitelist[E]];for(let I=0;I<L.length;I++)b[I+O]=L[I]}}return this.replaceUppercases(b,[...m]),this.formatUppercases(b),b.join("").trim()}static read(u,_,m,R){this.readBadWords(u),this.readDomains(_),this.readFragments(m),this.readTld(R)}static readTld(u){let _=u.g4();for(let m=0;m<_;m++)this.tldTypes[m]=u.g1(),this.tlds[m]=new Uint16Array(u.g1()).map(()=>u.g1())}static readBadWords(u){let _=u.g4();for(let m=0;m<_;m++){this.bads[m]=new Uint16Array(u.g1()).map(()=>u.g1());let R=Array(u.g1()).fill([]).map(()=>[u.g1b(),u.g1b()]);if(R.length>0)this.badCombinations[m]=R}}static readDomains(u){let _=u.g4();for(let m=0;m<_;m++)this.domains[m]=new Uint16Array(u.g1()).map(()=>u.g1())}static readFragments(u){let _=u.g4();for(let m=0;m<_;m++)this.fragments[m]=u.g2()}static filterTlds(u){let _=[...u],m=[...u];this.filterBadCombinations(null,_,this.PERIOD),this.filterBadCombinations(null,m,this.SLASH);for(let R=0;R<this.tlds.length;R++)this.filterTld(m,this.tldTypes[R],u,this.tlds[R],_)}static filterBadWords(u){for(let _=0;_<2;_++)for(let m=this.bads.length-1;m>=0;m--)this.filterBadCombinations(this.badCombinations[m],u,this.bads[m])}static filterDomains(u){let _=[...u],m=[...u];this.filterBadCombinations(null,_,this.AMPERSAT),this.filterBadCombinations(null,m,this.PERIOD);for(let R=this.domains.length-1;R>=0;R--)this.filterDomain(m,_,this.domains[R],u)}static filterFragments(u){for(let _=0;_<u.length;){let m=this.indexOfNumber(u,_);if(m===-1)return;let R=!1;for(let O=_;O>=0&&O<m&&!R;O++)if(!this.isSymbol(u[O])&&!this.isNotLowercaseAlpha(u[O]))R=!0;let b=0;if(R)b=0;if(b===0)b=1,_=m;let E=0;for(let O=m;O<u.length&&O<_;O++)E=E*10+u[O].charCodeAt(0)-48;if(E<=255&&_-m<=8)b++;else b=0;if(b===4)this.maskChars(m,_,u),b=0;_=this.indexOfNonNumber(_,u)}}static isBadFragment(u){if(this.isNumericalChars(u))return!0;let _=this.getInteger(u),m=this.fragments,R=m.length;if(_===m[0]||_===m[R-1])return!0;let b=0,E=R-1;while(b<=E){let O=(b+E)/2|0;if(_===m[O])return!0;else if(_<m[O])E=O-1;else b=O+1}return!1}static getInteger(u){if(u.length>6)return 0;let _=0;for(let m=0;m<u.length;m++){let R=u[u.length-m-1];if(this.isLowercaseAlpha(R))_=_*38+R.charCodeAt(0)+1-97;else if(R==="'")_=_*38+27;else if(this.isNumerical(R))_=_*38+R.charCodeAt(0)+28-48;else if(R!=="\x00")return 0}return _}static indexOfNumber(u,_){for(let m=_;m<u.length&&m>=0;m++)if(this.isNumerical(u[m]))return m;return-1}static indexOfNonNumber(u,_){for(let m=u;m<_.length&&m>=0;m++)if(!this.isNumerical(_[m]))return m;return _.length}static getEmulatedDomainCharLen(u,_,m){if(_===m)return 1;else if(_==="o"&&m==="0")return 1;else if(_==="o"&&m==="("&&u===")")return 2;else if(_==="c"&&(m==="("||m==="<"||m==="["))return 1;else if(_==="e"&&m==="€")return 1;else if(_==="s"&&m==="$")return 1;else if(_==="l"&&m==="i")return 1;return 0}static filterDomain(u,_,m,R){let b=m.length,E=R.length;for(let O=0;O<=E-b;O++){let{matched:L,currentIndex:I}=this.findMatchingDomain(O,m,R);if(!L)continue;let N=this.prefixSymbolStatus(O,R,3,_,["@"]),H=this.suffixSymbolStatus(I-1,R,3,u,[".",","]);if(!(N>2||H>2))continue;this.maskChars(O,I,R)}}static findMatchingDomain(u,_,m){let R=_.length,b=u,E=0;while(b<m.length&&E<R){let O=m[b],L=b+1<m.length?m[b+1]:"\x00",I=this.getEmulatedDomainCharLen(L,String.fromCharCode(_[E]),O);if(I>0)b+=I,E++;else{if(E===0)break;let N=this.getEmulatedDomainCharLen(L,String.fromCharCode(_[E-1]),O);if(N>0){if(b+=N,E===1)u++}else{if(E>=R||!this.isSymbol(O))break;b++}}}return{matched:E>=R,currentIndex:b}}static filterBadCombinations(u,_,m){if(m.length>_.length)return;for(let R=0;R<=_.length-m.length;R++){let b=R,{currentIndex:E,badIndex:O,hasSymbol:L,hasNumber:I,hasDigit:N}=this.processBadCharacters(_,m,b);b=E;let H=_[b],G=b+1<_.length?_[b+1]:"\x00";if(!(O>=m.length&&(!I||!N)))continue;let T=!0,q;if(L){let J=!1,U=!1;if(R-1<0||this.isSymbol(_[R-1])&&_[R-1]!=="'")J=!0;if(b>=_.length||this.isSymbol(_[b])&&_[b]!=="'")U=!0;if(!J||!U){let w=!1;if(q=R-2,J)q=R;while(!w&&q<b){if(q>=0&&(!this.isSymbol(_[q])||_[q]==="'")){let k=[],V;for(V=0;V<3&&q+V<_.length&&(!this.isSymbol(_[q+V])||_[q+V]==="'");V++)k[V]=_[q+V];let j=!0;if(V===0)j=!1;if(V<3&&q-1>=0&&(!this.isSymbol(_[q-1])||_[q-1]==="'"))j=!1;if(j&&!this.isBadFragment(k))w=!0}q++}if(!w)T=!1}}else{if(H=" ",R-1>=0)H=_[R-1];if(G=" ",b<_.length)G=_[b];let J=this.getIndex(H),U=this.getIndex(G);if(u&&this.comboMatches(J,u,U))T=!1}if(!T)continue;let Q=0,n=0;for(let J=R;J<b;J++)if(this.isNumerical(_[J]))Q++;else if(this.isAlpha(_[J]))n++;if(Q<=n)this.maskChars(R,b,_)}}static processBadCharacters(u,_,m){let R=m,b=0,E=0,O=!1,L=!1,I=!1;for(;R<u.length&&!(L&&I);){if(R>=u.length||L&&I)break;let N=u[R],H=R+1<u.length?u[R+1]:"\x00",G;if(b<_.length&&(G=this.getEmulatedBadCharLen(H,String.fromCharCode(_[b]),N))>0){if(G===1&&this.isNumerical(N))L=!0;if(G===2&&(this.isNumerical(N)||this.isNumerical(H)))L=!0;R+=G,b++}else{if(b===0)break;let T;if((T=this.getEmulatedBadCharLen(H,String.fromCharCode(_[b-1]),N))>0)R+=T;else{if(b>=_.length||!this.isNotLowercaseAlpha(N))break;if(this.isSymbol(N)&&N!=="'")O=!0;if(this.isNumerical(N))I=!0;if(R++,E++,(E*100/(R-m)|0)>90)break}}}return{currentIndex:R,badIndex:b,hasSymbol:O,hasNumber:L,hasDigit:I}}static getEmulatedBadCharLen(u,_,m){if(_===m)return 1;if(_>="a"&&_<="m"){if(_==="a"){if(m!=="4"&&m!=="@"&&m!=="^"){if(m==="/"&&u==="\\")return 2;return 0}return 1}if(_==="b"){if(m!=="6"&&m!=="8"){if(m==="1"&&u==="3")return 2;return 0}return 1}if(_==="c"){if(m!=="("&&m!=="<"&&m!=="{"&&m!=="[")return 0;return 1}if(_==="d"){if(m==="["&&u===")")return 2;return 0}if(_==="e"){if(m!=="3"&&m!=="€")return 0;return 1}if(_==="f"){if(m==="p"&&u==="h")return 2;if(m==="£")return 1;return 0}if(_==="g"){if(m!=="9"&&m!=="6")return 0;return 1}if(_==="h"){if(m==="#")return 1;return 0}if(_==="i"){if(m!=="y"&&m!=="l"&&m!=="j"&&m!=="1"&&m!=="!"&&m!==":"&&m!==";"&&m!=="|")return 0;return 1}if(_==="j")return 0;if(_==="k")return 0;if(_==="l"){if(m!=="1"&&m!=="|"&&m!=="i")return 0;return 1}if(_==="m")return 0}if(_>="n"&&_<="z"){if(_==="n")return 0;if(_==="o"){if(m!=="0"&&m!=="*"){if((m!=="("||u!==")")&&(m!=="["||u!=="]")&&(m!=="{"||u!=="}")&&(m!=="<"||u!==">"))return 0;return 2}return 1}if(_==="p")return 0;if(_==="q")return 0;if(_==="r")return 0;if(_==="s"){if(m!=="5"&&m!=="z"&&m!=="$"&&m!=="2")return 0;return 1}if(_==="t"){if(m!=="7"&&m!=="+")return 0;return 1}if(_==="u"){if(m==="v")return 1;if((m!=="\\"||u!=="/")&&(m!=="\\"||u!=="|")&&(m!=="|"||u!=="/"))return 0;return 2}if(_==="v"){if((m!=="\\"||u!=="/")&&(m!=="\\"||u!=="|")&&(m!=="|"||u!=="/"))return 0;return 2}if(_==="w"){if(m==="v"&&u==="v")return 2;return 0}if(_==="x"){if((m!==")"||u!=="(")&&(m!=="}"||u!=="{")&&(m!=="]"||u!=="[")&&(m!==">"||u!=="<"))return 0;return 2}if(_==="y")return 0;if(_==="z")return 0}if(_>="0"&&_<="9")if(_==="0")if(m==="o"||m==="O")return 1;else if((m!=="("||u!==")")&&(m!=="{"||u!=="}")&&(m!=="["||u!=="]"))return 0;else return 2;else if(_==="1")return m==="l"?1:0;else return 0;else if(_===",")return m==="."?1:0;else if(_===".")return m===","?1:0;else if(_==="!")return m==="i"?1:0;return 0}static comboMatches(u,_,m){let R=0,b=_.length-1;while(R<=b){let E=(R+b)/2|0;if(_[E][0]===u&&_[E][1]===m)return!0;else if(u<_[E][0]||u===_[E][0]&&m<_[E][1])b=E-1;else R=E+1}return!1}static getIndex(u){if(this.isLowercaseAlpha(u))return u.charCodeAt(0)+1-97;else if(u==="'")return 28;else if(this.isNumerical(u))return u.charCodeAt(0)+29-48;return 27}static filterTld(u,_,m,R,b){if(R.length>m.length)return;for(let E=0;E<=m.length-R.length;E++){let{currentIndex:O,tldIndex:L}=this.processTlds(m,R,E);if(L<R.length)continue;let I=!1,N=this.prefixSymbolStatus(E,m,3,b,[",","."]),H=this.suffixSymbolStatus(O-1,m,5,u,["\\","/"]);if(_===1&&N>0&&H>0)I=!0;if(_===2&&(N>2&&H>0||N>0&&H>2))I=!0;if(_===3&&N>0&&H>2)I=!0;if(!I)continue;let G=E,T=O-1,q=!1,Q;if(N>2){if(N===4){q=!1;for(Q=E-1;Q>=0;Q--)if(q){if(b[Q]!=="*")break;G=Q}else if(b[Q]==="*")G=Q,q=!0}q=!1;for(Q=G-1;Q>=0;Q--)if(q){if(this.isSymbol(m[Q]))break;G=Q}else if(!this.isSymbol(m[Q]))q=!0,G=Q}if(H>2){if(H===4){q=!1;for(Q=T+1;Q<m.length;Q++)if(q){if(u[Q]!=="*")break;T=Q}else if(u[Q]==="*")T=Q,q=!0}q=!1;for(Q=T+1;Q<m.length;Q++)if(q){if(this.isSymbol(m[Q]))break;T=Q}else if(!this.isSymbol(m[Q]))q=!0,T=Q}this.maskChars(G,T+1,m)}}static processTlds(u,_,m){let R=0;while(m<u.length&&R<_.length){let b=u[m],E=m+1<u.length?u[m+1]:"\x00",O;if((O=this.getEmulatedDomainCharLen(E,String.fromCharCode(_[R]),b))>0)m+=O,R++;else{if(R===0)break;let L;if((L=this.getEmulatedDomainCharLen(E,String.fromCharCode(_[R-1]),b))>0)m+=L;else{if(!this.isSymbol(b))break;m++}}}return{currentIndex:m,tldIndex:R}}static isSymbol(u){return!this.isAlpha(u)&&!this.isNumerical(u)}static isNotLowercaseAlpha(u){return this.isLowercaseAlpha(u)?u==="v"||u==="x"||u==="j"||u==="q"||u==="z":!0}static isAlpha(u){return this.isLowercaseAlpha(u)||this.isUppercaseAlpha(u)}static isNumerical(u){return u>="0"&&u<="9"}static isLowercaseAlpha(u){return u>="a"&&u<="z"}static isUppercaseAlpha(u){return u>="A"&&u<="Z"}static isNumericalChars(u){for(let _=0;_<u.length;_++)if(!this.isNumerical(u[_])&&u[_]!=="\x00")return!1;return!0}static maskChars(u,_,m){for(let R=u;R<_;R++)m[R]="*"}static maskedCountBackwards(u,_){let m=0;for(let R=_-1;R>=0&&this.isSymbol(u[R]);R--)if(u[R]==="*")m++;return m}static maskedCountForwards(u,_){let m=0;for(let R=_+1;R<u.length&&this.isSymbol(u[R]);R++)if(u[R]==="*")m++;return m}static maskedCharsStatus(u,_,m,R,b){if((b?this.maskedCountBackwards(_,m):this.maskedCountForwards(_,m))>=R)return 4;else if(this.isSymbol(b?u[m-1]:u[m+1]))return 1;return 0}static prefixSymbolStatus(u,_,m,R,b){if(u===0)return 2;for(let E=u-1;E>=0&&this.isSymbol(_[E]);E--)if(b.includes(_[E]))return 3;return this.maskedCharsStatus(_,R,u,m,!0)}static suffixSymbolStatus(u,_,m,R,b){if(u+1===_.length)return 2;for(let E=u+1;E<_.length&&this.isSymbol(_[E]);E++)if(b.includes(_[E]))return 3;return this.maskedCharsStatus(_,R,u,m,!1)}static format(u){let _=0;for(let m=0;m<u.length;m++){if(this.isCharacterAllowed(u[m]))u[_]=u[m];else u[_]=" ";if(_===0||u[_]!==" "||u[_-1]!==" ")_++}for(let m=_;m<u.length;m++)u[m]=" "}static isCharacterAllowed(u){return u>=" "&&u<=""||u===" "||u===`
`||u==="\t"||u==="£"||u==="€"}static replaceUppercases(u,_){for(let m=0;m<_.length;m++)if(u[m]!=="*"&&this.isUppercaseAlpha(_[m]))u[m]=_[m]}static formatUppercases(u){let _=!0;for(let m=0;m<u.length;m++){let R=u[m];if(!this.isAlpha(R))_=!0;else if(_){if(this.isLowercaseAlpha(R))_=!1}else if(this.isUppercaseAlpha(R))u[m]=String.fromCharCode(R.charCodeAt(0)+97-65)}}}class v0{static TABLE=[" ","e","t","a","o","i","h","n","s","r","d","l","u","m","w","c","y","f","g","p","b","v","k","x","j","q","z","0","1","2","3","4","5","6","7","8","9"," ","!","?",".",",",":",";","(",")","-","&","*","\\","'","@","#","+","=","£","$","%",'"',"[","]"];static charBuffer=[];static unpack(u,_){let m=0,R=-1,b;for(let O=0;O<_&&m<100;O++){let L=u.g1();if(b=L>>4&15,R!==-1)this.charBuffer[m++]=this.TABLE[(R<<4)+b-195],R=-1;else if(b<13)this.charBuffer[m++]=this.TABLE[b];else R=b;if(b=L&15,R!==-1)this.charBuffer[m++]=this.TABLE[(R<<4)+b-195],R=-1;else if(b<13)this.charBuffer[m++]=this.TABLE[b];else R=b}let E=!0;for(let O=0;O<m;O++){let L=this.charBuffer[O];if(E&&L>="a"&&L<="z")this.charBuffer[O]=L.toUpperCase(),E=!1;if(L==="."||L==="!")E=!0}return this.charBuffer.slice(0,m).join("")}static pack(u,_){if(_.length>80)_=_.substring(0,80);_=_.toLowerCase();let m=-1;for(let R=0;R<_.length;R++){let b=_.charAt(R),E=0;for(let O=0;O<this.TABLE.length;O++)if(b===this.TABLE[O]){E=O;break}if(E>12)E+=195;if(m===-1)if(E<13)m=E;else u.p1(E);else if(E<13)u.p1((m<<4)+E),m=-1;else u.p1((m<<4)+(E>>4)),m=E&15}if(m!==-1)u.p1(m<<4)}}class M0{length=0;shapeDelta=null;shapePeak=null;start=0;end=0;form=0;threshold=0;position=0;delta=0;amplitude=0;ticks=0;unpack(u){this.form=u.g1(),this.start=u.g4(),this.end=u.g4(),this.length=u.g1(),this.shapeDelta=new Int32Array(this.length),this.shapePeak=new Int32Array(this.length);for(let _=0;_<this.length;_++)this.shapeDelta[_]=u.g2(),this.shapePeak[_]=u.g2()}reset(){this.threshold=0,this.position=0,this.delta=0,this.amplitude=0,this.ticks=0}evaluate(u){if(this.ticks>=this.threshold&&this.shapePeak&&this.shapeDelta){if(this.amplitude=this.shapePeak[this.position++]<<15,this.position>=this.length)this.position=this.length-1;if(this.threshold=this.shapeDelta[this.position]/65536*u|0,this.threshold>this.ticks)this.delta=((this.shapePeak[this.position]<<15)-this.amplitude)/(this.threshold-this.ticks)|0}return this.amplitude+=this.delta,this.ticks++,this.amplitude-this.delta>>15}}class O0{frequencyBase=null;amplitudeBase=null;frequencyModRate=null;frequencyModRange=null;amplitudeModRate=null;amplitudeModRange=null;release=null;attack=null;harmonicVolume=new Int32Array(5);harmonicSemitone=new Int32Array(5);harmonicDelay=new Int32Array(5);reverbDelay=0;reverbVolume=100;start=0;length=500;static buffer=null;static noise=null;static sin=null;static tmpPhases=new Int32Array(5);static tmpDelays=new Int32Array(5);static tmpVolumes=new Int32Array(5);static tmpSemitones=new Int32Array(5);static tmpStarts=new Int32Array(5);static init(){this.noise=new Int32Array(32768);for(let u=0;u<32768;u++)if(Math.random()>0.5)this.noise[u]=1;else this.noise[u]=-1;this.sin=new Int32Array(32768);for(let u=0;u<32768;u++)this.sin[u]=Math.sin(u/5215.1903)*16384|0;this.buffer=new Int32Array(220500)}generate(u,_){if(!this.frequencyBase||!this.amplitudeBase)return O0.buffer;for(let N=0;N<u;N++)O0.buffer[N]=0;if(_<10)return O0.buffer;let m=u/_|0;this.frequencyBase.reset(),this.amplitudeBase.reset();let R=0,b=0,E=0;if(this.frequencyModRate&&this.frequencyModRange)this.frequencyModRate.reset(),this.frequencyModRange.reset(),R=(this.frequencyModRate.end-this.frequencyModRate.start)*32.768/m|0,b=this.frequencyModRate.start*32.768/m|0;let O=0,L=0,I=0;if(this.amplitudeModRate&&this.amplitudeModRange)this.amplitudeModRate.reset(),this.amplitudeModRange.reset(),O=(this.amplitudeModRate.end-this.amplitudeModRate.start)*32.768/m|0,L=this.amplitudeModRate.start*32.768/m|0;for(let N=0;N<5;N++)if(this.frequencyBase&&this.harmonicVolume[N]!==0)O0.tmpPhases[N]=0,O0.tmpDelays[N]=this.harmonicDelay[N]*m,O0.tmpVolumes[N]=(this.harmonicVolume[N]<<14)/100|0,O0.tmpSemitones[N]=(this.frequencyBase.end-this.frequencyBase.start)*32.768*Math.pow(1.0057929410678534,this.harmonicSemitone[N])/m|0,O0.tmpStarts[N]=this.frequencyBase.start*32.768/m|0;for(let N=0;N<u;N++){let H=this.frequencyBase.evaluate(u),G=this.amplitudeBase.evaluate(u);if(this.frequencyModRate&&this.frequencyModRange){let T=this.frequencyModRate.evaluate(u),q=this.frequencyModRange.evaluate(u);H+=this.generate2(q,E,this.frequencyModRate.form)>>1,E+=(T*R>>16)+b}if(this.amplitudeModRate&&this.amplitudeModRange){let T=this.amplitudeModRate.evaluate(u),q=this.amplitudeModRange.evaluate(u);G=G*((this.generate2(q,I,this.amplitudeModRate.form)>>1)+32768)>>15,I+=(T*O>>16)+L}for(let T=0;T<5;T++)if(this.harmonicVolume[T]!==0){let q=N+O0.tmpDelays[T];if(q<u)O0.buffer[q]+=this.generate2(G*O0.tmpVolumes[T]>>15,O0.tmpPhases[T],this.frequencyBase.form),O0.tmpPhases[T]+=(H*O0.tmpSemitones[T]>>16)+O0.tmpStarts[T]}}if(this.release&&this.attack){this.release.reset(),this.attack.reset();let N=0,H=!0;for(let G=0;G<u;G++){let T=this.release.evaluate(u),q=this.attack.evaluate(u),Q;if(H)Q=this.release.start+((this.release.end-this.release.start)*T>>8);else Q=this.release.start+((this.release.end-this.release.start)*q>>8);if(N+=256,N>=Q)N=0,H=!H;if(H)O0.buffer[G]=0}}if(this.reverbDelay>0&&this.reverbVolume>0){let N=this.reverbDelay*m;for(let H=N;H<u;H++)O0.buffer[H]+=O0.buffer[H-N]*this.reverbVolume/100|0,O0.buffer[H]|=0}for(let N=0;N<u;N++){if(O0.buffer[N]<-32768)O0.buffer[N]=-32768;if(O0.buffer[N]>32767)O0.buffer[N]=32767}return O0.buffer}generate2(u,_,m){if(m===1)return(_&32767)<16384?u:-u;else if(m===2)return O0.sin[_&32767]*u>>14;else if(m===3)return((_&32767)*u>>14)-u;else if(m===4)return O0.noise[(_/2607|0)&32767]*u;else return 0}unpack(u){if(this.frequencyBase=new M0,this.frequencyBase.unpack(u),this.amplitudeBase=new M0,this.amplitudeBase.unpack(u),u.g1()!==0)u.pos--,this.frequencyModRate=new M0,this.frequencyModRate.unpack(u),this.frequencyModRange=new M0,this.frequencyModRange.unpack(u);if(u.g1()!==0)u.pos--,this.amplitudeModRate=new M0,this.amplitudeModRate.unpack(u),this.amplitudeModRange=new M0,this.amplitudeModRange.unpack(u);if(u.g1()!==0)u.pos--,this.release=new M0,this.release.unpack(u),this.attack=new M0,this.attack.unpack(u);for(let _=0;_<10;_++){let m=u.gsmarts();if(m===0)break;this.harmonicVolume[_]=m,this.harmonicSemitone[_]=u.gsmart(),this.harmonicDelay[_]=u.gsmarts()}this.reverbDelay=u.gsmarts(),this.reverbVolume=u.gsmarts(),this.length=u.g2(),this.start=u.g2()}}class b0{static tracks=new r(1000,null);static delays=new Int32Array(1000);static waveBytes=new Uint8Array(441000);static waveBuffer=null;tones=new r(10,null);loopBegin=0;loopEnd=0;static unpack(u){let _=new W(u.read("sounds.dat"));this.waveBytes=new Uint8Array(441000),this.waveBuffer=new W(this.waveBytes),O0.init();while(!0){let m=_.g2();if(m===65535)break;this.tracks[m]=new b0,this.tracks[m].read(_),this.delays[m]=this.tracks[m].trim()}}static generate(u,_){if(!this.tracks[u])return null;return this.tracks[u]?.getWave(_)??null}read(u){for(let _=0;_<10;_++)if(u.g1()!==0)u.pos--,this.tones[_]=new O0,this.tones[_]?.unpack(u);this.loopBegin=u.g2(),this.loopEnd=u.g2()}trim(){let u=9999999;for(let _=0;_<10;_++)if(this.tones[_]&&(this.tones[_].start/20|0)<u)u=this.tones[_].start/20|0;if(this.loopBegin<this.loopEnd&&(this.loopBegin/20|0)<u)u=this.loopBegin/20|0;if(u===9999999||u===0)return 0;for(let _=0;_<10;_++)if(this.tones[_])this.tones[_].start-=u*20;if(this.loopBegin<this.loopEnd)this.loopBegin-=u*20,this.loopEnd-=u*20;return u}getWave(u){if(!b0.waveBuffer)return null;let _=this.generate(u);return b0.waveBuffer.pos=0,b0.waveBuffer.p4(1380533830),b0.waveBuffer.ip4(_+36),b0.waveBuffer.p4(1463899717),b0.waveBuffer.p4(1718449184),b0.waveBuffer.ip4(16),b0.waveBuffer.ip2(1),b0.waveBuffer.ip2(1),b0.waveBuffer.ip4(22050),b0.waveBuffer.ip4(22050),b0.waveBuffer.ip2(1),b0.waveBuffer.ip2(8),b0.waveBuffer.p4(1684108385),b0.waveBuffer.ip4(_),b0.waveBuffer.pos+=_,b0.waveBuffer}generate(u){let _=0;for(let O=0;O<10;O++)if(this.tones[O]&&this.tones[O].length+this.tones[O].start>_)_=this.tones[O].length+this.tones[O].start;if(_===0)return 0;let m=_*22050/1000|0,R=this.loopBegin*22050/1000|0,b=this.loopEnd*22050/1000|0;if(R<0||b<0||b>m||R>=b)u=0;let E=m+(b-R)*(u-1);for(let O=44;O<E+44;O++)if(b0.waveBytes)b0.waveBytes[O]=-128;for(let O=0;O<10;O++)if(this.tones[O]){let L=this.tones[O].length*22050/1000|0,I=this.tones[O].start*22050/1000|0,N=this.tones[O].generate(L,this.tones[O].length);for(let H=0;H<L;H++)if(b0.waveBytes)b0.waveBytes[H+I+44]+=N[H]>>8<<24>>24}if(u>1){R+=44,b+=44,m+=44,E+=44;let O=E-m;for(let L=m-1;L>=b;L--)if(b0.waveBytes)b0.waveBytes[L+O]=b0.waveBytes[L];for(let L=1;L<u;L++){let I=(b-R)*L;for(let N=R;N<b;N++)if(b0.waveBytes)b0.waveBytes[N+I]=b0.waveBytes[N]}E-=44}return E}}class Uu{requestModel(u){}}class y0 extends V0{archive=0;file=0;data=null;cycle=0;urgent=!0}import{gunzipSync as u1,unzipSync as pu}from"./deps.js";class nu extends Uu{modernized=!0;zip=null;versions=[];crcs=[];priorities=[];topPriority=0;models=[];mapIndex=[];mapLand=[];mapLoc=[];mapMembers=[];animIndex=[];midiIndex=[];running=!0;app;active=!1;importantCount=0;requestCount=0;requests=new i0;queue=new $0;missing=new $0;pending=new $0;completed=new $0;prefetches=new $0;message="";buf=new Uint8Array(500);data=new Uint8Array(65000);loadedPrefetchFiles=0;totalPrefetchFiles=0;partOffset=0;partAvailable=0;waitCycles=0;heartbeatCycle=0;cycle=0;socketOpenTime=0;current=null;stream=null;constructor(u,_){super();let m=["model_version","anim_version","midi_version","map_version"];for(let E=0;E<4;E++){let O=u.read(m[E]);if(!O)throw Error();let L=O.length/2,I=new W(O);this.versions[E]=Array(L),this.priorities[E]=Array(L);for(let N=0;N<L;N++)this.versions[E][N]=I.g2()}let R=["model_crc","anim_crc","midi_crc","map_crc"];for(let E=0;E<4;E++){let O=u.read(R[E]);if(!O)throw Error();let L=O.length/4,I=new W(O);this.crcs[E]=Array(L);for(let N=0;N<L;N++)this.crcs[E][N]=I.g4()}let b=u.read("model_index");if(b){let E=this.versions[0].length;this.models=Array(E);for(let O=0;O<E;O++)if(O<b.length)this.models[O]=b[O];else this.models[O]=0}if(b=u.read("map_index"),b){let E=b.length/7,O=new W(b);this.mapIndex=Array(E),this.mapLand=Array(E),this.mapLoc=Array(E),this.mapMembers=Array(E);for(let L=0;L<E;L++)this.mapIndex[L]=O.g2(),this.mapLand[L]=O.g2(),this.mapLoc[L]=O.g2(),this.mapMembers[L]=O.g1()}if(b=u.read("anim_index"),b){let E=b.length/2,O=new W(b);this.animIndex=Array(E);for(let L=0;L<E;L++)this.animIndex[L]=O.g2()}if(b=u.read("midi_index"),b){let E=b.length,O=new W(b);this.midiIndex=Array(E);for(let L=0;L<E;L++)this.midiIndex[L]=O.g1()}this.app=_,this.running=!0}stop(){this.running=!1}getFileCount(u){return this.versions[u].length}getAnimCount(){return this.animIndex.length}getMapFile(u,_,m){let R=(u<<8)+_;for(let b=0;b<this.mapIndex.length;b++)if(this.mapIndex[b]===R)if(m===0)return this.mapLand[b];else return this.mapLoc[b];return-1}async prefetchMaps(u){let _=this.mapIndex.length;for(let m=0;m<_;m++)if(u||this.mapMembers[m]!=0)await this.prefetchPriority(3,this.mapLoc[m],2),await this.prefetchPriority(3,this.mapLand[m],2)}hasMapLocFile(u){for(let _=0;_<this.mapIndex.length;_++)if(this.mapLoc[_]===u)return!0;return!1}getModelFlags(u){return this.models[u]&255}shouldPrefetchMidi(u){return this.midiIndex[u]===1}requestModel(u){this.request(0,u)}request(u,_){if(u<0||u>this.versions.length||_<0||_>this.versions[u].length||this.versions[u][_]==0)return;for(let R=this.requests.head();R!==null;R=this.requests.next())if(R.archive==u&&R.file==_)return;let m=new y0;m.archive=u,m.file=_,m.urgent=!0,this.queue.push(m),this.requests.push(m)}remaining(){return this.requests.size()}loop(){let u=this.completed.pop();if(u===null)return null;if(u.unlink2(),u.data===null)return u;return u.data=u1(u.data.slice(0,u.data.length-2)),u}async prefetchPriority(u,_,m){if(!this.app.db||this.versions[u][_]===0)return;let R=await this.app.db.read(u+1,_);if(this.validate(R,this.crcs[u][_],this.versions[u][_]))return;if(this.priorities[u][_]=m,m>this.topPriority)this.topPriority=m;this.totalPrefetchFiles++}clearPrefetches(){this.prefetches.clear()}prefetch(u,_){if(!this.app.db||this.versions[u][_]===0||this.priorities[u][_]===0||this.topPriority===0)return;let m=new y0;m.archive=u,m.file=_,m.urgent=!1,this.prefetches.push(m)}async run(){if(!this.running)return;this.cycle++,this.active=!0;for(let _=0;_<100&&this.active;_++){if(this.active=!1,await this.handleQueue(),await this.handlePending(),this.importantCount===0&&_>=5)break;await this.handleExtras(),await this.read()}let u=!1;for(let _=this.pending.head();_!==null;_=this.pending.next())if(_.urgent){if(u=!0,_.cycle++,_.cycle>50)_.cycle=0,this.send(_)}if(!u){for(let _=this.pending.head();_!==null;_=this.pending.next())if(u=!0,_.cycle++,_.cycle>50)_.cycle=0,this.send(_)}if(u){if(this.waitCycles++,this.waitCycles>750){if(this.stream)this.stream.close(),this.stream=null;this.partAvailable=0}}else this.waitCycles=0,this.message="";if(this.app.ingame&&this.stream&&(this.topPriority>0||!this.app.db)){if(this.heartbeatCycle++,this.heartbeatCycle>500)this.heartbeatCycle=0,this.buf[0]=0,this.buf[1]=0,this.buf[2]=0,this.buf[3]=10,this.stream.write(this.buf,4)}}async handleQueue(){let u=this.queue.pop();while(u!==null){this.active=!0;let _;if(this.app.db)_=await this.app.db.read(u.archive+1,u.file);if(!this.validate(_,this.crcs[u.archive][u.file],this.versions[u.archive][u.file]))_=void 0;if(!_)this.missing.push(u);else u.data=_,this.completed.push(u);u=this.queue.pop()}}async handlePending(){this.importantCount=0,this.requestCount=0;for(let u=this.pending.head();u!==null;u=this.pending.next())if(u.urgent)this.importantCount++;else this.requestCount++;while(this.importantCount<10){let u=this.missing.pop();if(u===null)break;if(this.priorities[u.archive][u.file]!==0)this.loadedPrefetchFiles++;this.priorities[u.archive][u.file]=0,this.pending.push(u),this.importantCount++,await this.send(u),this.active=!0}}async handleExtras(){while(this.importantCount===0&&this.requestCount<10){if(this.topPriority===0)return;let u=this.prefetches.pop();while(u!==null){if(this.priorities[u.archive][u.file]!=0){if(this.priorities[u.archive][u.file]=0,this.pending.push(u),await this.send(u),this.active=!0,this.loadedPrefetchFiles<this.totalPrefetchFiles)this.loadedPrefetchFiles++;if(this.message="Loading extra files - "+(this.loadedPrefetchFiles*100/this.totalPrefetchFiles|0)+"%",this.requestCount++,this.requestCount==10)return}u=this.prefetches.pop()}for(let _=0;_<4;_++){let m=this.priorities[_],R=m.length;for(let b=0;b<R;b++)if(m[b]==this.topPriority){m[b]=0;let E=new y0;if(E.archive=_,E.file=b,E.urgent=!1,this.pending.push(E),await this.send(E),this.active=!0,this.loadedPrefetchFiles<this.totalPrefetchFiles)this.loadedPrefetchFiles++;if(this.message="Loading extra files - "+(this.loadedPrefetchFiles*100/this.totalPrefetchFiles|0)+"%",this.requestCount++,this.requestCount==10)return}}this.topPriority--}}async read(){if(this.modernized){for(let u=this.pending.head();u!==null;u=this.pending.next()){this.current=u;break}if(this.current){if(await this.downloadZip(),!this.zip)return;if(this.current.data=this.zip[`${this.current.archive+1}.${this.current.file}`],!this.current.data){this.current.unlink(),this.current=null;return}if(this.app.db)await this.app.db.write(this.current.archive+1,this.current.file,this.current.data);if(!this.current.urgent&&this.current.archive===3)this.current.urgent=!0,this.current.archive=93;if(this.current.urgent)this.completed.push(this.current);else this.current.unlink();this.current=null}}else{if(!this.stream)return;try{let u=this.stream.available;if(this.partAvailable===0&&u>=6){this.active=!0,await this.stream.readBytes(this.buf,0,6);let _=this.buf[0]&255,m=((this.buf[1]&255)<<8)+(this.buf[2]&255),R=((this.buf[3]&255)<<8)+(this.buf[4]&255),b=this.buf[5]&255;this.current=null;for(let E=this.pending.head();E!==null;E=this.pending.next()){if(E.archive==_&&E.file==m)this.current=E;if(this.current!=null)E.cycle=0}if(this.current)if(this.waitCycles=0,R===0){if(this.current.data=null,this.current.urgent)this.completed.push(this.current);else this.current.unlink();this.current=null}else{if(this.current.data===null&&b===0)this.current.data=new Uint8Array(R);if(this.current.data===null&&b!=0)throw Error()}if(this.partOffset=b*500,this.partAvailable=500,this.partAvailable>R-b*500)this.partAvailable=R-b*500}if(this.partAvailable>0&&u>=this.partAvailable){this.active=!0;let _=this.buf,m=0;if(this.current&&this.current.data)_=this.current.data,m=this.partOffset;if(await this.stream.readBytes(_,m,this.partAvailable),this.partAvailable+this.partOffset>=_.length&&this.current){if(this.app.db)this.app.db.write(this.current.archive+1,this.current.file,_);if(!this.current.urgent&&this.current.archive===3)this.current.urgent=!0,this.current.archive=93;if(this.current.urgent)this.completed.push(this.current);else this.current.unlink()}this.partAvailable=0}}catch(u){if(this.stream)this.stream.close();this.stream=null,this.partAvailable=0}}}validate(u,_,m){if(typeof u>"u"||u.length<2)return!1;let R=u.length-2,b=((u[R]&255)<<8)+(u[R+1]&255),E=W.getcrc(u,0,u.length-2);return b===m&&E===_}async send(u){if(this.modernized)return;try{if(this.stream===null){let _=performance.now();if(_-this.socketOpenTime<5000)return;this.socketOpenTime=_,this.stream=new W0(await W0.openSocket(window.location.host,window.location.protocol==="https:")),this.buf[0]=15,this.stream.write(this.buf,1);for(let m=0;m<8;m++)await this.stream.read();this.waitCycles=0}if(this.buf[0]=u.archive,this.buf[1]=u.file>>8,this.buf[2]=u.file,u.urgent)this.buf[3]=2;else if(this.app.ingame)this.buf[3]=0;else this.buf[3]=1;this.stream.write(this.buf,4),this.heartbeatCycle=0}catch(_){this.stream=null,this.partAvailable=0}}async downloadZip(){while(!this.zip)try{this.zip=pu(await r0("/ondemand.zip"));break}catch(u){await Y0(1000)}}async prefetchAll(){if(!this.app.db)return;let u=!1;for(let _=0;_<3&&!u;_++){if(typeof await this.app.db.read(2,0)<"u")return;try{let m=pu(await r0("/ondemand.zip"));for(let R=0;R<4;R++){let b=this.versions[R].length;for(let E=0;E<b;E++){let O=m[`${R+1}.${E}`];if(typeof O>"u")continue;let L=await this.app.db.read(R+1,E);if(!L||!this.validate(L,this.crcs[R][E],this.versions[R][E]))await this.app.db.write(R+1,E,O)}}u=!0}catch(m){}}}}class v extends mu{static nodeId=10;static membersWorld=!0;static lowMemory=!1;static cyclelogic1=0;static cyclelogic2=0;static cyclelogic3=0;static cyclelogic4=0;static cyclelogic5=0;static cyclelogic6=0;static oplogic1=0;static oplogic2=0;static oplogic3=0;static oplogic4=0;static oplogic5=0;static oplogic6=0;static oplogic7=0;static oplogic8=0;static oplogic9=0;alreadyStarted=!1;errorStarted=!1;errorLoading=!1;errorHost=!1;errorMessage=null;db=null;loopCycle=0;jagChecksum=[];stream=null;in=W.alloc(1);out=W.alloc(1);loginout=W.alloc(1);serverSeed=0n;idleNetCycles=0;idleTimeout=0;systemUpdateTimer=0;randomIn=null;ptype=0;psize=0;ptype0=0;ptype1=0;ptype2=0;jagTitle=null;redrawFrame=!0;titleScreenState=0;titleLoginField=0;imageTitle2=null;imageTitle3=null;imageTitle4=null;imageTitle0=null;imageTitle1=null;imageTitle5=null;imageTitle6=null;imageTitle7=null;imageTitle8=null;imageTitlebox=null;imageTitlebutton=null;loginMessage0="";loginMessage1="";username="";password="";fontPlain11=null;fontPlain12=null;fontBold12=null;fontQuill8=null;imageRunes=[];flameActive=!1;imageFlamesLeft=null;imageFlamesRight=null;flameBuffer1=null;flameBuffer0=null;flameBuffer3=null;flameBuffer2=null;flameGradient=null;flameGradient0=null;flameGradient1=null;flameGradient2=null;flameLineOffset=new Int32Array(256);flameCycle0=0;flameGradientCycle0=0;flameGradientCycle1=0;flamesInterval=null;areaSidebar=null;areaMapback=null;areaViewport=null;areaChatback=null;areaBackbase1=null;areaBackbase2=null;areaBackhmid1=null;areaBackleft1=null;areaBackleft2=null;areaBackright1=null;areaBackright2=null;areaBacktop1=null;areaBackvmid1=null;areaBackvmid2=null;areaBackvmid3=null;areaBackhmid2=null;areaChatbackOffsets=null;areaSidebarOffsets=null;areaViewportOffsets=null;compassMaskLineOffsets=new Int32Array(33);compassMaskLineLengths=new Int32Array(33);minimapMaskLineOffsets=new Int32Array(151);minimapMaskLineLengths=new Int32Array(151);imageInvback=null;imageChatback=null;imageMapback=null;imageBackbase1=null;imageBackbase2=null;imageBackhmid1=null;imageSideicons=new r(13,null);imageMinimap=null;imageCompass=null;imageMapedge=null;imageMapscene=new r(50,null);imageMapfunction=new r(50,null);imageHitmarks=new r(20,null);imageHeadicon=new r(20,null);imageMapmarker0=null;imageMapmarker1=null;imageCrosses=new r(8,null);imageMapdot0=null;imageMapdot1=null;imageMapdot2=null;imageMapdot3=null;imageScrollbar0=null;imageScrollbar1=null;imageRedstone1=null;imageRedstone2=null;imageRedstone3=null;imageRedstone1h=null;imageRedstone2h=null;imageRedstone1v=null;imageRedstone2v=null;imageRedstone3v=null;imageRedstone1hv=null;imageRedstone2hv=null;genderButtonImage0=null;genderButtonImage1=null;activeMapFunctions=new r(1000,null);redrawSidebar=!1;redrawChatback=!1;redrawSideicons=!1;redrawPrivacySettings=!1;viewportInterfaceId=-1;dragCycles=0;crossMode=0;crossCycle=0;crossX=0;crossY=0;overrideChat=0;menuVisible=!1;menuArea=0;menuX=0;menuY=0;menuWidth=0;menuHeight=0;menuSize=0;menuOption=[];sidebarInterfaceId=-1;chatInterfaceId=-1;chatInterface=new g;chatScrollHeight=78;chatScrollOffset=0;ignoreCount=0;ignoreName37=[];hintType=0;hintNpc=0;hintOffsetX=0;hintOffsetZ=0;hintPlayer=0;hintTileX=0;hintTileZ=0;hintHeight=0;skillExperience=[];skillLevel=[];skillBaseLevel=[];levelExperience=[];modalMessage=null;flashingTab=-1;selectedTab=3;tabInterfaceId=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];chatPublicMode=0;chatPrivateMode=0;chatTradeMode=0;scrollGrabbed=!1;scrollInputPadding=0;showSocialInput=!1;socialMessage="";socialInput="";socialInputType=0;chatbackInput="";chatbackInputOpen=!1;stickyChatInterfaceId=-1;messageText=new r(100,null);messageSender=new r(100,null);messageType=new Int32Array(100);messageTextIds=new Int32Array(100);privateMessageCount=0;splitPrivateChat=0;chatEffects=0;chatTyped="";viewportHoveredInterfaceIndex=0;sidebarHoveredInterfaceIndex=0;chatHoveredInterfaceIndex=0;objDragInterfaceId=0;objDragSlot=0;objDragArea=0;objGrabX=0;objGrabY=0;objDragCycles=0;objGrabThreshold=!1;objSelected=0;objSelectedSlot=0;objSelectedInterface=0;objInterface=0;objSelectedName=null;selectedArea=0;selectedItem=0;selectedInterface=0;selectedCycle=0;pressedContinueOption=!1;varps=[];varCache=[];spellSelected=0;activeSpellId=0;activeSpellFlags=0;spellCaption=null;oneMouseButton=0;menuAction=new Int32Array(500);menuParamA=new Int32Array(500);menuParamB=new Int32Array(500);menuParamC=new Int32Array(500);hoveredSlotParentId=0;hoveredSlot=0;lastHoveredInterfaceId=0;reportAbuseInput="";reportAbuseMuteOption=!1;reportAbuseInterfaceId=-1;lastAddress=0;daysSinceLastLogin=0;daysSinceRecoveriesChanged=0;unreadMessages=0;activeMapFunctionCount=0;activeMapFunctionX=new Int32Array(1000);activeMapFunctionZ=new Int32Array(1000);scene=null;sceneState=0;sceneDelta=0;sceneCycle=0;flagSceneTileX=0;flagSceneTileZ=0;cutscene=!1;macroCameraCycle=0;macroCameraX=0;macroCameraZ=0;macroCameraAngle=0;macroCameraXModifier=2;macroCameraZModifier=2;macroCameraAngleModifier=1;cameraModifierCycle=new Int32Array(5);cameraModifierEnabled=new r(5,!1);cameraModifierJitter=new Int32Array(5);cameraModifierWobbleScale=new Int32Array(5);cameraModifierWobbleSpeed=new Int32Array(5);cameraX=0;cameraY=0;cameraZ=0;cameraPitch=0;cameraYaw=0;cameraPitchClamp=0;macroMinimapCycle=0;macroMinimapAngle=0;macroMinimapZoom=0;macroMinimapZoomModifier=1;macroMinimapAngleModifier=2;minimapLevel=-1;baseX=0;baseZ=0;sceneCenterZoneX=0;sceneCenterZoneZ=0;sceneBaseTileX=0;sceneBaseTileZ=0;sceneMapLandData=null;sceneMapLandFile=[];sceneMapLocData=null;sceneMapLocFile=[];sceneMapIndex=null;withinTutorialIsland=!1;awaitingSync=!1;scenePrevBaseTileX=0;scenePrevBaseTileZ=0;textureBuffer=new Int8Array(16384);levelCollisionMap=new r(4,null);currentLevel=0;orbitCameraPitch=128;orbitCameraYaw=0;orbitCameraYawVelocity=0;orbitCameraPitchVelocity=0;orbitCameraX=0;orbitCameraZ=0;levelHeightmap=null;levelTileFlags=null;tileLastOccupiedCycle=new X0(104,104);projectX=0;projectY=0;cutsceneDstLocalTileX=0;cutsceneDstLocalTileZ=0;cutsceneDstHeight=0;cutsceneRotateSpeed=0;cutsceneRotateAcceleration=0;cutsceneSrcLocalTileX=0;cutsceneSrcLocalTileZ=0;cutsceneSrcHeight=0;cutsceneMoveSpeed=0;cutsceneMoveAcceleration=0;players=new r(2048,null);playerCount=0;playerIds=new Int32Array(2048);entityUpdateCount=0;entityRemovalCount=0;entityUpdateIds=new Int32Array(2048);entityRemovalIds=new Int32Array(1000);playerAppearanceBuffer=new r(2048,null);npcs=new r(8192,null);npcCount=0;npcIds=new Int32Array(8192);projectiles=new $0;spotanims=new $0;objStacks=new c0(4,104,104,null);locChanges=new $0;bfsStepX=new Int32Array(4000);bfsStepZ=new Int32Array(4000);bfsDirection=new Int32Array(104*104);bfsCost=new Int32Array(104*104);tryMoveNearest=0;localPlayer=null;runenergy=0;inMultizone=0;localPid=-1;runweight=0;noTimeoutCycle=0;wildernessLevel=0;worldLocationState=0;staffmodlevel=0;designGender=!0;updateDesignModel=!1;designKits=new Int32Array(7);designColours=new Int32Array(5);static CHAT_COLORS=Int32Array.of(16776960,16711680,65280,65535,16711935,16777215);friendCount=0;chatCount=0;chatX=new Int32Array(50);chatY=new Int32Array(50);chatHeight=new Int32Array(50);chatWidth=new Int32Array(50);chatColors=new Int32Array(50);chatEffect=new Int32Array(50);chatTimers=new Int32Array(50);chats=new r(50,null);friendName=new r(200,null);friendName37=new BigInt64Array(200);friendWorld=new Int32Array(200);socialName37=null;waveCount=0;waveEnabled=!0;waveIds=new Int32Array(50);waveLoops=new Int32Array(50);waveDelay=new Int32Array(50);waveVolume=64;lastWaveId=-1;lastWaveLoops=-1;lastWaveLength=0;lastWaveStartTime=0;nextMusicDelay=0;midiActive=!0;midiVolume=64;midiSong=-1;midiFading=!1;nextMidiSong=-1;displayFps=!1;onDemand=null;ingame=!1;imageModIcons=[];lastProgressPercent=0;lastProgressMessage="";drawCycle=0;sceneLoadStartTime=0;viewportOverlayInterfaceId=-1;bankArrangeMode=0;field1264=0;warnMembersInNonMembers=0;membersAccount=0;flameCycle=0;initializeLevelExperience(){let u=0;for(let _=0;_<99;_++){let m=_+1,R=m+Math.pow(2,m/7)*300|0;u+=R,this.levelExperience[_]=u/4|0}}constructor(u,_,m){super();if(typeof u>"u"||typeof _>"u"||typeof m>"u")return;if(v.nodeId=u,v.membersWorld=m,_)v.setLowMemory();else v.setHighMemory();this.run()}static setLowMemory(){F.lowMemory=!0,h.lowMemory=!0,v.lowMemory=!0,C.lowMemory=!0}static setHighMemory(){F.lowMemory=!1,h.lowMemory=!1,v.lowMemory=!1,C.lowMemory=!1}saveMidi(u,_){m1(_,this.midiVolume,u)}async load(){if(this.isMobile&&v.lowMemory)this.setTargetedFramerate(30);if(this.alreadyStarted){this.errorStarted=!0;return}this.alreadyStarted=!0;try{this.db=new o0(await o0.openDatabase())}catch(u){this.db=null}try{await this.drawProgress(10,"Connecting to web server");let u=new W(await r0("/crc"));for(let Y=0;Y<9;Y++)this.jagChecksum[Y]=u.g4();this.jagTitle=await this.getJagFile("title","title screen",1,25),this.fontPlain11=k0.fromArchive(this.jagTitle,"p11"),this.fontPlain12=k0.fromArchive(this.jagTitle,"p12"),this.fontBold12=k0.fromArchive(this.jagTitle,"b12"),this.fontQuill8=k0.fromArchive(this.jagTitle,"q8"),await this.loadTitleBackground(),await this.loadTitleImages();let _=await this.getJagFile("config","config",2,30),m=await this.getJagFile("interface","interface",3,35),R=await this.getJagFile("media","2d graphics",4,40),b=await this.getJagFile("textures","textures",6,45),E=await this.getJagFile("wordenc","chat system",7,50),O=await this.getJagFile("sounds","sound effects",8,55);this.levelTileFlags=new B0(4,104,104),this.levelHeightmap=new g0(4,104+1,104+1),this.scene=new F(this.levelHeightmap,104,4,104);for(let Y=0;Y<4;Y++)this.levelCollisionMap[Y]=new e;this.imageMinimap=new R0(512,512);let L=await this.getJagFile("versionlist","update list",5,60);if(await this.drawProgress(60,"Connecting to update server"),this.onDemand=new nu(L,this),h0.init(this.onDemand.getAnimCount()),$.init(this.onDemand.getFileCount(0),this.onDemand),await this.onDemand.prefetchAll(),!v.lowMemory){this.midiSong=0,this.midiFading=!1,this.onDemand.request(2,this.midiSong);while(this.onDemand.remaining()>0)await this.updateOnDemand(),await Y0(100)}await this.drawProgress(65,"Requesting animations");let I=this.onDemand.getFileCount(1);for(let Y=0;Y<I;Y++)this.onDemand.request(1,Y);while(this.onDemand.remaining()>0){let Y=I-this.onDemand.remaining();if(Y>0)await this.drawProgress(65,"Loading animations - "+(Y*100/I|0)+"%");await this.updateOnDemand(),await Y0(100)}await this.drawProgress(70,"Requesting models");let N=this.onDemand.getFileCount(0);for(let Y=0;Y<N;Y++)if((this.onDemand.getModelFlags(Y)&1)!=0)this.onDemand.request(0,Y);let H=this.onDemand.remaining();while(this.onDemand.remaining()>0){let Y=H-this.onDemand.remaining();if(Y>0)await this.drawProgress(70,"Loading models - "+(Y*100/H|0)+"%");await this.updateOnDemand(),await Y0(100)}if(this.db){await this.drawProgress(75,"Requesting maps"),this.onDemand.request(3,this.onDemand.getMapFile(47,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(47,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(48,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(48,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(49,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(49,48,1)),this.onDemand.request(3,this.onDemand.getMapFile(47,47,0)),this.onDemand.request(3,this.onDemand.getMapFile(47,47,1)),this.onDemand.request(3,this.onDemand.getMapFile(48,47,0)),this.onDemand.request(3,this.onDemand.getMapFile(48,47,1)),this.onDemand.request(3,this.onDemand.getMapFile(148,48,0)),this.onDemand.request(3,this.onDemand.getMapFile(148,48,1));let Y=this.onDemand.remaining();while(this.onDemand.remaining()>0){let S=Y-this.onDemand.remaining();if(S>0)await this.drawProgress(75,"Loading maps - "+(S*100/Y|0)+"%");await this.updateOnDemand(),await Y0(100)}}let G=this.onDemand.getFileCount(0);for(let Y=0;Y<G;Y++){let S=this.onDemand.getModelFlags(Y),s=0;if((S&8)!=0)s=10;else if((S&32)!=0)s=9;else if((S&16)!=0)s=8;else if((S&64)!=0)s=7;else if((S&128)!=0)s=6;else if((S&2)!=0)s=5;else if((S&4)!=0)s=4;if((S&1)!=0)s=3;if(s!=0)await this.onDemand.prefetchPriority(0,Y,s)}if(await this.onDemand.prefetchMaps(v.membersWorld),!v.lowMemory){let Y=this.onDemand.getFileCount(2);for(let S=0;S<Y;S++)if(this.onDemand.shouldPrefetchMidi(S))this.onDemand.prefetchPriority(2,S,1)}await this.drawProgress(80,"Unpacking media"),this.imageInvback=I0.fromArchive(R,"invback",0),this.imageChatback=I0.fromArchive(R,"chatback",0),this.imageMapback=I0.fromArchive(R,"mapback",0),this.imageBackbase1=I0.fromArchive(R,"backbase1",0),this.imageBackbase2=I0.fromArchive(R,"backbase2",0),this.imageBackhmid1=I0.fromArchive(R,"backhmid1",0);for(let Y=0;Y<13;Y++)this.imageSideicons[Y]=I0.fromArchive(R,"sideicons",Y);this.imageCompass=R0.fromArchive(R,"compass",0),this.imageMapedge=R0.fromArchive(R,"mapedge",0),this.imageMapedge.crop();try{for(let Y=0;Y<50;Y++)this.imageMapscene[Y]=I0.fromArchive(R,"mapscene",Y)}catch(Y){}try{for(let Y=0;Y<50;Y++)this.imageMapfunction[Y]=R0.fromArchive(R,"mapfunction",Y)}catch(Y){}try{for(let Y=0;Y<20;Y++)this.imageHitmarks[Y]=R0.fromArchive(R,"hitmarks",Y)}catch(Y){}try{for(let Y=0;Y<20;Y++)this.imageHeadicon[Y]=R0.fromArchive(R,"headicons",Y)}catch(Y){}this.imageMapmarker0=R0.fromArchive(R,"mapmarker",0),this.imageMapmarker1=R0.fromArchive(R,"mapmarker",1);for(let Y=0;Y<8;Y++)this.imageCrosses[Y]=R0.fromArchive(R,"cross",Y);this.imageMapdot0=R0.fromArchive(R,"mapdots",0),this.imageMapdot1=R0.fromArchive(R,"mapdots",1),this.imageMapdot2=R0.fromArchive(R,"mapdots",2),this.imageMapdot3=R0.fromArchive(R,"mapdots",3),this.imageScrollbar0=I0.fromArchive(R,"scrollbar",0),this.imageScrollbar1=I0.fromArchive(R,"scrollbar",1),this.imageRedstone1=I0.fromArchive(R,"redstone1",0),this.imageRedstone2=I0.fromArchive(R,"redstone2",0),this.imageRedstone3=I0.fromArchive(R,"redstone3",0),this.imageRedstone1h=I0.fromArchive(R,"redstone1",0),this.imageRedstone1h?.flipHorizontally(),this.imageRedstone2h=I0.fromArchive(R,"redstone2",0),this.imageRedstone2h?.flipHorizontally(),this.imageRedstone1v=I0.fromArchive(R,"redstone1",0),this.imageRedstone1v?.flipVertically(),this.imageRedstone2v=I0.fromArchive(R,"redstone2",0),this.imageRedstone2v?.flipVertically(),this.imageRedstone3v=I0.fromArchive(R,"redstone3",0),this.imageRedstone3v?.flipVertically(),this.imageRedstone1hv=I0.fromArchive(R,"redstone1",0),this.imageRedstone1hv?.flipHorizontally(),this.imageRedstone1hv?.flipVertically(),this.imageRedstone2hv=I0.fromArchive(R,"redstone2",0),this.imageRedstone2hv?.flipHorizontally(),this.imageRedstone2hv?.flipVertically();for(let Y=0;Y<2;Y++)this.imageModIcons[Y]=I0.fromArchive(R,"mod_icons",Y);let T=R0.fromArchive(R,"backleft1",0);this.areaBackleft1=new N0(T.cropRight,T.cropBottom),T.blitOpaque(0,0);let q=R0.fromArchive(R,"backleft2",0);this.areaBackleft2=new N0(q.cropRight,q.cropBottom),q.blitOpaque(0,0);let Q=R0.fromArchive(R,"backright1",0);this.areaBackright1=new N0(Q.cropRight,Q.cropBottom),Q.blitOpaque(0,0);let n=R0.fromArchive(R,"backright2",0);this.areaBackright2=new N0(n.cropRight,n.cropBottom),n.blitOpaque(0,0);let J=R0.fromArchive(R,"backtop1",0);this.areaBacktop1=new N0(J.cropRight,J.cropBottom),J.blitOpaque(0,0);let U=R0.fromArchive(R,"backvmid1",0);this.areaBackvmid1=new N0(U.cropRight,U.cropBottom),U.blitOpaque(0,0);let w=R0.fromArchive(R,"backvmid2",0);this.areaBackvmid2=new N0(w.cropRight,w.cropBottom),w.blitOpaque(0,0);let k=R0.fromArchive(R,"backvmid3",0);this.areaBackvmid3=new N0(k.cropRight,k.cropBottom),k.blitOpaque(0,0);let V=R0.fromArchive(R,"backhmid2",0);this.areaBackhmid2=new N0(V.cropRight,V.cropBottom),V.blitOpaque(0,0);let j=(Math.random()*21|0)-10,X=(Math.random()*21|0)-10,A=(Math.random()*21|0)-10,Z=(Math.random()*41|0)-20;for(let Y=0;Y<50;Y++){if(this.imageMapfunction[Y])this.imageMapfunction[Y]?.translate2d(j+Z,X+Z,A+Z);if(this.imageMapscene[Y])this.imageMapscene[Y]?.translate2d(j+Z,X+Z,A+Z)}if(await this.drawProgress(83,"Unpacking textures"),h.unpackTextures(b),h.initColourTable(0.8),h.initPool(20),await this.drawProgress(86,"Unpacking config"),o.unpack(_),m0.unpack(_),s0.unpack(_),l.unpack(_,v.membersWorld),j0.unpack(_),U0.unpack(_),n0.unpack(_),S0.unpack(_),!v.lowMemory)await this.drawProgress(90,"Unpacking sounds"),b0.unpack(O);await this.drawProgress(95,"Unpacking interfaces"),g.unpack(m,R,[this.fontPlain11,this.fontPlain12,this.fontBold12,this.fontQuill8]),await this.drawProgress(100,"Preparing game engine");for(let Y=0;Y<33;Y++){let S=999,s=0;for(let f=0;f<34;f++)if(this.imageMapback.pixels[f+Y*this.imageMapback.width2d]===0){if(S===999)S=f}else if(S!==999){s=f;break}this.compassMaskLineOffsets[Y]=S,this.compassMaskLineLengths[Y]=s-S}for(let Y=5;Y<156;Y++){let S=999,s=0;for(let f=25;f<172;f++)if(this.imageMapback.pixels[f+Y*this.imageMapback.width2d]===0&&(f>34||Y>34)){if(S===999)S=f}else if(S!==999){s=f;break}this.minimapMaskLineOffsets[Y-5]=S-25,this.minimapMaskLineLengths[Y-5]=s-S}h.init3D(479,96),this.areaChatbackOffsets=h.lineOffset,h.init3D(190,261),this.areaSidebarOffsets=h.lineOffset,h.init3D(512,334),this.areaViewportOffsets=h.lineOffset;let D=new Int32Array(9);for(let Y=0;Y<9;Y++){let S=Y*32+128+15,s=S*3+600,f=h.sinTable[S];D[Y]=s*f>>16}F.init(512,334,500,800,D),D0.unpack(E),this.initializeLevelExperience()}catch(u){if(u instanceof Error)this.errorMessage=`loaderror - ${this.lastProgressMessage} ${this.lastProgressPercent}%: ${u.message}`;this.errorLoading=!0}}async update(){if(this.errorStarted||this.errorLoading||this.errorHost)return;if(this.loopCycle++,this.ingame)await this.updateGame();else await this.updateTitle();await this.updateOnDemand()}async draw(){if(this.errorStarted||this.errorLoading||this.errorHost){this.drawError();return}if(this.drawCycle++,this.ingame)this.drawGame();else await this.drawTitle();this.dragCycles=0}refresh(){this.redrawFrame=!0}async drawProgress(u,_){if(this.lastProgressPercent=u,this.lastProgressMessage=_,await this.loadTitle(),!this.jagTitle){await super.drawProgress(u,_);return}this.imageTitle4?.bind();let m=360,R=200,b=20;this.fontBold12?.drawStringCenter(m/2|0,(R/2|0)-b-26,"RuneScape is loading - please wait...",16777215);let E=(R/2|0)-18-b;if(K.drawRect((m/2|0)-152,E,304,34,9179409),K.drawRect((m/2|0)-151,E+1,302,32,0),K.fillRect2d((m/2|0)-150,E+2,u*3,30,9179409),K.fillRect2d((m/2|0)-150+u*3,E+2,300-u*3,30,0),this.fontBold12?.drawStringCenter(m/2|0,(R/2|0)+5-b,_,16777215),this.imageTitle4?.draw(202,171),this.redrawFrame){if(this.redrawFrame=!1,!this.flameActive)this.imageTitle0?.draw(0,0),this.imageTitle1?.draw(637,0);this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(202,371),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(562,265),this.imageTitle7?.draw(128,171),this.imageTitle8?.draw(562,171)}await Y0(5)}drawError(){i.fillStyle="black",i.fillRect(0,0,this.width,this.height),this.setFramerate(1),this.flameActive=!1;let u=0;if(this.errorLoading)i.font="bold 16px helvetica, sans-serif",i.textAlign="left",i.fillStyle="yellow",u=35,i.fillText("Sorry, an error has occured whilst loading RuneScape",30,u),u+=50,i.fillStyle="white",i.fillText("To fix this try the following (in order):",30,u),u+=50,i.font="bold 12px helvetica, sans-serif",i.fillText("1: Try closing ALL open web-browser windows, and reloading",30,u),u+=30,i.fillText("2: Try clearing your web-browsers cache",30,u),u+=30,i.fillText("3: Try using a different game-world",30,u),u+=30,i.fillText("4: Try rebooting your computer",30,u),u+=30,i.fillText("5: Try selecting a different method from the play-game menu",30,u);else if(this.errorHost)i.font="bold 20px helvetica, sans-serif",i.textAlign="left",i.fillStyle="white",u=50,i.fillText("Error - unable to load game!",50,u),u+=50,i.fillText("To play RuneScape make sure you play from",50,u),u+=50,i.fillText("An approved domain",50,u);else if(this.errorStarted)i.font="bold 13px helvetica, sans-serif",i.textAlign="left",i.fillStyle="yellow",u=35,i.fillText("Error a copy of RuneScape already appears to be loaded",30,u),u+=50,i.fillStyle="white",i.fillText("To fix this try the following (in order):",30,u),u+=50,i.font="bold 12px helvetica, sans-serif",i.fillText("1: Try closing ALL open web-browser windows, and reloading",30,u),u+=30,i.fillText("2: Try rebooting your computer, and reloading",30,u);if(this.errorMessage)u+=50,i.fillStyle="red",i.fillText(this.errorMessage,30,u)}async getJagFile(u,_,m,R){let b=this.jagChecksum[m],E,O=5;try{if(this.db)E=await this.db.read(0,m)}catch(I){}if(E&&W.getcrc(E,0,E.length)!==b)E=void 0;if(E)return new a0(E);let L=0;while(!E){await this.drawProgress(R,`Requesting ${_}`);try{E=await r0(`/${u}${b}`);let I=W.getcrc(E,0,E.length);if(b===I)try{if(this.db)await this.db.write(0,m,E)}catch(N){}else E=void 0,L++}catch(I){E=void 0}if(!E){for(let I=O;I>0;I--){if(L>=3)await this.drawProgress(R,"Game updated - please reload page"),I=10;else await this.drawProgress(R,`Error loading - Will retry in ${I} secs.`);await Y0(1000)}if(O*=2,O>60)O=60}}return new a0(E)}async updateOnDemand(){if(!this.onDemand)return;await this.onDemand.run();while(!0){let u=this.onDemand.loop();if(u===null)return;if(!u.data)continue;if(u.archive===0){if($.unpack(u.file,u.data),(this.onDemand.getModelFlags(u.file)&98)!=0){if(this.redrawSidebar=!0,this.chatInterfaceId!==-1)this.redrawChatback=!0}}else if(u.archive===1)h0.unpack(u.data);else if(u.archive===2){if(this.midiSong===u.file)this.saveMidi(this.midiFading,u.data)}else if(u.archive===3){if(this.sceneMapLandData&&this.sceneMapLocData&&this.sceneState===1)for(let _=0;_<this.sceneMapLandData.length;_++){if(this.sceneMapLandFile[_]==u.file){if(this.sceneMapLandData[_]=u.data,u.data==null)this.sceneMapLandFile[_]=-1;break}if(this.sceneMapLocFile[_]==u.file){if(this.sceneMapLocData[_]=u.data,u.data==null)this.sceneMapLocFile[_]=-1;break}}}else if(u.archive===93){if(this.onDemand.hasMapLocFile(u.file))C.prefetchLocs(new W(u.data),this.onDemand)}}}async updateTitle(){if(this.titleScreenState===0){let u=(this.width/2|0)-80,_=(this.height/2|0)+20;if(_+=20,this.mouseClickButton===1&&this.mouseClickX>=u-75&&this.mouseClickX<=u+75&&this.mouseClickY>=_-20&&this.mouseClickY<=_+20)this.titleScreenState=3,this.titleLoginField=0;if(u=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=u-75&&this.mouseClickX<=u+75&&this.mouseClickY>=_-20&&this.mouseClickY<=_+20)this.loginMessage0="",this.loginMessage1="Enter your username & password.",this.titleScreenState=2,this.titleLoginField=0}else if(this.titleScreenState===2){let u=(this.height/2|0)-40;if(u+=30,u+=25,this.mouseClickButton===1&&this.mouseClickY>=u-15&&this.mouseClickY<u)this.titleLoginField=0;if(u+=15,this.mouseClickButton===1&&this.mouseClickY>=u-15&&this.mouseClickY<u)this.titleLoginField=1;let _=(this.width/2|0)-80;if(u=(this.height/2|0)+50,u+=20,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=u-20&&this.mouseClickY<=u+20){if(await this.login(this.username,this.password,!1),this.ingame)return}if(_=(this.width/2|0)+80,this.mouseClickButton===1&&this.mouseClickX>=_-75&&this.mouseClickX<=_+75&&this.mouseClickY>=u-20&&this.mouseClickY<=u+20)this.titleScreenState=0,this.username="",this.password="";while(!0){let m=this.pollKey();if(m===-1)return;let R=!1;for(let b=0;b<k0.CHARSET.length;b++)if(String.fromCharCode(m)===k0.CHARSET.charAt(b)){R=!0;break}if(this.titleLoginField===0){if(m===8&&this.username.length>0)this.username=this.username.substring(0,this.username.length-1);if(m===9||m===10||m===13)this.titleLoginField=1;if(R)this.username=this.username+String.fromCharCode(m);if(this.username.length>12)this.username=this.username.substring(0,12)}else if(this.titleLoginField===1){if(m===8&&this.password.length>0)this.password=this.password.substring(0,this.password.length-1);if(m===9||m===10||m===13)this.titleLoginField=0;if(R)this.password=this.password+String.fromCharCode(m);if(this.password.length>20)this.password=this.password.substring(0,20)}}}else if(this.titleScreenState===3){let u=this.width/2|0,_=(this.height/2|0)+50;if(_+=20,this.mouseClickButton===1&&this.mouseClickX>=u-75&&this.mouseClickX<=u+75&&this.mouseClickY>=_-20&&this.mouseClickY<=_+20)this.titleScreenState=0}}async login(u,_,m){try{if(!m)this.loginMessage0="",this.loginMessage1="Connecting to server...",await this.drawTitle();this.stream=new W0(await W0.openSocket(window.location.host,window.location.protocol==="https:"));let R=c.toBase37(u),b=Number(R>>16n)&31;this.out.pos=0,this.out.p1(14),this.out.p1(b),this.stream.write(this.out.data,2);for(let O=0;O<8;O++)await this.stream.read();let E=await this.stream.read();if(E===0){await this.stream.readBytes(this.in.data,0,8),this.in.pos=0,this.serverSeed=this.in.g8();let O=new Int32Array([Math.floor(Math.random()*99999999),Math.floor(Math.random()*99999999),Number(this.serverSeed>>32n),Number(this.serverSeed&BigInt(4294967295))]);if(this.out.pos=0,this.out.p1(10),this.out.p4(O[0]),this.out.p4(O[1]),this.out.p4(O[2]),this.out.p4(O[3]),this.out.p4(1337),this.out.pjstr(u),this.out.pjstr(_),this.out.rsaenc(BigInt("7162900525229798032761816791230527296329313291232324290237849263501208207972894053929065636522363163621000728841182238772712427862772219676577293600221789"),BigInt("58778699976184461502525193738213253649000149147835990136706041084440742975821")),this.loginout.pos=0,m)this.loginout.p1(18);else this.loginout.p1(16);this.loginout.p1(this.out.pos+36+1+1),this.loginout.p1(245),this.loginout.p1(v.lowMemory?1:0);for(let L=0;L<9;L++)this.loginout.p4(this.jagChecksum[L]);this.loginout.pdata(this.out.data,this.out.pos,0),this.out.random=new e0(O);for(let L=0;L<4;L++)O[L]+=50;this.randomIn=new e0(O),this.stream?.write(this.loginout.data,this.loginout.pos),E=await this.stream.read()}if(E===1)await Y0(2000),await this.login(u,_,m);else if(E===2||E===18||E===19){if(this.staffmodlevel=0,E===18)this.staffmodlevel=1;else if(E===19)this.staffmodlevel=2;E0.setDisabled(),this.hasFocus=!0,this.ingame=!0,this.out.pos=0,this.in.pos=0,this.ptype=-1,this.ptype0=-1,this.ptype1=-1,this.ptype2=-1,this.psize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.idleTimeout=0,this.hintType=0,this.field1264=0,this.menuSize=0,this.menuVisible=!1,this.idleCycles=performance.now();for(let O=0;O<100;O++)this.messageText[O]=null;this.objSelected=0,this.spellSelected=0,this.sceneState=0,this.waveCount=0,this.macroCameraX=(Math.random()*100|0)-50,this.macroCameraZ=(Math.random()*110|0)-55,this.macroCameraAngle=(Math.random()*80|0)-40,this.macroMinimapAngle=(Math.random()*120|0)-60,this.macroMinimapZoom=(Math.random()*30|0)-20,this.orbitCameraYaw=(Math.random()*20|0)-10&2047,this.minimapLevel=-1,this.flagSceneTileX=0,this.flagSceneTileZ=0,this.playerCount=0,this.npcCount=0;for(let O=0;O<2048;O++)this.players[O]=null,this.playerAppearanceBuffer[O]=null;for(let O=0;O<8192;O++)this.npcs[O]=null;this.localPlayer=this.players[2047]=new T0,this.projectiles.clear(),this.spotanims.clear();for(let O=0;O<4;O++)for(let L=0;L<104;L++)for(let I=0;I<104;I++)this.objStacks[O][L][I]=null;this.locChanges=new $0,this.friendCount=0,this.stickyChatInterfaceId=-1,this.chatInterfaceId=-1,this.viewportInterfaceId=-1,this.sidebarInterfaceId=-1,this.viewportOverlayInterfaceId=-1,this.pressedContinueOption=!1,this.selectedTab=3,this.chatbackInputOpen=!1,this.menuVisible=!1,this.showSocialInput=!1,this.modalMessage=null,this.inMultizone=0,this.flashingTab=-1,this.designGender=!0,this.validateCharacterDesign();for(let O=0;O<5;O++)this.designColours[O]=0;v.oplogic1=0,v.oplogic2=0,v.oplogic3=0,v.oplogic4=0,v.oplogic5=0,v.oplogic6=0,v.oplogic7=0,v.oplogic8=0,v.oplogic9=0,this.prepareGame()}else if(E===3)this.loginMessage0="",this.loginMessage1="Invalid username or password.";else if(E===4)this.loginMessage0="Your account has been disabled.",this.loginMessage1="Please check your message-centre for details.";else if(E===5)this.loginMessage0="Your account is already logged in.",this.loginMessage1="Try again in 60 secs...";else if(E===6)this.loginMessage0="RuneScape has been updated!",this.loginMessage1="Please reload this page.";else if(E===7)this.loginMessage0="This world is full.",this.loginMessage1="Please use a different world.";else if(E===8)this.loginMessage0="Unable to connect.",this.loginMessage1="Login server offline.";else if(E===9)this.loginMessage0="Login limit exceeded.",this.loginMessage1="Too many connections from your address.";else if(E===10)this.loginMessage0="Unable to connect.",this.loginMessage1="Bad session id.";else if(E===11)this.loginMessage1="Login server rejected session.",this.loginMessage1="Please try again.";else if(E===12)this.loginMessage0="You need a members account to login to this world.",this.loginMessage1="Please subscribe, or use a different world.";else if(E===13)this.loginMessage0="Could not complete login.",this.loginMessage1="Please try using a different world.";else if(E===14)this.loginMessage0="The server is being updated.",this.loginMessage1="Please wait 1 minute and try again.";else if(E===15)this.ingame=!0,this.out.pos=0,this.in.pos=0,this.ptype=-1,this.ptype0=-1,this.ptype1=-1,this.ptype2=-1,this.psize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.menuSize=0,this.menuVisible=!1,this.sceneLoadStartTime=performance.now();else if(E===16)this.loginMessage0="Login attempts exceeded.",this.loginMessage1="Please wait 1 minute and try again.";else if(E===17)this.loginMessage0="You are standing in a members-only area.",this.loginMessage1="To play on this world move to a free area first";else if(E===20)this.loginMessage0="Invalid loginserver requested",this.loginMessage1="Please try using a different world.";else this.loginMessage0="Unexpected server response",this.loginMessage1="Please try using a different world."}catch(R){this.loginMessage0="",this.loginMessage1="Error connecting to server."}}async logout(){if(this.stream)this.stream.close();this.stream=null,this.ingame=!1,this.titleScreenState=0,this.username="",this.password="",E0.setDisabled(),this.clearCache(),this.scene?.reset();for(let u=0;u<4;u++)this.levelCollisionMap[u]?.reset();iu(!1),this.nextMidiSong=-1,this.midiSong=-1,this.nextMusicDelay=0}clearCache(){m0.modelCacheStatic?.clear(),m0.modelCacheDynamic?.clear(),j0.modelCache?.clear(),l.modelCache?.clear(),l.iconCache?.clear(),T0.modelCache?.clear(),n0.modelCache?.clear()}prepareGame(){if(this.areaChatback)return;this.unloadTitle(),this.drawArea=null,this.imageTitle2=null,this.imageTitle3=null,this.imageTitle4=null,this.imageTitle0=null,this.imageTitle1=null,this.imageTitle5=null,this.imageTitle6=null,this.imageTitle7=null,this.imageTitle8=null,this.areaChatback=new N0(479,96),this.areaMapback=new N0(172,156),K.clear(),this.imageMapback?.draw(0,0),this.areaSidebar=new N0(190,261),this.areaViewport=new N0(512,334),K.clear(),this.areaBackbase1=new N0(496,50),this.areaBackbase2=new N0(269,37),this.areaBackhmid1=new N0(249,45),this.redrawFrame=!0}async updateGame(){if(this.players===null)return;if(this.systemUpdateTimer>1)this.systemUpdateTimer--;if(this.idleTimeout>0)this.idleTimeout--;if(this.field1264>0)this.field1264-=2;for(let u=0;u<5&&await this.readPacket();u++);if(this.ingame){this.updateSceneState(),this.updateLocChanges(),await this.updateAudio();let u=E0.flush();if(u)this.out.p1isaac(19),this.out.p2(u.pos),this.out.pdata(u.data,u.pos,0),u.release();if(this.idleNetCycles++,this.idleNetCycles>250)await this.tryReconnect();if(this.updatePlayers(),this.updateNpcs(),this.updateEntityChats(),this.sceneDelta++,this.crossMode!==0){if(this.crossCycle+=20,this.crossCycle>=400)this.crossMode=0}if(this.selectedArea!==0){if(this.selectedCycle++,this.selectedCycle>=15){if(this.selectedArea===2)this.redrawSidebar=!0;else if(this.selectedArea===3)this.redrawChatback=!0;this.selectedArea=0}}if(this.objDragArea!==0){if(this.objDragCycles++,this.mouseX>this.objGrabX+5||this.mouseX<this.objGrabX-5||this.mouseY>this.objGrabY+5||this.mouseY<this.objGrabY-5)this.objGrabThreshold=!0;if(this.mouseButton===0){if(this.objDragArea===2)this.redrawSidebar=!0;else if(this.objDragArea===3)this.redrawChatback=!0;if(this.objDragArea=0,this.objGrabThreshold&&this.objDragCycles>=5){if(this.hoveredSlotParentId=-1,this.handleInput(),this.hoveredSlotParentId===this.objDragInterfaceId&&this.hoveredSlot!==this.objDragSlot){let m=g.types[this.objDragInterfaceId],R=0;if(this.bankArrangeMode==1&&m.clientCode==206)R=1;if(m.invSlotObjId&&m.invSlotObjId[this.hoveredSlot]<=0)R=0;if(m.swappable&&m.invSlotObjId&&m.invSlotObjCount){let b=this.objDragSlot,E=this.hoveredSlot;m.invSlotObjId[E]=m.invSlotObjId[b],m.invSlotObjCount[E]=m.invSlotObjCount[b],m.invSlotObjId[b]=-1,m.invSlotObjCount[b]=0}else if(R==1){let b=this.objDragSlot,E=this.hoveredSlot;while(b!=E)if(b>E)m.swapObj(b,b-1),b--;else if(b<E)m.swapObj(b,b+1),b++}else m.swapObj(this.objDragSlot,this.hoveredSlot);this.out.p1isaac(7),this.out.p2(this.objDragInterfaceId),this.out.p2(this.objDragSlot),this.out.p2(this.hoveredSlot),this.out.p1(R)}}else if((this.oneMouseButton===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)this.showContextMenu();else if(this.menuSize>0)this.useMenuOption(this.menuSize-1);this.selectedCycle=10,this.mouseClickButton=0}}if(v.cyclelogic3++,v.cyclelogic3>127)v.cyclelogic3=0,this.out.p1isaac(181),this.out.p3(4991788);if(F.clickTileX!==-1){if(this.localPlayer){let m=F.clickTileX,R=F.clickTileZ,b=this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],m,R,0,0,0,0,0,0,!0);if(F.clickTileX=-1,b)this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=1,this.crossCycle=0}}if(this.mouseClickButton===1&&this.modalMessage)this.modalMessage=null,this.redrawChatback=!0,this.mouseClickButton=0;if(!this.isMobile||this.isMobile&&!J0.isWithinCanvasKeyboard(this.mouseClickX,this.mouseClickY))this.handleMouseInput(),this.handleMinimapInput(),this.handleTabInput(),this.handleChatModeInput();if(this.mouseButton===1||this.mouseClickButton===1)this.dragCycles++;if(this.sceneState===2)this.updateOrbitCamera();if(this.sceneState===2&&this.cutscene)this.applyCutscene();for(let m=0;m<5;m++)this.cameraModifierCycle[m]++;if(await this.handleInputKey(),performance.now()-this.idleCycles>90000)this.idleTimeout=250,this.idleCycles=performance.now()-1e4,this.out.p1isaac(102);if(this.macroCameraCycle++,this.macroCameraCycle>500){this.macroCameraCycle=0;let m=Math.random()*8|0;if((m&1)===1)this.macroCameraX+=this.macroCameraXModifier;if((m&2)===2)this.macroCameraZ+=this.macroCameraZModifier;if((m&4)===4)this.macroCameraAngle+=this.macroCameraAngleModifier}if(this.macroCameraX<-50)this.macroCameraXModifier=2;else if(this.macroCameraX>50)this.macroCameraXModifier=-2;if(this.macroCameraZ<-55)this.macroCameraZModifier=2;else if(this.macroCameraZ>55)this.macroCameraZModifier=-2;if(this.macroCameraAngle<-40)this.macroCameraAngleModifier=1;else if(this.macroCameraAngle>40)this.macroCameraAngleModifier=-1;if(this.macroMinimapCycle++,this.macroMinimapCycle>500){this.macroMinimapCycle=0;let m=Math.random()*8|0;if((m&1)===1)this.macroMinimapAngle+=this.macroMinimapAngleModifier;if((m&2)===2)this.macroMinimapZoom+=this.macroMinimapZoomModifier}if(this.macroMinimapAngle<-60)this.macroMinimapAngleModifier=2;else if(this.macroMinimapAngle>60)this.macroMinimapAngleModifier=-2;if(this.macroMinimapZoom<-20)this.macroMinimapZoomModifier=1;else if(this.macroMinimapZoom>10)this.macroMinimapZoomModifier=-1;if(v.cyclelogic4++,v.cyclelogic4>110)v.cyclelogic4=0,this.out.p1isaac(94),this.out.p4(0);if(this.noTimeoutCycle++,this.noTimeoutCycle>50)this.out.p1isaac(206);try{if(this.stream&&this.out.pos>0)this.stream.write(this.out.data,this.out.pos),this.out.pos=0,this.noTimeoutCycle=0}catch(m){await this.tryReconnect()}}}async tryReconnect(){if(this.idleTimeout>0){await this.logout();return}if(this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,144,"Connection lost",0),this.fontPlain12?.drawStringCenter(256,143,"Connection lost",16777215),this.fontPlain12?.drawStringCenter(257,159,"Please wait - attempting to reestablish",0),this.fontPlain12?.drawStringCenter(256,158,"Please wait - attempting to reestablish",16777215),this.areaViewport?.draw(4,4),this.flagSceneTileX=0,this.stream?.close(),this.ingame=!1,await this.login(this.username,this.password,!0),!this.ingame)await this.logout()}updateSceneState(){if(v.lowMemory&&this.sceneState===2&&C.levelBuilt!==this.currentLevel)this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(4,4),this.sceneState=1;if(this.sceneState===1){if(this.checkScene()!=0&&performance.now()-this.sceneLoadStartTime>360000)this.sceneLoadStartTime=performance.now()}if(this.sceneState===2&&this.currentLevel!==this.minimapLevel)this.minimapLevel=this.currentLevel,this.createMinimap(this.currentLevel)}checkScene(){if(!this.sceneMapIndex||!this.sceneMapLandData||!this.sceneMapLocData)return-1000;for(let _=0;_<this.sceneMapLandData.length;_++){if(this.sceneMapLandData[_]==null&&this.sceneMapLandFile[_]!==-1)return-1;if(this.sceneMapLocData[_]==null&&this.sceneMapLocFile[_]!==-1)return-2}let u=!0;for(let _=0;_<this.sceneMapLandData.length;_++){let m=this.sceneMapLocData[_];if(m!=null){let R=(this.sceneMapIndex[_]>>8)*64-this.sceneBaseTileX,b=(this.sceneMapIndex[_]&255)*64-this.sceneBaseTileZ;u&&=C.locsAreReady(m,R,b)}}if(!u)return-3;else if(this.awaitingSync)return-4;return this.sceneState=2,C.levelBuilt=this.currentLevel,this.buildScene(),0}buildScene(){try{this.minimapLevel=-1,this.spotanims.clear(),this.projectiles.clear(),h.clearTexels(),this.clearCache(),this.scene?.reset();for(let O=0;O<4;O++)this.levelCollisionMap[O]?.reset();let b=new C(104,104,this.levelHeightmap,this.levelTileFlags,this.levelShadowmap);C.lowMemory=F.lowMemory;let E=this.sceneMapLandData?.length??0;if(this.sceneMapIndex)for(let O=0;O<E;O++){let L=this.sceneMapIndex[O]>>8,I=this.sceneMapIndex[O]&255;if(L===33&&I>=71&&I<=73){C.lowMemory=!1;break}}if(v.lowMemory)this.scene?.setMinLevel(this.currentLevel);else this.scene?.setMinLevel(0);if(this.sceneMapIndex&&this.sceneMapLandData){this.out.p1isaac(206);for(let O=0;O<E;O++){let L=(this.sceneMapIndex[O]>>8)*64-this.sceneBaseTileX,I=(this.sceneMapIndex[O]&255)*64-this.sceneBaseTileZ,N=this.sceneMapLandData[O];if(N)b.loadGround((this.sceneCenterZoneX-6)*8,(this.sceneCenterZoneZ-6)*8,L,I,N)}for(let O=0;O<E;O++){let L=(this.sceneMapIndex[O]>>8)*64-this.sceneBaseTileX,I=(this.sceneMapIndex[O]&255)*64-this.sceneBaseTileZ;if(!this.sceneMapLandData[O]&&this.sceneCenterZoneZ<800)b.spreadHeight(I,L,64,64)}}if(this.sceneMapIndex&&this.sceneMapLocData){this.out.p1isaac(206);for(let O=0;O<E;O++){let L=this.sceneMapLocData[O];if(L){let I=(this.sceneMapIndex[O]>>8)*64-this.sceneBaseTileX,N=(this.sceneMapIndex[O]&255)*64-this.sceneBaseTileZ;b.loadLocations(this.loopCycle,this.scene,this.levelCollisionMap,L,I,N)}}}this.out.p1isaac(206),b.build(this.scene,this.levelCollisionMap),this.areaViewport?.bind(),this.out.p1isaac(206);for(let O=0;O<104;O++)for(let L=0;L<104;L++)this.sortObjStacks(O,L);this.clearLocChanges()}catch(b){}if(m0.modelCacheStatic?.clear(),v.lowMemory&&this.db){let b=this.onDemand?.getFileCount(0)??0;for(let E=0;E<b;E++)if(((this.onDemand?.getModelFlags(E)??0)&121)==0)$.unload(E)}h.initPool(20),this.onDemand?.clearPrefetches();let u=(this.sceneCenterZoneX-6)/8-1,_=(this.sceneCenterZoneX+6)/8+1,m=(this.sceneCenterZoneZ-6)/8-1,R=(this.sceneCenterZoneZ+6)/8+1;if(this.withinTutorialIsland)u=49,_=50,m=49,R=50;for(let b=u;b<=_;b++)for(let E=m;E<=R;E++)if(u==b||_==b||m==E||R==E){let O=this.onDemand?.getMapFile(E,b,0)??-1;if(O!=-1)this.onDemand?.prefetch(3,O);let L=this.onDemand?.getMapFile(E,b,1)??-1;if(L!=-1)this.onDemand?.prefetch(3,L)}}clearLocChanges(){for(let u=this.locChanges.head();u;u=this.locChanges.next())if(u.endTime===-1)u.startTime=0,this.storeLoc(u);else u.unlink()}createMinimap(u){if(!this.imageMinimap)return;let _=this.imageMinimap.pixels,m=_.length;for(let E=0;E<m;E++)_[E]=0;for(let E=1;E<104-1;E++){let O=(104-1-E)*512*4+24628;for(let L=1;L<104-1;L++){if(this.levelTileFlags&&(this.levelTileFlags[u][L][E]&24)===0)this.scene?.drawMinimapTile(u,L,E,_,O,512);if(u<3&&this.levelTileFlags&&(this.levelTileFlags[u+1][L][E]&8)!==0)this.scene?.drawMinimapTile(u+1,L,E,_,O,512);O+=4}}let R=((Math.random()*20|0)+238-10<<16)+((Math.random()*20|0)+238-10<<8)+(Math.random()*20|0)+238-10,b=(Math.random()*20|0)+238-10<<16;this.imageMinimap.bind();for(let E=1;E<104-1;E++)for(let O=1;O<104-1;O++){if(this.levelTileFlags&&(this.levelTileFlags[u][O][E]&24)===0)this.drawMinimapLoc(O,E,u,R,b);if(u<3&&this.levelTileFlags&&(this.levelTileFlags[u+1][O][E]&8)!==0)this.drawMinimapLoc(O,E,u+1,R,b)}this.areaViewport?.bind(),this.activeMapFunctionCount=0;for(let E=0;E<104;E++)for(let O=0;O<104;O++){let L=this.scene?.getGroundDecorTypecode(this.currentLevel,E,O)??0;if(L===0)continue;let I=L>>14&32767,N=m0.get(I).mapfunction;if(N<0)continue;let H=E,G=O;if(N!==22&&N!==29&&N!==34&&N!==36&&N!==46&&N!==47&&N!==48){let T=104,q=104,Q=this.levelCollisionMap[this.currentLevel];if(Q){let n=Q.flags;for(let J=0;J<10;J++){let U=Math.random()*4|0;if(U===0&&H>0&&H>E-3&&(n[e.index(H-1,G)]&2621704)===0)H--;if(U===1&&H<T-1&&H<E+3&&(n[e.index(H+1,G)]&2621824)===0)H++;if(U===2&&G>0&&G>O-3&&(n[e.index(H,G-1)]&2621698)===0)G--;if(U===3&&G<q-1&&G<O+3&&(n[e.index(H,G+1)]&2621728)===0)G++}}}this.activeMapFunctions[this.activeMapFunctionCount]=this.imageMapfunction[N],this.activeMapFunctionX[this.activeMapFunctionCount]=H,this.activeMapFunctionZ[this.activeMapFunctionCount]=G,this.activeMapFunctionCount++}}updateLocChanges(){if(this.sceneState!==2)return;for(let u=this.locChanges.head();u;u=this.locChanges.next()){if(u.endTime>0)u.endTime--;if(u.endTime!=0){if(u.startTime>0)u.startTime--;if(u.startTime===0&&u.x>=1&&u.z>=1&&u.x<=102&&u.z<=102&&(u.newType<0||C.isLocReady(u.newType,u.newShape))){if(this.addLoc(u.level,u.x,u.z,u.newType,u.newAngle,u.newShape,u.layer),u.startTime=-1,u.oldType===u.newType&&u.oldType===-1)u.unlink();else if(u.oldType===u.newType&&u.oldAngle===u.newAngle&&u.oldShape===u.newShape)u.unlink()}}else if(u.oldType<0||C.isLocReady(u.oldType,u.oldShape))this.addLoc(u.level,u.x,u.z,u.oldType,u.oldAngle,u.oldShape,u.layer),u.unlink()}if(v.cyclelogic5++,v.cyclelogic5>85)v.cyclelogic5=0,this.out.p1isaac(63)}async updateAudio(){for(let u=0;u<this.waveCount;u++)if(this.waveDelay[u]<=0){try{let _=b0.generate(this.waveIds[u],this.waveLoops[u]);if(!_)throw Error();if(performance.now()+(_.pos/22|0)>this.lastWaveStartTime+(this.lastWaveLength/22|0))this.lastWaveLength=_.pos,this.lastWaveStartTime=performance.now(),this.lastWaveId=this.waveIds[u],this.lastWaveLoops=this.waveLoops[u],await _1(_.data.slice(0,_.pos))}catch(_){}this.waveCount--;for(let _=u;_<this.waveCount;_++)this.waveIds[_]=this.waveIds[_+1],this.waveLoops[_]=this.waveLoops[_+1],this.waveDelay[_]=this.waveDelay[_+1];u--}else this.waveDelay[u]--;if(this.nextMusicDelay>0){if(this.nextMusicDelay-=20,this.nextMusicDelay<0)this.nextMusicDelay=0;if(this.nextMusicDelay===0&&this.midiActive&&!v.lowMemory)this.midiSong=this.nextMidiSong,this.midiFading=!1,this.onDemand?.request(2,this.midiSong)}}handleInput(){if(this.objDragArea!==0)return;if(this.menuOption[0]="Cancel",this.menuAction[0]=1252,this.menuSize=1,this.handlePrivateChatInput(),this.lastHoveredInterfaceId=0,this.mouseX>4&&this.mouseY>4&&this.mouseX<516&&this.mouseY<338)if(this.viewportInterfaceId===-1)this.handleViewportOptions();else this.handleInterfaceInput(g.types[this.viewportInterfaceId],this.mouseX,this.mouseY,4,4,0);if(this.lastHoveredInterfaceId!==this.viewportHoveredInterfaceIndex)this.viewportHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>553&&this.mouseY>205&&this.mouseX<743&&this.mouseY<466){if(this.sidebarInterfaceId!==-1)this.handleInterfaceInput(g.types[this.sidebarInterfaceId],this.mouseX,this.mouseY,553,205,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.handleInterfaceInput(g.types[this.tabInterfaceId[this.selectedTab]],this.mouseX,this.mouseY,553,205,0)}if(this.lastHoveredInterfaceId!==this.sidebarHoveredInterfaceIndex)this.redrawSidebar=!0,this.sidebarHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>17&&this.mouseY>357&&this.mouseX<426&&this.mouseY<453){if(this.chatInterfaceId!==-1)this.handleInterfaceInput(g.types[this.chatInterfaceId],this.mouseX,this.mouseY,17,357,0);else if(this.mouseY<434)this.handleChatMouseInput(this.mouseX-17,this.mouseY-357)}if(this.chatInterfaceId!==-1&&this.lastHoveredInterfaceId!==this.chatHoveredInterfaceIndex)this.redrawChatback=!0,this.chatHoveredInterfaceIndex=this.lastHoveredInterfaceId;let u=!1;while(!u){u=!0;for(let _=0;_<this.menuSize-1;_++)if(this.menuAction[_]<1000&&this.menuAction[_+1]>1000){let m=this.menuOption[_];this.menuOption[_]=this.menuOption[_+1],this.menuOption[_+1]=m;let R=this.menuAction[_];this.menuAction[_]=this.menuAction[_+1],this.menuAction[_+1]=R;let b=this.menuParamB[_];this.menuParamB[_]=this.menuParamB[_+1],this.menuParamB[_+1]=b;let E=this.menuParamC[_];this.menuParamC[_]=this.menuParamC[_+1],this.menuParamC[_+1]=E;let O=this.menuParamA[_];this.menuParamA[_]=this.menuParamA[_+1],this.menuParamA[_+1]=O,u=!1}}}handlePrivateChatInput(){if(this.splitPrivateChat===0)return;let u=0;if(this.systemUpdateTimer!==0)u=1;for(let _=0;_<100;_++)if(this.messageText[_]!==null){let m=this.messageType[_],R=this.messageSender[_],b=!1;if(R&&R.startsWith("@cr1@"))R=R.substring(5),b=!0;else if(R&&R.startsWith("@cr2@"))R=R.substring(5),b=!0;if((m===3||m===7)&&(m===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(R))){let E=329-u*13;if(this.mouseX>4&&this.mouseX<516&&this.mouseY-4>E-10&&this.mouseY-4<=E+3){if(this.staffmodlevel)this.menuOption[this.menuSize]="Report abuse @whi@"+R,this.menuAction[this.menuSize]=2034,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+R,this.menuAction[this.menuSize]=2436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+R,this.menuAction[this.menuSize]=2406,this.menuSize++}if(u++,u>=5)return}else if((m===5||m===6)&&this.chatPrivateMode<2){if(u++,u>=5)return}}}handleChatMouseInput(u,_){let m=0;for(let R=0;R<100;R++){if(!this.messageText[R])continue;let b=this.messageType[R],E=this.chatScrollOffset+70+4-m*14;if(E<-20)break;let O=this.messageSender[R],L=!1;if(O&&O.startsWith("@cr1@"))O=O.substring(5),L=!0;else if(O&&O.startsWith("@cr2@"))O=O.substring(5),L=!0;if(b===0)m++;else if((b==1||b==2)&&(b==1||this.chatPublicMode==0||this.chatPublicMode==1&&this.isFriend(O))){if(_>E-14&&_<=E&&this.localPlayer&&O!==this.localPlayer.name){if(this.staffmodlevel>=1)this.menuOption[this.menuSize]="Report abuse @whi@"+O,this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+O,this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+O,this.menuAction[this.menuSize]=406,this.menuSize++}m++}else if((b===3||b===7)&&this.splitPrivateChat===0&&(b===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(O))){if(_>E-14&&_<=E){if(this.staffmodlevel>=1)this.menuOption[this.menuSize]="Report abuse @whi@"+O,this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+O,this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+O,this.menuAction[this.menuSize]=406,this.menuSize++}m++}else if(b===4&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(O))){if(_>E-14&&_<=E)this.menuOption[this.menuSize]="Accept trade @whi@"+O,this.menuAction[this.menuSize]=903,this.menuSize++;m++}else if((b===5||b===6)&&this.splitPrivateChat===0&&this.chatPrivateMode<2)m++;else if(b===8&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(O))){if(_>E-14&&_<=E)this.menuOption[this.menuSize]="Accept duel @whi@"+O,this.menuAction[this.menuSize]=363,this.menuSize++;m++}}}handleViewportOptions(){if(this.objSelected===0&&this.spellSelected===0)this.menuOption[this.menuSize]="Walk here",this.menuAction[this.menuSize]=660,this.menuParamB[this.menuSize]=this.mouseX,this.menuParamC[this.menuSize]=this.mouseY,this.menuSize++;let u=-1;for(let _=0;_<$.pickedCount;_++){let m=$.pickedBitsets[_],R=m&127,b=m>>7&127,E=m>>29&3,O=m>>14&32767;if(m===u)continue;if(u=m,E===2&&this.scene&&this.scene.getInfo(this.currentLevel,R,b,m)>=0){let L=m0.get(O);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @cya@"+L.name,this.menuAction[this.menuSize]=450,this.menuParamA[this.menuSize]=m,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++;else if(this.spellSelected!==1){if(L.op){for(let I=4;I>=0;I--)if(L.op[I]){if(this.menuOption[this.menuSize]=L.op[I]+" @cya@"+L.name,I===0)this.menuAction[this.menuSize]=285;else if(I===1)this.menuAction[this.menuSize]=504;else if(I===2)this.menuAction[this.menuSize]=364;else if(I===3)this.menuAction[this.menuSize]=581;else if(I===4)this.menuAction[this.menuSize]=1501;this.menuParamA[this.menuSize]=m,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}}this.menuOption[this.menuSize]="Examine @cya@"+L.name,this.menuAction[this.menuSize]=1175,this.menuParamA[this.menuSize]=m,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}else if((this.activeSpellFlags&4)===4)this.menuOption[this.menuSize]=this.spellCaption+" @cya@"+L.name,this.menuAction[this.menuSize]=55,this.menuParamA[this.menuSize]=m,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}else if(E===1){let L=this.npcs[O];if(L&&L.type&&L.type.size===1&&(L.x&127)===64&&(L.z&127)===64)for(let I=0;I<this.npcCount;I++){let N=this.npcs[this.npcIds[I]];if(N&&N!==L&&N.type&&N.type.size===1&&N.x===L.x&&N.z===L.z)this.addNpcOptions(N.type,this.npcIds[I],R,b)}if(L&&L.type)this.addNpcOptions(L.type,O,R,b)}else if(E===0){let L=this.players[O];if(L&&(L.x&127)===64&&(L.z&127)===64){for(let I=0;I<this.npcCount;I++){let N=this.npcs[this.npcIds[I]];if(N&&N.type&&N.type.size===1&&N.x===L.x&&N.z===L.z)this.addNpcOptions(N.type,this.npcIds[I],R,b)}for(let I=0;I<this.playerCount;I++){let N=this.players[this.playerIds[I]];if(N&&N!==L&&N.x===L.x&&N.z===L.z)this.addPlayerOptions(N,this.playerIds[I],R,b)}}if(L)this.addPlayerOptions(L,O,R,b)}else if(E===3){let L=this.objStacks[this.currentLevel][R][b];if(!L)continue;for(let I=L.tail();I;I=L.prev()){let N=l.get(I.index);if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+N.name,this.menuAction[this.menuSize]=217,this.menuParamA[this.menuSize]=I.index,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++;else if(this.spellSelected!==1){for(let H=4;H>=0;H--)if(N.op&&N.op[H]){if(this.menuOption[this.menuSize]=N.op[H]+" @lre@"+N.name,H===0)this.menuAction[this.menuSize]=224;else if(H===1)this.menuAction[this.menuSize]=993;else if(H===2)this.menuAction[this.menuSize]=99;else if(H===3)this.menuAction[this.menuSize]=746;else if(H===4)this.menuAction[this.menuSize]=877;this.menuParamA[this.menuSize]=I.index,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}else if(H===2)this.menuOption[this.menuSize]="Take @lre@"+N.name,this.menuAction[this.menuSize]=99,this.menuParamA[this.menuSize]=I.index,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++;this.menuOption[this.menuSize]="Examine @lre@"+N.name,this.menuAction[this.menuSize]=1102,this.menuParamA[this.menuSize]=I.index,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}else if((this.activeSpellFlags&1)===1)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+N.name,this.menuAction[this.menuSize]=965,this.menuParamA[this.menuSize]=I.index,this.menuParamB[this.menuSize]=R,this.menuParamC[this.menuSize]=b,this.menuSize++}}}}handleMouseInput(){if(this.objDragArea!==0)return;if(this.isMobile&&this.chatbackInputOpen&&this.insideChatPopupArea())return;let u=this.mouseClickButton;if(this.spellSelected===1&&this.mouseClickX>=516&&this.mouseClickY>=160&&this.mouseClickX<=765&&this.mouseClickY<=205)u=0;if(!this.menuVisible){if(u===1&&this.menuSize>0){let _=this.menuAction[this.menuSize-1];if(_==602||_==596||_==22||_==892||_==415||_==405||_==38||_==422||_==478||_==347||_==188){let m=this.menuParamB[this.menuSize-1],R=this.menuParamC[this.menuSize-1],b=g.types[R];if(b.draggable||b.swappable){if(this.objGrabThreshold=!1,this.objDragCycles=0,this.objDragInterfaceId=R,this.objDragSlot=m,this.objDragArea=2,this.objGrabX=this.mouseClickX,this.objGrabY=this.mouseClickY,g.types[R].layer===this.viewportInterfaceId)this.objDragArea=1;if(g.types[R].layer===this.chatInterfaceId)this.objDragArea=3;return}}}if(u===1&&(this.oneMouseButton===1||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)u=2;if(u===1&&this.menuSize>0)this.useMenuOption(this.menuSize-1);else if(u==2&&this.menuSize>0)this.showContextMenu();return}if(u===1){let _=this.menuX,m=this.menuY,R=this.menuWidth,b=this.mouseClickX,E=this.mouseClickY;if(this.menuArea===0)b-=4,E-=4;else if(this.menuArea===1)b-=553,E-=205;else if(this.menuArea===2)b-=17,E-=357;let O=-1;for(let L=0;L<this.menuSize;L++){let I=m+(this.menuSize-1-L)*15+31;if(b>_&&b<_+R&&E>I-13&&E<I+3)O=L}if(O!==-1)this.useMenuOption(O);if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;else if(this.menuArea===2)this.redrawChatback=!0}else{let _=this.mouseX,m=this.mouseY;if(this.menuArea===0)_-=4,m-=4;else if(this.menuArea===1)_-=553,m-=205;else if(this.menuArea===2)_-=17,m-=357;if(_<this.menuX-10||_>this.menuX+this.menuWidth+10||m<this.menuY-10||m>this.menuY+this.menuHeight+10){if(this.menuVisible=!1,this.menuArea===1)this.redrawSidebar=!0;if(this.menuArea===2)this.redrawChatback=!0}}}handleMinimapInput(){if(this.mouseClickButton!==1||!this.localPlayer)return;let u=this.mouseClickX-25-550,_=this.mouseClickY-4-4;if(u<0||_<0||u>=146||_>=151)return;u-=73,_-=75;let m=this.orbitCameraYaw+this.macroMinimapAngle&2047,R=h.sinTable[m],b=h.cosTable[m];R=R*(this.macroMinimapZoom+256)>>8,b=b*(this.macroMinimapZoom+256)>>8;let E=_*R+u*b>>11,O=_*b-u*R>>11,L=this.localPlayer.x+E>>7,I=this.localPlayer.z-O>>7;if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],L,I,1,0,0,0,0,0,!0))this.out.p1(u),this.out.p1(_),this.out.p2(this.orbitCameraYaw),this.out.p1(57),this.out.p1(this.macroMinimapAngle),this.out.p1(this.macroMinimapZoom),this.out.p1(89),this.out.p2(this.localPlayer.x),this.out.p2(this.localPlayer.z),this.out.p1(this.tryMoveNearest),this.out.p1(63)}handleTabInput(){if(this.mouseClickButton!==1)return;if(this.mouseClickX>=539&&this.mouseClickX<=573&&this.mouseClickY>=169&&this.mouseClickY<205&&this.tabInterfaceId[0]!=-1)this.redrawSidebar=!0,this.selectedTab=0,this.redrawSideicons=!0;else if(this.mouseClickX>=569&&this.mouseClickX<=599&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[1]!=-1)this.redrawSidebar=!0,this.selectedTab=1,this.redrawSideicons=!0;else if(this.mouseClickX>=597&&this.mouseClickX<=627&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[2]!=-1)this.redrawSidebar=!0,this.selectedTab=2,this.redrawSideicons=!0;else if(this.mouseClickX>=625&&this.mouseClickX<=669&&this.mouseClickY>=168&&this.mouseClickY<203&&this.tabInterfaceId[3]!=-1)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;else if(this.mouseClickX>=666&&this.mouseClickX<=696&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[4]!=-1)this.redrawSidebar=!0,this.selectedTab=4,this.redrawSideicons=!0;else if(this.mouseClickX>=694&&this.mouseClickX<=724&&this.mouseClickY>=168&&this.mouseClickY<205&&this.tabInterfaceId[5]!=-1)this.redrawSidebar=!0,this.selectedTab=5,this.redrawSideicons=!0;else if(this.mouseClickX>=722&&this.mouseClickX<=756&&this.mouseClickY>=169&&this.mouseClickY<205&&this.tabInterfaceId[6]!=-1)this.redrawSidebar=!0,this.selectedTab=6,this.redrawSideicons=!0;else if(this.mouseClickX>=540&&this.mouseClickX<=574&&this.mouseClickY>=466&&this.mouseClickY<502&&this.tabInterfaceId[7]!=-1)this.redrawSidebar=!0,this.selectedTab=7,this.redrawSideicons=!0;else if(this.mouseClickX>=572&&this.mouseClickX<=602&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[8]!=-1)this.redrawSidebar=!0,this.selectedTab=8,this.redrawSideicons=!0;else if(this.mouseClickX>=599&&this.mouseClickX<=629&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[9]!=-1)this.redrawSidebar=!0,this.selectedTab=9,this.redrawSideicons=!0;else if(this.mouseClickX>=627&&this.mouseClickX<=671&&this.mouseClickY>=467&&this.mouseClickY<502&&this.tabInterfaceId[10]!=-1)this.redrawSidebar=!0,this.selectedTab=10,this.redrawSideicons=!0;else if(this.mouseClickX>=669&&this.mouseClickX<=699&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[11]!=-1)this.redrawSidebar=!0,this.selectedTab=11,this.redrawSideicons=!0;else if(this.mouseClickX>=696&&this.mouseClickX<=726&&this.mouseClickY>=466&&this.mouseClickY<503&&this.tabInterfaceId[12]!=-1)this.redrawSidebar=!0,this.selectedTab=12,this.redrawSideicons=!0;else if(this.mouseClickX>=724&&this.mouseClickX<=758&&this.mouseClickY>=466&&this.mouseClickY<502&&this.tabInterfaceId[13]!=-1)this.redrawSidebar=!0,this.selectedTab=13,this.redrawSideicons=!0;if(v.cyclelogic1++,v.cyclelogic1>150)v.cyclelogic1=0,this.out.p1isaac(136),this.out.p1(43)}handleChatModeInput(){if(this.mouseClickButton!==1)return;if(this.mouseClickX>=6&&this.mouseClickX<=106&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatPublicMode=(this.chatPublicMode+1)%4,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(8),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=135&&this.mouseClickX<=235&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatPrivateMode=(this.chatPrivateMode+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(8),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=273&&this.mouseClickX<=373&&this.mouseClickY>=467&&this.mouseClickY<=499)this.chatTradeMode=(this.chatTradeMode+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(8),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode);else if(this.mouseClickX>=412&&this.mouseClickX<=512&&this.mouseClickY>=467&&this.mouseClickY<=499){this.closeInterfaces(),this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let u=0;u<g.types.length;u++)if(g.types[u]&&g.types[u].clientCode===600){this.reportAbuseInterfaceId=this.viewportInterfaceId=g.types[u].layer;break}if(this.isMobile)J0.show()}}closeInterfaces(){if(this.out.p1isaac(245),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.pressedContinueOption=!1,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0,this.pressedContinueOption=!1;this.viewportInterfaceId=-1}updateEntityChats(){for(let u=-1;u<this.playerCount;u++){let _;if(u===-1)_=2047;else _=this.playerIds[u];let m=this.players[_];if(m&&m.chatTimer>0){if(m.chatTimer--,m.chatTimer===0)m.chatMessage=null}}for(let u=0;u<this.npcCount;u++){let _=this.npcIds[u],m=this.npcs[_];if(m&&m.chatTimer>0){if(m.chatTimer--,m.chatTimer===0)m.chatMessage=null}}}updateOrbitCamera(){if(!this.localPlayer)return;let u=this.localPlayer.x+this.macroCameraX,_=this.localPlayer.z+this.macroCameraZ;if(this.orbitCameraX-u<-500||this.orbitCameraX-u>500||this.orbitCameraZ-_<-500||this.orbitCameraZ-_>500)this.orbitCameraX=u,this.orbitCameraZ=_;if(this.orbitCameraX!==u)this.orbitCameraX+=(u-this.orbitCameraX)/16|0;if(this.orbitCameraZ!==_)this.orbitCameraZ+=(_-this.orbitCameraZ)/16|0;if(this.actionKey[1]===1)this.orbitCameraYawVelocity+=(-this.orbitCameraYawVelocity-24)/2|0;else if(this.actionKey[2]===1)this.orbitCameraYawVelocity+=(24-this.orbitCameraYawVelocity)/2|0;else this.orbitCameraYawVelocity=this.orbitCameraYawVelocity/2|0;if(this.actionKey[3]===1)this.orbitCameraPitchVelocity+=(12-this.orbitCameraPitchVelocity)/2|0;else if(this.actionKey[4]===1)this.orbitCameraPitchVelocity+=(-this.orbitCameraPitchVelocity-12)/2|0;else this.orbitCameraPitchVelocity=this.orbitCameraPitchVelocity/2|0;if(this.orbitCameraYaw=(this.orbitCameraYaw+this.orbitCameraYawVelocity/2|0)&2047,this.orbitCameraPitch+=this.orbitCameraPitchVelocity/2|0,this.orbitCameraPitch<128)this.orbitCameraPitch=128;else if(this.orbitCameraPitch>383)this.orbitCameraPitch=383;let m=this.orbitCameraX>>7,R=this.orbitCameraZ>>7,b=this.getHeightmapY(this.currentLevel,this.orbitCameraX,this.orbitCameraZ),E=0;if(this.levelHeightmap){if(m>3&&R>3&&m<100&&R<100)for(let L=m-4;L<=m+4;L++)for(let I=R-4;I<=R+4;I++){let N=this.currentLevel;if(N<3&&this.levelTileFlags&&(this.levelTileFlags[1][L][I]&2)===2)N++;let H=b-this.levelHeightmap[N][L][I];if(H>E)E=H}}let O=E*192;if(O>98048)O=98048;else if(O<32768)O=32768;if(O>this.cameraPitchClamp)this.cameraPitchClamp+=(O-this.cameraPitchClamp)/24|0;else if(O<this.cameraPitchClamp)this.cameraPitchClamp+=(O-this.cameraPitchClamp)/80|0}applyCutscene(){let u=this.cutsceneSrcLocalTileX*128+64,_=this.cutsceneSrcLocalTileZ*128+64,m=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;if(this.cameraX<u){if(this.cameraX+=this.cutsceneMoveSpeed+((u-this.cameraX)*this.cutsceneMoveAcceleration/1000|0),this.cameraX>u)this.cameraX=u}if(this.cameraX>u){if(this.cameraX-=this.cutsceneMoveSpeed+((this.cameraX-u)*this.cutsceneMoveAcceleration/1000|0),this.cameraX<u)this.cameraX=u}if(this.cameraY<m){if(this.cameraY+=this.cutsceneMoveSpeed+((m-this.cameraY)*this.cutsceneMoveAcceleration/1000|0),this.cameraY>m)this.cameraY=m}if(this.cameraY>m){if(this.cameraY-=this.cutsceneMoveSpeed+((this.cameraY-m)*this.cutsceneMoveAcceleration/1000|0),this.cameraY<m)this.cameraY=m}if(this.cameraZ<_){if(this.cameraZ+=this.cutsceneMoveSpeed+((_-this.cameraZ)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ>_)this.cameraZ=_}if(this.cameraZ>_){if(this.cameraZ-=this.cutsceneMoveSpeed+((this.cameraZ-_)*this.cutsceneMoveAcceleration/1000|0),this.cameraZ<_)this.cameraZ=_}u=this.cutsceneDstLocalTileX*128+64,_=this.cutsceneDstLocalTileZ*128+64,m=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight;let R=u-this.cameraX,b=m-this.cameraY,E=_-this.cameraZ,O=Math.sqrt(R*R+E*E)|0,L=(Math.atan2(b,O)*325.949|0)&2047,I=(Math.atan2(R,E)*-325.949|0)&2047;if(L<128)L=128;else if(L>383)L=383;if(this.cameraPitch<L){if(this.cameraPitch+=this.cutsceneRotateSpeed+((L-this.cameraPitch)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch>L)this.cameraPitch=L}if(this.cameraPitch>L){if(this.cameraPitch-=this.cutsceneRotateSpeed+((this.cameraPitch-L)*this.cutsceneRotateAcceleration/1000|0),this.cameraPitch<L)this.cameraPitch=L}let N=I-this.cameraYaw;if(N>1024)N-=2048;else if(N<-1024)N+=2048;if(N>0)this.cameraYaw+=this.cutsceneRotateSpeed+(N*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;if(N<0)this.cameraYaw-=this.cutsceneRotateSpeed+(-N*this.cutsceneRotateAcceleration/1000|0),this.cameraYaw&=2047;let H=I-this.cameraYaw;if(H>1024)H-=2048;else if(H<-1024)H+=2048;if(H<0&&N>0||H>0&&N<0)this.cameraYaw=I}async handleInputKey(){while(!0){let u;do while(!0){if(u=this.pollKey(),u===-1)return;if(this.viewportInterfaceId!==-1&&this.viewportInterfaceId===this.reportAbuseInterfaceId){if(u===8&&this.reportAbuseInput.length>0)this.reportAbuseInput=this.reportAbuseInput.substring(0,this.reportAbuseInput.length-1);break}if(this.showSocialInput){if(u>=32&&u<=122&&this.socialInput.length<80)this.socialInput=this.socialInput+String.fromCharCode(u),this.redrawChatback=!0;if(u===8&&this.socialInput.length>0)this.socialInput=this.socialInput.substring(0,this.socialInput.length-1),this.redrawChatback=!0;if(u===13||u===10){this.showSocialInput=!1,this.redrawChatback=!0;let _;if(this.socialInputType===1)_=c.toBase37(this.socialInput),this.addFriend(_);if(this.socialInputType===2&&this.friendCount>0)_=c.toBase37(this.socialInput),this.removeFriend(_);if(this.socialInputType===3&&this.socialInput.length>0&&this.socialName37){this.out.p1isaac(99),this.out.p1(0);let m=this.out.pos;if(this.out.p8(this.socialName37),v0.pack(this.out,this.socialInput),this.out.psize1(this.out.pos-m),this.socialInput=c.toSentenceCase(this.socialInput),this.socialInput=D0.filter(this.socialInput),this.addMessage(6,this.socialInput,c.formatName(c.fromBase37(this.socialName37))),this.chatPrivateMode===2)this.chatPrivateMode=1,this.redrawPrivacySettings=!0,this.out.p1isaac(8),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode)}if(this.socialInputType===4&&this.ignoreCount<100)_=c.toBase37(this.socialInput),this.addIgnore(_);if(this.socialInputType===5&&this.ignoreCount>0)_=c.toBase37(this.socialInput),this.removeIgnore(_)}}else if(this.chatbackInputOpen){if(u>=48&&u<=57&&this.chatbackInput.length<10)this.chatbackInput=this.chatbackInput+String.fromCharCode(u),this.redrawChatback=!0;if(u===8&&this.chatbackInput.length>0)this.chatbackInput=this.chatbackInput.substring(0,this.chatbackInput.length-1),this.redrawChatback=!0;if(u===13||u===10){if(this.chatbackInput.length>0){let _=0;try{_=parseInt(this.chatbackInput,10)}catch(m){}this.out.p1isaac(241),this.out.p4(_)}this.chatbackInputOpen=!1,this.redrawChatback=!0}}else if(this.chatInterfaceId===-1){if(u>=32&&(u<=122||this.chatTyped.startsWith("::")&&u<=126)&&this.chatTyped.length<80)this.chatTyped=this.chatTyped+String.fromCharCode(u),this.redrawChatback=!0;if(u===8&&this.chatTyped.length>0)this.chatTyped=this.chatTyped.substring(0,this.chatTyped.length-1),this.redrawChatback=!0;if((u===13||u===10)&&this.chatTyped.length>0){if(this.staffmodlevel===2){if(this.chatTyped==="::clientdrop")await this.tryReconnect();else if(this.chatTyped==="::prefetchmusic"){if(this.onDemand)for(let _=0;_<this.onDemand.getFileCount(2);_++)this.onDemand.prefetchPriority(2,_,1)}else if(this.chatTyped==="::lag")this.lag()}if(this.chatTyped==="::fpson")this.displayFps=!0;else if(this.chatTyped==="::fpsoff")this.displayFps=!1;else if(this.chatTyped.startsWith("::fps "))try{let _=parseInt(this.chatTyped.substring(6))||50;this.setTargetedFramerate(_)}catch(_){}else if(this.chatTyped.startsWith("::"))this.out.p1isaac(11),this.out.p1(this.chatTyped.length-1),this.out.pjstr(this.chatTyped.substring(2));else{let _=0;if(this.chatTyped.startsWith("yellow:"))_=0,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("red:"))_=1,this.chatTyped=this.chatTyped.substring(4);else if(this.chatTyped.startsWith("green:"))_=2,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("cyan:"))_=3,this.chatTyped=this.chatTyped.substring(5);else if(this.chatTyped.startsWith("purple:"))_=4,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("white:"))_=5,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("flash1:"))_=6,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash2:"))_=7,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash3:"))_=8,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("glow1:"))_=9,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow2:"))_=10,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow3:"))_=11,this.chatTyped=this.chatTyped.substring(6);let m=0;if(this.chatTyped.startsWith("wave:"))m=1,this.chatTyped=this.chatTyped.substring(5);if(this.chatTyped.startsWith("scroll:"))m=2,this.chatTyped=this.chatTyped.substring(7);this.out.p1isaac(78),this.out.p1(0);let R=this.out.pos;if(this.out.p1(_),this.out.p1(m),v0.pack(this.out,this.chatTyped),this.out.psize1(this.out.pos-R),this.chatTyped=c.toSentenceCase(this.chatTyped),this.chatTyped=D0.filter(this.chatTyped),this.localPlayer&&this.localPlayer.name)if(this.localPlayer.chatMessage=this.chatTyped,this.localPlayer.chatColour=_,this.localPlayer.chatEffect=m,this.localPlayer.chatTimer=150,this.staffmodlevel===2)this.addMessage(2,this.localPlayer.chatMessage,"@cr2@"+this.localPlayer.name);else if(this.staffmodlevel===1)this.addMessage(2,this.localPlayer.chatMessage,"@cr1@"+this.localPlayer.name);else this.addMessage(2,this.localPlayer.chatMessage,this.localPlayer.name);if(this.chatPublicMode===2)this.chatPublicMode=3,this.redrawPrivacySettings=!0,this.out.p1isaac(8),this.out.p1(this.chatPublicMode),this.out.p1(this.chatPrivateMode),this.out.p1(this.chatTradeMode)}this.chatTyped="",this.redrawChatback=!0}}}while((u<97||u>122)&&(u<65||u>90)&&(u<48||u>57)&&u!==32);if(this.reportAbuseInput.length<12)this.reportAbuseInput=this.reportAbuseInput+String.fromCharCode(u)}}lag(){if(this.onDemand);}updatePlayers(){for(let u=-1;u<this.playerCount;u++){let _;if(u===-1)_=2047;else _=this.playerIds[u];let m=this.players[_];if(m)this.updateEntity(m)}if(v.cyclelogic6++,v.cyclelogic6>1406){v.cyclelogic6=0,this.out.p1isaac(112),this.out.p1(0);let u=this.out.pos;if(this.out.p1(162),this.out.p1(22),(Math.random()*2|0)===0)this.out.p1(84);if(this.out.p2(31824),this.out.p2(13490),(Math.random()*2|0)===0)this.out.p1(123);if((Math.random()*2|0)===0)this.out.p1(134);this.out.p1(100),this.out.p1(94),this.out.p2(35521),this.out.psize1(this.out.pos-u)}}updateNpcs(){for(let u=0;u<this.npcCount;u++){let _=this.npcIds[u],m=this.npcs[_];if(m&&m.type)this.updateEntity(m)}}updateEntity(u){if(u.x<128||u.z<128||u.x>=13184||u.z>=13184)u.primarySeqId=-1,u.spotanimId=-1,u.forceMoveEndCycle=0,u.forceMoveStartCycle=0,u.x=u.routeTileX[0]*128+u.size*64,u.z=u.routeTileZ[0]*128+u.size*64,u.clearRoute();if(u===this.localPlayer&&(u.x<1536||u.z<1536||u.x>=11776||u.z>=11776))u.primarySeqId=-1,u.spotanimId=-1,u.forceMoveEndCycle=0,u.forceMoveStartCycle=0,u.x=u.routeTileX[0]*128+u.size*64,u.z=u.routeTileZ[0]*128+u.size*64,u.clearRoute();if(u.forceMoveEndCycle>this.loopCycle)this.updateForceMovement(u);else if(u.forceMoveStartCycle>=this.loopCycle)this.startForceMovement(u);else this.updateMovement(u);this.updateFacingDirection(u),this.updateSequences(u)}updateForceMovement(u){let _=u.forceMoveEndCycle-this.loopCycle,m=u.forceMoveStartSceneTileX*128+u.size*64,R=u.forceMoveStartSceneTileZ*128+u.size*64;if(u.x+=(m-u.x)/_|0,u.z+=(R-u.z)/_|0,u.seqDelayMove=0,u.forceMoveFaceDirection===0)u.dstYaw=1024;else if(u.forceMoveFaceDirection===1)u.dstYaw=1536;else if(u.forceMoveFaceDirection===2)u.dstYaw=0;else if(u.forceMoveFaceDirection===3)u.dstYaw=512}startForceMovement(u){if(u.forceMoveStartCycle===this.loopCycle||u.primarySeqId===-1||u.primarySeqDelay!==0||u.primarySeqCycle+1>o.types[u.primarySeqId].getFrameDuration(u.primarySeqFrame)){let _=u.forceMoveStartCycle-u.forceMoveEndCycle,m=this.loopCycle-u.forceMoveEndCycle,R=u.forceMoveStartSceneTileX*128+u.size*64,b=u.forceMoveStartSceneTileZ*128+u.size*64,E=u.forceMoveEndSceneTileX*128+u.size*64,O=u.forceMoveEndSceneTileZ*128+u.size*64;u.x=(R*(_-m)+E*m)/_|0,u.z=(b*(_-m)+O*m)/_|0}if(u.seqDelayMove=0,u.forceMoveFaceDirection===0)u.dstYaw=1024;else if(u.forceMoveFaceDirection===1)u.dstYaw=1536;else if(u.forceMoveFaceDirection===2)u.dstYaw=0;else if(u.forceMoveFaceDirection===3)u.dstYaw=512;u.yaw=u.dstYaw}updateMovement(u){if(u.secondarySeqId=u.readyanim,u.routeLength===0){u.seqDelayMove=0;return}if(u.primarySeqId!==-1&&u.primarySeqDelay===0){let I=o.types[u.primarySeqId];if(u.preanimRouteLength>0&&I.preanim_move===0){u.seqDelayMove++;return}if(u.preanimRouteLength<=0&&I.postanim_move===0){u.seqDelayMove++;return}}let{x:_,z:m}=u,R=u.routeTileX[u.routeLength-1]*128+u.size*64,b=u.routeTileZ[u.routeLength-1]*128+u.size*64;if(R-_>256||R-_<-256||b-m>256||b-m<-256){u.x=R,u.z=b;return}if(_<R)if(m<b)u.dstYaw=1280;else if(m>b)u.dstYaw=1792;else u.dstYaw=1536;else if(_>R)if(m<b)u.dstYaw=768;else if(m>b)u.dstYaw=256;else u.dstYaw=512;else if(m<b)u.dstYaw=1024;else u.dstYaw=0;let E=u.dstYaw-u.yaw&2047;if(E>1024)E-=2048;let O=u.walkanim_b;if(E>=-256&&E<=256)O=u.walkanim;else if(E>=256&&E<768)O=u.walkanim_r;else if(E>=-768&&E<=-256)O=u.walkanim_l;if(O===-1)O=u.walkanim;u.secondarySeqId=O;let L=4;if(u.yaw!==u.dstYaw&&u.targetId===-1)L=2;if(u.routeLength>2)L=6;if(u.routeLength>3)L=8;if(u.seqDelayMove>0&&u.routeLength>1)L=8,u.seqDelayMove--;if(u.routeRun[u.routeLength-1])L<<=1;if(L>=8&&u.secondarySeqId===u.walkanim&&u.runanim!==-1)u.secondarySeqId=u.runanim;if(_<R){if(u.x+=L,u.x>R)u.x=R}else if(_>R){if(u.x-=L,u.x<R)u.x=R}if(m<b){if(u.z+=L,u.z>b)u.z=b}else if(m>b){if(u.z-=L,u.z<b)u.z=b}if(u.x===R&&u.z===b){if(u.routeLength--,u.preanimRouteLength>0)u.preanimRouteLength--}}updateFacingDirection(u){if(u.targetId!==-1&&u.targetId<32768){let m=this.npcs[u.targetId];if(m){let R=u.x-m.x,b=u.z-m.z;if(R!==0||b!==0)u.dstYaw=(Math.atan2(R,b)*325.949|0)&2047}}if(u.targetId>=32768){let m=u.targetId-32768;if(m===this.localPid)m=2047;let R=this.players[m];if(R){let b=u.x-R.x,E=u.z-R.z;if(b!==0||E!==0)u.dstYaw=(Math.atan2(b,E)*325.949|0)&2047}}if((u.targetTileX!==0||u.targetTileZ!==0)&&(u.routeLength===0||u.seqDelayMove>0)){let m=u.x-(u.targetTileX-this.sceneBaseTileX-this.sceneBaseTileX)*64,R=u.z-(u.targetTileZ-this.sceneBaseTileZ-this.sceneBaseTileZ)*64;if(m!==0||R!==0)u.dstYaw=(Math.atan2(m,R)*325.949|0)&2047;u.targetTileX=0,u.targetTileZ=0}let _=u.dstYaw-u.yaw&2047;if(_!==0){if(_<32||_>2016)u.yaw=u.dstYaw;else if(_>1024)u.yaw-=32;else u.yaw+=32;if(u.yaw&=2047,u.secondarySeqId===u.readyanim&&u.yaw!==u.dstYaw)if(u.turnanim!=-1)u.secondarySeqId=u.turnanim;else u.secondarySeqId=u.walkanim}}updateSequences(u){u.needsForwardDrawPadding=!1;let _;if(u.secondarySeqId!==-1){if(_=o.types[u.secondarySeqId],u.secondarySeqCycle++,u.secondarySeqFrame<_.frameCount&&u.secondarySeqCycle>_.getFrameDuration(u.secondarySeqFrame))u.secondarySeqCycle=0,u.secondarySeqFrame++;if(u.secondarySeqFrame>=_.frameCount)u.secondarySeqCycle=0,u.secondarySeqFrame=0}if(u.spotanimId!==-1&&this.loopCycle>=u.spotanimLastCycle){if(u.spotanimFrame<0)u.spotanimFrame=0;_=n0.types[u.spotanimId].seq,u.spotanimCycle++;while(_&&u.spotanimFrame<_.frameCount&&u.spotanimCycle>_.getFrameDuration(u.spotanimFrame))u.spotanimCycle-=_.getFrameDuration(u.spotanimFrame),u.spotanimFrame++;if(_&&u.spotanimFrame>=_.frameCount){if(u.spotanimFrame<0||u.spotanimFrame>=_.frameCount)u.spotanimId=-1}}if(u.primarySeqId!=-1&&u.primarySeqDelay<=1){if(_=o.types[u.primarySeqId],_.preanim_move===1&&u.preanimRouteLength>0&&this.loopCycle>=u.forceMoveStartCycle&&this.loopCycle>u.forceMoveEndCycle){u.primarySeqDelay=1;return}}if(u.primarySeqId!==-1&&u.primarySeqDelay===0){_=o.types[u.primarySeqId],u.primarySeqCycle++;while(u.primarySeqFrame<_.frameCount&&u.primarySeqCycle>_.getFrameDuration(u.primarySeqFrame))u.primarySeqCycle-=_.getFrameDuration(u.primarySeqFrame),u.primarySeqFrame++;if(u.primarySeqFrame>=_.frameCount){if(u.primarySeqFrame-=_.loops,u.primarySeqLoop++,u.primarySeqLoop>=_.maxloops)u.primarySeqId=-1;if(u.primarySeqFrame<0||u.primarySeqFrame>=_.frameCount)u.primarySeqId=-1}u.needsForwardDrawPadding=_.stretches}if(u.primarySeqDelay>0)u.primarySeqDelay--}async loadTitle(){if(this.imageTitle2)return;if(this.drawArea=null,this.areaChatback=null,this.areaMapback=null,this.areaSidebar=null,this.areaViewport=null,this.areaBackbase1=null,this.areaBackbase2=null,this.areaBackhmid1=null,this.imageTitle0=new N0(128,265),K.clear(),this.imageTitle1=new N0(128,265),K.clear(),this.imageTitle2=new N0(509,171),K.clear(),this.imageTitle3=new N0(360,132),K.clear(),this.imageTitle4=new N0(360,200),K.clear(),this.imageTitle5=new N0(202,238),K.clear(),this.imageTitle6=new N0(203,238),K.clear(),this.imageTitle7=new N0(74,94),K.clear(),this.imageTitle8=new N0(75,94),K.clear(),this.jagTitle)await this.loadTitleBackground(),await this.loadTitleImages();this.redrawFrame=!0}async loadTitleBackground(){if(!this.jagTitle)return;let u=await R0.fromJpeg(this.jagTitle,"title");this.imageTitle0?.bind(),u.blitOpaque(0,0),this.imageTitle1?.bind(),u.blitOpaque(-637,0),this.imageTitle2?.bind(),u.blitOpaque(-128,0),this.imageTitle3?.bind(),u.blitOpaque(-202,-371),this.imageTitle4?.bind(),u.blitOpaque(-202,-171),this.imageTitle5?.bind(),u.blitOpaque(0,-265),this.imageTitle6?.bind(),u.blitOpaque(-562,-265),this.imageTitle7?.bind(),u.blitOpaque(-128,-171),this.imageTitle8?.bind(),u.blitOpaque(-562,-171),u.flipHorizontally(),this.imageTitle0?.bind(),u.blitOpaque(382,0),this.imageTitle1?.bind(),u.blitOpaque(-255,0),this.imageTitle2?.bind(),u.blitOpaque(254,0),this.imageTitle3?.bind(),u.blitOpaque(180,-371),this.imageTitle4?.bind(),u.blitOpaque(180,-171),this.imageTitle5?.bind(),u.blitOpaque(382,-265),this.imageTitle6?.bind(),u.blitOpaque(-180,-265),this.imageTitle7?.bind(),u.blitOpaque(254,-171),this.imageTitle8?.bind(),u.blitOpaque(-180,-171);let _=R0.fromArchive(this.jagTitle,"logo");this.imageTitle2?.bind(),_.draw((this.width/2|0)-(_.cropRight/2|0)-128,18)}async loadTitleImages(){if(!this.jagTitle)return;this.imageTitlebox=I0.fromArchive(this.jagTitle,"titlebox"),this.imageTitlebutton=I0.fromArchive(this.jagTitle,"titlebutton");for(let u=0;u<12;u++)this.imageRunes[u]=I0.fromArchive(this.jagTitle,"runes",u);if(this.imageFlamesLeft=new R0(128,265),this.imageFlamesRight=new R0(128,265),this.imageTitle0)ku(this.imageTitle0.pixels,0,this.imageFlamesLeft.pixels,0,33920);if(this.imageTitle1)ku(this.imageTitle1.pixels,0,this.imageFlamesRight.pixels,0,33920);this.flameGradient0=new Int32Array(256);for(let u=0;u<64;u++)this.flameGradient0[u]=u*262144;for(let u=0;u<64;u++)this.flameGradient0[u+64]=u*1024+16711680;for(let u=0;u<64;u++)this.flameGradient0[u+128]=u*4+16776960;for(let u=0;u<64;u++)this.flameGradient0[u+192]=16777215;this.flameGradient1=new Int32Array(256);for(let u=0;u<64;u++)this.flameGradient1[u]=u*1024;for(let u=0;u<64;u++)this.flameGradient1[u+64]=u*4+65280;for(let u=0;u<64;u++)this.flameGradient1[u+128]=u*262144+65535;for(let u=0;u<64;u++)this.flameGradient1[u+192]=16777215;this.flameGradient2=new Int32Array(256);for(let u=0;u<64;u++)this.flameGradient2[u]=u*4;for(let u=0;u<64;u++)this.flameGradient2[u+64]=u*262144+255;for(let u=0;u<64;u++)this.flameGradient2[u+128]=u*1024+16711935;for(let u=0;u<64;u++)this.flameGradient2[u+192]=16777215;if(this.flameGradient=new Int32Array(256),this.flameBuffer0=new Int32Array(32768),this.flameBuffer1=new Int32Array(32768),this.updateFlameBuffer(null),this.flameBuffer3=new Int32Array(32768),this.flameBuffer2=new Int32Array(32768),await this.drawProgress(10,"Connecting to fileserver"),!this.flameActive)this.flameActive=!0,this.flamesInterval=setInterval(this.runFlames.bind(this),35)}async drawTitle(){await this.loadTitle(),this.imageTitle4?.bind(),this.imageTitlebox?.draw(0,0);let u=360,_=200;if(this.titleScreenState===0){let m=(_/2|0)+80,R=(_/2|0)-20;if(this.onDemand)this.fontPlain11?.drawStringTaggableCenter(u/2,m,this.onDemand.message,7711145,!0);this.fontBold12?.drawStringTaggableCenter(u/2,R,"Welcome to RuneScape",16776960,!0),R+=30;let b=(u/2|0)-80;R=(_/2|0)+20,this.imageTitlebutton?.draw(b-73,R-20),this.fontBold12?.drawStringTaggableCenter(b,R+5,"New user",16777215,!0),b=(u/2|0)+80,this.imageTitlebutton?.draw(b-73,R-20),this.fontBold12?.drawStringTaggableCenter(b,R+5,"Existing User",16777215,!0)}else if(this.titleScreenState===2){let m=(u/2|0)-80,R=(_/2|0)-40;if(this.loginMessage0.length>0)this.fontBold12?.drawStringTaggableCenter(u/2,R-15,this.loginMessage0,16776960,!0),this.fontBold12?.drawStringTaggableCenter(u/2,R,this.loginMessage1,16776960,!0),R+=30;else this.fontBold12?.drawStringTaggableCenter(u/2,R-7,this.loginMessage1,16776960,!0),R+=30;this.fontBold12?.drawStringTaggable(u/2-90,R,`Username: ${this.username}${this.titleLoginField===0&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),R+=15,this.fontBold12?.drawStringTaggable(u/2-88,R,`Password: ${c.toAsterisks(this.password)}${this.titleLoginField===1&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),R+=15,m=(u/2|0)-80,R=(_/2|0)+50,this.imageTitlebutton?.draw(m-73,R-20),this.fontBold12?.drawStringTaggableCenter(m,R+5,"Login",16777215,!0),m=(u/2|0)+80,this.imageTitlebutton?.draw(m-73,R-20),this.fontBold12?.drawStringTaggableCenter(m,R+5,"Cancel",16777215,!0)}else if(this.titleScreenState===3){let m=u/2|0,R=(_/2|0)-60;this.fontBold12?.drawStringTaggableCenter(m,R,"Create a free account",16776960,!0),R=(_/2|0)-35,this.fontBold12?.drawStringTaggableCenter(m,R,"To create a new account you need to",16777215,!0),R+=15,this.fontBold12?.drawStringTaggableCenter(m,R,"go back to the main RuneScape webpage",16777215,!0),R+=15,this.fontBold12?.drawStringTaggableCenter(m,R,"and choose the red 'create account'",16777215,!0),R+=15,this.fontBold12?.drawStringTaggableCenter(m,R,"button at the top right of that page.",16777215,!0),R+=15,m=u/2|0,R=(_/2|0)+50,this.imageTitlebutton?.draw(m-73,R-20),this.fontBold12?.drawStringTaggableCenter(m,R+5,"Cancel",16777215,!0)}if(this.imageTitle4?.draw(202,171),this.redrawFrame)this.redrawFrame=!1,this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(202,371),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(562,265),this.imageTitle7?.draw(128,171),this.imageTitle8?.draw(562,171)}drawGame(){if(this.players===null)return;if(this.redrawFrame){if(this.redrawFrame=!1,this.areaBackleft1?.draw(0,4),this.areaBackleft2?.draw(0,357),this.areaBackright1?.draw(722,4),this.areaBackright2?.draw(743,205),this.areaBacktop1?.draw(0,0),this.areaBackvmid1?.draw(516,4),this.areaBackvmid2?.draw(516,205),this.areaBackvmid3?.draw(496,357),this.areaBackhmid2?.draw(0,338),this.redrawSidebar=!0,this.redrawChatback=!0,this.redrawSideicons=!0,this.redrawPrivacySettings=!0,this.sceneState!==2)this.areaViewport?.draw(4,4),this.areaMapback?.draw(550,4)}if(this.sceneState===2)this.drawScene();if(this.menuVisible&&this.menuArea===1)this.redrawSidebar=!0;if(this.sidebarInterfaceId!==-1){if(this.updateInterfaceAnimation(this.sidebarInterfaceId,this.sceneDelta))this.redrawSidebar=!0}if(this.selectedArea===2)this.redrawSidebar=!0;if(this.objDragArea===2)this.redrawSidebar=!0;if(this.redrawSidebar)this.drawSidebar(),this.redrawSidebar=!1;if(this.chatInterfaceId===-1){if(this.chatInterface.scrollPosition=this.chatScrollHeight-this.chatScrollOffset-77,this.mouseX>448&&this.mouseX<560&&this.mouseY>332)this.handleScrollInput(this.mouseX-17,this.mouseY-357,this.chatScrollHeight,77,!1,463,0,this.chatInterface);let u=this.chatScrollHeight-this.chatInterface.scrollPosition-77;if(u<0)u=0;if(u>this.chatScrollHeight-77)u=this.chatScrollHeight-77;if(this.chatScrollOffset!==u)this.chatScrollOffset=u,this.redrawChatback=!0}if(this.chatInterfaceId!==-1){if(this.updateInterfaceAnimation(this.chatInterfaceId,this.sceneDelta))this.redrawChatback=!0}if(this.selectedArea===3)this.redrawChatback=!0;if(this.objDragArea===3)this.redrawChatback=!0;if(this.modalMessage)this.redrawChatback=!0;if(this.menuVisible&&this.menuArea===2)this.redrawChatback=!0;if(this.redrawChatback)this.drawChat(),this.redrawChatback=!1;if(this.sceneState===2)this.drawMinimap(),this.areaMapback?.draw(550,4);if(this.flashingTab!==-1)this.redrawSideicons=!0;if(this.redrawSideicons){if(this.flashingTab!==-1&&this.flashingTab===this.selectedTab)this.flashingTab=-1,this.out.p1isaac(243),this.out.p1(this.selectedTab);if(this.redrawSideicons=!1,this.areaBackhmid1?.bind(),this.imageBackhmid1?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===0)this.imageRedstone1?.draw(22,10);else if(this.selectedTab===1)this.imageRedstone2?.draw(54,8);else if(this.selectedTab===2)this.imageRedstone2?.draw(82,8);else if(this.selectedTab===3)this.imageRedstone3?.draw(110,8);else if(this.selectedTab===4)this.imageRedstone2h?.draw(153,8);else if(this.selectedTab===5)this.imageRedstone2h?.draw(181,8);else if(this.selectedTab===6)this.imageRedstone1h?.draw(209,9)}if(this.tabInterfaceId[0]!==-1&&(this.flashingTab!==0||this.loopCycle%20<10))this.imageSideicons[0]?.draw(29,13);if(this.tabInterfaceId[1]!==-1&&(this.flashingTab!==1||this.loopCycle%20<10))this.imageSideicons[1]?.draw(53,11);if(this.tabInterfaceId[2]!==-1&&(this.flashingTab!==2||this.loopCycle%20<10))this.imageSideicons[2]?.draw(82,11);if(this.tabInterfaceId[3]!==-1&&(this.flashingTab!==3||this.loopCycle%20<10))this.imageSideicons[3]?.draw(115,12);if(this.tabInterfaceId[4]!==-1&&(this.flashingTab!==4||this.loopCycle%20<10))this.imageSideicons[4]?.draw(153,13);if(this.tabInterfaceId[5]!==-1&&(this.flashingTab!==5||this.loopCycle%20<10))this.imageSideicons[5]?.draw(180,11);if(this.tabInterfaceId[6]!==-1&&(this.flashingTab!==6||this.loopCycle%20<10))this.imageSideicons[6]?.draw(208,13)}if(this.areaBackhmid1?.draw(516,160),this.areaBackbase2?.bind(),this.imageBackbase2?.draw(0,0),this.sidebarInterfaceId===-1){if(this.tabInterfaceId[this.selectedTab]!==-1){if(this.selectedTab===7)this.imageRedstone1v?.draw(42,0);else if(this.selectedTab===8)this.imageRedstone2v?.draw(74,0);else if(this.selectedTab===9)this.imageRedstone2v?.draw(102,0);else if(this.selectedTab===10)this.imageRedstone3v?.draw(130,1);else if(this.selectedTab===11)this.imageRedstone2hv?.draw(173,0);else if(this.selectedTab===12)this.imageRedstone2hv?.draw(201,0);else if(this.selectedTab===13)this.imageRedstone1hv?.draw(229,0)}if(this.tabInterfaceId[8]!==-1&&(this.flashingTab!==8||this.loopCycle%20<10))this.imageSideicons[7]?.draw(74,2);if(this.tabInterfaceId[9]!==-1&&(this.flashingTab!==9||this.loopCycle%20<10))this.imageSideicons[8]?.draw(102,3);if(this.tabInterfaceId[10]!==-1&&(this.flashingTab!==10||this.loopCycle%20<10))this.imageSideicons[9]?.draw(137,4);if(this.tabInterfaceId[11]!==-1&&(this.flashingTab!==11||this.loopCycle%20<10))this.imageSideicons[10]?.draw(174,2);if(this.tabInterfaceId[12]!==-1&&(this.flashingTab!==12||this.loopCycle%20<10))this.imageSideicons[11]?.draw(201,2);if(this.tabInterfaceId[13]!==-1&&(this.flashingTab!==13||this.loopCycle%20<10))this.imageSideicons[12]?.draw(226,2)}this.areaBackbase2?.draw(496,466),this.areaViewport?.bind()}if(this.redrawPrivacySettings){if(this.redrawPrivacySettings=!1,this.areaBackbase1?.bind(),this.imageBackbase1?.draw(0,0),this.fontPlain12?.drawStringTaggableCenter(55,28,"Public chat",16777215,!0),this.chatPublicMode===0)this.fontPlain12?.drawStringTaggableCenter(55,41,"On",65280,!0);if(this.chatPublicMode===1)this.fontPlain12?.drawStringTaggableCenter(55,41,"Friends",16776960,!0);if(this.chatPublicMode===2)this.fontPlain12?.drawStringTaggableCenter(55,41,"Off",16711680,!0);if(this.chatPublicMode===3)this.fontPlain12?.drawStringTaggableCenter(55,41,"Hide",65535,!0);if(this.fontPlain12?.drawStringTaggableCenter(184,28,"Private chat",16777215,!0),this.chatPrivateMode===0)this.fontPlain12?.drawStringTaggableCenter(184,41,"On",65280,!0);if(this.chatPrivateMode===1)this.fontPlain12?.drawStringTaggableCenter(184,41,"Friends",16776960,!0);if(this.chatPrivateMode===2)this.fontPlain12?.drawStringTaggableCenter(184,41,"Off",16711680,!0);if(this.fontPlain12?.drawStringTaggableCenter(324,28,"Trade/duel",16777215,!0),this.chatTradeMode===0)this.fontPlain12?.drawStringTaggableCenter(324,41,"On",65280,!0);if(this.chatTradeMode===1)this.fontPlain12?.drawStringTaggableCenter(324,41,"Friends",16776960,!0);if(this.chatTradeMode===2)this.fontPlain12?.drawStringTaggableCenter(324,41,"Off",16711680,!0);this.fontPlain12?.drawStringTaggableCenter(458,33,"Report abuse",16777215,!0),this.areaBackbase1?.draw(0,453),this.areaViewport?.bind()}this.sceneDelta=0}drawScene(){if(this.sceneCycle++,this.pushNpcs(!0),this.pushPlayers(),this.pushNpcs(!1),this.pushProjectiles(),this.pushSpotanims(),!this.cutscene){let L=this.orbitCameraPitch;if((this.cameraPitchClamp/256|0)>L)L=this.cameraPitchClamp/256|0;if(this.cameraModifierEnabled[4]&&this.cameraModifierWobbleScale[4]+128>L)L=this.cameraModifierWobbleScale[4]+128;let I=this.orbitCameraYaw+this.macroCameraAngle&2047;if(this.localPlayer)this.orbitCamera(this.orbitCameraX,this.getHeightmapY(this.currentLevel,this.localPlayer.x,this.localPlayer.z)-50,this.orbitCameraZ,I,L,L*3+600);if(v.cyclelogic2++,v.cyclelogic2>1802){v.cyclelogic2=0,this.out.p1isaac(223),this.out.p1(0);let N=this.out.pos;if(this.out.p2(29711),this.out.p1(70),this.out.p1(Math.random()*256|0),this.out.p1(242),this.out.p1(186),this.out.p1(39),this.out.p1(61),(Math.random()*2|0)===0)this.out.p1(13);if((Math.random()*2|0)===0)this.out.p2(57856);this.out.p2(Math.random()*65536|0),this.out.psize1(this.out.pos-N)}}let u;if(this.cutscene)u=this.getTopLevelCutscene();else u=this.getTopLevel();let _=this.cameraX,m=this.cameraY,R=this.cameraZ,b=this.cameraPitch,E=this.cameraYaw;for(let L=0;L<5;L++)if(this.cameraModifierEnabled[L]){let I=Math.random()*(this.cameraModifierJitter[L]*2+1)-this.cameraModifierJitter[L]+Math.sin(this.cameraModifierCycle[L]*(this.cameraModifierWobbleSpeed[L]/100))*this.cameraModifierWobbleScale[L]|0;if(L===0)this.cameraX+=I;else if(L===1)this.cameraY+=I;else if(L===2)this.cameraZ+=I;else if(L===3)this.cameraYaw=this.cameraYaw+I&2047;else if(L===4){if(this.cameraPitch+=I,this.cameraPitch<128)this.cameraPitch=128;if(this.cameraPitch>383)this.cameraPitch=383}}let O=h.cycle;$.checkHover=!0,$.pickedCount=0,$.mouseX=this.mouseX-4,$.mouseY=this.mouseY-4,K.clear(),this.scene?.draw(this.cameraX,this.cameraY,this.cameraZ,u,this.cameraYaw,this.cameraPitch,this.loopCycle),this.scene?.clearLocChanges(),this.draw2DEntityElements(),this.drawTileHint(),this.updateTextures(O),this.draw3DEntityElements(),this.areaViewport?.draw(4,4),this.cameraX=_,this.cameraY=m,this.cameraZ=R,this.cameraPitch=b,this.cameraYaw=E}pushPlayers(){if(!this.localPlayer)return;if(this.localPlayer.x>>7===this.flagSceneTileX&&this.localPlayer.z>>7===this.flagSceneTileZ)this.flagSceneTileX=0;for(let u=-1;u<this.playerCount;u++){let _,m;if(u===-1)_=this.localPlayer,m=33538048;else _=this.players[this.playerIds[u]],m=this.playerIds[u]<<14;if(!_||!_.isVisible())continue;if(_.lowMemory=!1,(v.lowMemory&&this.playerCount>50||this.playerCount>200)&&u!=-1&&_.secondarySeqId==_.readyanim)_.lowMemory=!0;let R=_.x>>7,b=_.z>>7;if(R<0||R>=104||b<0||b>=104)continue;if(!_.locModel||this.loopCycle<_.locStartCycle||this.loopCycle>=_.locStopCycle){if((_.x&127)===64&&(_.z&127)===64){if(this.tileLastOccupiedCycle[R][b]==this.sceneCycle&&u!=-1)continue;this.tileLastOccupiedCycle[R][b]=this.sceneCycle}_.y=this.getHeightmapY(this.currentLevel,_.x,_.z),this.scene?.changeLoc(this.currentLevel,_.x,_.y,_.z,_,m,_.yaw,60,_.needsForwardDrawPadding)}else _.lowMemory=!1,_.y=this.getHeightmapY(this.currentLevel,_.x,_.z),this.scene?.changeLoc2(this.currentLevel,_.x,_.y,_.z,_.minTileX,_.minTileZ,_.maxTileX,_.maxTileZ,_,m,_.yaw)}}pushNpcs(u){for(let _=0;_<this.npcCount;_++){let m=this.npcs[this.npcIds[_]],R=(this.npcIds[_]<<14)+536870912|0;if(!m||!m.isVisible()||m.type?.alwaysontop!==u)continue;let b=m.x>>7,E=m.z>>7;if(b<0||b>=104||E<0||E>=104)continue;if(m.size===1&&(m.x&127)===64&&(m.z&127)===64){if(this.tileLastOccupiedCycle[b][E]===this.sceneCycle)continue;this.tileLastOccupiedCycle[b][E]=this.sceneCycle}this.scene?.changeLoc(this.currentLevel,m.x,this.getHeightmapY(this.currentLevel,m.x,m.z),m.z,m,R,m.yaw,(m.size-1)*64+60,m.needsForwardDrawPadding)}}pushProjectiles(){for(let u=this.projectiles.head();u;u=this.projectiles.next())if(u.projLevel!==this.currentLevel||this.loopCycle>u.lastCycle)u.unlink();else if(this.loopCycle>=u.startCycle){if(u.projTarget>0){let _=this.npcs[u.projTarget-1];if(_)u.updateVelocity(_.x,this.getHeightmapY(u.projLevel,_.x,_.z)-u.projOffsetY,_.z,this.loopCycle)}if(u.projTarget<0){let _=-u.projTarget-1,m;if(_===this.localPid)m=this.localPlayer;else m=this.players[_];if(m)u.updateVelocity(m.x,this.getHeightmapY(u.projLevel,m.x,m.z)-u.projOffsetY,m.z,this.loopCycle)}u.update(this.sceneDelta),this.scene?.changeLoc(this.currentLevel,u.x|0,u.y|0,u.z|0,u,-1,u.yaw,60,!1)}}pushSpotanims(){for(let u=this.spotanims.head();u;u=this.spotanims.next())if(u.spotLevel!==this.currentLevel||u.seqComplete)u.unlink();else if(this.loopCycle>=u.startCycle)if(u.update(this.sceneDelta),u.seqComplete)u.unlink();else this.scene?.changeLoc(u.spotLevel,u.x,u.y,u.z,u,-1,0,60,!1)}orbitCamera(u,_,m,R,b,E){let O=2048-b&2047,L=2048-R&2047,I=0,N=0,H=E,G,T,q;if(O!==0)G=h.sinTable[O],T=h.cosTable[O],q=N*T-E*G>>16,H=N*G+E*T>>16,N=q;if(L!==0)G=h.sinTable[L],T=h.cosTable[L],q=H*G+I*T>>16,H=H*T-I*G>>16,I=q;this.cameraX=u-I,this.cameraY=_-N,this.cameraZ=m-H,this.cameraPitch=b,this.cameraYaw=R}getTopLevelCutscene(){if(!this.levelTileFlags)return 0;return this.getHeightmapY(this.currentLevel,this.cameraX,this.cameraZ)-this.cameraY>=800||(this.levelTileFlags[this.currentLevel][this.cameraX>>7][this.cameraZ>>7]&4)===0?3:this.currentLevel}getTopLevel(){let u=3;if(this.cameraPitch<310&&this.localPlayer){let _=this.cameraX>>7,m=this.cameraZ>>7,R=this.localPlayer.x>>7,b=this.localPlayer.z>>7;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][_][m]&4)!==0)u=this.currentLevel;let E;if(R>_)E=R-_;else E=_-R;let O;if(b>m)O=b-m;else O=m-b;if(E>O){let L=O*65536/E|0,I=32768;while(_!==R){if(_<R)_++;else if(_>R)_--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][_][m]&4)!==0)u=this.currentLevel;if(I+=L,I>=65536){if(I-=65536,m<b)m++;else if(m>b)m--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][_][m]&4)!==0)u=this.currentLevel}}}else{let L=E*65536/O|0,I=32768;while(m!==b){if(m<b)m++;else if(m>b)m--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][_][m]&4)!==0)u=this.currentLevel;if(I+=L,I>=65536){if(I-=65536,_<R)_++;else if(_>R)_--;if(this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][_][m]&4)!==0)u=this.currentLevel}}}}if(this.localPlayer&&this.levelTileFlags&&(this.levelTileFlags[this.currentLevel][this.localPlayer.x>>7][this.localPlayer.z>>7]&4)!==0)u=this.currentLevel;return u}draw2DEntityElements(){this.chatCount=0;for(let u=-1;u<this.playerCount+this.npcCount;u++){let _=null;if(u===-1)_=this.localPlayer;else if(u<this.playerCount)_=this.players[this.playerIds[u]];else _=this.npcs[this.npcIds[u-this.playerCount]];if(!_||!_.isVisible())continue;if(u>=this.playerCount){let m=_.type;if(m&&m.headicon>=0&&m.headicon<this.imageHeadicon.length){if(this.projectFromEntity(_,_.height+15),this.projectX>-1)this.imageHeadicon[m.headicon]?.draw(this.projectX-12,this.projectY-30)}if(this.hintType===1&&this.hintNpc===this.npcIds[u-this.playerCount]&&this.loopCycle%20<10){if(this.projectFromEntity(_,_.height+15),this.projectX>-1)this.imageHeadicon[2]?.draw(this.projectX-12,this.projectY-28)}}else{let m=30,R=_;if(R.headicons!==0){if(this.projectFromEntity(_,_.height+15),this.projectX>-1){for(let b=0;b<8;b++)if((R.headicons&1<<b)!==0)this.imageHeadicon[b]?.draw(this.projectX-12,this.projectY-m),m-=25}}if(u>=0&&this.hintType===10&&this.hintPlayer===this.playerIds[u]){if(this.projectFromEntity(_,_.height+15),this.projectX>-1)this.imageHeadicon[7]?.draw(this.projectX-12,this.projectY-m)}}if(_.chatMessage&&(u>=this.playerCount||this.chatPublicMode===0||this.chatPublicMode===3||this.chatPublicMode===1&&this.isFriend(_.name))){if(this.projectFromEntity(_,_.height),this.projectX>-1&&this.chatCount<50&&this.fontBold12){if(this.chatWidth[this.chatCount]=this.fontBold12.stringWidth(_.chatMessage)/2|0,this.chatHeight[this.chatCount]=this.fontBold12.height2d,this.chatX[this.chatCount]=this.projectX,this.chatY[this.chatCount]=this.projectY,this.chatColors[this.chatCount]=_.chatColour,this.chatEffect[this.chatCount]=_.chatEffect,this.chatTimers[this.chatCount]=_.chatTimer,this.chats[this.chatCount++]=_.chatMessage,this.chatEffects===0&&_.chatEffect===1)this.chatHeight[this.chatCount]+=10,this.chatY[this.chatCount]+=5;if(this.chatEffects===0&&_.chatEffect===2)this.chatWidth[this.chatCount]=60}}if(_.combatCycle>this.loopCycle+100){if(this.projectFromEntity(_,_.height+15),this.projectX>-1){let m=_.health*30/_.totalHealth|0;if(m>30)m=30;K.fillRect2d(this.projectX-15,this.projectY-3,m,5,65280),K.fillRect2d(this.projectX-15+m,this.projectY-3,30-m,5,16711680)}}for(let m=0;m<4;++m)if(_.damageCycles[m]>this.loopCycle){if(this.projectFromEntity(_,_.height/2|0),this.projectX<=-1)continue;if(m==1)this.projectY-=20;else if(m==2)this.projectX-=15,this.projectY-=10;else if(m==3)this.projectX+=15,this.projectY-=10;this.imageHitmarks[_.damageTypes[m]]?.draw(this.projectX-12,this.projectY-12),this.fontPlain11?.drawStringCenter(this.projectX,this.projectY+4,_.damageValues[m].toString(),0),this.fontPlain11?.drawStringCenter(this.projectX-1,this.projectY+3,_.damageValues[m].toString(),16777215)}}for(let u=0;u<this.chatCount;u++){let _=this.chatX[u],m=this.chatY[u],R=this.chatWidth[u],b=this.chatHeight[u],E=!0;while(E){E=!1;for(let L=0;L<u;L++)if(m+2>this.chatY[L]-this.chatHeight[L]&&m-b<this.chatY[L]+2&&_-R<this.chatX[L]+this.chatWidth[L]&&_+R>this.chatX[L]-this.chatWidth[L]&&this.chatY[L]-this.chatHeight[L]<m)m=this.chatY[L]-this.chatHeight[L],E=!0}this.projectX=this.chatX[u],this.projectY=this.chatY[u]=m;let O=this.chats[u];if(this.chatEffects===0){let L=16776960;if(this.chatColors[u]<6)L=v.CHAT_COLORS[this.chatColors[u]];else if(this.chatColors[u]===6)L=this.sceneCycle%20<10?16711680:16776960;else if(this.chatColors[u]===7)L=this.sceneCycle%20<10?255:65535;else if(this.chatColors[u]===8)L=this.sceneCycle%20<10?45056:8454016;else if(this.chatColors[u]===9){let I=150-this.chatTimers[u];if(I<50)L=I*1280+16711680;else if(I<100)L=16776960-(I-50)*327680;else if(I<150)L=(I-100)*5+65280}else if(this.chatColors[u]===10){let I=150-this.chatTimers[u];if(I<50)L=I*5+16711680;else if(I<100)L=16711935-(I-50)*327680;else if(I<150)L=(I-100)*327680+255-(I-100)*5}if(this.chatColors[u]===11){let I=150-this.chatTimers[u];if(I<50)L=16777215-I*327685;else if(I<100)L=(I-50)*327685+65280;else if(I<150)L=16777215-(I-100)*327680}if(this.chatEffect[u]===0)this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,O,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,O,L);else if(this.chatEffect[u]===1)this.fontBold12?.drawCenteredWave(this.projectX,this.projectY+1,O,0,this.sceneCycle),this.fontBold12?.drawCenteredWave(this.projectX,this.projectY,O,L,this.sceneCycle);else if(this.chatEffect[u]===2){let I=this.fontBold12?.stringWidth(O)??0,N=(150-this.chatTimers[u])*(I+100)/150;K.setBounds(this.projectX-50,0,this.projectX+50,334),this.fontBold12?.drawString(this.projectX+50-N,this.projectY+1,O,0),this.fontBold12?.drawString(this.projectX+50-N,this.projectY,O,L),K.resetBounds()}}else this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,O,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,O,16776960)}}drawTileHint(){if(this.hintType!==2||!this.imageHeadicon[2])return;if(this.projectFromGround((this.hintTileX-this.sceneBaseTileX<<7)+this.hintOffsetX,this.hintHeight*2,(this.hintTileZ-this.sceneBaseTileZ<<7)+this.hintOffsetZ),this.projectX>-1&&this.loopCycle%20<10)this.imageHeadicon[2].draw(this.projectX-12,this.projectY-28)}projectFromEntity(u,_){this.projectFromGround(u.x,_,u.z)}projectFromGround(u,_,m){if(u<128||m<128||u>13056||m>13056){this.projectX=-1,this.projectY=-1;return}let R=this.getHeightmapY(this.currentLevel,u,m)-_;this.project(u,R,m)}project(u,_,m){let R=u-this.cameraX,b=_-this.cameraY,E=m-this.cameraZ,O=h.sinTable[this.cameraPitch],L=h.cosTable[this.cameraPitch],I=h.sinTable[this.cameraYaw],N=h.cosTable[this.cameraYaw],H=E*I+R*N>>16;if(E=E*N-R*I>>16,R=H,H=b*L-E*O>>16,E=b*O+E*L>>16,b=H,E>=50)this.projectX=h.centerX+((R<<9)/E|0),this.projectY=h.centerY+((b<<9)/E|0);else this.projectX=-1,this.projectY=-1}getHeightmapY(u,_,m){if(!this.levelHeightmap)return 0;let R=_>>7,b=m>>7;if(R<0||b<0||R>103||b>103)return 0;let E=u;if(u<3&&this.levelTileFlags&&(this.levelTileFlags[1][R][b]&2)===2)E=u+1;let O=_&127,L=m&127,I=this.levelHeightmap[E][R][b]*(128-O)+this.levelHeightmap[E][R+1][b]*O>>7,N=this.levelHeightmap[E][R][b+1]*(128-O)+this.levelHeightmap[E][R+1][b+1]*O>>7;return I*(128-L)+N*L>>7}updateTextures(u){if(!v.lowMemory){if(h.textureCycle[17]>=u){let _=h.textures[17];if(!_)return;let m=_.width2d*_.height2d-1,R=_.width2d*this.sceneDelta*2,b=_.pixels,E=this.textureBuffer;for(let O=0;O<=m;O++)E[O]=b[O-R&m];_.pixels=E,this.textureBuffer=b,h.pushTexture(17)}if(h.textureCycle[24]>=u){let _=h.textures[24];if(!_)return;let m=_.width2d*_.height2d-1,R=_.width2d*this.sceneDelta*2,b=_.pixels,E=this.textureBuffer;for(let O=0;O<=m;O++)E[O]=b[O-R&m];_.pixels=E,this.textureBuffer=b,h.pushTexture(24)}}}draw3DEntityElements(){if(this.drawPrivateMessages(),this.crossMode===1)this.imageCrosses[this.crossCycle/100|0]?.draw(this.crossX-8-4,this.crossY-8-4);else if(this.crossMode===2)this.imageCrosses[(this.crossCycle/100|0)+4]?.draw(this.crossX-8-4,this.crossY-8-4);if(this.viewportOverlayInterfaceId!==-1)this.updateInterfaceAnimation(this.viewportOverlayInterfaceId,this.sceneDelta),this.drawInterface(g.types[this.viewportOverlayInterfaceId],0,0,0);if(this.field1264>0){let u=302-(Math.abs(Math.sin(this.field1264/10)*10)|0);for(let _=0;_<30;_++){let m=(30-_)*16;K.drawHorizontalLineAlpha(256-m/2,u+_,16776960,m,this.field1264)}}if(this.viewportInterfaceId!==-1)this.updateInterfaceAnimation(this.viewportInterfaceId,this.sceneDelta),this.drawInterface(g.types[this.viewportInterfaceId],0,0,0);if(this.updateWorldLocation(),!this.menuVisible)this.handleInput(),this.drawTooltip();else if(this.menuArea===0)this.drawMenu();if(this.inMultizone===1)if(this.wildernessLevel>0||this.worldLocationState===1)this.imageHeadicon[1]?.draw(472,258);else this.imageHeadicon[1]?.draw(472,296);if(this.wildernessLevel>0)this.imageHeadicon[0]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Level: "+this.wildernessLevel,16776960);if(this.worldLocationState===1)this.imageHeadicon[6]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Arena",16776960);if(this.displayFps){let u=507,_=20,m=16776960;if(this.fps<15)m=16711680;this.fontPlain12?.drawStringRight(u,_,"Fps:"+this.fps,m),_+=15;let R=-1;if(typeof window.performance.memory<"u")R=window.performance.memory.usedJSHeapSize/1024|0;if(R!==-1)this.fontPlain12?.drawStringRight(u,_,"Mem:"+R+"k",16776960)}if(this.systemUpdateTimer!==0){let u=this.systemUpdateTimer/50|0,_=u/60|0;if(u%=60,u<10)this.fontPlain12?.drawString(4,329,"System update in: "+_+":0"+u,16776960);else this.fontPlain12?.drawString(4,329,"System update in: "+_+":"+u,16776960)}}drawPrivateMessages(){if(this.splitPrivateChat===0)return;let u=this.fontPlain12,_=0;if(this.systemUpdateTimer!==0)_=1;for(let m=0;m<100;m++){if(!this.messageText[m])continue;let R=this.messageType[m],b=this.messageSender[m],E=0;if(b&&b.startsWith("@cr1@"))b=b.substring(5),E=1;else if(b&&b.startsWith("@cr2@"))b=b.substring(5),E=2;if((R==3||R==7)&&(R==7||this.chatPrivateMode==0||this.chatPrivateMode==1&&this.isFriend(b))){let O=329-_*13,L=4;if(u?.drawString(4,O,"From",0),u?.drawString(4,O-1,"From",65535),L+=u?.stringWidth("From ")??0,E==1)this.imageModIcons[0].draw(L,O-12),L+=14;else if(E==2)this.imageModIcons[1].draw(L,O-12),L+=14;if(u?.drawString(L,O,b+": "+this.messageText[m],0),u?.drawString(L,O-1,b+": "+this.messageText[m],65535),_++,_>=5)return}else if(R===5&&this.chatPrivateMode<2){let O=329-_*13;if(u?.drawString(4,O,this.messageText[m],0),u?.drawString(4,O-1,this.messageText[m],65535),_++,_>=5)return}else if(R===6&&this.chatPrivateMode<2){let O=329-_*13;if(u?.drawString(4,O,"To "+b+": "+this.messageText[m],0),u?.drawString(4,O-1,"To "+b+": "+this.messageText[m],65535),_++,_>=5)return}}}updateWorldLocation(){if(!this.localPlayer)return;let u=(this.localPlayer.x>>7)+this.sceneBaseTileX,_=(this.localPlayer.z>>7)+this.sceneBaseTileZ;if(u>=2944&&u<3392&&_>=3520&&_<6400)this.wildernessLevel=((_-3520)/8|0)+1;else if(u>=2944&&u<3392&&_>=9920&&_<12800)this.wildernessLevel=((_-9920)/8|0)+1;else this.wildernessLevel=0;if(this.worldLocationState=0,u>=3328&&u<3392&&_>=3200&&_<3264){let m=u&63,R=_&63;if(m>=4&&m<=29&&R>=44&&R<=58)this.worldLocationState=1;else if(m>=36&&m<=61&&R>=44&&R<=58)this.worldLocationState=1;else if(m>=4&&m<=29&&R>=25&&R<=39)this.worldLocationState=1;else if(m>=36&&m<=61&&R>=25&&R<=39)this.worldLocationState=1;else if(m>=4&&m<=29&&R>=6&&R<=20)this.worldLocationState=1;else if(m>=36&&m<=61&&R>=6&&R<=20)this.worldLocationState=1}if(this.worldLocationState===0&&u>=3328&&u<=3393&&_>=3203&&_<=3325)this.worldLocationState=2;if(this.overrideChat=0,u>=3053&&u<=3156&&_>=3056&&_<=3136)this.overrideChat=1;else if(u>=3072&&u<=3118&&_>=9492&&_<=9535)this.overrideChat=1;if(this.overrideChat===1&&u>=3139&&u<=3199&&_>=3008&&_<=3062)this.overrideChat=0}drawTooltip(){if(this.menuSize<2&&this.objSelected===0&&this.spellSelected===0)return;let u;if(this.objSelected===1&&this.menuSize<2)u="Use "+this.objSelectedName+" with...";else if(this.spellSelected===1&&this.menuSize<2)u=this.spellCaption+"...";else u=this.menuOption[this.menuSize-1];if(this.menuSize>2)u=u+"@whi@ / "+(this.menuSize-2)+" more options";this.fontBold12?.drawStringTooltip(4,15,u,16777215,!0,this.loopCycle/1000|0)}drawMenu(){let u=this.menuX,_=this.menuY,m=this.menuWidth,R=this.menuHeight,b=6116423;K.fillRect2d(u,_,m,R,b),K.fillRect2d(u+1,_+1,m-2,16,0),K.drawRect(u+1,_+18,m-2,R-19,0),this.fontBold12?.drawString(u+3,_+14,"Choose Option",b);let E=this.mouseX,O=this.mouseY;if(this.menuArea===0)E-=4,O-=4;else if(this.menuArea===1)E-=553,O-=205;else if(this.menuArea===2)E-=17,O-=357;for(let L=0;L<this.menuSize;L++){let I=_+(this.menuSize-1-L)*15+31,N=16777215;if(E>u&&E<u+m&&O>I-13&&O<I+3)N=16776960;this.fontBold12?.drawStringTaggable(u+3,I,this.menuOption[L],N,!0)}}drawMinimapLoc(u,_,m,R,b){if(!this.scene||!this.imageMinimap)return;let E=this.scene.getWallTypecode(m,u,_);if(E!==0){let O=this.scene.getInfo(m,u,_,E),L=O>>6&3,I=O&31,N=R;if(E>0)N=b;let H=this.imageMinimap.pixels,G=u*4+(103-_)*512*4+24624,T=E>>14&32767,q=m0.get(T);if(q.mapscene===-1){if(I===P.WALL_STRAIGHT.id||I===P.WALL_L.id){if(L===0)H[G]=N,H[G+512]=N,H[G+1024]=N,H[G+1536]=N;else if(L===1)H[G]=N,H[G+1]=N,H[G+2]=N,H[G+3]=N;else if(L===2)H[G+3]=N,H[G+3+512]=N,H[G+3+1024]=N,H[G+3+1536]=N;else if(L===3)H[G+1536]=N,H[G+1536+1]=N,H[G+1536+2]=N,H[G+1536+3]=N}if(I===P.WALL_SQUARE_CORNER.id){if(L===0)H[G]=N;else if(L===1)H[G+3]=N;else if(L===2)H[G+3+1536]=N;else if(L===3)H[G+1536]=N}if(I===P.WALL_L.id){if(L===3)H[G]=N,H[G+512]=N,H[G+1024]=N,H[G+1536]=N;else if(L===0)H[G]=N,H[G+1]=N,H[G+2]=N,H[G+3]=N;else if(L===1)H[G+3]=N,H[G+3+512]=N,H[G+3+1024]=N,H[G+3+1536]=N;else if(L===2)H[G+1536]=N,H[G+1536+1]=N,H[G+1536+2]=N,H[G+1536+3]=N}}else{let Q=this.imageMapscene[q.mapscene];if(Q){let n=(q.width*4-Q.width2d)/2|0,J=(q.length*4-Q.height2d)/2|0;Q.draw(u*4+48+n,(104-_-q.length)*4+J+48)}}}if(E=this.scene.getLocTypecode(m,u,_),E!==0){let O=this.scene.getInfo(m,u,_,E),L=O>>6&3,I=O&31,N=E>>14&32767,H=m0.get(N);if(H.mapscene===-1){if(I===P.WALL_DIAGONAL.id){let G=15658734;if(E>0)G=15597568;let T=this.imageMinimap.pixels,q=u*4+(104-1-_)*512*4+24624;if(L===0||L===2)T[q+1536]=G,T[q+1024+1]=G,T[q+512+2]=G,T[q+3]=G;else T[q]=G,T[q+512+1]=G,T[q+1024+2]=G,T[q+1536+3]=G}}else{let G=this.imageMapscene[H.mapscene];if(G){let T=(H.width*4-G.width2d)/2|0,q=(H.length*4-G.height2d)/2|0;G.draw(u*4+48+T,(104-_-H.length)*4+q+48)}}}if(E=this.scene.getGroundDecorTypecode(m,u,_),E!==0){let O=E>>14&32767,L=m0.get(O);if(L.mapscene!==-1){let I=this.imageMapscene[L.mapscene];if(I){let N=(L.width*4-I.width2d)/2|0,H=(L.length*4-I.height2d)/2|0;I.draw(u*4+48+N,(104-_-L.length)*4+H+48)}}}}interactWithLoc(u,_,m,R){if(!this.localPlayer||!this.scene)return!1;let b=R>>14&32767,E=this.scene.getInfo(this.currentLevel,_,m,R);if(E===-1)return!1;let O=E&31,L=E>>6&3;if(O===P.CENTREPIECE_STRAIGHT.id||O===P.CENTREPIECE_DIAGONAL.id||O===P.GROUND_DECOR.id){let I=m0.get(b),N,H;if(L===0||L===2)N=I.width,H=I.length;else N=I.length,H=I.width;let G=I.forceapproach;if(L!==0)G=(G<<L&15)+(G>>4-L);this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],_,m,2,N,H,0,0,G,!1)}else this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],_,m,2,0,0,L,O+1,0,!1);return this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(u),this.out.p2(_+this.sceneBaseTileX),this.out.p2(m+this.sceneBaseTileZ),this.out.p2(b),!0}tryMove(u,_,m,R,b,E,O,L,I,N,H){let G=this.levelCollisionMap[this.currentLevel];if(!G)return!1;let T=104,q=104;for(let Z=0;Z<T;Z++)for(let D=0;D<q;D++){let Y=e.index(Z,D);this.bfsDirection[Y]=0,this.bfsCost[Y]=99999999}let Q=u,n=_,J=e.index(u,_);this.bfsDirection[J]=99,this.bfsCost[J]=0;let U=0,w=0;this.bfsStepX[U]=u,this.bfsStepZ[U++]=_;let k=!1,V=this.bfsStepX.length,j=G.flags;while(w!==U){if(Q=this.bfsStepX[w],n=this.bfsStepZ[w],w=(w+1)%V,Q===m&&n===R){k=!0;break}if(I!==P.WALL_STRAIGHT.id){if((I<P.WALLDECOR_STRAIGHT_OFFSET.id||I===P.CENTREPIECE_STRAIGHT.id)&&G.reachedWall(Q,n,m,R,I-1,L)){k=!0;break}if(I<P.CENTREPIECE_STRAIGHT.id&&G.reachedWallDecoration(Q,n,m,R,I-1,L)){k=!0;break}}if(E!==0&&O!==0&&G.reachedLoc(Q,n,m,R,E,O,N)){k=!0;break}let Z=this.bfsCost[e.index(Q,n)]+1,D=e.index(Q-1,n);if(Q>0&&this.bfsDirection[D]===0&&(j[D]&2621704)===0)this.bfsStepX[U]=Q-1,this.bfsStepZ[U]=n,U=(U+1)%V,this.bfsDirection[D]=2,this.bfsCost[D]=Z;if(D=e.index(Q+1,n),Q<T-1&&this.bfsDirection[D]===0&&(j[D]&2621824)===0)this.bfsStepX[U]=Q+1,this.bfsStepZ[U]=n,U=(U+1)%V,this.bfsDirection[D]=8,this.bfsCost[D]=Z;if(D=e.index(Q,n-1),n>0&&this.bfsDirection[D]===0&&(j[D]&2621698)===0)this.bfsStepX[U]=Q,this.bfsStepZ[U]=n-1,U=(U+1)%V,this.bfsDirection[D]=1,this.bfsCost[D]=Z;if(D=e.index(Q,n+1),n<q-1&&this.bfsDirection[D]===0&&(j[D]&2621728)===0)this.bfsStepX[U]=Q,this.bfsStepZ[U]=n+1,U=(U+1)%V,this.bfsDirection[D]=4,this.bfsCost[D]=Z;if(D=e.index(Q-1,n-1),Q>0&&n>0&&this.bfsDirection[D]===0&&(j[D]&2621710)===0&&(j[e.index(Q-1,n)]&2621704)===0&&(j[e.index(Q,n-1)]&2621698)===0)this.bfsStepX[U]=Q-1,this.bfsStepZ[U]=n-1,U=(U+1)%V,this.bfsDirection[D]=3,this.bfsCost[D]=Z;if(D=e.index(Q+1,n-1),Q<T-1&&n>0&&this.bfsDirection[D]===0&&(j[D]&2621827)===0&&(j[e.index(Q+1,n)]&2621824)===0&&(j[e.index(Q,n-1)]&2621698)===0)this.bfsStepX[U]=Q+1,this.bfsStepZ[U]=n-1,U=(U+1)%V,this.bfsDirection[D]=9,this.bfsCost[D]=Z;if(D=e.index(Q-1,n+1),Q>0&&n<q-1&&this.bfsDirection[D]===0&&(j[D]&2621752)===0&&(j[e.index(Q-1,n)]&2621704)===0&&(j[e.index(Q,n+1)]&2621728)===0)this.bfsStepX[U]=Q-1,this.bfsStepZ[U]=n+1,U=(U+1)%V,this.bfsDirection[D]=6,this.bfsCost[D]=Z;if(D=e.index(Q+1,n+1),Q<T-1&&n<q-1&&this.bfsDirection[D]===0&&(j[D]&2621920)===0&&(j[e.index(Q+1,n)]&2621824)===0&&(j[e.index(Q,n+1)]&2621728)===0)this.bfsStepX[U]=Q+1,this.bfsStepZ[U]=n+1,U=(U+1)%V,this.bfsDirection[D]=12,this.bfsCost[D]=Z}if(this.tryMoveNearest=0,!k){if(H){let Z=100;for(let D=1;D<2;D++){for(let Y=m-D;Y<=m+D;Y++)for(let S=R-D;S<=R+D;S++){let s=e.index(Y,S);if(Y>=0&&S>=0&&Y<104&&S<104&&this.bfsCost[s]<Z)Z=this.bfsCost[s],Q=Y,n=S,this.tryMoveNearest=1,k=!0}if(k)break}}if(!k)return!1}w=0,this.bfsStepX[w]=Q,this.bfsStepZ[w++]=n;let X=this.bfsDirection[e.index(Q,n)],A=X;while(Q!==u||n!==_){if(A!==X)X=A,this.bfsStepX[w]=Q,this.bfsStepZ[w++]=n;if((A&2)!==0)Q++;else if((A&8)!==0)Q--;if((A&1)!==0)n++;else if((A&4)!==0)n--;A=this.bfsDirection[e.index(Q,n)]}if(w>0){V=Math.min(w,25),w--;let Z=this.bfsStepX[w],D=this.bfsStepZ[w];if(b===0)this.out.p1isaac(182),this.out.p1(V+V+3);else if(b===1)this.out.p1isaac(198),this.out.p1(V+V+3+14);else if(b===2)this.out.p1isaac(216),this.out.p1(V+V+3);if(this.actionKey[5]===1)this.out.p1(1);else this.out.p1(0);this.out.p2(Z+this.sceneBaseTileX),this.out.p2(D+this.sceneBaseTileZ),this.flagSceneTileX=this.bfsStepX[0],this.flagSceneTileZ=this.bfsStepZ[0];for(let Y=1;Y<V;Y++)w--,this.out.p1(this.bfsStepX[w]-Z),this.out.p1(this.bfsStepZ[w]-D);return!0}return b!==1}async readPacket(){if(!this.stream)return!1;try{let u=this.stream.available;if(u===0)return!1;if(this.ptype===-1){if(await this.stream.readBytes(this.in.data,0,1),this.ptype=this.in.data[0]&255,this.randomIn)this.ptype=this.ptype-this.randomIn.nextInt&255;this.psize=ru[this.ptype],u--}if(this.psize===-1){if(u<=0)return!1;await this.stream.readBytes(this.in.data,0,1),this.psize=this.in.data[0]&255,u--}if(this.psize===-2){if(u<=1)return!1;await this.stream.readBytes(this.in.data,0,2),this.in.pos=0,this.psize=this.in.g2(),u-=2}if(u<this.psize)return!1;if(this.in.pos=0,await this.stream.readBytes(this.in.data,0,this.psize),this.idleNetCycles=0,this.ptype2=this.ptype1,this.ptype1=this.ptype0,this.ptype0=this.ptype,this.ptype===203)return this.baseX=this.in.g1(),this.baseZ=this.in.g1(),this.ptype=-1,!0;if(this.ptype===69){let _=this.in.g2();return g.types[_].anim=this.in.g2(),this.ptype=-1,!0}if(this.ptype===236){let _=this.in.g2();if(this.resetInterfaceAnimation(_),this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.sidebarInterfaceId=_,this.redrawSidebar=!0,this.redrawSideicons=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===177){let _=this.in.g2();if(this.resetInterfaceAnimation(_),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=_,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===165){let _=E0.stop();if(_)this.out.p1isaac(19),this.out.p2(_.pos),this.out.pdata(_.data,_.pos,0),_.release();return this.ptype=-1,!0}if(this.ptype===60){let _=this.in.g2(),m=this.in.g2();return g.types[_].modelType=1,g.types[_].model=m,this.ptype=-1,!0}if(this.ptype===105)return this.getNpcPos(this.in,this.psize),this.ptype=-1,!0;if(this.ptype===15){this.baseX=this.in.g1(),this.baseZ=this.in.g1();while(this.in.pos<this.psize){let _=this.in.g1();this.readZonePacket(this.in,_)}return this.ptype=-1,!0}if(this.ptype===8)return this.selectedTab=this.in.g1(),this.redrawSidebar=!0,this.redrawSideicons=!0,this.ptype=-1,!0;if(this.ptype===152)return this.stickyChatInterfaceId=this.in.g2b(),this.redrawChatback=!0,this.ptype=-1,!0;if(this.ptype===207){let _=this.in.g8(),m=this.in.g4(),R=this.in.g1(),b=!1;for(let E=0;E<100;E++)if(this.messageTextIds[E]===m){b=!0;break}if(R<=1){for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===_){b=!0;break}}if(!b&&this.overrideChat===0)try{this.messageTextIds[this.privateMessageCount]=m,this.privateMessageCount=(this.privateMessageCount+1)%100;let E=v0.unpack(this.in,this.psize-13),O=D0.filter(E);if(R===2||R===3)this.addMessage(7,O,"@cr2@"+c.formatName(c.fromBase37(_)));else if(R===1)this.addMessage(7,O,"@cr1@"+c.formatName(c.fromBase37(_)));else this.addMessage(3,O,c.formatName(c.fromBase37(_)))}catch(E){}return this.ptype=-1,!0}if(this.ptype===175){let _=this.in.gjstr();if(_.endsWith(":tradereq:")){let m=_.substring(0,_.indexOf(":")),R=c.toBase37(m),b=!1;for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===R){b=!0;break}if(!b&&this.overrideChat===0)this.addMessage(4,"wishes to trade with you.",m)}else if(_.endsWith(":duelreq:")){let m=_.substring(0,_.indexOf(":")),R=c.toBase37(m),b=!1;for(let E=0;E<this.ignoreCount;E++)if(this.ignoreName37[E]===R){b=!0;break}if(!b&&this.overrideChat===0)this.addMessage(8,"wishes to duel with you.",m)}else this.addMessage(0,_,"");return this.ptype=-1,!0}if(this.ptype===181){this.ignoreCount=this.psize/8|0;for(let _=0;_<this.ignoreCount;_++)this.ignoreName37[_]=this.in.g8();return this.ptype=-1,!0}if(this.ptype===229){let _=this.in.g2(),m=this.in.g2();if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=_,this.sidebarInterfaceId=m,this.redrawSidebar=!0,this.redrawSideicons=!0,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===238){if(this.lastAddress=this.in.g4(),this.daysSinceLastLogin=this.in.g2(),this.daysSinceRecoveriesChanged=this.in.g1(),this.unreadMessages=this.in.g2(),this.warnMembersInNonMembers=this.in.g1(),this.lastAddress!==0&&this.viewportInterfaceId===-1){this.closeInterfaces();let _=650;if(this.daysSinceRecoveriesChanged!==201||this.warnMembersInNonMembers==1)_=655;this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let m=0;m<g.types.length;m++)if(g.types[m]&&g.types[m].clientCode===_){this.viewportInterfaceId=g.types[m].layer;break}}return this.ptype=-1,!0}if(this.ptype===161)return this.getPlayerPos(this.in,this.psize),this.awaitingSync=!1,this.ptype=-1,!0;if(this.ptype===243){if(this.hintType=this.in.g1(),this.hintType===1)this.hintNpc=this.in.g2();if(this.hintType>=2&&this.hintType<=6){if(this.hintType===2)this.hintOffsetX=64,this.hintOffsetZ=64;else if(this.hintType===3)this.hintOffsetX=0,this.hintOffsetZ=64;else if(this.hintType===4)this.hintOffsetX=128,this.hintOffsetZ=64;else if(this.hintType===5)this.hintOffsetX=64,this.hintOffsetZ=0;else if(this.hintType===6)this.hintOffsetX=64,this.hintOffsetZ=128;this.hintType=2,this.hintTileX=this.in.g2(),this.hintTileZ=this.in.g2(),this.hintHeight=this.in.g1()}if(this.hintType===10)this.hintPlayer=this.in.g2();return this.ptype=-1,!0}if(this.ptype===135){let _=this.in.g2(),m=this.in.g2(),R=m>>10&31,b=m>>5&31,E=m&31;return g.types[_].colour=(R<<19)+(b<<11)+(E<<3),this.ptype=-1,!0}if(this.ptype===56){if(this.showSocialInput=!1,this.chatbackInputOpen=!0,this.chatbackInput="",this.redrawChatback=!0,this.isMobile)J0.show();return this.ptype=-1,!0}if(this.ptype===7){let _=this.in.g2();if(this.resetInterfaceAnimation(_),this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;return this.chatInterfaceId=_,this.redrawChatback=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===151||this.ptype===188||this.ptype===190||this.ptype===141||this.ptype===187||this.ptype===13||this.ptype===94||this.ptype===71||this.ptype===198||this.ptype===119)return this.readZonePacket(this.in,this.ptype),this.ptype=-1,!0;if(this.ptype===96){let _=this.in.g2();if(_==65535)_=-1;if(this.nextMidiSong!=_&&this.midiActive&&!v.lowMemory)this.midiSong=_,this.midiFading=!0,this.onDemand?.request(2,this.midiSong);return this.nextMidiSong=_,this.nextMusicDelay=0,this.ptype=-1,!0}if(this.ptype===39){let _=this.in.g2(),m=this.in.g2();if(this.midiActive&&!v.lowMemory)this.midiSong=_,this.midiFading=!1,this.onDemand?.request(2,this.midiSong),this.nextMusicDelay=m;return this.ptype=-1,!0}if(this.ptype===225){let _=this.in.g2(),m=this.in.g1()===1;return g.types[_].hide=m,this.ptype=-1,!0}if(this.ptype===143){let _=this.in.g2(),m=g.types[_];if(m.invSlotObjId)for(let R=0;R<m.invSlotObjId.length;R++)m.invSlotObjId[R]=-1,m.invSlotObjId[R]=0;return this.ptype=-1,!0}if(this.ptype===26)return this.systemUpdateTimer=this.in.g2()*30,this.ptype=-1,!0;if(this.ptype===209){let _=this.in.g2(),m=this.in.g1(),R=this.in.g2();if(this.waveEnabled&&!v.lowMemory&&this.waveCount<50)this.waveIds[this.waveCount]=_,this.waveLoops[this.waveCount]=m,this.waveDelay[this.waveCount]=R+b0.delays[_],this.waveCount++;return this.ptype=-1,!0}if(this.ptype===109){let _=this.in.g8(),m=this.in.g1(),R=c.formatName(c.fromBase37(_));for(let E=0;E<this.friendCount;E++)if(_===this.friendName37[E]){if(this.friendWorld[E]!==m){if(this.friendWorld[E]=m,this.redrawSidebar=!0,m>0)this.addMessage(5,R+" has logged in.","");if(m===0)this.addMessage(5,R+" has logged out.","")}R=null;break}if(R&&this.friendCount<200)this.friendName37[this.friendCount]=_,this.friendName[this.friendCount]=R,this.friendWorld[this.friendCount]=m,this.friendCount++,this.redrawSidebar=!0;let b=!1;while(!b){b=!0;for(let E=0;E<this.friendCount-1;E++)if(this.friendWorld[E]!==v.nodeId&&this.friendWorld[E+1]===v.nodeId||this.friendWorld[E]===0&&this.friendWorld[E+1]!==0){let O=this.friendWorld[E];this.friendWorld[E]=this.friendWorld[E+1],this.friendWorld[E+1]=O;let L=this.friendName[E];this.friendName[E]=this.friendName[E+1],this.friendName[E+1]=L;let I=this.friendName37[E];this.friendName37[E]=this.friendName37[E+1],this.friendName37[E+1]=I,this.redrawSidebar=!0,b=!1}}return this.ptype=-1,!0}if(this.ptype===2)return this.chatPublicMode=this.in.g1(),this.chatPrivateMode=this.in.g1(),this.chatTradeMode=this.in.g1(),this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.ptype=-1,!0;if(this.ptype===36)return await this.logout(),this.ptype=-1,!1;if(this.ptype===28)return E0.setEnabled(),this.ptype=-1,!0;if(this.ptype===174){if(this.sidebarInterfaceId!==-1)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(this.chatInterfaceId!==-1)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.ptype=-1,!0}if(this.ptype===29){let _=this.in.g2(),m=this.in.g1();if(_===65535)_=-1;return this.tabInterfaceId[m]=_,this.redrawSidebar=!0,this.redrawSideicons=!0,this.ptype=-1,!0}if(this.ptype===132){if(this.flashingTab=this.in.g1(),this.flashingTab===this.selectedTab){if(this.flashingTab===3)this.selectedTab=1;else this.selectedTab=3;this.redrawSidebar=!0}return this.ptype=-1,!0}if(this.ptype===25){for(let _=0;_<this.varps.length;_++)if(this.varps[_]!==this.varCache[_])this.varps[_]=this.varCache[_],this.updateVarp(_),this.redrawSidebar=!0;return this.ptype=-1,!0}if(this.ptype===156){this.redrawSidebar=!0;let _=this.in.g2(),m=g.types[_],R=this.in.g1();if(m.invSlotObjId&&m.invSlotObjCount){for(let b=0;b<R;b++){m.invSlotObjId[b]=this.in.g2();let E=this.in.g1();if(E===255)E=this.in.g4();m.invSlotObjCount[b]=E}for(let b=R;b<m.invSlotObjId.length;b++)m.invSlotObjId[b]=0,m.invSlotObjCount[b]=0}else for(let b=0;b<R;b++)if(this.in.g2(),this.in.g1()===255)this.in.g4();return this.ptype=-1,!0}if(this.ptype===32){let _=this.in.g2(),m=this.in.gjstr();if(g.types[_].text=m,g.types[_].layer===this.tabInterfaceId[this.selectedTab])this.redrawSidebar=!0;return this.ptype=-1,!0}if(this.ptype===140){this.baseX=this.in.g1(),this.baseZ=this.in.g1();for(let _=this.baseX;_<this.baseX+8;_++)for(let m=this.baseZ;m<this.baseZ+8;m++)if(this.objStacks[this.currentLevel][_][m])this.objStacks[this.currentLevel][_][m]=null,this.sortObjStacks(_,m);for(let _=this.locChanges.head();_;_=this.locChanges.next())if(_.x>=this.baseX&&_.x<this.baseX+8&&_.z>=this.baseZ&&_.z<this.baseZ+8&&_.level===this.currentLevel)_.endTime=0;return this.ptype=-1,!0}if(this.ptype===76){let _=this.in.g2(),m=this.in.g2();return g.types[_].modelType=2,g.types[_].model=m,this.ptype=-1,!0}if(this.ptype===75){let _=this.in.g2(),m=this.in.g4();if(this.varCache[_]=m,this.varps[_]!==m){if(this.varps[_]=m,this.updateVarp(_),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.ptype=-1,!0}if(this.ptype===134){this.cutscene=!1;for(let _=0;_<5;_++)this.cameraModifierEnabled[_]=!1;return this.ptype=-1,!0}if(this.ptype===226){let _=this.in.g2(),m=this.in.g2(),R=g.types[_];if(typeof R<"u"&&R.type===0){if(m<0)m=0;if(m>R.scroll-R.height)m=R.scroll-R.height;R.scrollPosition=m}return this.ptype=-1,!0}if(this.ptype===103){let _=this.in.g1(),m=this.in.g1(),R=this.in.g1(),b=this.in.g1();return this.cameraModifierEnabled[_]=!0,this.cameraModifierJitter[_]=m,this.cameraModifierWobbleScale[_]=R,this.cameraModifierWobbleSpeed[_]=b,this.cameraModifierCycle[_]=0,this.ptype=-1,!0}if(this.ptype===123){if(this.cutscene=!0,this.cutsceneDstLocalTileX=this.in.g1(),this.cutsceneDstLocalTileZ=this.in.g1(),this.cutsceneDstHeight=this.in.g2(),this.cutsceneRotateSpeed=this.in.g1(),this.cutsceneRotateAcceleration=this.in.g1(),this.cutsceneRotateAcceleration>=100){let _=this.cutsceneDstLocalTileX*128+64,m=this.cutsceneDstLocalTileZ*128+64,R=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight,b=_-this.cameraX,E=R-this.cameraY,O=m-this.cameraZ,L=Math.sqrt(b*b+O*O)|0;if(this.cameraPitch=(Math.atan2(E,L)*325.949|0)&2047,this.cameraYaw=(Math.atan2(b,O)*-325.949|0)&2047,this.cameraPitch<128)this.cameraPitch=128;else if(this.cameraPitch>383)this.cameraPitch=383}return this.ptype=-1,!0}if(this.ptype===95){this.redrawSidebar=!0;let _=this.in.g2(),m=g.types[_];while(this.in.pos<this.psize){let R=this.in.g1(),b=this.in.g2(),E=this.in.g1();if(E===255)E=this.in.g4();if(m.invSlotObjId&&m.invSlotObjCount&&R>=0&&R<m.invSlotObjId.length)m.invSlotObjId[R]=b,m.invSlotObjCount[R]=E}return this.ptype=-1,!0}if(this.ptype===110){this.redrawSidebar=!0;let _=this.in.g1(),m=this.in.g4(),R=this.in.g1();this.skillExperience[_]=m,this.skillLevel[_]=R,this.skillBaseLevel[_]=1;for(let b=0;b<98;b++)if(m>=this.levelExperience[b])this.skillBaseLevel[_]=b+2;return this.ptype=-1,!0}if(this.ptype===66){let _=this.in.g2(),m=this.in.g2();if(this.sceneCenterZoneX===_&&this.sceneCenterZoneZ===m&&this.sceneState!==0)return this.ptype=-1,!0;if(this.sceneCenterZoneX=_,this.sceneCenterZoneZ=m,this.sceneBaseTileX=(this.sceneCenterZoneX-6)*8,this.sceneBaseTileZ=(this.sceneCenterZoneZ-6)*8,this.withinTutorialIsland=!1,(this.sceneCenterZoneX/8==48||this.sceneCenterZoneX/8==49)&&this.sceneCenterZoneZ/8==48)this.withinTutorialIsland=!0;else if(this.sceneCenterZoneX/8==48&&this.sceneCenterZoneZ/8==148)this.withinTutorialIsland=!0;this.sceneState=1,this.sceneLoadStartTime=performance.now(),this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(4,4);let R=0;for(let q=(this.sceneCenterZoneX-6)/8|0;q<=((this.sceneCenterZoneX+6)/8|0);q++)for(let Q=(this.sceneCenterZoneZ-6)/8|0;Q<=((this.sceneCenterZoneZ+6)/8|0);Q++)R++;this.sceneMapLandData=new r(R,null),this.sceneMapLocData=new r(R,null),this.sceneMapIndex=new Int32Array(R),this.sceneMapLandFile=Array(R),this.sceneMapLocFile=Array(R);let b=0;for(let q=(this.sceneCenterZoneX-6)/8|0;q<=((this.sceneCenterZoneX+6)/8|0);q++)for(let Q=(this.sceneCenterZoneZ-6)/8|0;Q<=((this.sceneCenterZoneZ+6)/8|0);Q++)if(this.sceneMapIndex[b]=(q<<8)+Q,this.withinTutorialIsland&&(Q==49||Q==149||Q==147||q==50||q==49&&Q==47))this.sceneMapLandFile[b]=-1,this.sceneMapLocFile[b]=-1,b++;else if(this.onDemand){let n=this.sceneMapLandFile[b]=this.onDemand.getMapFile(q,Q,0);if(n!=-1)this.onDemand.request(3,n);let J=this.sceneMapLocFile[b]=this.onDemand.getMapFile(q,Q,1);if(J!=-1)this.onDemand.request(3,J);b++}let E=this.sceneBaseTileX-this.scenePrevBaseTileX,O=this.sceneBaseTileZ-this.scenePrevBaseTileZ;this.scenePrevBaseTileX=this.sceneBaseTileX,this.scenePrevBaseTileZ=this.sceneBaseTileZ;for(let q=0;q<8192;q++){let Q=this.npcs[q];if(Q){for(let n=0;n<10;n++)Q.routeTileX[n]-=E,Q.routeTileZ[n]-=O;Q.x-=E*128,Q.z-=O*128}}for(let q=0;q<2048;q++){let Q=this.players[q];if(Q){for(let n=0;n<10;n++)Q.routeTileX[n]-=E,Q.routeTileZ[n]-=O;Q.x-=E*128,Q.z-=O*128}}this.awaitingSync=!0;let L=0,I=104,N=1;if(E<0)L=104-1,I=-1,N=-1;let H=0,G=104,T=1;if(O<0)H=104-1,G=-1,T=-1;for(let q=L;q!==I;q+=N)for(let Q=H;Q!==G;Q+=T){let n=q+E,J=Q+O;for(let U=0;U<4;U++)if(n>=0&&J>=0&&n<104&&J<104)this.objStacks[U][q][Q]=this.objStacks[U][n][J];else this.objStacks[U][q][Q]=null}for(let q=this.locChanges.head();q;q=this.locChanges.next())if(q.x-=E,q.z-=O,q.x<0||q.z<0||q.x>=104||q.z>=104)q.unlink();if(this.flagSceneTileX!==0)this.flagSceneTileX-=E,this.flagSceneTileZ-=O;return this.cutscene=!1,this.ptype=-1,!0}if(this.ptype==115){let _=this.in.g2b();return this.viewportOverlayInterfaceId=_,this.ptype=-1,!0}if(this.ptype===144){for(let _=0;_<this.players.length;_++){let m=this.players[_];if(!m)continue;m.primarySeqId=-1}for(let _=0;_<this.npcs.length;_++){let m=this.npcs[_];if(!m)continue;m.primarySeqId=-1}return this.ptype=-1,!0}if(this.ptype==108)return this.field1264=255,this.ptype=-1,!0;if(this.ptype===35)return this.inMultizone=this.in.g1(),this.ptype=-1,!0;if(this.ptype===70){if(this.selectedTab===12)this.redrawSidebar=!0;return this.runweight=this.in.g2b(),this.ptype=-1,!0}if(this.ptype===83){let _=this.in.g2();if(this.localPlayer)g.types[_].modelType=3,g.types[_].model=(this.localPlayer.appearance[8]<<6)+(this.localPlayer.appearance[0]<<12)+(this.localPlayer.colour[0]<<24)+(this.localPlayer.colour[4]<<18)+this.localPlayer.appearance[11];return this.ptype=-1,!0}if(this.ptype===153){let _=this.in.g2(),m=this.in.g2(),R=this.in.g2(),b=l.get(m);return g.types[_].modelType=4,g.types[_].model=m,g.types[_].xan=b.xan2d,g.types[_].yan=b.yan2d,g.types[_].zoom=b.zoom2d*100/R|0,this.ptype=-1,!0}if(this.ptype===86){if(this.cutscene=!0,this.cutsceneSrcLocalTileX=this.in.g1(),this.cutsceneSrcLocalTileZ=this.in.g1(),this.cutsceneSrcHeight=this.in.g2(),this.cutsceneMoveSpeed=this.in.g1(),this.cutsceneMoveAcceleration=this.in.g1(),this.cutsceneMoveAcceleration>=100)this.cameraX=this.cutsceneSrcLocalTileX*128+64,this.cameraZ=this.cutsceneSrcLocalTileZ*128+64,this.cameraY=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;return this.ptype=-1,!0}if(this.ptype===230){let _=this.in.g2(),m=this.in.g2b(),R=this.in.g2b(),b=g.types[_];return b.x=m,b.y=R,this.ptype=-1,!0}if(this.ptype===233)return this.flagSceneTileX=0,this.ptype=-1,!0;if(this.ptype===208){if(this.selectedTab===12)this.redrawSidebar=!0;return this.runenergy=this.in.g1(),this.ptype=-1,!0}if(this.ptype===49)return this.localPid=this.in.g2(),this.membersAccount=this.in.g1(),this.ptype=-1,!0;if(this.ptype===192){let _=this.in.g2(),m=this.in.g1b();if(this.varCache[_]=m,this.varps[_]!==m){if(this.varps[_]=m,this.updateVarp(_),this.redrawSidebar=!0,this.stickyChatInterfaceId!==-1)this.redrawChatback=!0}return this.ptype=-1,!0}await this.logout()}catch(u){let _=`T1 - ${this.ptype},${this.psize} - ${this.ptype1},${this.ptype2} - ${this.psize},${(this.localPlayer?.routeTileX[0]??0)+this.sceneBaseTileX},${(this.localPlayer?.routeTileZ[0]??0)+this.sceneBaseTileZ} -`;for(let m=0;m<this.psize&&m<50;m++)_+=this.in.data[m]+",";await this.logout()}return!0}readZonePacket(u,_){let m=u.g1(),R=this.baseX+(m>>4&7),b=this.baseZ+(m&7);if(_===119){let E=u.g1(),O=E>>2,L=E&3,I=P.of(O).layer,N=u.g2();if(R>=0&&b>=0&&R<104&&b<104)this.appendLoc(-1,N,L,I,b,O,this.currentLevel,R,0)}else if(_===198){let E=u.g1(),O=E>>2,L=E&3,I=P.of(O).layer;if(R>=0&&b>=0&&R<104&&b<104)this.appendLoc(-1,-1,L,I,b,O,this.currentLevel,R,0)}else if(_===71){let E=u.g1(),O=E>>2,L=E&3,I=P.of(O).layer,N=u.g2();if(R>=0&&b>=0&&R<104&&b<104&&this.scene&&this.levelHeightmap){let H=this.levelHeightmap[this.currentLevel][R][b],G=this.levelHeightmap[this.currentLevel][R+1][b],T=this.levelHeightmap[this.currentLevel][R+1][b+1],q=this.levelHeightmap[this.currentLevel][R][b+1];if(I==0){let Q=this.scene.getWall(this.currentLevel,R,b);if(Q){let n=Q.typecode>>14&32767;if(O==2)Q.model1=new u0(this.loopCycle,n,2,L+4,H,G,T,q,N,!1),Q.model2=new u0(this.loopCycle,n,2,L+1&3,H,G,T,q,N,!1);else Q.model1=new u0(this.loopCycle,n,O,L,H,G,T,q,N,!1)}}else if(I==1){let Q=this.scene.getDecor(this.currentLevel,b,R);if(Q)Q.model=new u0(this.loopCycle,Q.typecode>>14&32767,4,0,H,T,T,q,N,!1)}else if(I==2){let Q=this.scene.getLoc(this.currentLevel,R,b);if(O==11)O=10;if(Q)Q.model=new u0(this.loopCycle,Q.typecode>>14&32767,O,L,H,G,T,q,N,!1)}else if(I==3){let Q=this.scene.getGroundDecor(this.currentLevel,R,b);if(Q)Q.model=new u0(this.loopCycle,Q.typecode>>14&32767,22,L,H,G,T,q,N,!1)}}}else if(_===94){let E=u.g2(),O=u.g2();if(R>=0&&b>=0&&R<104&&b<104){let L=new l0(E,O);if(!this.objStacks[this.currentLevel][R][b])this.objStacks[this.currentLevel][R][b]=new $0;this.objStacks[this.currentLevel][R][b]?.push(L),this.sortObjStacks(R,b)}}else if(_===13){let E=u.g2();if(R>=0&&b>=0&&R<104&&b<104){let O=this.objStacks[this.currentLevel][R][b];if(O){for(let L=O.head();L;L=O.next())if(L.index===(E&32767)){L.unlink();break}if(!O.head())this.objStacks[this.currentLevel][R][b]=null;this.sortObjStacks(R,b)}}}else if(_===187){let E=R+u.g1b(),O=b+u.g1b(),L=u.g2b(),I=u.g2(),N=u.g1(),H=u.g1(),G=u.g2(),T=u.g2(),q=u.g1(),Q=u.g1();if(R>=0&&b>=0&&R<104&&b<104&&E>=0&&O>=0&&E<104&&O<104){R=R*128+64,b=b*128+64,E=E*128+64,O=O*128+64;let n=new qu(I,this.currentLevel,R,this.getHeightmapY(this.currentLevel,R,b)-N,b,G+this.loopCycle,T+this.loopCycle,q,Q,L,H);n.updateVelocity(E,this.getHeightmapY(this.currentLevel,E,O)-H,O,G+this.loopCycle),this.projectiles.push(n)}}else if(_===141){let E=u.g2(),O=u.g1(),L=u.g2();if(R>=0&&b>=0&&R<104&&b<104){R=R*128+64,b=b*128+64;let I=new $u(E,this.currentLevel,R,b,this.getHeightmapY(this.currentLevel,R,b)-O,this.loopCycle,L);this.spotanims.push(I)}}else if(_===190){let E=u.g2(),O=u.g2(),L=u.g2();if(R>=0&&b>=0&&R<104&&b<104&&L!==this.localPid){let I=new l0(E,O);if(!this.objStacks[this.currentLevel][R][b])this.objStacks[this.currentLevel][R][b]=new $0;this.objStacks[this.currentLevel][R][b]?.push(I),this.sortObjStacks(R,b)}}else if(_===188){let E=u.g1(),O=E>>2,L=E&3,I=P.of(O).layer,N=u.g2(),H=u.g2(),G=u.g2(),T=u.g2(),q=u.g1b(),Q=u.g1b(),n=u.g1b(),J=u.g1b(),U;if(T===this.localPid)U=this.localPlayer;else U=this.players[T];if(U&&this.levelHeightmap){let w=m0.get(N),k=this.levelHeightmap[this.currentLevel][R][b],V=this.levelHeightmap[this.currentLevel][R+1][b],j=this.levelHeightmap[this.currentLevel][R+1][b+1],X=this.levelHeightmap[this.currentLevel][R][b+1],A=w.getModel(O,L,k,V,j,X,-1);if(A){this.appendLoc(G+1,-1,0,I,b,0,this.currentLevel,R,H+1),U.locStartCycle=H+this.loopCycle,U.locStopCycle=G+this.loopCycle,U.locModel=A;let{width:Z,length:D}=w;if(L===1||L===3)Z=w.length,D=w.width;U.locOffsetX=R*128+Z*64,U.locOffsetZ=b*128+D*64,U.locOffsetY=this.getHeightmapY(this.currentLevel,U.locOffsetX,U.locOffsetZ);let Y;if(q>n)Y=q,q=n,n=Y;if(Q>J)Y=Q,Q=J,J=Y;U.minTileX=R+q,U.maxTileX=R+n,U.minTileZ=b+Q,U.maxTileZ=b+J}}}else if(_===151){let E=u.g2(),O=u.g2(),L=u.g2();if(R>=0&&b>=0&&R<104&&b<104){let I=this.objStacks[this.currentLevel][R][b];if(I){for(let N=I.head();N;N=I.next())if(N.index===(E&32767)&&N.count===O){N.count=L;break}this.sortObjStacks(R,b)}}}}appendLoc(u,_,m,R,b,E,O,L,I){let N=null;for(let H=this.locChanges.head();H;H=this.locChanges.next())if(H.level===this.currentLevel&&H.x===L&&H.z===b&&H.layer===R){N=H;break}if(!N)N=new Qu,N.level=O,N.layer=R,N.x=L,N.z=b,this.storeLoc(N),this.locChanges.push(N);N.newType=_,N.newShape=E,N.newAngle=m,N.startTime=I,N.endTime=u}storeLoc(u){if(!this.scene)return;let _=0,m=-1,R=0,b=0;if(u.layer===0)_=this.scene.getWallTypecode(u.level,u.x,u.z);else if(u.layer===1)_=this.scene.getDecorTypecode(u.level,u.z,u.x);else if(u.layer===2)_=this.scene.getLocTypecode(u.level,u.x,u.z);else if(u.layer===3)_=this.scene.getGroundDecorTypecode(u.level,u.x,u.z);if(_!==0){let E=this.scene.getInfo(u.level,u.x,u.z,_);m=_>>14&32767,R=E&31,b=E>>6}u.oldType=m,u.oldShape=R,u.oldAngle=b}addLoc(u,_,m,R,b,E,O){if(_<1||m<1||_>102||m>102)return;if(v.lowMemory&&u!==this.currentLevel)return;if(!this.scene)return;let L=0;if(O===0)L=this.scene.getWallTypecode(u,_,m);else if(O===1)L=this.scene.getDecorTypecode(u,m,_);else if(O===2)L=this.scene.getLocTypecode(u,_,m);else if(O===3)L=this.scene.getGroundDecorTypecode(u,_,m);if(L!==0){let I=this.scene.getInfo(u,_,m,L),N=L>>14&32767,H=I&31,G=I>>6;if(O===0){this.scene?.removeWall(u,_,m,1);let T=m0.get(N);if(T.blockwalk)this.levelCollisionMap[u]?.removeWall(_,m,H,G,T.blockrange)}else if(O===1)this.scene?.removeWallDecoration(u,_,m);else if(O===2){this.scene.removeLoc(u,_,m);let T=m0.get(N);if(_+T.width>104-1||m+T.width>104-1||_+T.length>104-1||m+T.length>104-1)return;if(T.blockwalk)this.levelCollisionMap[u]?.removeLoc(_,m,T.width,T.length,G,T.blockrange)}else if(O===3){this.scene?.removeGroundDecoration(u,_,m);let T=m0.get(N);if(T.blockwalk&&T.active)this.levelCollisionMap[u]?.removeFloor(_,m)}}if(R>=0){let I=u;if(this.levelTileFlags&&u<3&&(this.levelTileFlags[1][_][m]&2)===2)I=u+1;if(this.levelHeightmap)C.addLoc(this.loopCycle,u,_,m,this.scene,this.levelHeightmap,this.levelCollisionMap[u],R,E,b,I)}}sortObjStacks(u,_){let m=this.objStacks[this.currentLevel][u][_];if(!m){this.scene?.removeGroundObject(this.currentLevel,u,_);return}let R=-99999999,b=null;for(let I=m.head();I;I=m.next()){let N=l.get(I.index),H=N.cost;if(N.stackable)H*=I.count+1;if(H>R)R=H,b=I}if(!b)return;m.addHead(b);let E=null,O=null;for(let I=m.head();I;I=m.next()){if(I.index!==b.index&&E===null)E=I;if(I.index!==b.index&&E&&I.index!==E.index&&O===null)O=I}let L=u+(_<<7)+1610612736|0;this.scene?.addGroundObject(u,_,this.getHeightmapY(this.currentLevel,u*128+64,_*128+64),this.currentLevel,L,b,O,E)}getPlayerPos(u,_){this.entityRemovalCount=0,this.entityUpdateCount=0,this.getPlayerLocal(u),this.getPlayerOldVis(u),this.getPlayerNewVis(u,_),this.getPlayerExtended(u);for(let m=0;m<this.entityRemovalCount;m++){let R=this.entityRemovalIds[m],b=this.players[R];if(!b)continue;if(b.cycle!==this.loopCycle)this.players[R]=null}if(u.pos!==_)throw Error("eek");for(let m=0;m<this.playerCount;m++)if(!this.players[this.playerIds[m]])throw Error("eek")}getPlayerLocal(u){if(u.bits(),u.gBit(1)!==0){let m=u.gBit(2);if(m===0)this.entityUpdateIds[this.entityUpdateCount++]=2047;else if(m===1){let R=u.gBit(3);if(this.localPlayer?.step(!1,R),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(m===2){let R=u.gBit(3);this.localPlayer?.step(!0,R);let b=u.gBit(3);if(this.localPlayer?.step(!0,b),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(m===3){this.currentLevel=u.gBit(2);let R=u.gBit(7),b=u.gBit(7),E=u.gBit(1);if(this.localPlayer?.move(E===1,R,b),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=2047}}}getPlayerOldVis(u){let _=u.gBit(8);if(_<this.playerCount)for(let m=_;m<this.playerCount;m++)this.entityRemovalIds[this.entityRemovalCount++]=this.playerIds[m];if(_>this.playerCount)throw Error();this.playerCount=0;for(let m=0;m<_;m++){let R=this.playerIds[m],b=this.players[R];if(u.gBit(1)===0){if(this.playerIds[this.playerCount++]=R,b)b.cycle=this.loopCycle}else{let O=u.gBit(2);if(O===0){if(this.playerIds[this.playerCount++]=R,b)b.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=R}else if(O===1){if(this.playerIds[this.playerCount++]=R,b)b.cycle=this.loopCycle;let L=u.gBit(3);if(b?.step(!1,L),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=R}else if(O===2){if(this.playerIds[this.playerCount++]=R,b)b.cycle=this.loopCycle;let L=u.gBit(3);b?.step(!0,L);let I=u.gBit(3);if(b?.step(!0,I),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=R}else if(O===3)this.entityRemovalIds[this.entityRemovalCount++]=R}}}getPlayerNewVis(u,_){while(u.bitPos+10<_*8){let m=u.gBit(11);if(m===2047)break;if(!this.players[m]){this.players[m]=new T0;let I=this.playerAppearanceBuffer[m];if(I)this.players[m]?.read(I)}this.playerIds[this.playerCount++]=m;let R=this.players[m];if(R)R.cycle=this.loopCycle;let b=u.gBit(5);if(b>15)b-=32;let E=u.gBit(5);if(E>15)E-=32;let O=u.gBit(1);if(this.localPlayer)R?.move(O===1,this.localPlayer.routeTileX[0]+b,this.localPlayer.routeTileZ[0]+E);if(u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=m}u.bytes()}getPlayerExtended(u){for(let _=0;_<this.entityUpdateCount;_++){let m=this.entityUpdateIds[_],R=this.players[m];if(!R)continue;let b=u.g1();if((b&128)!==0)b+=u.g1()<<8;this.getPlayerExtendedInfo(R,m,b,u)}}getPlayerExtendedInfo(u,_,m,R){if((m&1)!==0){let b=R.g1(),E=new Uint8Array(b),O=new W(E);R.gdata(b,0,E),this.playerAppearanceBuffer[_]=O,u.read(O)}if((m&2)!==0){let b=R.g2();if(b===65535)b=-1;if(b===u.primarySeqId)u.primarySeqLoop=0;let E=R.g1();if(u.primarySeqId===b&&b!==-1){let O=o.types[b].duplicatebehavior;if(O==1)u.primarySeqFrame=0,u.primarySeqCycle=0,u.primarySeqDelay=E,u.primarySeqLoop=0;else if(O==2)u.primarySeqLoop=0}else if(b===-1||u.primarySeqId===-1||o.types[b].priority>o.types[u.primarySeqId].priority||o.types[u.primarySeqId].priority===0)u.primarySeqId=b,u.primarySeqFrame=0,u.primarySeqCycle=0,u.primarySeqDelay=E,u.primarySeqLoop=0,u.preanimRouteLength=u.routeLength}if((m&4)!==0){if(u.targetId=R.g2(),u.targetId===65535)u.targetId=-1}if((m&8)!==0){if(u.chatMessage=R.gjstr(),u.chatColour=0,u.chatEffect=0,u.chatTimer=150,u.name)this.addMessage(2,u.chatMessage,u.name)}if((m&16)!==0){let b=R.g1(),E=R.g1();u.hit(this.loopCycle,E,b),u.combatCycle=this.loopCycle+400,u.health=R.g1(),u.totalHealth=R.g1()}if((m&32)!==0)u.targetTileX=R.g2(),u.targetTileZ=R.g2();if((m&64)!==0){let b=R.g2(),E=R.g1(),O=R.g1(),L=R.pos;if(u.name&&u.visible){let I=c.toBase37(u.name),N=!1;if(E<=1){for(let H=0;H<this.ignoreCount;H++)if(this.ignoreName37[H]===I){N=!0;break}}if(!N&&this.overrideChat===0)try{let H=v0.unpack(R,O),G=D0.filter(H);if(u.chatMessage=G,u.chatColour=b>>8,u.chatEffect=b&255,u.chatTimer=150,E===2||E===3)this.addMessage(1,G,"@cr2@"+u.name);else if(E===1)this.addMessage(1,G,"@cr1@"+u.name);else this.addMessage(2,G,u.name)}catch(H){}}R.pos=L+O}if((m&256)!==0){u.spotanimId=R.g2();let b=R.g4();if(u.spotanimHeight=b>>16,u.spotanimLastCycle=this.loopCycle+(b&65535),u.spotanimFrame=0,u.spotanimCycle=0,u.spotanimLastCycle>this.loopCycle)u.spotanimFrame=-1;if(u.spotanimId===65535)u.spotanimId=-1}if((m&512)!==0)u.forceMoveStartSceneTileX=R.g1(),u.forceMoveStartSceneTileZ=R.g1(),u.forceMoveEndSceneTileX=R.g1(),u.forceMoveEndSceneTileZ=R.g1(),u.forceMoveEndCycle=R.g2()+this.loopCycle,u.forceMoveStartCycle=R.g2()+this.loopCycle,u.forceMoveFaceDirection=R.g1(),u.clearRoute();if((m&1024)!==0){let b=R.g1(),E=R.g1();u.hit(this.loopCycle,E,b),u.combatCycle=this.loopCycle+400,u.health=R.g1(),u.totalHealth=R.g1()}}getNpcPos(u,_){this.entityRemovalCount=0,this.entityUpdateCount=0,this.getNpcPosOldVis(u),this.getNpcPosNewVis(u,_),this.getNpcPosExtended(u);for(let m=0;m<this.entityRemovalCount;m++){let R=this.entityRemovalIds[m],b=this.npcs[R];if(!b)continue;if(b.cycle!==this.loopCycle)b.type=null,this.npcs[R]=null}if(u.pos!==_)throw Error("eek");for(let m=0;m<this.npcCount;m++)if(!this.npcs[this.npcIds[m]])throw Error("eek")}getNpcPosOldVis(u){u.bits();let _=u.gBit(8);if(_<this.npcCount)for(let m=_;m<this.npcCount;m++)this.entityRemovalIds[this.entityRemovalCount++]=this.npcIds[m];if(_>this.npcCount)throw Error("eek");this.npcCount=0;for(let m=0;m<_;m++){let R=this.npcIds[m],b=this.npcs[R];if(u.gBit(1)===0){if(this.npcIds[this.npcCount++]=R,b)b.cycle=this.loopCycle}else{let O=u.gBit(2);if(O===0){if(this.npcIds[this.npcCount++]=R,b)b.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=R}else if(O===1){if(this.npcIds[this.npcCount++]=R,b)b.cycle=this.loopCycle;let L=u.gBit(3);if(b?.step(!1,L),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=R}else if(O===2){if(this.npcIds[this.npcCount++]=R,b)b.cycle=this.loopCycle;let L=u.gBit(3);b?.step(!0,L);let I=u.gBit(3);if(b?.step(!0,I),u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=R}else if(O===3)this.entityRemovalIds[this.entityRemovalCount++]=R}}}getNpcPosNewVis(u,_){while(u.bitPos+21<_*8){let m=u.gBit(13);if(m===8191)break;if(!this.npcs[m])this.npcs[m]=new Tu;let R=this.npcs[m];if(this.npcIds[this.npcCount++]=m,R)R.cycle=this.loopCycle,R.type=j0.get(u.gBit(11)),R.size=R.type.size,R.walkanim=R.type.walkanim,R.walkanim_b=R.type.walkanim_b,R.walkanim_l=R.type.walkanim_r,R.walkanim_r=R.type.walkanim_l,R.readyanim=R.type.readyanim;else u.gBit(11);let b=u.gBit(5);if(b>15)b-=32;let E=u.gBit(5);if(E>15)E-=32;if(this.localPlayer)R?.move(!1,this.localPlayer.routeTileX[0]+b,this.localPlayer.routeTileZ[0]+E);if(u.gBit(1)===1)this.entityUpdateIds[this.entityUpdateCount++]=m}u.bytes()}getNpcPosExtended(u){for(let _=0;_<this.entityUpdateCount;_++){let m=this.entityUpdateIds[_],R=this.npcs[m];if(!R)continue;let b=u.g1();if((b&1)!==0){let E=u.g1(),O=u.g1();R.hit(this.loopCycle,O,E),R.combatCycle=this.loopCycle+400,R.health=u.g1(),R.totalHealth=u.g1()}if((b&2)!==0){let E=u.g2();if(E===65535)E=-1;if(E===R.primarySeqId)R.primarySeqLoop=0;let O=u.g1();if(R.primarySeqId===E&&E!==-1){let L=o.types[E].duplicatebehavior;if(L==1)R.primarySeqFrame=0,R.primarySeqCycle=0,R.primarySeqDelay=O,R.primarySeqLoop=0;else if(L==2)R.primarySeqLoop=0}else if(E===-1||R.primarySeqId===-1||o.types[E].priority>o.types[R.primarySeqId].priority||o.types[R.primarySeqId].priority===0)R.primarySeqId=E,R.primarySeqFrame=0,R.primarySeqCycle=0,R.primarySeqDelay=O,R.primarySeqLoop=0,R.preanimRouteLength=R.routeLength}if((b&4)!==0){if(R.targetId=u.g2(),R.targetId===65535)R.targetId=-1}if((b&8)!==0)R.chatMessage=u.gjstr(),R.chatTimer=100;if((b&16)!==0){let E=u.g1(),O=u.g1();R.hit(this.loopCycle,O,E),R.combatCycle=this.loopCycle+400,R.health=u.g1(),R.totalHealth=u.g1()}if((b&32)!==0)R.type=j0.get(u.g2()),R.walkanim=R.type.walkanim,R.walkanim_b=R.type.walkanim_b,R.walkanim_l=R.type.walkanim_r,R.walkanim_r=R.type.walkanim_l,R.readyanim=R.type.readyanim;if((b&64)!==0){R.spotanimId=u.g2();let E=u.g4();if(R.spotanimHeight=E>>16,R.spotanimLastCycle=this.loopCycle+(E&65535),R.spotanimFrame=0,R.spotanimCycle=0,R.spotanimLastCycle>this.loopCycle)R.spotanimFrame=-1;if(R.spotanimId===65535)R.spotanimId=-1}if((b&128)!==0)R.targetTileX=u.g2(),R.targetTileZ=u.g2()}}showContextMenu(){let u=0;if(this.fontBold12){u=this.fontBold12.stringWidth("Choose Option");let b;for(let E=0;E<this.menuSize;E++)if(b=this.fontBold12.stringWidth(this.menuOption[E]),b>u)u=b}u+=8;let _=this.menuSize*15+21,m,R;if(this.mouseClickX>4&&this.mouseClickY>4&&this.mouseClickX<516&&this.mouseClickY<338){if(m=this.mouseClickX-(u/2|0)-8,m+u>512)m=512-u;if(m<0)m=0;if(R=this.mouseClickY-11,R+_>334)R=334-_;if(R<0)R=0;this.menuVisible=!0,this.menuArea=0,this.menuX=m,this.menuY=R,this.menuWidth=u,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>553&&this.mouseClickY>205&&this.mouseClickX<743&&this.mouseClickY<466){if(m=this.mouseClickX-(u/2|0)-553,m<0)m=0;else if(m+u>190)m=190-u;if(R=this.mouseClickY-205,R<0)R=0;else if(R+_>261)R=261-_;this.menuVisible=!0,this.menuArea=1,this.menuX=m,this.menuY=R,this.menuWidth=u,this.menuHeight=this.menuSize*15+22}if(this.mouseClickX>17&&this.mouseClickY>357&&this.mouseClickX<496&&this.mouseClickY<453){if(m=this.mouseClickX-(u/2|0)-17,m<0)m=0;else if(m+u>479)m=479-u;if(R=this.mouseClickY-357,R<0)R=0;else if(R+_>96)R=96-_;this.menuVisible=!0,this.menuArea=2,this.menuX=m,this.menuY=R,this.menuWidth=u,this.menuHeight=this.menuSize*15+22}}isAddFriendOption(u){if(u<0)return!1;let _=this.menuAction[u];if(_>=2000)_-=2000;return _===406}useMenuOption(u){if(u<0)return;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;let _=this.menuAction[u],m=this.menuParamA[u],R=this.menuParamB[u],b=this.menuParamC[u];if(_>=2000)_-=2000;if(_===1501){if(v.oplogic6+=this.sceneBaseTileZ,v.oplogic6>=92)this.out.p1isaac(250),this.out.p4(0);this.interactWithLoc(86,R,b,m)}else if(_===34){let E=this.menuOption[u],O=E.indexOf("@whi@");if(O!==-1){this.closeInterfaces(),this.reportAbuseInput=E.substring(O+5).trim(),this.reportAbuseMuteOption=!1;for(let L=0;L<g.types.length;L++)if(g.types[L]&&g.types[L].clientCode===600){this.reportAbuseInterfaceId=this.viewportInterfaceId=g.types[L].layer;break}}}else if(_===367){let E=this.players[m];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(210),this.out.p2(m),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(_===951){let E=g.types[b],O=!0;if(E.clientCode>0)O=this.handleInterfaceAction(E);if(O)this.out.p1isaac(177),this.out.p2(b)}else if(_===217){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],R,b,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],R,b,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(143),this.out.p2(R+this.sceneBaseTileX),this.out.p2(b+this.sceneBaseTileZ),this.out.p2(m),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}}else if(_===450){if(this.interactWithLoc(147,R,b,m))this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(_===265){let E=this.npcs[m];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(141),this.out.p2(m),this.out.p2(this.activeSpellId)}else if(_===364)this.interactWithLoc(226,R,b,m);else if(_===55){if(this.interactWithLoc(208,R,b,m))this.out.p2(this.activeSpellId)}else if(_===224||_===993||_===99||_===746||_===877){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],R,b,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],R,b,2,1,1,0,0,0,!1);if(this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,_===99)this.out.p1isaac(55);else if(_===993)this.out.p1isaac(238);else if(_===224)this.out.p1isaac(113);else if(_===877)this.out.p1isaac(247);else if(_===746)this.out.p1isaac(17);this.out.p2(R+this.sceneBaseTileX),this.out.p2(b+this.sceneBaseTileZ),this.out.p2(m)}}else if(_===581){if((m&3)===0)v.oplogic1++;if(v.oplogic1>=99)this.out.p1isaac(87),this.out.p4(0);this.interactWithLoc(55,R,b,m)}else if(_===679){let E=this.menuOption[u],O=E.indexOf("@whi@");if(O!==-1){let L=c.toBase37(E.substring(O+5).trim()),I=-1;for(let N=0;N<this.friendCount;N++)if(this.friendName37[N]===L){I=N;break}if(I!==-1&&this.friendWorld[I]>0)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=3,this.socialName37=this.friendName37[I],this.socialMessage="Enter message to send to "+this.friendName[I]}}else if(_===960){this.out.p1isaac(177),this.out.p2(b);let E=g.types[b];if(E.scripts&&E.scripts[0]&&E.scripts[0][0]===5){let O=E.scripts[0][1];if(E.scriptOperand&&this.varps[O]!==E.scriptOperand[0])this.varps[O]=E.scriptOperand[0],this.updateVarp(O),this.redrawSidebar=!0}}else if(_===1175){let E=m>>14&32767,O=m0.get(E),L;if(!O.desc)L="It's a "+O.name+".";else L=O.desc;this.addMessage(0,L,"")}else if(_===881){if(this.out.p1isaac(126),this.out.p2(m),this.out.p2(R),this.out.p2(b),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface),this.selectedCycle=0,this.selectedInterface=b,this.selectedItem=R,this.selectedArea=2,g.types[b].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.types[b].layer===this.chatInterfaceId)this.selectedArea=3}else if(_===44){if(!this.pressedContinueOption)this.out.p1isaac(239),this.out.p2(b),this.pressedContinueOption=!0}else if(_===285)this.interactWithLoc(1,R,b,m);else if(_===406||_===436||_===557||_===556){let E=this.menuOption[u],O=E.indexOf("@whi@");if(O!==-1){let L=c.toBase37(E.substring(O+5).trim());if(_===406)this.addFriend(L);else if(_===436)this.addIgnore(L);else if(_===557)this.removeFriend(L);else if(_===556)this.removeIgnore(L)}}else if(_===947)this.closeInterfaces();else if(_===405||_===38||_===422||_===478||_===347){if(_===347)this.out.p1isaac(9);else if(_===422)this.out.p1isaac(115);else if(_===478){if((R&3)===0)v.oplogic5++;if(v.oplogic5>=90)this.out.p1isaac(74);this.out.p1isaac(194)}else if(_===405){if(v.oplogic3+=m,v.oplogic3>=97)this.out.p1isaac(146),this.out.p3(14953816);this.out.p1isaac(104)}else if(_===38)this.out.p1isaac(193);if(this.out.p2(m),this.out.p2(R),this.out.p2(b),this.selectedCycle=0,this.selectedInterface=b,this.selectedItem=R,this.selectedArea=2,g.types[b].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.types[b].layer===this.chatInterfaceId)this.selectedArea=3}else if(_===965){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],R,b,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],R,b,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(122),this.out.p2(R+this.sceneBaseTileX),this.out.p2(b+this.sceneBaseTileZ),this.out.p2(m),this.out.p2(this.activeSpellId)}}else if(_===602||_===596||_===22||_===892||_===415){if(_===415){if((b&3)===0)v.oplogic7++;if(v.oplogic7>=55)this.out.p1isaac(119),this.out.p4(0);this.out.p1isaac(242)}else if(_===22)this.out.p1isaac(48);else if(_===596)this.out.p1isaac(58);else if(_===892){if((R&3)===0)v.oplogic9++;if(v.oplogic9>=130)this.out.p1isaac(233),this.out.p1(177);this.out.p1isaac(183)}else if(_===602)this.out.p1isaac(13);if(this.out.p2(m),this.out.p2(R),this.out.p2(b),this.selectedCycle=0,this.selectedInterface=b,this.selectedItem=R,this.selectedArea=2,g.types[b].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.types[b].layer===this.chatInterfaceId)this.selectedArea=3}else if(_===465){this.out.p1isaac(177),this.out.p2(b);let E=g.types[b];if(E.scripts&&E.scripts[0]&&E.scripts[0][0]===5){let O=E.scripts[0][1];this.varps[O]=1-this.varps[O],this.updateVarp(O),this.redrawSidebar=!0}}else if(_===900){let E=this.npcs[m];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(14),this.out.p2(m),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(_===188){this.objSelected=1,this.objSelectedSlot=R,this.objSelectedInterface=b,this.objInterface=m,this.objSelectedName=l.get(m).name,this.spellSelected=0,this.redrawSidebar=!0;return}else if(_===728||_===542||_===6||_===963||_===245){let E=this.npcs[m];if(E&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,_===963)this.out.p1isaac(107);else if(_===6){if((m&3)===0)v.oplogic2++;if(v.oplogic2>=124)this.out.p1isaac(95),this.out.p4(0);this.out.p1isaac(196)}else if(_===245){if((m&3)===0)v.oplogic4++;if(v.oplogic4>=85)this.out.p1isaac(186),this.out.p2(39596);this.out.p1isaac(43)}else if(_===728)this.out.p1isaac(180);else if(_===542)this.out.p1isaac(252);this.out.p2(m)}}else if(_===391){if(this.out.p1isaac(188),this.out.p2(m),this.out.p2(R),this.out.p2(b),this.out.p2(this.activeSpellId),this.selectedCycle=0,this.selectedInterface=b,this.selectedItem=R,this.selectedArea=2,g.types[b].layer===this.viewportInterfaceId)this.selectedArea=1;if(g.types[b].layer===this.chatInterfaceId)this.selectedArea=3}else if(_===930){let E=g.types[b];this.spellSelected=1,this.activeSpellId=b,this.activeSpellFlags=E.targetMask,this.objSelected=0,this.redrawSidebar=!0;let O=E.targetVerb;if(O&&O.indexOf(" ")!==-1)O=O.substring(0,O.indexOf(" "));let L=E.targetVerb;if(L&&L.indexOf(" ")!==-1)L=L.substring(L.indexOf(" ")+1);if(this.spellCaption=O+" "+E.targetText+" "+L,this.activeSpellFlags===16)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;return}else if(_===660)if(this.menuVisible)this.scene?.click(R-8,b-11);else this.scene?.click(this.mouseClickX-8,this.mouseClickY-11);else if(_===903||_===363){let E=this.menuOption[u],O=E.indexOf("@whi@");if(O!==-1){E=E.substring(O+5).trim();let L=c.formatName(c.fromBase37(c.toBase37(E))),I=!1;for(let N=0;N<this.playerCount;N++){let H=this.players[this.playerIds[N]];if(H&&H.name&&H.name.toLowerCase()===L.toLowerCase()&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],H.routeTileX[0],H.routeTileZ[0],2,1,1,0,0,0,!1),_===903)this.out.p1isaac(54);else if(_===363)this.out.p1isaac(135);this.out.p2(this.playerIds[N]),I=!0;break}}if(!I)this.addMessage(0,"Unable to find "+L,"")}}else if(_===1607){let E=this.npcs[m];if(E&&E.type){let O;if(!E.type.desc)O="It's a "+E.type.name+".";else O=E.type.desc;this.addMessage(0,O,"")}}else if(_===651){let E=this.players[m];if(E&&this.localPlayer)this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(52),this.out.p2(m),this.out.p2(this.activeSpellId)}else if(_===1102){let E=l.get(m),O;if(!E.desc)O="It's a "+E.name+".";else O=E.desc;this.addMessage(0,O,"")}else if(_===1373||_===1544||_===151||_===1101){let E=this.players[m];if(E&&this.localPlayer){if(this.tryMove(this.localPlayer.routeTileX[0],this.localPlayer.routeTileZ[0],E.routeTileX[0],E.routeTileZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,_===1544)this.out.p1isaac(172);else if(_===1373)this.out.p1isaac(54);else if(_===151){if(v.oplogic8++,v.oplogic8>=90)this.out.p1isaac(171),this.out.p2(31114);this.out.p1isaac(165)}else if(_===1101)this.out.p1isaac(135);this.out.p2(m)}}else if(_===504)this.interactWithLoc(219,R,b,m);else if(_===1773){let E=l.get(m),O;if(b>=1e5)O=b+" x "+E.name;else if(!E.desc)O="It's a "+E.name+".";else O=E.desc;this.addMessage(0,O,"")}this.objSelected=0,this.spellSelected=0,this.redrawSidebar=!0}addNpcOptions(u,_,m,R){if(this.menuSize>=400)return;let b=u.name;if(u.vislevel!==0&&this.localPlayer)b=b+this.getCombatLevelTag(this.localPlayer.combatLevel,u.vislevel)+" (level-"+u.vislevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @yel@"+b,this.menuAction[this.menuSize]=900,this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++;else if(this.spellSelected!==1){let E;if(u.op){for(E=4;E>=0;E--)if(u.op[E]&&u.op[E]?.toLowerCase()!=="attack"){if(this.menuOption[this.menuSize]=u.op[E]+" @yel@"+b,E===0)this.menuAction[this.menuSize]=728;else if(E===1)this.menuAction[this.menuSize]=542;else if(E===2)this.menuAction[this.menuSize]=6;else if(E===3)this.menuAction[this.menuSize]=963;else if(E===4)this.menuAction[this.menuSize]=245;this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++}}if(u.op){for(E=4;E>=0;E--)if(u.op[E]&&u.op[E]?.toLowerCase()==="attack"){let O=0;if(this.localPlayer&&u.vislevel>this.localPlayer.combatLevel)O=2000;if(this.menuOption[this.menuSize]=u.op[E]+" @yel@"+b,E===0)this.menuAction[this.menuSize]=O+728;else if(E===1)this.menuAction[this.menuSize]=O+542;else if(E===2)this.menuAction[this.menuSize]=O+6;else if(E===3)this.menuAction[this.menuSize]=O+963;else if(E===4)this.menuAction[this.menuSize]=O+245;this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++}}this.menuOption[this.menuSize]="Examine @yel@"+b,this.menuAction[this.menuSize]=1607,this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++}else if((this.activeSpellFlags&2)===2)this.menuOption[this.menuSize]=this.spellCaption+" @yel@"+b,this.menuAction[this.menuSize]=265,this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++}addPlayerOptions(u,_,m,R){if(u===this.localPlayer||this.menuSize>=400)return;let b=null;if(this.localPlayer)b=u.name+this.getCombatLevelTag(this.localPlayer.combatLevel,u.combatLevel)+" (level-"+u.combatLevel+")";if(this.objSelected===1)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @whi@"+b,this.menuAction[this.menuSize]=367,this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++;else if(this.spellSelected!==1){if(this.menuOption[this.menuSize]="Follow @whi@"+b,this.menuAction[this.menuSize]=1544,this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++,this.overrideChat===0)this.menuOption[this.menuSize]="Trade with @whi@"+b,this.menuAction[this.menuSize]=1373,this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++;if(this.wildernessLevel>0){if(this.menuOption[this.menuSize]="Attack @whi@"+b,this.localPlayer&&this.localPlayer.combatLevel>=u.combatLevel)this.menuAction[this.menuSize]=151;else this.menuAction[this.menuSize]=2151;this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++}if(this.worldLocationState===1)this.menuOption[this.menuSize]="Fight @whi@"+b,this.menuAction[this.menuSize]=151,this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++;if(this.worldLocationState===2)this.menuOption[this.menuSize]="Duel-with @whi@"+b,this.menuAction[this.menuSize]=1101,this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++}else if((this.activeSpellFlags&8)===8)this.menuOption[this.menuSize]=this.spellCaption+" @whi@"+b,this.menuAction[this.menuSize]=651,this.menuParamA[this.menuSize]=_,this.menuParamB[this.menuSize]=m,this.menuParamC[this.menuSize]=R,this.menuSize++;for(let E=0;E<this.menuSize;E++)if(this.menuAction[E]===660){this.menuOption[E]="Walk here @whi@"+b;break}}getCombatLevelTag(u,_){let m=u-_;if(m<-9)return"@red@";else if(m<-6)return"@or3@";else if(m<-3)return"@or2@";else if(m<0)return"@or1@";else if(m>9)return"@gre@";else if(m>6)return"@gr3@";else if(m>3)return"@gr2@";else if(m>0)return"@gr1@";else return"@yel@"}drawInterface(u,_,m,R){if(u.type!==0||!u.children||u.hide&&this.viewportHoveredInterfaceIndex!==u.id&&this.sidebarHoveredInterfaceIndex!==u.id&&this.chatHoveredInterfaceIndex!==u.id)return;let b=K.left,E=K.top,O=K.right,L=K.bottom;K.setBounds(_,m,_+u.width,m+u.height);let I=u.children.length;for(let N=0;N<I;N++){if(!u.childX||!u.childY)continue;let H=u.childX[N]+_,G=u.childY[N]+m-R,T=g.types[u.children[N]];if(H+=T.x,G+=T.y,T.clientCode>0)this.updateInterfaceContent(T);if(T.type===0){if(T.scrollPosition>T.scroll-T.height)T.scrollPosition=T.scroll-T.height;if(T.scrollPosition<0)T.scrollPosition=0;if(this.drawInterface(T,H,G,T.scrollPosition),T.scroll>T.height)this.drawScrollbar(H+T.width,G,T.scrollPosition,T.scroll,T.height)}else if(T.type===2){let q=0;for(let Q=0;Q<T.height;Q++)for(let n=0;n<T.width;n++){if(!T.invSlotOffsetX||!T.invSlotOffsetY||!T.invSlotObjId||!T.invSlotObjCount)continue;let J=H+n*(T.marginX+32),U=G+Q*(T.marginY+32);if(q<20)J+=T.invSlotOffsetX[q],U+=T.invSlotOffsetY[q];if(T.invSlotObjId[q]>0){let w=0,k=0,V=T.invSlotObjId[q]-1;if(J>K.left-32&&J<K.right&&U>K.top-32&&U<K.bottom||this.objDragArea!==0&&this.objDragSlot===q){let j=0;if(this.objSelected==1&&this.objSelectedSlot==q&&this.objSelectedInterface==T.id)j=16777215;let X=l.getIcon(V,T.invSlotObjCount[q],j);if(X){if(this.objDragArea!==0&&this.objDragSlot===q&&this.objDragInterfaceId===T.id){if(w=this.mouseX-this.objGrabX,k=this.mouseY-this.objGrabY,w<5&&w>-5)w=0;if(k<5&&k>-5)k=0;if(this.objDragCycles<5)w=0,k=0;if(X.drawAlpha(128,J+w,U+k),U+k<K.top&&u.scrollPosition>0){let A=(K.top-U-k)*this.sceneDelta/3;if(A>this.sceneDelta*10)A=this.sceneDelta*10;if(A>u.scrollPosition)A=u.scrollPosition;u.scrollPosition-=A,this.objGrabY+=A}if(U+k+32>K.bottom&&u.scrollPosition<u.scroll-u.height){let A=(U+k+32-K.bottom)*this.sceneDelta/3;if(A>this.sceneDelta*10)A=this.sceneDelta*10;if(A>u.scroll-u.height-u.scrollPosition)A=u.scroll-u.height-u.scrollPosition;u.scrollPosition+=A,this.objGrabY-=A}}else if(this.selectedArea!==0&&this.selectedItem===q&&this.selectedInterface===T.id)X.drawAlpha(128,J,U);else X.draw(J,U);if(X.width===33||T.invSlotObjCount[q]!==1){let A=T.invSlotObjCount[q];this.fontPlain11?.drawString(J+w+1,U+10+k,this.formatObjCount(A),0),this.fontPlain11?.drawString(J+w,U+9+k,this.formatObjCount(A),16776960)}}}}else if(T.invSlotGraphic&&q<20)T.invSlotGraphic[q]?.draw(J,U);q++}}else if(T.type===3){let q=!1;if(this.chatHoveredInterfaceIndex===T.id||this.sidebarHoveredInterfaceIndex===T.id||this.viewportHoveredInterfaceIndex===T.id)q=!0;let Q=0;if(this.executeInterfaceScript(T)){if(Q=T.activeColour,q&&T.activeOverColour!==0)Q=T.activeOverColour}else if(Q=T.colour,q&&T.overColour!==0)Q=T.overColour;if(T.alpha===0)if(T.fill)K.fillRect2d(H,G,T.width,T.height,Q);else K.drawRect(H,G,T.width,T.height,Q);else if(T.fill)K.fillRectAlpha(H,G,T.width,T.height,Q,256-(T.alpha&255));else K.drawRect(H,G,T.width,T.height,Q),K.drawRectAlpha(H,G,T.width,T.height,Q,256-(T.alpha&255))}else if(T.type===4){let{font:q,text:Q}=T,n=!1;if(this.chatHoveredInterfaceIndex===T.id||this.sidebarHoveredInterfaceIndex===T.id||this.viewportHoveredInterfaceIndex===T.id)n=!0;let J=0;if(this.executeInterfaceScript(T)){if(J=T.activeColour,n&&T.activeOverColour!==0)J=T.activeOverColour;if(T.activeText&&T.activeText.length>0)Q=T.activeText}else if(J=T.colour,n&&T.overColour!==0)J=T.overColour;if(T.buttonType===6&&this.pressedContinueOption)Q="Please wait...",J=T.colour;if(K.width2d==479){if(J==16776960)J=255;if(J==49152)J=16777215}if(!q||!Q)continue;for(let U=G+q.height2d;Q.length>0;U+=q.height2d){if(Q.indexOf("%")!==-1){do{let V=Q.indexOf("%1");if(V===-1)break;Q=Q.substring(0,V)+this.getIntString(this.executeClientScript(T,0))+Q.substring(V+2)}while(!0);do{let V=Q.indexOf("%2");if(V===-1)break;Q=Q.substring(0,V)+this.getIntString(this.executeClientScript(T,1))+Q.substring(V+2)}while(!0);do{let V=Q.indexOf("%3");if(V===-1)break;Q=Q.substring(0,V)+this.getIntString(this.executeClientScript(T,2))+Q.substring(V+2)}while(!0);do{let V=Q.indexOf("%4");if(V===-1)break;Q=Q.substring(0,V)+this.getIntString(this.executeClientScript(T,3))+Q.substring(V+2)}while(!0);do{let V=Q.indexOf("%5");if(V===-1)break;Q=Q.substring(0,V)+this.getIntString(this.executeClientScript(T,4))+Q.substring(V+2)}while(!0)}let w=Q.indexOf("\\n"),k;if(w!==-1)k=Q.substring(0,w),Q=Q.substring(w+2);else k=Q,Q="";if(T.center)q.drawStringTaggableCenter(H+(T.width/2|0),U,k,J,T.shadowed);else q.drawStringTaggable(H,U,k,J,T.shadowed)}}else if(T.type===5){let q;if(this.executeInterfaceScript(T))q=T.activeGraphic;else q=T.graphic;q?.draw(H,G)}else if(T.type===6){let q=h.centerX,Q=h.centerY;h.centerX=H+(T.width/2|0),h.centerY=G+(T.height/2|0);let n=h.sinTable[T.xan]*T.zoom>>16,J=h.cosTable[T.xan]*T.zoom>>16,U=this.executeInterfaceScript(T),w;if(U)w=T.activeAnim;else w=T.anim;let k=null;if(w===-1)k=T.getModel(-1,-1,U,this.localPlayer);else{let V=o.types[w];if(V.frames&&V.iframes)k=T.getModel(V.frames[T.seqFrame],V.iframes[T.seqFrame],U,this.localPlayer)}if(k)k.drawSimple(0,T.yan,0,T.xan,0,n,J);h.centerX=q,h.centerY=Q}else if(T.type===7){let q=T.font;if(!q||!T.invSlotObjId||!T.invSlotObjCount)continue;let Q=0;for(let n=0;n<T.height;n++)for(let J=0;J<T.width;J++){if(T.invSlotObjId[Q]>0){let U=l.get(T.invSlotObjId[Q]-1),w=U.name;if(U.stackable||T.invSlotObjCount[Q]!==1)w=w+" x"+this.formatObjCountTagged(T.invSlotObjCount[Q]);if(!w)continue;let k=H+J*(T.marginX+115),V=G+n*(T.marginY+12);if(T.center)q.drawStringTaggableCenter(k+(T.width/2|0),V,w,T.colour,T.shadowed);else q.drawStringTaggable(k,V,w,T.colour,T.shadowed)}Q++}}}K.setBounds(b,E,O,L)}drawScrollbar(u,_,m,R,b){this.imageScrollbar0?.draw(u,_),this.imageScrollbar1?.draw(u,_+b-16),K.fillRect2d(u,_+16,16,b-32,2301979);let E=(b-32)*b/R|0;if(E<8)E=8;let O=(b-E-32)*m/(R-b)|0;K.fillRect2d(u,_+O+16,16,E,5063219),K.drawVerticalLine(u,_+O+16,7759444,E),K.drawVerticalLine(u+1,_+O+16,7759444,E),K.drawHorizontalLine(u,_+O+16,7759444,16),K.drawHorizontalLine(u,_+O+17,7759444,16),K.drawVerticalLine(u+15,_+O+16,3353893,E),K.drawVerticalLine(u+14,_+O+17,3353893,E-1),K.drawHorizontalLine(u,_+O+E+15,3353893,16),K.drawHorizontalLine(u+1,_+O+E+14,3353893,15)}formatObjCount(u){if(u<1e5)return String(u);else if(u<1e7)return(u/1000|0)+"K";else return(u/1e6|0)+"M"}formatObjCountTagged(u){let _=String(u);for(let m=_.length-3;m>0;m-=3)_=_.substring(0,m)+","+_.substring(m);if(_.length>8)_="@gre@"+_.substring(0,_.length-8)+" million @whi@("+_+")";else if(_.length>4)_="@cya@"+_.substring(0,_.length-4)+"K @whi@("+_+")";return" "+_}handleScrollInput(u,_,m,R,b,E,O,L){if(this.scrollGrabbed)this.scrollInputPadding=32;else this.scrollInputPadding=0;if(this.scrollGrabbed=!1,u>=E&&u<E+16&&_>=O&&_<O+16){if(L.scrollPosition-=this.dragCycles*4,b)this.redrawSidebar=!0}else if(u>=E&&u<E+16&&_>=O+R-16&&_<O+R){if(L.scrollPosition+=this.dragCycles*4,b)this.redrawSidebar=!0}else if(u>=E-this.scrollInputPadding&&u<E+this.scrollInputPadding+16&&_>=O+16&&_<O+R-16&&this.dragCycles>0){let I=(R-32)*R/m|0;if(I<8)I=8;let N=_-O-(I/2|0)-16,H=R-I-32;if(L.scrollPosition=(m-R)*N/H|0,b)this.redrawSidebar=!0;this.scrollGrabbed=!0}}getIntString(u){return u<999999999?String(u):"*"}executeInterfaceScript(u){if(!u.scriptComparator)return!1;for(let _=0;_<u.scriptComparator.length;_++){if(!u.scriptOperand)return!1;let m=this.executeClientScript(u,_),R=u.scriptOperand[_];if(u.scriptComparator[_]===2){if(m>=R)return!1}else if(u.scriptComparator[_]===3){if(m<=R)return!1}else if(u.scriptComparator[_]===4){if(m===R)return!1}else if(m!==R)return!1}return!0}executeClientScript(u,_){if(!u.scripts||_>=u.scripts.length)return-2;try{let m=u.scripts[_];if(!m)return-1;let R=0,b=0;while(!0){let E=m[b++];if(E===0)return R;if(E===1)R+=this.skillLevel[m[b++]];else if(E===2)R+=this.skillBaseLevel[m[b++]];else if(E===3)R+=this.skillExperience[m[b++]];else if(E===4){let O=g.types[m[b++]],L=m[b++]+1;if(O.invSlotObjId&&O.invSlotObjCount){for(let I=0;I<O.invSlotObjId.length;I++)if(O.invSlotObjId[I]===L)R+=O.invSlotObjCount[I]}else R+=0}else if(E===5)R+=this.varps[m[b++]];else if(E===6)R+=this.levelExperience[this.skillBaseLevel[m[b++]]-1];else if(E===7)R+=this.varps[m[b++]]*100/46875|0;else if(E===8)R+=this.localPlayer?.combatLevel||0;else if(E===9)for(let O=0;O<19;O++){if(O===18)O=20;R+=this.skillBaseLevel[O]}else if(E===10){let O=g.types[m[b++]],L=m[b++]+1;if(O.invSlotObjId){for(let I=0;I<O.invSlotObjId.length;I++)if(O.invSlotObjId[I]===L){R+=999999999;break}}}else if(E===11)R+=this.runenergy;else if(E===12)R+=this.runweight;else if(E===13){let O=this.varps[m[b++]],L=m[b++];R+=(O&1<<L)===0?0:1}}}catch(m){return-1}}handleInterfaceInput(u,_,m,R,b,E){if(u.type!==0||!u.children||u.hide||_<R||m<b||_>R+u.width||m>b+u.height||!u.childX||!u.childY)return;let O=u.children.length;for(let L=0;L<O;L++){let I=u.childX[L]+R,N=u.childY[L]+b-E,H=g.types[u.children[L]];if(I+=H.x,N+=H.y,(H.overlayer>=0||H.overColour!==0)&&_>=I&&m>=N&&_<I+H.width&&m<N+H.height)if(H.overlayer>=0)this.lastHoveredInterfaceId=H.overlayer;else this.lastHoveredInterfaceId=H.id;if(H.type===0){if(this.handleInterfaceInput(H,_,m,I,N,H.scrollPosition),H.scroll>H.height)this.handleScrollInput(_,m,H.scroll,H.height,!0,I+H.width,N,H)}else if(H.type===2){let G=0;for(let T=0;T<H.height;T++)for(let q=0;q<H.width;q++){let Q=I+q*(H.marginX+32),n=N+T*(H.marginY+32);if(G<20&&H.invSlotOffsetX&&H.invSlotOffsetY)Q+=H.invSlotOffsetX[G],n+=H.invSlotOffsetY[G];if(_<Q||m<n||_>=Q+32||m>=n+32){G++;continue}if(this.hoveredSlot=G,this.hoveredSlotParentId=H.id,!H.invSlotObjId||H.invSlotObjId[G]<=0){G++;continue}let J=l.get(H.invSlotObjId[G]-1);if(this.objSelected===1&&H.interactable){if(H.id!==this.objSelectedInterface||G!==this.objSelectedSlot)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+J.name,this.menuAction[this.menuSize]=881,this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=H.id,this.menuSize++}else if(this.spellSelected===1&&H.interactable){if((this.activeSpellFlags&16)===16)this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+J.name,this.menuAction[this.menuSize]=391,this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=H.id,this.menuSize++}else{if(H.interactable){for(let U=4;U>=3;U--)if(J.iop&&J.iop[U]){if(this.menuOption[this.menuSize]=J.iop[U]+" @lre@"+J.name,U===3)this.menuAction[this.menuSize]=478;else if(U===4)this.menuAction[this.menuSize]=347;this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=H.id,this.menuSize++}else if(U===4)this.menuOption[this.menuSize]="Drop @lre@"+J.name,this.menuAction[this.menuSize]=347,this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=H.id,this.menuSize++}if(H.usable)this.menuOption[this.menuSize]="Use @lre@"+J.name,this.menuAction[this.menuSize]=188,this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=H.id,this.menuSize++;if(H.interactable&&J.iop){for(let U=2;U>=0;U--)if(J.iop[U]){if(this.menuOption[this.menuSize]=J.iop[U]+" @lre@"+J.name,U===0)this.menuAction[this.menuSize]=405;else if(U===1)this.menuAction[this.menuSize]=38;else if(U===2)this.menuAction[this.menuSize]=422;this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=H.id,this.menuSize++}}if(H.iop){for(let U=4;U>=0;U--)if(H.iop[U]){if(this.menuOption[this.menuSize]=H.iop[U]+" @lre@"+J.name,U===0)this.menuAction[this.menuSize]=602;else if(U===1)this.menuAction[this.menuSize]=596;else if(U===2)this.menuAction[this.menuSize]=22;else if(U===3)this.menuAction[this.menuSize]=892;else if(U===4)this.menuAction[this.menuSize]=415;this.menuParamA[this.menuSize]=J.id,this.menuParamB[this.menuSize]=G,this.menuParamC[this.menuSize]=H.id,this.menuSize++}}if(this.menuOption[this.menuSize]="Examine @lre@"+J.name,this.menuAction[this.menuSize]=1773,this.menuParamA[this.menuSize]=J.id,H.invSlotObjCount)this.menuParamC[this.menuSize]=H.invSlotObjCount[G];this.menuSize++}G++}}else if(_>=I&&m>=N&&_<I+H.width&&m<N+H.height){if(H.buttonType===1){let G=!1;if(H.clientCode!==0)G=this.handleSocialMenuOption(H);if(!G&&H.option)this.menuOption[this.menuSize]=H.option,this.menuAction[this.menuSize]=951,this.menuParamC[this.menuSize]=H.id,this.menuSize++}else if(H.buttonType===2&&this.spellSelected===0){let G=H.targetVerb;if(G&&G.indexOf(" ")!==-1)G=G.substring(0,G.indexOf(" "));this.menuOption[this.menuSize]=G+" @gre@"+H.targetText,this.menuAction[this.menuSize]=930,this.menuParamC[this.menuSize]=H.id,this.menuSize++}else if(H.buttonType===3)this.menuOption[this.menuSize]="Close",this.menuAction[this.menuSize]=947,this.menuParamC[this.menuSize]=H.id,this.menuSize++;else if(H.buttonType===4&&H.option)this.menuOption[this.menuSize]=H.option,this.menuAction[this.menuSize]=465,this.menuParamC[this.menuSize]=H.id,this.menuSize++;else if(H.buttonType===5&&H.option)this.menuOption[this.menuSize]=H.option,this.menuAction[this.menuSize]=960,this.menuParamC[this.menuSize]=H.id,this.menuSize++;else if(H.buttonType===6&&!this.pressedContinueOption&&H.option)this.menuOption[this.menuSize]=H.option,this.menuAction[this.menuSize]=44,this.menuParamC[this.menuSize]=H.id,this.menuSize++}}}handleSocialMenuOption(u){let _=u.clientCode;if(_>=1&&_<=200||_>=701&&_<=900){if(_>=801)_-=701;else if(_>=701)_-=601;else if(_>=101)_-=101;else _--;return this.menuOption[this.menuSize]="Remove @whi@"+this.friendName[_],this.menuAction[this.menuSize]=557,this.menuSize++,this.menuOption[this.menuSize]="Message @whi@"+this.friendName[_],this.menuAction[this.menuSize]=679,this.menuSize++,!0}else if(_>=401&&_<=500)return this.menuOption[this.menuSize]="Remove @whi@"+u.text,this.menuAction[this.menuSize]=556,this.menuSize++,!0;return!1}resetInterfaceAnimation(u){let _=g.types[u];if(!_.children)return;for(let m=0;m<_.children.length&&_.children[m]!==-1;m++){let R=g.types[_.children[m]];if(R.type===1)this.resetInterfaceAnimation(R.id);R.seqFrame=0,R.seqCycle=0}}updateInterfaceAnimation(u,_){let m=g.types[u];if(!m.children)return!1;let R=!1;for(let b=0;b<m.children.length&&m.children[b]!==-1;b++){let E=g.types[m.children[b]];if(E.type===1)R||=this.updateInterfaceAnimation(E.id,_);if(E.type===6&&(E.anim!==-1||E.activeAnim!==-1)){let O=this.executeInterfaceScript(E),L;if(O)L=E.activeAnim;else L=E.anim;if(L!==-1){let I=o.types[L];E.seqCycle+=_;while(E.seqCycle>I.getFrameDuration(E.seqFrame)){if(E.seqCycle-=I.getFrameDuration(E.seqFrame)+1,E.seqFrame++,E.seqFrame>=I.frameCount){if(E.seqFrame-=I.loops,E.seqFrame<0||E.seqFrame>=I.frameCount)E.seqFrame=0}R=!0}}}}return R}updateVarp(u){let _=S0.types[u].clientcode;if(_===0)return;let m=this.varps[u];if(_===1){if(m===1)h.initColourTable(0.9);else if(m===2)h.initColourTable(0.8);else if(m===3)h.initColourTable(0.7);else if(m===4)h.initColourTable(0.6);l.iconCache?.clear(),this.redrawFrame=!0}else if(_===3){let R=this.midiActive;if(m===0)this.midiVolume=128,Fu(128),this.midiActive=!0;else if(m===1)this.midiVolume=96,Fu(96),this.midiActive=!0;else if(m===2)this.midiVolume=64,Fu(64),this.midiActive=!0;else if(m===3)this.midiVolume=32,Fu(32),this.midiActive=!0;else if(m===4)this.midiActive=!1;if(this.midiActive!==R){if(this.midiActive)this.midiSong=this.nextMidiSong,this.midiFading=!1,this.onDemand?.request(2,this.midiSong);else iu(!1);this.nextMusicDelay=0}}else if(_===4){if(m===0)this.waveVolume=128,Ku(128),this.waveEnabled=!0;else if(m===1)this.waveVolume=96,Ku(96),this.waveEnabled=!0;else if(m===2)this.waveVolume=64,Ku(64),this.waveEnabled=!0;else if(m===3)this.waveVolume=32,Ku(32),this.waveEnabled=!0;else if(m===4)this.waveEnabled=!1}else if(_===5)this.oneMouseButton=m;else if(_===6)this.chatEffects=m;else if(_===8)this.splitPrivateChat=m,this.redrawChatback=!0;else if(_===9)this.bankArrangeMode=m}updateInterfaceContent(u){let _=u.clientCode;if(_>=1&&_<=100||_>=701&&_<=800){if(_>700)_-=601;else _--;if(_>=this.friendCount)u.text="",u.buttonType=0;else u.text=this.friendName[_],u.buttonType=1}else if(_>=101&&_<=200||_>=801&&_<=900){if(_>800)_-=701;else _-=101;if(_>=this.friendCount)u.text="",u.buttonType=0;else{if(this.friendWorld[_]===0)u.text="@red@Offline";else if(this.friendWorld[_]===v.nodeId)u.text="@gre@World-"+(this.friendWorld[_]-9);else u.text="@yel@World-"+(this.friendWorld[_]-9);u.buttonType=1}}else if(_===203){if(u.scroll=this.friendCount*15+20,u.scroll<=u.height)u.scroll=u.height+1}else if(_>=401&&_<=500)if(_-=401,_>=this.ignoreCount)u.text="",u.buttonType=0;else u.text=c.formatName(c.fromBase37(this.ignoreName37[_])),u.buttonType=1;else if(_===503){if(u.scroll=this.ignoreCount*15+20,u.scroll<=u.height)u.scroll=u.height+1}else if(_===327){if(u.xan=150,u.yan=(Math.sin(this.loopCycle/40)*256|0)&2047,this.updateDesignModel){for(let E=0;E<7;E++){let O=this.designKits[E];if(O>=0&&!U0.types[O].modelIsReady())return}this.updateDesignModel=!1;let m=new r(7,null),R=0;for(let E=0;E<7;E++){let O=this.designKits[E];if(O>=0)m[R++]=U0.types[O].getModel()}let b=$.modelFromModels(m,R);for(let E=0;E<5;E++)if(this.designColours[E]!==0){if(b.recolour(T0.DESIGN_IDK_COLORS[E][0],T0.DESIGN_IDK_COLORS[E][this.designColours[E]]),E===1)b.recolour(T0.TORSO_RECOLORS[0],T0.TORSO_RECOLORS[this.designColours[E]])}if(b.createLabelReferences(),b.calculateNormals(64,850,-30,-50,-30,!0),this.localPlayer){let E=o.types[this.localPlayer.readyanim].frames;if(E)b.applyTransform(E[0])}u.modelType=5,u.model=0,g.cacheModel(b,5,0)}}else if(_===324){if(!this.genderButtonImage0)this.genderButtonImage0=u.graphic,this.genderButtonImage1=u.activeGraphic;if(this.designGender)u.graphic=this.genderButtonImage1;else u.graphic=this.genderButtonImage0}else if(_===325){if(!this.genderButtonImage0)this.genderButtonImage0=u.graphic,this.genderButtonImage1=u.activeGraphic;if(this.designGender)u.graphic=this.genderButtonImage0;else u.graphic=this.genderButtonImage1}else if(_===600)if(u.text=this.reportAbuseInput,this.loopCycle%20<10)u.text=u.text+"|";else u.text=u.text+" ";else if(_===613)if(this.staffmodlevel<1)u.text="";else if(this.reportAbuseMuteOption)u.colour=16711680,u.text="Moderator option: Mute player for 48 hours: <ON>";else u.colour=16777215,u.text="Moderator option: Mute player for 48 hours: <OFF>";else if(_===650||_===655)if(this.lastAddress===0)u.text="";else{let m;if(this.daysSinceLastLogin===0)m="earlier today";else if(this.daysSinceLastLogin===1)m="yesterday";else m=this.daysSinceLastLogin+" days ago";let R=c.formatIPv4(this.lastAddress);u.text="You last logged in "+m+(R==="127.0.0.1"?".":" from: "+R)}else if(_===651){if(this.unreadMessages===0)u.text="0 unread messages",u.colour=16776960;else if(this.unreadMessages===1)u.text="1 unread message",u.colour=65280;else if(this.unreadMessages>1)u.text=this.unreadMessages+" unread messages",u.colour=65280}else if(_===652)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)u.text="@yel@This is a non-members world: @whi@Since you are a member we";else u.text="";else if(this.daysSinceRecoveriesChanged===200)u.text="You have not yet set any password recovery questions.";else{let m;if(this.daysSinceRecoveriesChanged===0)m="Earlier today";else if(this.daysSinceRecoveriesChanged===1)m="Yesterday";else m=this.daysSinceRecoveriesChanged+" days ago";u.text=m+" you changed your recovery questions"}else if(_===653)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)u.text="@whi@recommend you use a members world instead. You may use";else u.text="";else if(this.daysSinceRecoveriesChanged===200)u.text="We strongly recommend you do so now to secure your account.";else u.text="If you do not remember making this change then cancel it immediately";else if(_===654)if(this.daysSinceRecoveriesChanged===201)if(this.warnMembersInNonMembers==1)u.text="@whi@this world but member benefits are unavailable whilst here.";else u.text="";else if(this.daysSinceRecoveriesChanged===200)u.text="Do this from the 'account management' area on our front webpage";else u.text="Do this from the 'account management' area on our front webpage"}handleInterfaceAction(u){let _=u.clientCode;if(_===201)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=1,this.socialMessage="Enter name of friend to add to list";else if(_===202)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=2,this.socialMessage="Enter name of friend to delete from list";else if(_===205)return this.idleTimeout=250,!0;else if(_===501)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=4,this.socialMessage="Enter name of player to add to list";else if(_===502)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialInputType=5,this.socialMessage="Enter name of player to delete from list";else if(_>=300&&_<=313){let m=(_-300)/2|0,R=_&1,b=this.designKits[m];if(b!==-1)while(!0){if(R===0){if(b--,b<0)b=U0.count-1}if(R===1){if(b++,b>=U0.count)b=0}if(!U0.types[b].disable&&U0.types[b].type===m+(this.designGender?0:7)){this.designKits[m]=b,this.updateDesignModel=!0;break}}}else if(_>=314&&_<=323){let m=(_-314)/2|0,R=_&1,b=this.designColours[m];if(R===0){if(b--,b<0)b=T0.DESIGN_IDK_COLORS[m].length-1}if(R===1){if(b++,b>=T0.DESIGN_IDK_COLORS[m].length)b=0}this.designColours[m]=b,this.updateDesignModel=!0}else if(_===324&&!this.designGender)this.designGender=!0,this.validateCharacterDesign();else if(_===325&&this.designGender)this.designGender=!1,this.validateCharacterDesign();else if(_===326){this.out.p1isaac(150),this.out.p1(this.designGender?0:1);for(let m=0;m<7;m++)this.out.p1(this.designKits[m]);for(let m=0;m<5;m++)this.out.p1(this.designColours[m]);return!0}else if(_===613)this.reportAbuseMuteOption=!this.reportAbuseMuteOption;else if(_>=601&&_<=612){if(this.closeInterfaces(),this.reportAbuseInput.length>0)this.out.p1isaac(205),this.out.p8(c.toBase37(this.reportAbuseInput)),this.out.p1(_-601),this.out.p1(this.reportAbuseMuteOption?1:0)}return!1}validateCharacterDesign(){this.updateDesignModel=!0;for(let u=0;u<7;u++){this.designKits[u]=-1;for(let _=0;_<U0.count;_++)if(!U0.types[_].disable&&U0.types[_].type===u+(this.designGender?0:7)){this.designKits[u]=_;break}}}drawSidebar(){if(this.areaSidebar?.bind(),this.areaSidebarOffsets)h.lineOffset=this.areaSidebarOffsets;if(this.imageInvback?.draw(0,0),this.sidebarInterfaceId!==-1)this.drawInterface(g.types[this.sidebarInterfaceId],0,0,0);else if(this.tabInterfaceId[this.selectedTab]!==-1)this.drawInterface(g.types[this.tabInterfaceId[this.selectedTab]],0,0,0);if(this.menuVisible&&this.menuArea===1)this.drawMenu();if(this.areaSidebar?.draw(553,205),this.areaViewport?.bind(),this.areaViewportOffsets)h.lineOffset=this.areaViewportOffsets}drawChat(){if(this.areaChatback?.bind(),this.areaChatbackOffsets)h.lineOffset=this.areaChatbackOffsets;if(this.imageChatback?.draw(0,0),this.showSocialInput)this.fontBold12?.drawStringCenter(239,40,this.socialMessage,0),this.fontBold12?.drawStringCenter(239,60,this.socialInput+"*",128);else if(this.chatbackInputOpen)this.fontBold12?.drawStringCenter(239,40,"Enter amount:",0),this.fontBold12?.drawStringCenter(239,60,this.chatbackInput+"*",128);else if(this.modalMessage)this.fontBold12?.drawStringCenter(239,40,this.modalMessage,0),this.fontBold12?.drawStringCenter(239,60,"Click to continue",128);else if(this.chatInterfaceId!==-1)this.drawInterface(g.types[this.chatInterfaceId],0,0,0);else if(this.stickyChatInterfaceId!==-1)this.drawInterface(g.types[this.stickyChatInterfaceId],0,0,0);else{let u=this.fontPlain12,_=0;K.setBounds(0,0,463,77);for(let R=0;R<100;R++){let b=this.messageText[R];if(!b)continue;let E=this.messageType[R],O=this.chatScrollOffset+70-_*14,L=this.messageSender[R],I=0;if(L&&L.startsWith("@cr1@"))L=L.substring(5),I=1;else if(L&&L.startsWith("@cr2@"))L=L.substring(5),I=2;if(E===0){if(O>0&&O<110)u?.drawString(4,O,b,0);_++}else if((E===1||E===2)&&(this.chatPublicMode===0||this.chatPublicMode===1&&this.isFriend(L))){if(O>0&&O<110){let N=4;if(I==1)this.imageModIcons[0].draw(N,O-12),N+=14;else if(I==2)this.imageModIcons[1].draw(N,O-12),N+=14;u?.drawString(N,O,L+":",0),N+=(u?.stringWidth(L)??0)+8,u?.drawString(N,O,b,255)}_++}else if((E===3||E===7)&&this.splitPrivateChat===0&&(E===7||this.chatPrivateMode===0||this.chatPrivateMode===1&&this.isFriend(L))){if(O>0&&O<110){let N=4;if(u?.drawString(N,O,"From ",0),N+=u?.stringWidth("From ")??0,I==1)this.imageModIcons[0].draw(N,O-12),N+=14;else if(I==2)this.imageModIcons[1].draw(N,O-12),N+=14;u?.drawString(N,O,L+":",0),N+=(u?.stringWidth(L)??0)+8,u?.drawString(N,O,b,8388608)}_++}else if(E===4&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(L))){if(O>0&&O<110)u?.drawString(4,O,L+" "+this.messageText[R],8388736);_++}else if(E===5&&this.splitPrivateChat===0&&this.chatPrivateMode<2){if(O>0&&O<110)u?.drawString(4,O,b,8388608);_++}else if(E===6&&this.splitPrivateChat===0&&this.chatPrivateMode<2){if(O>0&&O<110)u?.drawString(4,O,"To "+L+":",0),u?.drawString(u.stringWidth("To "+L)+12,O,b,8388608);_++}else if(E===8&&(this.chatTradeMode===0||this.chatTradeMode===1&&this.isFriend(L))){if(O>0&&O<110)u?.drawString(4,O,L+" "+this.messageText[R],8270336);_++}}if(K.resetBounds(),this.chatScrollHeight=_*14+7,this.chatScrollHeight<78)this.chatScrollHeight=78;this.drawScrollbar(463,0,this.chatScrollHeight-this.chatScrollOffset-77,this.chatScrollHeight,77);let m;if(this.localPlayer==null||this.localPlayer.name==null)m=c.formatName(this.username);else m=this.localPlayer.name;u?.drawString(4,90,m+":",0),u?.drawString(u.stringWidth(m+": ")+6,90,this.chatTyped+"*",255),K.drawHorizontalLine(0,77,0,479)}if(this.menuVisible&&this.menuArea===2)this.drawMenu();if(this.areaChatback?.draw(17,357),this.areaViewport?.bind(),this.areaViewportOffsets)h.lineOffset=this.areaViewportOffsets}drawMinimap(){if(!this.localPlayer)return;this.areaMapback?.bind();let u=this.orbitCameraYaw+this.macroMinimapAngle&2047,_=(this.localPlayer.x/32|0)+48,m=464-(this.localPlayer.z/32|0);this.imageMinimap?.drawRotatedMasked(25,5,146,151,this.minimapMaskLineOffsets,this.minimapMaskLineLengths,_,m,u,this.macroMinimapZoom+256),this.imageCompass?.drawRotatedMasked(0,0,33,33,this.compassMaskLineOffsets,this.compassMaskLineLengths,25,25,this.orbitCameraYaw,256);for(let R=0;R<this.activeMapFunctionCount;R++)_=this.activeMapFunctionX[R]*4+2-(this.localPlayer.x/32|0),m=this.activeMapFunctionZ[R]*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(m,this.activeMapFunctions[R],_);for(let R=0;R<104;R++)for(let b=0;b<104;b++)if(this.objStacks[this.currentLevel][R][b])_=R*4+2-(this.localPlayer.x/32|0),m=b*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(m,this.imageMapdot0,_);for(let R=0;R<this.npcCount;R++){let b=this.npcs[this.npcIds[R]];if(b&&b.isVisible()&&b.type&&b.type.minimap)_=(b.x/32|0)-(this.localPlayer.x/32|0),m=(b.z/32|0)-(this.localPlayer.z/32|0),this.drawOnMinimap(m,this.imageMapdot1,_)}for(let R=0;R<this.playerCount;R++){let b=this.players[this.playerIds[R]];if(b&&b.isVisible()&&b.name){_=(b.x/32|0)-(this.localPlayer.x/32|0),m=(b.z/32|0)-(this.localPlayer.z/32|0);let E=!1,O=c.toBase37(b.name);for(let L=0;L<this.friendCount;L++)if(O===this.friendName37[L]&&this.friendWorld[L]!==0){E=!0;break}if(E)this.drawOnMinimap(m,this.imageMapdot3,_);else this.drawOnMinimap(m,this.imageMapdot2,_)}}if(this.hintType!=0&&this.loopCycle%20<10){if(this.hintType==1&&this.hintNpc>=0&&this.hintNpc<this.npcs.length){let R=this.npcs[this.hintNpc];if(R!=null){let b=(R.x/32|0)-(this.localPlayer.x/32|0),E=(R.z/32|0)-(this.localPlayer.z/32|0);this.drawMinimapHint(b,E,this.imageMapmarker1)}}else if(this.hintType==2){let R=(this.hintTileX-this.sceneBaseTileX)*4+2-(this.localPlayer.x/32|0),b=(this.hintTileZ-this.sceneBaseTileZ)*4+2-(this.localPlayer.z/32|0);this.drawMinimapHint(R,b,this.imageMapmarker1)}else if(this.hintType==10&&this.hintPlayer>=0&&this.hintPlayer<this.players.length){let R=this.players[this.hintPlayer];if(R!=null){let b=(R.x/32|0)-(this.localPlayer.x/32|0),E=(R.z/32|0)-(this.localPlayer.z/32|0);this.drawMinimapHint(b,E,this.imageMapmarker1)}}}if(this.flagSceneTileX!==0)_=this.flagSceneTileX*4+2-(this.localPlayer.x/32|0),m=this.flagSceneTileZ*4+2-(this.localPlayer.z/32|0),this.drawOnMinimap(m,this.imageMapmarker0,_);K.fillRect2d(97,78,3,3,16777215),this.areaViewport?.bind()}drawMinimapHint(u,_,m){if(!m)return;let R=u*u+_*_;if(R<=4225||R>=90000){this.drawOnMinimap(_,m,u);return}let b=this.orbitCameraYaw+this.macroMinimapAngle&2047,E=h.sinTable[b],O=h.cosTable[b];E=E*256/(this.macroMinimapZoom+256)|0,O=O*256/(this.macroMinimapZoom+256)|0;let L=_*E+u*O>>16,I=_*O-u*E>>16,N=Math.atan2(L,I),H=Math.sin(N)*63|0,G=Math.cos(N)*57|0;this.imageMapedge?.drawRotated(83-G-20,N,256,15,15,20,20,H+94+4-10)}drawOnMinimap(u,_,m){if(!_)return;let R=m*m+u*u;if(R>6400)return;let b=this.orbitCameraYaw+this.macroMinimapAngle&2047,E=h.sinTable[b],O=h.cosTable[b];E=E*256/(this.macroMinimapZoom+256)|0,O=O*256/(this.macroMinimapZoom+256)|0;let L=u*E+m*O>>16,I=u*O-m*E>>16;if(R>2500&&this.imageMapback)_.drawMasked(L+94-(_.width/2|0)+4,83-I-(_.height/2|0)-4,this.imageMapback);else _.draw(L+94-(_.width/2|0)+4,83-I-(_.height/2|0)-4)}addMessage(u,_,m){if(u===0&&this.stickyChatInterfaceId!==-1)this.modalMessage=_,this.mouseClickButton=0;if(this.chatInterfaceId===-1)this.redrawChatback=!0;for(let R=99;R>0;R--)this.messageType[R]=this.messageType[R-1],this.messageSender[R]=this.messageSender[R-1],this.messageText[R]=this.messageText[R-1];this.messageType[0]=u,this.messageSender[0]=m,this.messageText[0]=_}isFriend(u){if(!u)return!1;for(let _=0;_<this.friendCount;_++)if(u.toLowerCase()===this.friendName[_]?.toLowerCase())return!0;if(!this.localPlayer)return!1;return u.toLowerCase()===this.localPlayer.name?.toLowerCase()}addFriend(u){if(u===0n)return;if(this.friendCount>=100&&this.membersAccount!=1){this.addMessage(0,"Your friendlist is full. Max of 100 for free users, and 200 for members","");return}else if(this.friendCount>=200){this.addMessage(0,"Your friendlist is full. Max of 100 for free users, and 200 for members","");return}let _=c.formatName(c.fromBase37(u));for(let m=0;m<this.friendCount;m++)if(this.friendName37[m]===u){this.addMessage(0,_+" is already on your friend list","");return}for(let m=0;m<this.ignoreCount;m++)if(this.ignoreName37[m]===u){this.addMessage(0,"Please remove "+_+" from your ignore list first","");return}if(!this.localPlayer||!this.localPlayer.name)return;if(_!==this.localPlayer.name)this.friendName[this.friendCount]=_,this.friendName37[this.friendCount]=u,this.friendWorld[this.friendCount]=0,this.friendCount++,this.redrawSidebar=!0,this.out.p1isaac(116),this.out.p8(u)}removeFriend(u){if(u===0n)return;for(let _=0;_<this.friendCount;_++)if(this.friendName37[_]===u){this.friendCount--,this.redrawSidebar=!0;for(let m=_;m<this.friendCount;m++)this.friendName[m]=this.friendName[m+1],this.friendWorld[m]=this.friendWorld[m+1],this.friendName37[m]=this.friendName37[m+1];this.out.p1isaac(61),this.out.p8(u);return}}addIgnore(u){if(u===0n)return;if(this.ignoreCount>=100){this.addMessage(0,"Your ignore list is full. Max of 100 hit","");return}let _=c.formatName(c.fromBase37(u));for(let m=0;m<this.ignoreCount;m++)if(this.ignoreName37[m]===u){this.addMessage(0,_+" is already on your ignore list","");return}for(let m=0;m<this.friendCount;m++)if(this.friendName37[m]===u){this.addMessage(0,"Please remove "+_+" from your friend list first","");return}this.ignoreName37[this.ignoreCount++]=u,this.redrawSidebar=!0,this.out.p1isaac(20),this.out.p8(u)}removeIgnore(u){if(u===0n)return;for(let _=0;_<this.ignoreCount;_++)if(this.ignoreName37[_]===u){this.ignoreCount--,this.redrawSidebar=!0;for(let m=_;m<this.ignoreCount;m++)this.ignoreName37[m]=this.ignoreName37[m+1];this.out.p1isaac(4),this.out.p8(u);return}}unloadTitle(){if(this.flameActive=!1,this.flamesInterval)clearInterval(this.flamesInterval),this.flamesInterval=null;this.imageTitlebox=null,this.imageTitlebutton=null,this.imageRunes=[],this.flameGradient=null,this.flameGradient0=null,this.flameGradient1=null,this.flameGradient2=null,this.flameBuffer0=null,this.flameBuffer1=null,this.flameBuffer3=null,this.flameBuffer2=null,this.imageFlamesLeft=null,this.imageFlamesRight=null}runFlames(){if(!this.flameActive)return;this.flameCycle++,this.updateFlames(),this.updateFlames(),this.drawFlames()}updateFlames(){if(!this.flameBuffer3||!this.flameBuffer2||!this.flameBuffer0||!this.flameLineOffset)return;let u=256;for(let _=10;_<117;_++)if((Math.random()*100|0)<50)this.flameBuffer3[_+(u-2<<7)]=255;for(let _=0;_<100;_++){let m=(Math.random()*124|0)+2,R=(Math.random()*128|0)+128,b=m+(R<<7);this.flameBuffer3[b]=192}for(let _=1;_<u-1;_++)for(let m=1;m<127;m++){let R=m+(_<<7);this.flameBuffer2[R]=(this.flameBuffer3[R-1]+this.flameBuffer3[R+1]+this.flameBuffer3[R-128]+this.flameBuffer3[R+128])/4|0}if(this.flameCycle0+=128,this.flameCycle0>this.flameBuffer0.length)this.flameCycle0-=this.flameBuffer0.length,this.updateFlameBuffer(this.imageRunes[Math.random()*12|0]);for(let _=1;_<u-1;_++)for(let m=1;m<127;m++){let R=m+(_<<7),b=this.flameBuffer2[R+128]-(this.flameBuffer0[R+this.flameCycle0&this.flameBuffer0.length-1]/5|0);if(b<0)b=0;this.flameBuffer3[R]=b}for(let _=0;_<u-1;_++)this.flameLineOffset[_]=this.flameLineOffset[_+1];if(this.flameLineOffset[u-1]=Math.sin(this.loopCycle/14)*16+Math.sin(this.loopCycle/15)*14+Math.sin(this.loopCycle/16)*12|0,this.flameGradientCycle0>0)this.flameGradientCycle0-=4;if(this.flameGradientCycle1>0)this.flameGradientCycle1-=4;if(this.flameGradientCycle0===0&&this.flameGradientCycle1===0){let _=Math.random()*2000|0;if(_===0)this.flameGradientCycle0=1024;else if(_===1)this.flameGradientCycle1=1024}}updateFlameBuffer(u){if(!this.flameBuffer0||!this.flameBuffer1)return;let _=256;this.flameBuffer0.fill(0);for(let m=0;m<5000;m++){let R=Math.random()*128*_|0;this.flameBuffer0[R]=Math.random()*256|0}for(let m=0;m<20;m++){for(let b=1;b<_-1;b++)for(let E=1;E<127;E++){let O=E+(b<<7);this.flameBuffer1[O]=(this.flameBuffer0[O-1]+this.flameBuffer0[O+1]+this.flameBuffer0[O-128]+this.flameBuffer0[O+128])/4|0}let R=this.flameBuffer0;this.flameBuffer0=this.flameBuffer1,this.flameBuffer1=R}if(u){let m=0;for(let R=0;R<u.height2d;R++)for(let b=0;b<u.width2d;b++)if(u.pixels[m++]!==0){let E=b+u.cropX+16,O=R+u.cropY+16,L=E+(O<<7);this.flameBuffer0[L]=0}}}drawFlames(){if(!this.flameGradient||!this.flameGradient0||!this.flameGradient1||!this.flameGradient2||!this.flameLineOffset||!this.flameBuffer3)return;let u=256;if(this.flameGradientCycle0>0)for(let R=0;R<256;R++)if(this.flameGradientCycle0>768)this.flameGradient[R]=this.mix(this.flameGradient0[R],1024-this.flameGradientCycle0,this.flameGradient1[R]);else if(this.flameGradientCycle0>256)this.flameGradient[R]=this.flameGradient1[R];else this.flameGradient[R]=this.mix(this.flameGradient1[R],256-this.flameGradientCycle0,this.flameGradient0[R]);else if(this.flameGradientCycle1>0)for(let R=0;R<256;R++)if(this.flameGradientCycle1>768)this.flameGradient[R]=this.mix(this.flameGradient0[R],1024-this.flameGradientCycle1,this.flameGradient2[R]);else if(this.flameGradientCycle1>256)this.flameGradient[R]=this.flameGradient2[R];else this.flameGradient[R]=this.mix(this.flameGradient2[R],256-this.flameGradientCycle1,this.flameGradient0[R]);else for(let R=0;R<256;R++)this.flameGradient[R]=this.flameGradient0[R];for(let R=0;R<33920;R++)if(this.imageTitle0&&this.imageFlamesLeft)this.imageTitle0.pixels[R]=this.imageFlamesLeft.pixels[R];let _=0,m=1152;for(let R=1;R<u-1;R++){let E=(this.flameLineOffset[R]*(u-R)/u|0)+22;if(E<0)E=0;_+=E;for(let O=E;O<128;O++){let L=this.flameBuffer3[_++];if(L===0)m++;else{let I=L,N=256-L;if(L=this.flameGradient[L],this.imageTitle0){let H=this.imageTitle0.pixels[m];this.imageTitle0.pixels[m++]=((L&16711935)*I+(H&16711935)*N&4278255360)+((L&65280)*I+(H&65280)*N&16711680)>>8}}}m+=E}this.imageTitle0?.draw(0,0);for(let R=0;R<33920;R++)if(this.imageTitle1&&this.imageFlamesRight)this.imageTitle1.pixels[R]=this.imageFlamesRight.pixels[R];_=0,m=1176;for(let R=1;R<u-1;R++){let b=this.flameLineOffset[R]*(u-R)/u|0,E=103-b;m+=b;for(let O=0;O<E;O++){let L=this.flameBuffer3[_++];if(L===0)m++;else{let I=L,N=256-L;if(L=this.flameGradient[L],this.imageTitle1){let H=this.imageTitle1.pixels[m];this.imageTitle1.pixels[m++]=((L&16711935)*I+(H&16711935)*N&4278255360)+((L&65280)*I+(H&65280)*N&16711680)>>8}}}_+=128-E,m+=128-E-b}if(this.imageTitle1?.draw(637,0),this.isMobile)J0.draw()}mix(u,_,m){let R=256-_;return((u&16711935)*R+(m&16711935)*_&4278255360)+((u&65280)*R+(m&65280)*_&16711680)>>8}getTitleScreenState(){return this.titleScreenState}isChatBackInputOpen(){return this.chatbackInputOpen}isShowSocialInput(){return this.showSocialInput}getChatInterfaceId(){return this.chatInterfaceId}getViewportInterfaceId(){return this.viewportInterfaceId}getReportAbuseInterfaceId(){return this.reportAbuseInterfaceId}}export{v as Client};

//# debugId=0470522AB96B8BB264756E2164756E21
